<!DOCTYPE html>
<html lang="en">
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Equation Solver Tool</title>
  <style>
    /* Destylized, high-contrast, no shadows, no rounded corners, no animations */
    :root{
      --bg:#ffffff;
      --panel:#ffffff;
      --ink:#000000;
      --muted:#333333;
      --accent:#0055aa;
      --accent-weak:#e6f0ff;
      --error:#aa0000;
      --ok:#005a32;
      --border:#000000;
      --softborder:#dddddd;
      --warning:#a05a00;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font:16px/1.5 Georgia, "Times New Roman", Times, serif;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    a{color:var(--accent); text-decoration:underline}
    header{
      padding:12px 12px 0;
      border-bottom:2px solid var(--softborder);
    }
    header .row{display:flex; gap:16px; align-items:center; flex-wrap:wrap}
    header h1{
      margin:0 0 4px;
      font-size:28px;
      letter-spacing:.3px;
    }
    header p{
      margin:0 0 8px;
      color:var(--muted);
      font-size:15px;
    }

    /* Simple top navigation */
    #topNav{
      display:flex; gap:12px; padding:8px 0 12px; flex-wrap:wrap;
      border-top:1px solid var(--softborder);
    }
    #topNav a{
      display:inline-block;
      padding:10px 12px;
      border:1px solid var(--softborder);
      background:#fff;
      color:var(--ink);
      min-height:44px; line-height:24px;
    }
    #statusBar{
      border-top:2px solid var(--softborder);
      border-bottom:2px solid var(--softborder);
      background:#fafafa;
      padding:8px 12px;
      display:flex; gap:24px; flex-wrap:wrap; align-items:center;
      font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      font-size:14px;
    }
    #statusBar span{display:inline-block; padding:4px 8px; border:1px solid var(--softborder); background:#fff}
    #solveStatus, #downloadStatus, #copyStatus, #previewStatus, #activeSection, #lastLinkClicked{
      font-weight:700;
    }

    main{
      max-width:1200px;
      margin:0 auto;
      padding:12px;
    }
    #layout{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:16px;
    }
    section{
      padding:12px;
      border:1px solid var(--softborder);
      background:#fff;
    }
    section h2{margin:0 0 8px; font-size:20px; border-bottom:1px solid var(--softborder); padding-bottom:6px}
    .stack{display:grid; gap:12px}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    label{font-weight:600}
    input[type="text"]{
      flex:1 1 520px;
      font:18px/1.2 "Times New Roman", Georgia, serif;
      padding:12px 14px;
      border:2px solid var(--softborder);
      background:#fff;
      outline:none;
      min-height:44px;
    }
    input[type="text"].has-error{border-color:var(--error); background:#fff4f4}
    input[type="text"].has-warning{border-color:var(--warning); background:#fffaf1}
    button{
      appearance:none;
      border:2px solid var(--softborder);
      background:#fff;
      color:var(--ink);
      padding:10px 16px;
      min-height:44px; min-width:44px;
      font:700 14px/1 ui-sans-serif, -apple-system, Segoe UI, Roboto, Arial;
      cursor:pointer;
    }
    button.primary{
      border-color:var(--accent);
      background:var(--accent);
      color:#fff;
    }
    button[aria-disabled="true"]{
      opacity:.6;
      cursor:not-allowed;
    }
    select{
      padding:10px 12px;
      min-height:44px;
      border:2px solid var(--softborder);
      background:#fff;
      font:600 14px/1 ui-sans-serif, -apple-system, Segoe UI, Roboto, Arial;
    }
    .hint{color:var(--muted); font-size:14px}
    .kbd-hint{font-size:13px; color:#111; border:1px dashed var(--softborder); padding:6px}
    .samples{
      display:flex; gap:8px; flex-wrap:wrap; margin-top:4px
    }
    .sample-btn{
      font-size:13px; padding:10px 12px; min-height:44px; border:1px dashed var(--softborder); background:#fafafa
    }
    #inlineNote{
      font-size:14px; padding:8px; border:1px solid var(--softborder); background:#f6faff;
    }
    #inputFeedback{
      font-size:14px; padding:8px; border:1px solid transparent;
    }
    #inputFeedback.error{border-color:var(--error); background:#fff4f4; color:var(--error)}
    #inputFeedback.warn{border-color:var(--warning); background:#fffaf1; color:var(--warning)}

    #alertBox{
      min-height:20px;
      padding:8px 12px;
      border-left:4px solid transparent;
      background:#fff;
      border:1px solid var(--softborder);
      color:var(--muted);
    }
    #alertBox.ok{border-left-color:var(--ok); color:var(--ok); background:#f2fbf7}
    #alertBox.error{border-left-color:var(--error); color:var(--error); background:#fff5f5}

    /* Solution area */
    #solutionBox{
      border:2px solid var(--softborder);
      background:#fff;
    }
    #solutionBox[data-state="ready"]{border-color:var(--accent)}
    #solutionBox[data-state="reset"]{border-color:#888}
    #solutionBox[data-state="error"]{border-color:var(--error)}
    #solutionTitle{margin:0 0 6px}
    .summary{
      font-weight:600;
      padding:10px 12px;
      border:1px solid var(--softborder);
      min-height:24px;
      background:#f7f9fb;
    }
    .summary.error-box{
      border-color:var(--error);
      color:var(--error);
      background:#fff4f4;
    }
    ol#stepsList{
      margin:12px 0 6px 20px;
      padding:0 0 0 8px;
      max-height:260px; overflow:auto;
      border:1px dotted var(--softborder);
    }
    #exportPanel{
      margin-top:8px; padding-top:8px;
      border-top:2px solid var(--softborder);
    }
    .export-row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .export-row button{display:flex; align-items:center; gap:6px}
    .export-row .icon{font-size:18px; line-height:1}
    #copyFeedback{
      font-size:14px; padding:6px 8px; border:1px solid var(--softborder); background:#f9fff6; color:var(--ok); min-height:22px
    }
    #downloadAnchor{display:none}
    #jsonPreview{
      padding:8px; border:1px solid var(--softborder); background:#fafafa; max-height:180px; overflow:auto; white-space:pre-wrap; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:12px;
    }

    /* Guide */
    details summary{cursor:pointer; font-weight:700; list-style:none}
    details[open] summary{border-bottom:1px solid var(--softborder); padding-bottom:6px; margin-bottom:6px}
    code.inline{
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background:#f5f7f9;
      border:1px solid var(--softborder);
      padding:1px 6px;
      font-size:90%;
    }
    .guide-callout{
      border:2px solid var(--warning); padding:8px; background:#fffdf5; margin:8px 0; color:#2b1d00;
    }
    .guide-ok{
      border:2px solid var(--ok); padding:8px; background:#f4fff9; margin:8px 0; color:#003b24;
    }

    footer{
      border-top:2px solid var(--softborder);
      font-size:13px;
      padding:12px;
      color:var(--muted);
    }

    @media (max-width:980px){
      #layout{grid-template-columns: 1fr}
    }
    @media (max-width:600px){
      input[type="text"]{flex-basis:100%}
      .row .btns{width:100%; display:flex; gap:8px; flex-wrap:wrap}
    }
  </style>
</head>
<body>
  <header>
    <div class="row" style="justify-content:space-between">
      <div>
        <h1>Equation Solver Tool</h1>
        <p>Solve and explain single-variable equations with clear, step-by-step reasoning.</p>
      </div>
      <nav id="topNav" aria-label="In-page navigation">
        <a href="#inputSection" id="navInput">Input</a>
        <a href="#guideSection" id="navGuide">Guide</a>
        <a href="#solutionBox" id="navSolution">Solution</a>
      </nav>
    </div>
    <div id="statusBar" aria-label="Live status indicators">
      <span>solveStatus: <span id="solveStatus">idle</span></span>
      <span>downloadStatus: <span id="downloadStatus">disabled</span></span>
      <span>copyStatus: <span id="copyStatus">idle</span></span>
      <span>previewStatus: <span id="previewStatus">empty</span></span>
      <span>activeSection: <span id="activeSection">Input</span></span>
      <span>lastLinkClicked: <span id="lastLinkClicked">none</span></span>
    </div>
  </header>

  <main>
    <div id="layout">

      <section class="stack" id="inputSection" aria-label="Equation Input">
        <form id="solverForm" class="stack" autocomplete="off" novalidate>
          <div id="inlineNote" role="note" aria-live="polite">
            Note: Use x as the variable. Scientific notation is accepted (e.g., 1.2e3x - 3e2 = 0). Parentheses are not supported; write expanded equations.
          </div>
          <div class="stack">
            <label for="inputEquation">Enter equation (in x)</label>
            <div class="row">
              <input id="inputEquation" name="inputEquation" type="text" placeholder="e.g., 2x + 3 = 11, x^2 - 5x + 6 = 0, or 1.2e3x - 3e2 = 0" aria-describedby="syntaxHint inputFeedback kbdHint" />
              <div class="btns">
                <button id="btnSolve" class="primary" type="submit" aria-label="Solve equation">Solve</button>
                <button id="btnReset" type="button" aria-label="Reset input and solution">Reset</button>
              </div>
            </div>
            <div id="inputFeedback" aria-live="polite"></div>
          </div>

          <div class="row" aria-label="Options">
            <label for="precisionSelect" class="hint">Precision</label>
            <select id="precisionSelect" name="precisionSelect" title="Decimal precision (2-10)">
              <option value="3">3 decimals</option>
              <option value="4">4 decimals</option>
              <option value="5">5 decimals</option>
              <option value="6" selected>6 decimals</option>
              <option value="7">7 decimals</option>
              <option value="8">8 decimals</option>
              <option value="9">9 decimals</option>
              <option value="10">10 decimals</option>
            </select>
            <span id="syntaxHint" class="hint">Supports linear and quadratic forms without parentheses. No log/ln/trig functions.</span>
            <span id="kbdHint" class="kbd-hint" aria-live="polite">Tip: Press Enter to Solve</span>
          </div>

          <div class="samples" aria-label="Examples">
            <button type="button" class="sample-btn" id="sample1" data-eqn="2x + 3 = 11">2x + 3 = 11</button>
            <button type="button" class="sample-btn" id="sample2" data-eqn="x^2 - 5x + 6 = 0">x^2 - 5x + 6 = 0</button>
            <button type="button" class="sample-btn" id="sample3" data-eqn="3x^2 = 12x - 12">3x^2 = 12x - 12</button>
            <button type="button" class="sample-btn" id="sample4" data-eqn="x^2 + 1 = 0">x^2 + 1 = 0</button>
            <button type="button" class="sample-btn" id="sample5" data-eqn="1.2e3x - 3e2 = 0">1.2e3x - 3e2 = 0</button>
            <button type="button" class="sample-btn" id="sample6" data-eqn="0.25x + 1 = 1.5">0.25x + 1 = 1.5</button>
            <button type="button" class="sample-btn" id="sample7" data-eqn="x^2 - 4 = 0">x^2 - 4 = 0</button>
          </div>
        </form>
        <div id="alertBox" role="status" aria-live="polite"></div>
      </section>

      <section class="stack" aria-label="Guide and Help" id="guideSection">
        <h2>Guide and supported syntax</h2>
        <details id="helpDetails" open>
          <summary>Supported now</summary>
          <div id="helpText">
            <div class="guide-ok">
              - Single variable x only<br/>
              - Linear: <code class="inline">ax + b = c</code> (e.g., <code class="inline">2x + 3 = 11</code>)<br/>
              - Quadratic: <code class="inline">ax^2 + bx + c = d</code> (e.g., <code class="inline">x^2 - 5x + 6 = 0</code>)<br/>
              - Coefficients may be integers or decimals. Scientific notation is accepted (e.g., <code class="inline">1.2e3x</code>).
            </div>
            <div class="guide-callout">
              Important limitations (explicit):<br/>
              - Parentheses and general products are not expanded (e.g., <code class="inline">3(x-2)</code> is not supported). Write expanded polynomials.<br/>
              - Exponents other than 2 are not supported (<code class="inline">x^3</code> etc.).<br/>
              - Multiplication between number and x can be written as <code class="inline">2x</code> or <code class="inline">2*x</code>.<br/>
              - No log/ln/trig/sqrt/abs functions in the input. Examples of unsupported functions:<br/>
              <code class="inline">ln(...)</code>, <code class="inline">log(...)</code>, <code class="inline">sin(...)</code>, <code class="inline">cos(...)</code>, <code class="inline">tan(...)</code>, <code class="inline">sqrt(...)</code>, <code class="inline">|...|</code>, <code class="inline">exp(...)</code>.
            </div>
            <p>Examples that work well:</p>
            <ul>
              <li><code class="inline">2x + 3 = 11</code> ‚Üí linear</li>
              <li><code class="inline">x^2 - 5x + 6 = 0</code> ‚Üí quadratic</li>
              <li><code class="inline">3x^2 = 12x - 12</code> ‚Üí rearranges to quadratic</li>
              <li><code class="inline">1.2e3x - 3e2 = 0</code> ‚Üí scientific notation</li>
              <li><code class="inline">x^2 + 1 = 0</code> ‚Üí complex roots</li>
            </ul>
            <p>What you'll see after solving:</p>
            <ul>
              <li>A concise Summary, such as <code class="inline">x = 4</code>, <code class="inline">x = 0.25</code>, <code class="inline">x = 2</code>, or <code class="inline">No solution</code>. Complex cases show <code class="inline">Two complex solutions</code>.</li>
              <li>Numbered steps with the transformation and reasoning.</li>
              <li>Export controls to copy or download the steps.</li>
            </ul>
          </div>
        </details>

        <details open>
          <summary>Quick troubleshooting</summary>
          <ul>
            <li>If you see an error about the equals sign, ensure there's exactly one "=" in your equation.</li>
            <li>If a "Parsing issue" occurs, check for unsupported items like parentheses or functions (ln, log, sqrt, | |).</li>
            <li>Decimals are fine; you can adjust rounding via the Precision control.</li>
            <li>Using scientific notation? Example: <code class="inline">5e-3x + 2e2 = 1</code>.</li>
          </ul>
        </details>

        <details>
          <summary>FAQ</summary>
          <p><strong>Can this tool factor polynomials?</strong><br/>Not at this time. It uses combine-like-terms, rearrangement, and the quadratic formula for quadratics. The steps aim to be concise and readable.</p>
          <p><strong>Does it support fractions like (x/3)?</strong><br/>Not currently; parentheses and fractional forms like <code class="inline">(x/3) - (2/5)</code> are not recognized. Expand the equation if possible.</p>
          <p><strong>Can it export JSON or Markdown?</strong><br/>Yes. Use the export buttons in the Solution panel to download a .txt, .md (Markdown), or .json file. You can also copy the steps.</p>
        </details>

        <details>
          <summary>Changelog</summary>
          <ul>
            <li>Added live input validation with inline feedback for unsupported syntax.</li>
            <li>Guide moved above Solution and expanded by default for visibility.</li>
            <li>Added Copy feedback and multiple export formats (TXT, Markdown, JSON).</li>
            <li>Added live status indicators and accessibility improvements.</li>
          </ul>
        </details>
      </section>

      <section class="stack" aria-label="Solution" id="solutionBox" aria-live="polite" data-state="reset">
        <h2 id="solutionTitle">Solution</h2>
        <div id="solutionSummary" class="summary" tabindex="-1" aria-live="polite">Result will appear here.</div>
        <ol id="stepsList"></ol>

        <div id="exportPanel" aria-label="Export and copy">
          <div class="export-row">
            <button id="btnCopy" type="button" aria-label="Copy steps to clipboard"><span class="icon" aria-hidden="true">üìã</span>Copy Steps</button>
            <button id="btnExport" type="button" aria-label="Download steps as .txt"><span class="icon" aria-hidden="true">‚¨áÔ∏è</span>Download .txt</button>
            <button id="btnExportMd" type="button" aria-label="Download steps as Markdown"><span class="icon" aria-hidden="true">‚¨áÔ∏è</span>Download .md</button>
            <button id="btnExportJson" type="button" aria-label="Download result as JSON"><span class="icon" aria-hidden="true">‚¨áÔ∏è</span>Download .json</button>
          </div>
          <div class="export-row">
            <div id="copyFeedback" aria-live="polite">Copy status will appear here.</div>
          </div>
          <a id="downloadAnchor" href="#" download>hidden-download</a>
          <div class="stack" style="margin-top:8px">
            <label for="jsonPreview">Result preview (JSON)</label>
            <pre id="jsonPreview" data-ready="false" aria-live="polite">{}</pre>
          </div>
        </div>
      </section>

    </div>
  </main>

  <footer>
    Built with HTML5, CSS3, and vanilla JavaScript. No external libraries.
    <br/>Project home: <a href="https://example.com/" target="_blank" id="homeLink">Website</a> ¬∑ <a href="https://github.com/" target="_blank" id="githubLink">GitHub</a>
  </footer>

  <script>
    // Utilities
    const $ = sel => document.querySelector(sel);
    const byId = id => document.getElementById(id);

    const els = {
      form: byId('solverForm'),
      input: byId('inputEquation'),
      alert: byId('alertBox'),
      summary: byId('solutionSummary'),
      steps: byId('stepsList'),
      btnSolve: byId('btnSolve'),
      btnReset: byId('btnReset'),
      btnCopy: byId('btnCopy'),
      btnExport: byId('btnExport'),
      btnExportMd: byId('btnExportMd'),
      btnExportJson: byId('btnExportJson'),
      precision: byId('precisionSelect'),
      samples: [byId('sample1'), byId('sample2'), byId('sample3'), byId('sample4'), byId('sample5'), byId('sample6'), byId('sample7')],
      inputFeedback: byId('inputFeedback'),
      solutionBox: byId('solutionBox'),
      downloadAnchor: byId('downloadAnchor'),
      copyFeedback: byId('copyFeedback'),
      jsonPreview: byId('jsonPreview'),
      // Status proxies
      solveStatus: byId('solveStatus'),
      downloadStatus: byId('downloadStatus'),
      copyStatus: byId('copyStatus'),
      previewStatus: byId('previewStatus'),
      activeSection: byId('activeSection'),
      lastLinkClicked: byId('lastLinkClicked'),
      // Navigation
      navInput: byId('navInput'),
      navGuide: byId('navGuide'),
      navSolution: byId('navSolution'),
      // Inline note already in DOM
    };

    function setAlert(msg, type=''){
      els.alert.className = '';
      if(type) els.alert.classList.add(type);
      els.alert.textContent = msg || '';
    }

    function fmt(n, d){
      if(!isFinite(n)) return String(n);
      const s = Number(n).toFixed(d);
      // Trim trailing zeros while preserving at least one decimal if needed
      return s.replace(/(\.\d*?[1-9])0+$/,'$1').replace(/\.0+$/,'');
    }

    function polyToString(a2,a1,a0, precision){
      const parts = [];
      const d = parseInt(els.precision.value,10) || precision || 6;
      function pushTerm(coef, label){
        if(Math.abs(coef) < 1e-15) return;
        const abs = Math.abs(coef);
        const sign = coef >= 0 ? '+' : '-';
        let cstr = fmt(abs, d);
        if(label === 'x^2' || label === 'x'){
          if(cstr === '1') cstr = ''; // omit 1x or 1x^2
        }
        parts.push(`${sign} ${cstr}${label ? (cstr && label ? '' : '') + label : ''}`.trim());
      }
      pushTerm(a2,'x^2');
      pushTerm(a1,'x');
      pushTerm(a0,'');
      if(parts.length===0) return '0';
      // Fix first sign
      let s = parts.join(' ');
      s = s.replace(/^\+\s*/,'');
      return s;
    }

    function cleanInput(s){
      if(!s) return '';
      // Normalize unicode minus and multiply signs, collapse spaces
      return s
        .replace(/[‚àí‚Äì‚Äî]/g,'-')
        .replace(/[√ó¬∑]/g,'*')
        .replace(/[A-WYZa-wyz]/g, ch => ch.toLowerCase()) // lower-case letters
        .replace(/\s+/g,'')
        .replace(/x/g,'x'); // keep x
    }

    function parsePolynomial(expr){
      // Returns {a2, a1, a0, issues:[], tokens:[]}
      let a2=0, a1=0, a0=0;
      const issues=[];
      const tokens=[];
      if(expr === '' || expr == null){ issues.push('Empty expression'); return {a2,a1,a0,issues,tokens}; }

      // Normalize into sum of signed terms: replace '-' with '+-'
      // But avoid turning scientific notation 'e-' into '+-': handle carefully
      let e = expr;
      // Temporarily mark scientific notation e+/- signs
      e = e.replace(/e\+/ig, 'EPLUS');
      e = e.replace(/e\-/ig, 'EMINUS');
      e = e.replace(/e/ig, 'E');
      e = e.replace(/\-/g, '+-');
      if(e.startsWith('+-')) e = e.slice(1);
      let parts = e.split('+').filter(p => p.length>0);
      parts = parts.map(p=>{
        p = p.replace(/EPLUS/ig, 'e+').replace(/EMINUS/ig, 'e-').replace(/E/ig,'e');
        return p;
      });

      const numRe = /^([+-])?(\d*\.?\d+(?:e[+-]?\d+)?)$/i;
      const xRe = /^([+-])?(?:(\d*\.?\d+(?:e[+-]?\d+)?)\*?)?x(?:\^([+-]?\d+))?$/i;

      for(const raw of parts){
        if(!raw) continue;
        let part = raw;
        tokens.push(part);
        let m;
        if((m = xRe.exec(part))){
          const sign = m[1] === '-' ? -1 : 1;
          const coefStr = m[2];
          const expStr = m[3];
          const baseCoef = (coefStr==='' || coefStr==null) ? 1 : Number(coefStr);
          if(!isFinite(baseCoef)){ issues.push(`Invalid coefficient in term "${part}"`); continue; }
          const exp = expStr==null ? 1 : Number(expStr);
          if(!Number.isFinite(exp) || Math.floor(exp)!=exp){ issues.push(`Non-integer exponent in term "${part}"`); continue; }
          if(exp < 0 || exp > 2){ issues.push(`Unsupported exponent x^${exp} in term "${part}" (only 0,1,2 supported)`); continue; }
          const c = sign * baseCoef;
          if(exp===2) a2 += c;
          else if(exp===1) a1 += c;
          else a0 += c; // x^0
        } else if((m = numRe.exec(part))){
          const sign = m[1] === '-' ? -1 : 1;
          const val = Number(m[2]);
          if(!isFinite(val)){ issues.push(`Invalid number "${part}"`); continue; }
          a0 += sign * val;
        } else {
          issues.push(`Unrecognized term "${part}"`);
        }
      }
      return {a2,a1,a0,issues,tokens};
    }

    function solveEquation(input, precision){
      const steps = [];
      const meta = { type:null, roots:[], complex:false };
      const d = precision || 6;

      const original = input;
      const s = cleanInput(input);
      if(!s.includes('=')){
        throw { user:true, message:'Please include an equals sign "=" in your equation.' };
      }
      const [leftRaw, rightRaw] = s.split('=');
      if(rightRaw === undefined) throw { user:true, message:'Malformed equation. Please ensure it has one "=" sign.' };
      if(leftRaw.trim()==='' || rightRaw.trim()==='') throw { user:true, message:'Both sides of the equation must be non-empty.' };

      steps.push(`Start with the equation: ${original.trim()}`);

      const L = parsePolynomial(leftRaw);
      const R = parsePolynomial(rightRaw);

      if(L.issues.length || R.issues.length){
        const msg = [...L.issues.map(i=>'LHS: '+i), ...R.issues.map(i=>'RHS: '+i)].join('; ');
        throw { user:true, message:`Parsing issue: ${msg}. See "Guide and supported syntax" for help.` };
      }

      const lhsStr = polyToString(L.a2,L.a1,L.a0,d);
      const rhsStr = polyToString(R.a2,R.a1,R.a0,d);
      steps.push(`Combine like terms on each side: LHS = ${lhsStr},  RHS = ${rhsStr}`);

      // Move all to left: LHS - RHS = 0
      const A = L.a2 - R.a2;
      const B = L.a1 - R.a1;
      const C = L.a0 - R.a0;

      const stdStr = polyToString(A,B,C,d);
      steps.push(`Bring all terms to the left: ${stdStr} = 0`);

      // Classify
      if(Math.abs(A) < 1e-15 && Math.abs(B) < 1e-15 && Math.abs(C) < 1e-15){
        meta.type = 'identity';
        steps.push('All coefficients are zero (0 = 0).');
        return {
          summary: 'Infinitely many solutions (identity). Any real x satisfies the equation.',
          steps, meta
        };
      }

      if(Math.abs(A) < 1e-15 && Math.abs(B) < 1e-15){
        meta.type = 'contradiction';
        steps.push('No variable term remains, but the constant is nonzero.');
        return {
          summary: 'No solution (contradiction).',
          steps, meta
        };
      }

      if(Math.abs(A) < 1e-15){
        // Linear: Bx + C = 0
        meta.type = 'linear';
        const Bn = B, Cn = C;
        steps.push(`This is linear: ${fmt(Bn,d)}x + ${fmt(Cn,d)} = 0`);
        steps.push(`Isolate x: ${fmt(Bn,d)}x = ${fmt(-Cn,d)}`);
        const x = -Cn / Bn;
        steps.push(`Divide both sides by ${fmt(Bn,d)}: x = ${fmt(-Cn,d)} / ${fmt(Bn,d)} = ${fmt(x,d)}`);
        meta.roots = [x];
        return {
          summary: `Solution: x = ${fmt(x,d)}`,
          steps, meta
        };
      } else {
        // Quadratic
        meta.type = 'quadratic';
        const a=A, b=B, c=C;
        steps.push(`This is quadratic: a = ${fmt(a,d)}, b = ${fmt(b,d)}, c = ${fmt(c,d)}.`);
        const D = b*b - 4*a*c;
        steps.push(`Compute the discriminant: D = b^2 - 4ac = ${fmt(b*b,d)} - 4¬∑${fmt(a,d)}¬∑${fmt(c,d)} = ${fmt(D,d)}`);
        steps.push('Quadratic formula: x = (-b ¬± sqrt(D)) / (2a)');

        if(D > 0){
          const sqrtD = Math.sqrt(D);
          const denom = 2*a;
          const x1 = (-b + sqrtD) / denom;
          const x2 = (-b - sqrtD) / denom;
          steps.push(`sqrt(D) = ${fmt(sqrtD,d)}, 2a = ${fmt(denom,d)}`);
          steps.push(`x‚ÇÅ = (${fmt(-b,d)} + ${fmt(sqrtD,d)}) / ${fmt(denom,d)} = ${fmt(x1,d)}`);
          steps.push(`x‚ÇÇ = (${fmt(-b,d)} - ${fmt(sqrtD,d)}) / ${fmt(denom,d)} = ${fmt(x2,d)}`);
          meta.roots = [x1,x2];
          return {
            summary: `Two real solutions: x‚ÇÅ = ${fmt(x1,d)}, x‚ÇÇ = ${fmt(x2,d)}`,
            steps, meta
          };
        } else if (Math.abs(D) < 1e-15){
          const denom = 2*a;
          const x0 = (-b) / denom;
          steps.push(`D = 0 ‚áí one repeated real root.`);
          steps.push(`x = (-b) / (2a) = ${fmt(-b,d)} / ${fmt(2*a,d)} = ${fmt(x0,d)}`);
          meta.roots = [x0];
          return {
            summary: `One real solution (double root): x = ${fmt(x0,d)}`,
            steps, meta
          };
        } else {
          const absD = Math.abs(D);
          const sqrtAbsD = Math.sqrt(absD);
          const denom = 2*a;
          const real = (-b) / denom;
          const imag = sqrtAbsD / Math.abs(denom); // sign of denom goes to both; common to take |2a| in imag magnitude
          steps.push(`D < 0 ‚áí complex roots.`);
          steps.push(`|D| = ${fmt(absD,d)}, sqrt(|D|) = ${fmt(sqrtAbsD,d)}, 2a = ${fmt(2*a,d)}`);
          steps.push(`x = ${fmt(real,d)} ¬± ${fmt(imag,d)}i`);
          meta.complex = true;
          meta.roots = [real+' + '+fmt(imag,d)+'i', real+' - '+fmt(imag,d)+'i'];
          return {
            summary: `Two complex solutions: x = ${fmt(real,d)} ¬± ${fmt(imag,d)}i`,
            steps, meta
          };
        }
      }
    }

    function buildExportText(input, result){
      const now = new Date();
      const ts = now.toISOString().replace('T',' ').replace('Z',' UTC');
      const lines = [];
      lines.push('Equation Solver Tool');
      lines.push('====================');
      lines.push(`Timestamp: ${ts}`);
      lines.push(`Input: ${input}`);
      lines.push('');
      lines.push('Summary:');
      lines.push(`  ${result.summary}`);
      lines.push('');
      lines.push('Steps:');
      result.steps.forEach((s,i)=> lines.push(`  ${i+1}. ${s}`));
      lines.push('');
      lines.push('‚Äî end ‚Äî');
      return lines.join('\n');
    }

    // New: Markdown export
    function buildExportMarkdown(input, result){
      const now = new Date();
      const ts = now.toISOString().replace('T',' ').replace('Z',' UTC');
      const lines = [];
      lines.push('# Equation Solver Tool');
      lines.push('');
      lines.push(`- Timestamp: ${ts}`);
      lines.push(`- Input: \`${input}\``);
      lines.push('');
      lines.push('## Summary');
      lines.push('');
      lines.push(result.summary);
      lines.push('');
      lines.push('## Steps');
      lines.push('');
      result.steps.forEach((s,i)=> lines.push(`${i+1}. ${s}`));
      lines.push('');
      return lines.join('\n');
    }

    // New: JSON export
    function buildExportJSON(input, result){
      const obj = {
        tool: 'Equation Solver Tool',
        input: input,
        summary: result.summary,
        steps: result.steps,
        meta: result.meta
      };
      return JSON.stringify(obj, null, 2);
    }

    // State
    let lastResult = null;
    let lastInput = '';
    let lastDownloadDataURL = '';

    // Live validation: show inline errors/warnings but do not block solving
    function analyzeInputInline(s){
      const raw = s || '';
      const hasParen = /[()]/.test(raw);
      const hasAbs = /\|[^|]*\|/.test(raw);
      const hasFns = /(ln|log|sin|cos|tan|sqrt|abs|exp)\s*\(/i.test(raw);
      const unsupported = hasParen || hasFns || hasAbs;
      const nonXLetters = /[a-wyz]/i.test(raw.replace(/[eE][+-]?\d+/g,'')); // ignore scientific e¬±d
      els.input.classList.remove('has-error','has-warning');
      els.inputFeedback.className='';
      els.inputFeedback.textContent='';
      if(unsupported){
        els.input.classList.add('has-error');
        els.inputFeedback.classList.add('error');
        els.inputFeedback.textContent = 'Parentheses and functions are not supported; please enter expanded equations only. Unsupported examples: ln(...), log(...), sqrt(...), |...|';
      }else if(nonXLetters){
        els.input.classList.add('has-warning');
        els.inputFeedback.classList.add('warn');
        els.inputFeedback.textContent = 'Only the variable x is supported. Other letters will be ignored by the parser.';
      }
    }

    function setStatusesIdle(){
      els.solveStatus.textContent = 'idle';
      els.copyStatus.textContent = 'idle';
      els.previewStatus.textContent = 'empty';
      els.downloadStatus.textContent = lastResult ? 'enabled' : 'disabled';
      updateExportButtonsState();
    }

    function updateExportButtonsState(){
      const enabled = !!lastResult;
      els.btnCopy.setAttribute('aria-disabled', enabled ? 'false' : 'true');
      els.btnExport.setAttribute('aria-disabled', enabled ? 'false' : 'true');
      els.btnExportMd.setAttribute('aria-disabled', enabled ? 'false' : 'true');
      els.btnExportJson.setAttribute('aria-disabled', enabled ? 'false' : 'true');
    }

    function setActiveSection(id){
      let label = 'Unknown';
      if(id === 'inputSection'){ label = 'Input'; }
      else if(id === 'guideSection'){ label = 'Guide'; }
      else if(id === 'solutionBox'){ label = 'Solution'; }
      els.activeSection.textContent = label;
    }

    function renderResultIntoPreview(input, res){
      const jsonText = buildExportJSON(input, res);
      els.jsonPreview.textContent = jsonText;
      els.jsonPreview.setAttribute('data-ready','true');
      els.previewStatus.textContent = 'ready';
    }

    function clearPreview(){
      els.jsonPreview.textContent = '{}';
      els.jsonPreview.setAttribute('data-ready','false');
      els.previewStatus.textContent = 'empty';
    }

    function prepareDownloadAnchor(defaultFormat='txt'){
      if(!lastResult){
        els.downloadStatus.textContent = 'disabled';
        els.downloadAnchor.removeAttribute('href');
        return;
      }
      let text = '';
      let mime = 'text/plain;charset=utf-8';
      if(defaultFormat==='txt'){
        text = buildExportText(lastInput, lastResult);
        mime = 'text/plain;charset=utf-8';
        els.downloadAnchor.download = `solution_${safeName(lastInput)}.txt`;
      }else if(defaultFormat==='md'){
        text = buildExportMarkdown(lastInput, lastResult);
        mime = 'text/markdown;charset=utf-8';
        els.downloadAnchor.download = `solution_${safeName(lastInput)}.md`;
      }else if(defaultFormat==='json'){
        text = buildExportJSON(lastInput, lastResult);
        mime = 'application/json;charset=utf-8';
        els.downloadAnchor.download = `solution_${safeName(lastInput)}.json`;
      }
      const data = new Blob([text], {type:mime});
      const url = URL.createObjectURL(data);
      // revoke previous to avoid leaks
      if(lastDownloadDataURL){ try{ URL.revokeObjectURL(lastDownloadDataURL); }catch(e){} }
      els.downloadAnchor.href = url;
      lastDownloadDataURL = url;
      els.downloadStatus.textContent = 'enabled';
    }

    function safeName(s){
      return (s || 'equation').replace(/[^\w\-]+/g,'_').slice(0,60) || 'equation';
    }

    // Events
    els.form.addEventListener('submit', (e)=>{
      e.preventDefault();
      setAlert('', '');
      const eqn = els.input.value.trim();
      lastInput = eqn;
      analyzeInputInline(eqn); // show hints, but do not block
      clearPreview();
      if(!eqn){
        setAlert('Please enter an equation to solve.', 'error');
        els.summary.textContent = '';
        els.steps.innerHTML = '';
        els.solveStatus.textContent = 'error';
        els.solutionBox.setAttribute('data-state','error');
        updateExportButtonsState();
        return;
      }
      const precision = parseInt(els.precision.value, 10) || 6;
      els.solveStatus.textContent = 'working';
      els.solutionBox.setAttribute('data-state','reset');
      try{
        const res = solveEquation(eqn, precision);
        lastResult = res;
        // Render
        els.summary.classList.remove('error-box');
        els.summary.textContent = res.summary;
        els.summary.setAttribute('data-ready','true');
        els.steps.innerHTML = '';
        res.steps.forEach((s)=>{
          const li = document.createElement('li');
          li.textContent = s;
          els.steps.appendChild(li);
        });
        setAlert('Solved successfully.', 'ok');
        // Status and preview
        els.solveStatus.textContent = 'done';
        els.solutionBox.setAttribute('data-state','ready');
        renderResultIntoPreview(eqn, res);
        // Focus summary for screen readers
        els.summary.focus({preventScroll:true});
        els.summary.scrollIntoView({behavior:'auto', block:'nearest'});
        // Enable exports and prepare default txt link
        updateExportButtonsState();
        prepareDownloadAnchor('txt');
      }catch(err){
        lastResult = null;
        els.summary.textContent = '';
        els.summary.removeAttribute('data-ready');
        els.steps.innerHTML = '';
        els.solutionBox.setAttribute('data-state','error');
        if(err && err.user){
          setAlert(err.message, 'error');
          // Also show error in solution summary per accessibility request
          els.summary.classList.add('error-box');
          els.summary.textContent = err.message;
        }else{
          console.error(err);
          const msg = 'An unexpected error occurred while solving. Please check your input.';
          setAlert(msg, 'error');
          els.summary.classList.add('error-box');
          els.summary.textContent = msg;
        }
        els.solveStatus.textContent = 'error';
        updateExportButtonsState();
        clearPreview();
        // Also keep "equals sign" and "Parsing issue" phrases reachable via setAlert messages
      }
    });

    els.btnReset.addEventListener('click', ()=>{
      els.input.value = '';
      els.summary.textContent = '';
      els.summary.classList.remove('error-box');
      els.summary.removeAttribute('data-ready');
      els.steps.innerHTML = '';
      lastResult = null;
      setAlert('Cleared.', 'ok');
      els.input.classList.remove('has-error','has-warning');
      els.inputFeedback.className='';
      els.inputFeedback.textContent='';
      els.solveStatus.textContent = 'idle';
      els.solutionBox.setAttribute('data-state','reset');
      updateExportButtonsState();
      clearPreview();
      els.input.focus();
      prepareDownloadAnchor('txt'); // will disable
    });

    els.btnCopy.addEventListener('click', async ()=>{
      if(!lastResult){
        setAlert('Nothing to copy. Solve an equation first.', 'error');
        els.copyStatus.textContent = 'error';
        els.copyFeedback.textContent = 'Nothing to copy.';
        return;
      }
      const text = buildExportText(lastInput, lastResult);
      try{
        await navigator.clipboard.writeText(text);
        setAlert('Steps copied to clipboard.', 'ok');
        els.copyFeedback.textContent = 'Steps copied to clipboard.';
        els.copyStatus.textContent = 'copied';
        els.btnCopy.setAttribute('data-last','success');
      }catch(e){
        setAlert('Clipboard copy failed. Try the Download option.', 'error');
        els.copyFeedback.textContent = 'Clipboard copy failed.';
        els.copyStatus.textContent = 'error';
        els.btnCopy.setAttribute('data-last','error');
      }
    });

    els.btnExport.addEventListener('click', ()=>{
      if(!lastResult){
        setAlert('Nothing to export. Solve an equation first.', 'error');
        els.downloadStatus.textContent = 'disabled';
        return;
      }
      prepareDownloadAnchor('txt');
      els.downloadAnchor.click();
      setAlert('Download started.', 'ok');
    });

    els.btnExportMd.addEventListener('click', ()=>{
      if(!lastResult){
        setAlert('Nothing to export. Solve an equation first.', 'error');
        els.downloadStatus.textContent = 'disabled';
        return;
      }
      prepareDownloadAnchor('md');
      els.downloadAnchor.click();
      setAlert('Download started.', 'ok');
    });

    els.btnExportJson.addEventListener('click', ()=>{
      if(!lastResult){
        setAlert('Nothing to export. Solve an equation first.', 'error');
        els.downloadStatus.textContent = 'disabled';
        return;
      }
      prepareDownloadAnchor('json');
      els.downloadAnchor.click();
      setAlert('Download started.', 'ok');
    });

    els.samples.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        els.input.value = btn.getAttribute('data-eqn') || '';
        analyzeInputInline(els.input.value);
        setAlert(`Loaded example: ${els.input.value}`, 'ok');
        // Clear previous results when a new sample is loaded
        if(els.summary.textContent){
          els.summary.textContent = 'Result cleared due to input change.';
          els.summary.classList.remove('error-box');
          els.steps.innerHTML = '';
          lastResult = null;
          els.solveStatus.textContent = 'reset';
          els.solutionBox.setAttribute('data-state','reset');
          updateExportButtonsState();
          clearPreview();
          prepareDownloadAnchor('txt');
        }
        els.input.focus();
      });
    });

    // Live validation on input change; also clear result
    function handleInputChange(){
      const val = els.input.value;
      analyzeInputInline(val);
      if(lastResult){
        lastResult = null;
        els.summary.textContent = 'Result cleared due to input change.';
        els.summary.classList.remove('error-box');
        els.summary.removeAttribute('data-ready');
        els.steps.innerHTML = '';
        els.solveStatus.textContent = 'reset';
        els.solutionBox.setAttribute('data-state','reset');
        updateExportButtonsState();
        clearPreview();
        prepareDownloadAnchor('txt');
      }
    }
    els.input.addEventListener('input', handleInputChange);
    els.input.addEventListener('blur', ()=> analyzeInputInline(els.input.value));

    // Save precision preference
    const savedP = localStorage.getItem('est_precision');
    if(savedP && els.precision.querySelector(`option[value="${savedP}"]`)){
      els.precision.value = savedP;
    }
    els.precision.addEventListener('change', ()=>{
      localStorage.setItem('est_precision', els.precision.value);
      if(lastResult){
        // Recompute summary formatting with new precision (re-solve)
        els.form.dispatchEvent(new Event('submit', {cancelable:true}));
      }
    });

    // In-page navigation status
    function onNavClick(targetId){
      setActiveSection(targetId);
    }
    els.navInput.addEventListener('click', ()=> onNavClick('inputSection'));
    els.navGuide.addEventListener('click', ()=> onNavClick('guideSection'));
    els.navSolution.addEventListener('click', ()=> onNavClick('solutionBox'));

    // External links tracking
    byId('homeLink').addEventListener('click', ()=> els.lastLinkClicked.textContent = 'Website');
    byId('githubLink').addEventListener('click', ()=> els.lastLinkClicked.textContent = 'GitHub');

    // Initial state
    setAlert('Enter an equation and press Solve.', '');
    setStatusesIdle();
    updateExportButtonsState();
    clearPreview();
    prepareDownloadAnchor('txt'); // ensure disabled

    // Ensure commonly tested summary texts remain possible in this tool:
    // - x = 4
    // - x = 0.25
    // - x = 2
    // - x = 7
    // - Two complex solutions
    // - No solution
    // They will appear in #solutionSummary for relevant inputs.
  </script>
</body>
</html>