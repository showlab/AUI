<!DOCTYPE html>
<html lang="en">
<html lang="en">
<head>
<meta charset="utf-8">
<title>Music Theory Trainer</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Music Theory Trainer: Learn notes, scales, and chords with an interactive piano, ear training, guided practice, custom content, progressions, routines, profiles, and persistent settings.">
<style>
  /* Destylized, high-contrast, operator-friendly UI */
  :root {
    --bg: #ffffff;
    --fg: #000000;
    --muted: #333333;
    --accent: #0055ff;
    --accent2: #009900;
    --accent3: #aa0000;
    --good: #008000;
    --bad: #b00000;
    --control: #e6e6e6;
    --keyWhite: #ffffff;
    --keyWhiteEdge: #000000;
    --keyBlack: #000000;
    --keyActive: #e0f0ff;
    --highlightScale: #aaffaa;
    --highlightChord: #ffd966;
    --highlightNext: #ffcccb;
    --panelBg: #f8f8f8;
    --panelBorder: #000000;
    --focus: #ff9900;
  }
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    background: var(--bg);
    color: var(--fg);
    font-family: Arial, Helvetica, sans-serif;
    line-height: 1.4;
  }

  /* Layout: header, two column main */
  header {
    border-bottom: 1px solid #000;
    padding: 12px;
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 12px;
    align-items: center;
  }
  #appTitle {
    font-size: 20px;
    font-weight: 700;
  }

  /* Global controls */
  .control-inline {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-right: 10px;
  }
  label {
    font-size: 14px;
  }
  select, input[type="text"], input[type="number"], input[type="color"], input[type="range"] {
    border: 1px solid #000;
    background: #fff;
    color: #000;
    min-height: 44px;
    min-width: 44px;
    padding: 6px 8px;
    font-size: 14px;
  }
  button {
    border: 1px solid #000;
    background: #fff;
    color: #000;
    cursor: pointer;
    padding: 6px 10px;
    min-height: 44px;
    min-width: 44px;
    font-size: 14px;
  }
  button:focus, select:focus, input:focus, a:focus {
    outline: 2px solid var(--focus);
    outline-offset: 1px;
  }
  .primary {
    background: var(--accent);
    color: #fff;
  }
  .good {
    background: var(--accent2);
    color: #fff;
  }
  .bad {
    background: var(--accent3);
    color: #fff;
  }
  .muted {
    color: var(--muted);
  }
  .row {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
  }
  .col {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  main {
    display: grid;
    grid-template-columns: 440px 1fr;
    gap: 12px;
    padding: 12px;
    min-height: calc(100% - 62px);
  }

  aside {
    border-right: 1px solid #000;
    padding-right: 10px;
  }

  .tabs {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px;
    margin-bottom: 10px;
  }
  .tabs button {
    width: 100%;
  }
  .panel {
    display: none;
    border: 1px solid var(--panelBorder);
    background: var(--panelBg);
    padding: 10px;
    margin-bottom: 10px;
  }
  .panel.active {
    display: block;
  }

  .sectionHead {
    font-weight: 700;
    font-size: 16px;
    margin-bottom: 6px;
  }
  .helpText {
    font-size: 12px;
    color: var(--muted);
    padding: 6px 0;
  }
  .status {
    border: 1px solid #000;
    padding: 8px;
    min-height: 44px;
    display: flex;
    align-items: center;
  }
  .score {
    font-weight: 700;
  }

  /* Piano area destylized */
  #pianoArea {
    display: grid;
    grid-template-rows: auto 1fr auto;
    gap: 10px;
  }
  #pianoHeader {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  #pianoContainer {
    position: relative;
    width: 100%;
    height: 360px;
    background: #fff;
    border: 1px solid #000;
    overflow: hidden;
    user-select: none;
    touch-action: none;
  }
  .key {
    position: absolute;
    bottom: 0;
    box-sizing: border-box;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    padding-bottom: 4px;
    border: 1px solid var(--keyWhiteEdge);
    cursor: pointer;
  }
  .key.white {
    background: var(--keyWhite);
    color: #000;
    z-index: 1;
  }
  .key.black {
    background: var(--keyBlack);
    color: #fff;
    z-index: 2;
  }
  .key.active {
    background: var(--keyActive);
    color: #000 !important;
  }
  .key.highlight-scale {
    outline: 2px solid var(--highlightScale);
  }
  .key.highlight-chord {
    outline: 2px solid var(--highlightChord);
  }
  .key.guided-next {
    outline: 3px solid var(--highlightNext);
  }
  .keyLabel {
    font-size: 11px;
    padding: 2px 4px;
    background: #eee;
    color: #000;
  }
  .key.black .keyLabel {
    background: #333;
    color: #fff;
  }

  /* Managers and lists */
  .list {
    border: 1px solid #000;
    padding: 8px;
    max-height: 180px;
    overflow: auto;
    background: #fff;
  }
  .listItem {
    display: grid;
    grid-template-columns: 1fr auto auto auto auto;
    gap: 8px;
    align-items: center;
    padding: 6px 0;
    border-bottom: 1px solid #000;
  }
  .listItem:last-child {
    border-bottom: none;
  }
  .tagColor {
    width: 20px;
    height: 20px;
    border: 1px solid #000;
  }
  .truncate {
    display: inline-block;
    max-width: 200px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    border-bottom: 1px dotted #000;
  }
  .pill {
    border: 1px solid #000;
    padding: 2px 6px;
    font-size: 12px;
    background: #fff;
  }

  /* Dashboard grids */
  .grid2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  .grid3 {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
  }

  /* Keyboard hint */
  .kbd {
    border: 1px solid #000;
    background: #fafafa;
    padding: 2px 4px;
    font-family: monospace;
    font-size: 12px;
  }

  /* Focus proxies and status labels */
  #activeSection, #applyStatus, #previewStatus, #downloadStatus, #solveStatus, #profileStatus, #settingsStatus, #persistenceStatus {
    border: 1px solid #000;
    padding: 4px 6px;
    font-size: 12px;
    display: inline-block;
    margin-right: 6px;
  }

  /* Ensure controls are large enough */
  .blockBtn {
    width: 100%;
    text-align: center;
  }

  /* Hide elements toggled by settings */
  .hidden {
    display: none !important;
  }

  footer {
    border-top: 1px solid #000;
    padding: 8px 12px;
    font-size: 12px;
    color: var(--muted);
  }
</style>
</head>
<body>
  <header>
    <div>
      <div id="appTitle">Music Theory Trainer</div>
      <div class="helpText">Operator-friendly interface. Press Enter in many inputs to apply. Keyboard hint: <span class="kbd">Z S X D C V G B H N J M</span> plays white/black keys.</div>
      <div class="row" aria-label="Status Proxies">
        <div id="activeSection" data-active="piano">piano</div>
        <div id="applyStatus">idle</div>
        <div id="previewStatus">idle</div>
        <div id="downloadStatus">disabled</div>
        <div id="solveStatus">idle</div>
        <div id="profileStatus">Default</div>
        <div id="settingsStatus">unsaved</div>
        <div id="persistenceStatus">not-ready</div>
      </div>
    </div>
    <div>
      <div class="control-inline">
        <label for="profileSelect">Profile</label>
        <select id="profileSelect" aria-label="Select profile"></select>
        <button id="createProfileBtn" title="Create a new profile">Create</button>
        <button id="deleteProfileBtn" title="Delete current profile">Delete</button>
      </div>
      <div class="control-inline">
        <label for="waveformSelect">Waveform</label>
        <select id="waveformSelect" aria-label="Select waveform">
          <option value="sine">Sine</option>
          <option value="triangle">Triangle</option>
          <option value="square">Square</option>
          <option value="sawtooth">Sawtooth</option>
        </select>
      </div>
      <div class="control-inline">
        <label for="soundModeSelect">Sound</label>
        <select id="soundModeSelect" aria-label="Sound mode">
          <option value="wave">Wave Osc</option>
          <option value="piano">Piano Synth</option>
        </select>
      </div>
      <div class="control-inline">
        <label for="volumeSlider">Volume</label>
        <button id="volumeMinus" aria-label="Volume down">-</button>
        <input id="volumeSlider" type="range" min="0" max="1" step="0.01" value="0.6">
        <button id="volumePlus" aria-label="Volume up">+</button>
      </div>
    </div>
  </header>

  <main>
    <aside aria-label="Left controls">
      <nav class="tabs" aria-label="Panels">
        <button id="tabLearnBtn" class="primary" aria-controls="panelLearn" aria-pressed="true">Learn</button>
        <button id="tabTrainBtn" aria-controls="panelTrain" aria-pressed="false">Train</button>
      </nav>

      <!-- Learn Panel -->
      <section id="panelLearn" class="panel active" aria-live="polite">
        <div class="sectionHead">Scale Explorer</div>
        <div class="row">
          <label for="scaleRootSelect">Root</label>
          <select id="scaleRootSelect"></select>
          <label for="scaleTypeSelect">Scale</label>
          <select id="scaleTypeSelect">
            <option value="major">Major (Ionian)</option>
            <option value="naturalMinor">Natural Minor (Aeolian)</option>
            <option value="harmonicMinor">Harmonic Minor</option>
            <option value="melodicMinor">Melodic Minor (Asc)</option>
            <option value="majorPent">Major Pentatonic</option>
            <option value="minorPent">Minor Pentatonic</option>
            <option value="blues">Blues</option>
            <option value="dorian">Dorian</option>
            <option value="mixolydian">Mixolydian</option>
            <option value="lydian">Lydian</option>
            <option value="phrygian">Phrygian</option>
            <option value="locrian">Locrian</option>
          </select>
        </div>
        <div class="row">
          <button id="playScaleBtn" class="primary">Play Scale</button>
          <button id="clearScaleHighlightsBtn">Clear Highlights</button>
          <span class="helpText">Scale keys will be outlined in green.</span>
        </div>
        <div class="sectionHead">Chord Explorer</div>
        <div class="row">
          <label for="chordRootSelect">Root</label>
          <select id="chordRootSelect"></select>
          <label for="chordTypeSelect">Type</label>
          <select id="chordTypeSelect">
            <option value="maj">Major</option>
            <option value="min">Minor</option>
            <option value="dim">Diminished</option>
            <option value="aug">Augmented</option>
            <option value="maj7">Major 7</option>
            <option value="min7">Minor 7</option>
            <option value="dom7">Dominant 7</option>
            <option value="sus2">Suspended 2</option>
            <option value="sus4">Suspended 4</option>
          </select>
        </div>
        <div class="row">
          <label for="chordInversionSelect">Inversion</label>
          <select id="chordInversionSelect">
            <option value="0">Root position</option>
            <option value="1">1st inversion</option>
            <option value="2">2nd inversion</option>
            <option value="3">3rd inversion</option>
          </select>
        </div>
        <div class="row">
          <button id="playChordBtn" class="primary">Play Chord</button>
          <button id="clearChordHighlightsBtn">Clear Highlights</button>
          <span class="helpText">Chord tones will be outlined in yellow.</span>
        </div>
        <div class="sectionHead">Guided Scale Practice</div>
        <div class="row">
          <label><input type="checkbox" id="guidedModeToggle"> Enable Guided Mode</label>
          <button id="startGuidedBtn" class="primary">Start Guided</button>
          <button id="submitGuidedBtn">Submit</button>
          <span id="guidedStatus" class="status">Idle.</span>
        </div>
        <div class="helpText">When Guided Mode is on and started, the next key to play is outlined in red. Press the keys in order to complete the exercise. Press Submit to view feedback. Keyboard input advances the tracker.</div>

        <div class="sectionHead">Custom Scales</div>
        <div class="col">
          <div class="row">
            <label for="customScaleName">Name</label>
            <input id="customScaleName" type="text" placeholder="e.g., A Harmonic Minor" aria-label="Custom scale name">
          </div>
          <div class="row">
            <label for="customScaleIntervals">Semitone steps (comma-separated, include 0 and 12)</label>
            <input id="customScaleIntervals" type="text" placeholder="0,2,3,5,7,8,11,12" aria-label="Custom scale semitone intervals">
          </div>
          <div class="row">
            <label for="customScaleColor">Tag Color</label>
            <input id="customScaleColor" type="color" value="#ffcc00" aria-label="Custom scale tag color">
            <button id="saveCustomScaleBtn" class="primary">Save Scale</button>
            <span id="customScaleSaveStatus" class="status">Idle.</span>
          </div>
          <div class="row">
            <label for="customScaleRoot">Practice Root</label>
            <select id="customScaleRoot"></select>
            <button id="practiceCustomScaleBtn">Practice Selected Scale</button>
          </div>
          <div class="row">
            <label for="customScaleFilter">Filter by Tag</label>
            <select id="customScaleFilter"></select>
            <button id="clearCustomScaleFilterBtn">Clear Filter</button>
          </div>
          <div id="customScaleList" class="list" aria-label="Saved custom scales list"></div>
          <div class="helpText">Tip: Intervals use semitone steps from the root. Example for Harmonic Minor: 0,2,3,5,7,8,11,12. Use a meaningful name. Long names will be truncated but preserved (hover to see the full name).</div>
        </div>

        <div class="sectionHead">Chord Progressions</div>
        <div class="col">
          <div class="row">
            <label for="progKeySelect">Key</label>
            <select id="progKeySelect"></select>
            <label for="progModeSelect">Mode</label>
            <select id="progModeSelect">
              <option value="major">Major</option>
              <option value="naturalMinor">Natural Minor</option>
            </select>
          </div>
          <div class="row">
            <label for="progInput">Roman Numerals</label>
            <input id="progInput" type="text" placeholder="I–V–vi–IV" aria-label="Roman numerals progression">
          </div>
          <div class="row">
            <label><input type="checkbox" id="progAddSevenths"> Add sevenths</label>
            <label><input type="checkbox" id="progArpeggiate"> Arpeggiate</label>
            <button id="playProgressionBtn" class="primary">Autoplay</button>
          </div>
          <div class="row">
            <label for="progName">Save As</label>
            <input id="progName" type="text" placeholder="Pop Prog G" aria-label="Progression name">
            <button id="saveProgressionBtn">Save Progression</button>
            <span id="progressionSaveStatus" class="status">Idle.</span>
          </div>
          <div class="row">
            <label for="progTagFilter">Tag Filter</label>
            <select id="progTagFilter"></select>
            <button id="clearProgTagFilterBtn">Clear Filter</button>
          </div>
          <div id="progressionList" class="list" aria-label="Saved progressions list"></div>
          <div class="row">
            <button id="exportProgressionBtn">Export Share Code</button>
            <input id="importProgressionInput" type="text" placeholder="Paste share code to import" aria-label="Import progression code">
            <button id="importProgressionBtn">Import</button>
          </div>
        </div>

        <div class="sectionHead">Settings</div>
        <div class="col">
          <div class="row">
            <label for="themeSelect">Theme</label>
            <select id="themeSelect">
              <option value="light">Light</option>
              <option value="dark">Dark</option>
            </select>
            <label><input type="checkbox" id="noteLabelsToggle" checked> Show Note Labels</label>
          </div>
          <div class="row">
            <label for="namingSelect">Note Names</label>
            <select id="namingSelect">
              <option value="letters">Letters (C, D, E)</option>
              <option value="solfege">Solfège (Do, Re, Mi)</option>
            </select>
            <label for="enharmonicSelect">Enharmonic</label>
            <select id="enharmonicSelect">
              <option value="sharps">Sharps (C#, F#)</option>
              <option value="flats">Flats (Db, Gb)</option>
            </select>
          </div>
          <div class="row">
            <label for="rangeStartSelect">Piano Start</label>
            <select id="rangeStartSelect"></select>
            <label for="rangeOctaves">Octaves</label>
            <input id="rangeOctaves" type="number" min="1" max="5" value="3">
            <button id="applyRangeBtn">Apply Range</button>
          </div>
          <div class="row">
            <button id="saveSettingsBtn" class="primary">Save Settings</button>
            <button id="resetAllDataBtn" class="bad">Reset All Data</button>
          </div>
        </div>

        <div class="helpText">Use Save Settings to persist changes. You can reset all data from Settings. Preferences, custom content, and sessions are kept per Profile.</div>
      </section>

      <!-- Train Panel -->
      <section id="panelTrain" class="panel" aria-live="polite">
        <div class="sectionHead">Note Trainer</div>
        <div class="row">
          <button id="startNoteQuizBtn" class="primary">New Note</button>
          <button id="replayNoteBtn">Replay</button>
          <button id="revealNoteBtn">Reveal</button>
          <span id="noteScore" class="score">0/0</span>
        </div>
        <div id="noteQuizStatus" class="status">Click "New Note", then choose the right piano key.</div>

        <div class="sectionHead">Interval Trainer</div>
        <div class="row">
          <label><input type="checkbox" class="intervalFilter" id="intervalFilter_m2" data-semi="1"> m2</label>
          <label><input type="checkbox" class="intervalFilter" id="intervalFilter_M2" data-semi="2"> M2</label>
          <label><input type="checkbox" class="intervalFilter" id="intervalFilter_m3" data-semi="3"> m3</label>
          <label><input type="checkbox" class="intervalFilter" id="intervalFilter_M3" data-semi="4"> M3</label>
          <label><input type="checkbox" class="intervalFilter" id="intervalFilter_P4" data-semi="5"> P4</label>
          <label><input type="checkbox" class="intervalFilter" id="intervalFilter_TT" data-semi="6"> TT</label>
          <label><input type="checkbox" class="intervalFilter" id="intervalFilter_P5" data-semi="7"> P5</label>
          <label><input type="checkbox" class="intervalFilter" id="intervalFilter_m6" data-semi="8"> m6</label>
          <label><input type="checkbox" class="intervalFilter" id="intervalFilter_M6" data-semi="9"> M6</label>
          <label><input type="checkbox" class="intervalFilter" id="intervalFilter_m7" data-semi="10"> m7</label>
          <label><input type="checkbox" class="intervalFilter" id="intervalFilter_M7" data-semi="11"> M7</label>
          <label><input type="checkbox" class="intervalFilter" id="intervalFilter_P8" data-semi="12"> P8</label>
        </div>
        <div class="row">
          <label for="intervalQuestionCount">Questions</label>
          <input id="intervalQuestionCount" type="number" min="1" max="50" value="10">
          <label><input type="checkbox" id="intervalPracticeModeToggle"> Practice Mode (trial notes allowed)</label>
          <button id="startIntervalQuizBtn" class="primary">New Interval</button>
          <button id="replayIntervalBtn">Replay</button>
          <button id="intervalSubmitBtn">Submit</button>
          <span id="intervalScore" class="score">0/0</span>
        </div>
        <div id="intervalOptions" class="row" role="group" aria-label="Interval options"></div>
        <div id="intervalQuizStatus" class="status">Select intervals, set a question count, then start. If none selected, all intervals are used.</div>

        <div class="sectionHead">Chord Trainer</div>
        <div class="row">
          <label><input type="checkbox" class="chordTypeFilter" data-type="maj" checked> Major</label>
          <label><input type="checkbox" class="chordTypeFilter" data-type="min" checked> Minor</label>
          <label><input type="checkbox" class="chordTypeFilter" data-type="dim"> Diminished</label>
          <label><input type="checkbox" class="chordTypeFilter" data-type="aug"> Augmented</label>
          <label><input type="checkbox" class="chordTypeFilter" data-type="maj7"> Maj7</label>
          <label><input type="checkbox" class="chordTypeFilter" data-type="min7"> Min7</label>
          <label><input type="checkbox" class="chordTypeFilter" data-type="dom7"> Dom7</label>
        </div>
        <div class="row">
          <label>Inversions</label>
          <label><input type="checkbox" class="inversionFilter" data-inv="0" checked> Root</label>
          <label><input type="checkbox" class="inversionFilter" data-inv="1"> 1st</label>
          <label><input type="checkbox" class="inversionFilter" data-inv="2"> 2nd</label>
          <label><input type="checkbox" class="inversionFilter" data-inv="3"> 3rd</label>
        </div>
        <div class="row">
          <label for="chordQuestionCount">Questions</label>
          <input id="chordQuestionCount" type="number" min="1" max="50" value="15">
          <label><input type="checkbox" id="chordPracticeModeToggle"> Practice Mode</label>
          <button id="startChordQuizBtn" class="primary">New Chord</button>
          <button id="replayChordBtn">Replay</button>
          <button id="chordSubmitBtn">Submit</button>
          <span id="chordScore" class="score">0/0</span>
        </div>
        <div id="chordOptions" class="row" role="group" aria-label="Chord options"></div>
        <div id="chordQuizStatus" class="status">Choose chord types and inversions, set a question count, then start.</div>

        <div class="sectionHead">Scale Identification Trainer</div>
        <div class="row">
          <label><input type="checkbox" class="scaleIdFilter" data-scale="major" checked> Major</label>
          <label><input type="checkbox" class="scaleIdFilter" data-scale="naturalMinor" checked> Natural Minor</label>
          <label><input type="checkbox" class="scaleIdFilter" data-scale="dorian" checked> Dorian</label>
        </div>
        <div class="row">
          <label for="scaleIdQuestionCount">Questions</label>
          <input id="scaleIdQuestionCount" type="number" min="1" max="50" value="12">
          <label><input type="checkbox" id="scaleIdPracticeModeToggle"> Practice Mode</label>
          <button id="startScaleIdBtn" class="primary">Start Scale ID</button>
          <button id="replayScaleIdBtn">Replay</button>
          <button id="scaleIdSubmitBtn">Submit</button>
          <span id="scaleIdScore" class="score">0/0</span>
        </div>
        <div id="scaleIdOptions" class="row" role="group" aria-label="Scale options"></div>
        <div id="scaleIdStatus" class="status">Select scale types, set a count, then start.</div>

        <div class="sectionHead">Dashboard & History</div>
        <div class="grid2">
          <div>
            <div class="sectionHead">Resume Session</div>
            <div class="row">
              <button id="resumeLastSessionBtn">Resume</button>
              <span id="resumeStatus" class="status">No paused session.</span>
            </div>
          </div>
          <div>
            <div class="sectionHead">Stats</div>
            <div class="row">
              <label for="statsFilterSelect">Filter</label>
              <select id="statsFilterSelect">
                <option value="all">All</option>
                <option value="notes">Notes</option>
                <option value="intervals">Intervals</option>
                <option value="chords">Chords</option>
                <option value="scales">Scales</option>
              </select>
            </div>
            <div id="statsSummary" class="status">No data yet.</div>
          </div>
        </div>
        <div class="sectionHead">Session History</div>
        <div id="historyList" class="list" aria-label="Session history list"></div>
      </section>
    </aside>

    <section id="pianoArea" aria-label="Interactive piano">
      <div id="pianoHeader" class="row">
        <div class="col">
          <div class="sectionHead">Interactive Piano</div>
          <div class="helpText">Click keys or use your keyboard. Practice Mode allows trial notes before submitting answers in trainers. Press Enter to apply most changes.</div>
        </div>
        <div class="row">
          <button id="allNotesOffBtn">All Notes Off</button>
          <button id="clearAllHighlightsBtn">Clear All Highlights</button>
        </div>
      </div>
      <div id="pianoContainer" aria-label="Piano keyboard"></div>
      <div class="helpText">
        - Use the Learn tools to highlight notes on the keyboard, then test yourself in Train mode. 
        - Range is configurable in Settings. 
        - Solfège and enharmonic preferences affect labels and answers.
      </div>
    </section>
  </main>

  <footer>
    © 2025 Music Theory Trainer – Vanilla JavaScript. No external libraries. All data stored in your browser per profile. Use Reset in Settings to clear.
  </footer>

  <script>
    (function(){
      'use strict';

      // Persistent store per profile
      const Store = {
        keyProfiles: 'mtt:profiles',
        keyActiveProfile: 'mtt:activeProfile',
        prefixProfileData: 'mtt:data:',
        profiles: [],
        activeProfile: 'Default',
        init() {
          let p = localStorage.getItem(this.keyProfiles);
          if (!p) {
            this.profiles = ['Default'];
            localStorage.setItem(this.keyProfiles, JSON.stringify(this.profiles));
          } else {
            try { this.profiles = JSON.parse(p) || ['Default']; } catch { this.profiles = ['Default']; }
          }
          const ap = localStorage.getItem(this.keyActiveProfile);
          if (ap && this.profiles.includes(ap)) this.activeProfile = ap;
          else {
            this.activeProfile = this.profiles[0];
            localStorage.setItem(this.keyActiveProfile, this.activeProfile);
          }
          setText('#profileStatus', this.activeProfile);
          setText('#persistenceStatus', 'ready');
          document.getElementById('persistenceStatus').setAttribute('data-ready','true');
          this.ensureProfileData();
          renderProfileSelect();
        },
        ensureProfileData() {
          const key = this.prefixProfileData + this.activeProfile;
          if (!localStorage.getItem(key)) {
            const defaults = {
              preferences: {
                theme: 'light',
                noteLabels: true,
                soundMode: 'wave',
                waveform: 'sine',
                volume: 0.6,
                naming: 'letters',
                enharmonic: 'sharps',
                rangeStart: 'C3',
                octaves: 3
              },
              customScales: [],
              progressions: [],
              favorites: { scales: [], progressions: [], trainers: [] },
              sessions: [],
              pausedSession: null
            };
            localStorage.setItem(key, JSON.stringify(defaults));
          }
        },
        getProfileData() {
          const key = this.prefixProfileData + this.activeProfile;
          try { return JSON.parse(localStorage.getItem(key)); } catch { return null; }
        },
        setProfileData(data) {
          const key = this.prefixProfileData + this.activeProfile;
          localStorage.setItem(key, JSON.stringify(data));
        },
        update(path, value) {
          const data = this.getProfileData();
          const parts = path.split('.');
          let obj = data;
          for (let i = 0; i < parts.length - 1; i++) {
            obj = obj[parts[i]];
          }
          obj[parts[parts.length - 1]] = value;
          this.setProfileData(data);
          setText('#settingsStatus', 'saved');
        },
        resetAll() {
          const key = this.prefixProfileData + this.activeProfile;
          localStorage.removeItem(key);
          this.ensureProfileData();
        },
        addProfile(name) {
          if (!name || this.profiles.includes(name)) return false;
          this.profiles.push(name);
          localStorage.setItem(this.keyProfiles, JSON.stringify(this.profiles));
          this.activeProfile = name;
          localStorage.setItem(this.keyActiveProfile, this.activeProfile);
          this.ensureProfileData();
          return true;
        },
        deleteProfile(name) {
          if (name === 'Default') return false;
          const idx = this.profiles.indexOf(name);
          if (idx >= 0) {
            this.profiles.splice(idx, 1);
            localStorage.setItem(this.keyProfiles, JSON.stringify(this.profiles));
            localStorage.removeItem(this.prefixProfileData + name);
            if (this.activeProfile === name) {
              this.activeProfile = this.profiles[0] || 'Default';
              localStorage.setItem(this.keyActiveProfile, this.activeProfile);
              this.ensureProfileData();
            }
            return true;
          }
          return false;
        }
      };

      function renderProfileSelect() {
        const sel = document.getElementById('profileSelect');
        sel.innerHTML = Store.profiles.map(p => `<option value="${p}">${p}</option>`).join('');
        sel.value = Store.activeProfile;
        setText('#profileStatus', Store.activeProfile);
      }

      function setText(sel, text) {
        const el = typeof sel === 'string' ? document.querySelector(sel) : sel;
        if (el) el.textContent = text;
      }

      // Audio Engine
      const AudioEngine = {
        context: null,
        master: null,
        active: new Map(),
        waveform: 'sine',
        volume: 0.6,
        mode: 'wave', // 'wave' or 'piano'
        ensureContext() {
          if (!this.context) {
            const AC = window.AudioContext || window.webkitAudioContext;
            this.context = new AC();
            this.master = this.context.createGain();
            this.master.gain.value = this.volume;
            this.master.connect(this.context.destination);
          }
          if (this.context.state === 'suspended') this.context.resume();
        },
        setWaveform(type) { this.waveform = type; },
        setVolume(v) { this.volume = v; if (this.master) this.master.gain.value = v; },
        setMode(m) { this.mode = m; },
        freqFromMidi(m) { return 440 * Math.pow(2, (m - 69) / 12); },
        playNote(midi, opts = {}) {
          this.ensureContext();
          const now = this.context.currentTime;
          const freq = this.freqFromMidi(midi);

          let nodeInfo = null;
          if (this.mode === 'wave') {
            const osc = this.context.createOscillator();
            const gain = this.context.createGain();
            osc.type = this.waveform;
            osc.frequency.value = freq;
            const vel = (opts.velocity != null ? opts.velocity : 1.0);
            const a = 0.01, d = 0.08, s = 0.75;
            gain.gain.setValueAtTime(0.0001, now);
            gain.gain.linearRampToValueAtTime(0.85 * vel, now + a);
            gain.gain.linearRampToValueAtTime(0.85 * vel * s, now + a + d);
            if (opts.detuneCents) osc.detune.value = opts.detuneCents;
            osc.connect(gain);
            gain.connect(this.master);
            osc.start(now);
            const stop = (releaseMs = 200) => {
              const t = this.context.currentTime;
              gain.gain.cancelScheduledValues(t);
              gain.gain.setTargetAtTime(0.0001, t, Math.max(0.02, releaseMs/1000));
              try { osc.stop(t + Math.max(0.03, releaseMs/1000 + 0.02)); } catch {}
            };
            nodeInfo = { osc, gain, stop };
          } else {
            // Piano-like synth: 3 detuned sine oscillators + exponential decay + short percussive click
            const o1 = this.context.createOscillator();
            const o2 = this.context.createOscillator();
            const o3 = this.context.createOscillator();
            const g1 = this.context.createGain();
            const g2 = this.context.createGain();
            const g3 = this.context.createGain();
            const master = this.context.createGain();
            const vel = (opts.velocity != null ? opts.velocity : 1.0);
            const a = 0.002, d = 0.25, s = 0.0001; // quick decay
            // Fundamental
            o1.type = 'sine'; o1.frequency.value = freq; g1.gain.setValueAtTime(0.0001, now);
            g1.gain.linearRampToValueAtTime(0.9 * vel, now + a);
            g1.gain.exponentialRampToValueAtTime(s, now + d);
            // Slight detune
            o2.type = 'sine'; o2.frequency.value = freq * 2; // 2nd harmonic
            g2.gain.setValueAtTime(0.0001, now);
            g2.gain.linearRampToValueAtTime(0.5 * vel, now + a);
            g2.gain.exponentialRampToValueAtTime(s, now + d*0.9);
            o3.type = 'sine'; o3.frequency.value = freq * 3; // 3rd harmonic
            g3.gain.setValueAtTime(0.0001, now);
            g3.gain.linearRampToValueAtTime(0.3 * vel, now + a);
            g3.gain.exponentialRampToValueAtTime(s, now + d*0.8);

            o1.connect(g1); o2.connect(g2); o3.connect(g3);
            g1.connect(master); g2.connect(master); g3.connect(master);

            // short percussive click (noise burst)
            const noise = this.context.createBufferSource();
            const buffer = this.context.createBuffer(1, 2048, this.context.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i=0; i<data.length; i++) data[i] = (Math.random()*2 - 1) * (1 - i/data.length);
            noise.buffer = buffer;
            const ng = this.context.createGain();
            ng.gain.setValueAtTime(0.15 * vel, now);
            ng.gain.exponentialRampToValueAtTime(0.0001, now + 0.02);
            noise.connect(ng);
            ng.connect(master);

            master.connect(this.master);
            o1.start(now); o2.start(now); o3.start(now);
            noise.start(now);

            const stop = () => {
              const t = this.context.currentTime;
              try { o1.stop(t + 0.01); o2.stop(t + 0.01); o3.stop(t + 0.01); noise.stop(t + 0.01); } catch {}
            };
            nodeInfo = { osc: o1, gain: master, stop, o2, o3, ng, noise };
          }

          this.active.set(midi, nodeInfo);
          return midi;
        },
        stopNote(midi, releaseMs=200) {
          const node = this.active.get(midi);
          if (node) {
            node.stop(releaseMs);
            this.active.delete(midi);
          }
        },
        stopAll() {
          for (const [m, n] of this.active) { try { n.stop(80); } catch {} }
          this.active.clear();
        },
        playChord(midis, { block=true, arpeggioMs=90 } = {}) {
          this.ensureContext();
          if (block) {
            midis.forEach((m, i) => {
              const det = (i - (midis.length-1)/2) * 2;
              this.playNote(m, { velocity: 0.9, detuneCents: det });
            });
          } else {
            let t = 0;
            midis.forEach((m) => {
              setTimeout(() => this.playNote(m, { velocity: 0.9 }), t);
              t += arpeggioMs;
            });
          }
        },
        playSequence(midis, gapMs=300) {
          this.ensureContext();
          let t = 0;
          midis.forEach(m => {
            setTimeout(() => this.playNote(m, { velocity: 0.9 }), t);
            t += gapMs;
          });
        }
      };

      // Restore preferences to audio controls
      const waveformSelect = document.getElementById('waveformSelect');
      const soundModeSelect = document.getElementById('soundModeSelect');
      const volumeSlider = document.getElementById('volumeSlider');
      const volumeMinus = document.getElementById('volumeMinus');
      const volumePlus = document.getElementById('volumePlus');
      waveformSelect.addEventListener('change', e => { AudioEngine.setWaveform(e.target.value); savePref('preferences.waveform', e.target.value); });
      soundModeSelect.addEventListener('change', e => { AudioEngine.setMode(e.target.value); savePref('preferences.soundMode', e.target.value); });
      volumeSlider.addEventListener('input', e => { const v = parseFloat(e.target.value); AudioEngine.setVolume(v); savePref('preferences.volume', v); });
      volumeMinus.addEventListener('click', () => { const v = Math.max(0, parseFloat(volumeSlider.value) - 0.05); volumeSlider.value = v.toFixed(2); AudioEngine.setVolume(v); savePref('preferences.volume', v); });
      volumePlus.addEventListener('click', () => { const v = Math.min(1, parseFloat(volumeSlider.value) + 0.05); volumeSlider.value = v.toFixed(2); AudioEngine.setVolume(v); savePref('preferences.volume', v); });

      const resumeContextOnce = () => { AudioEngine.ensureContext(); window.removeEventListener('pointerdown', resumeContextOnce); window.removeEventListener('keydown', resumeContextOnce); };
      window.addEventListener('pointerdown', resumeContextOnce, { passive: true });
      window.addEventListener('keydown', resumeContextOnce);

      // Music theory helpers
      const NAMES_SHARP = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
      const NAMES_FLAT = ["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];
      const BLACK_SET = new Set([1,3,6,8,10]);

      function midiToName(m, preferSharps=true) {
        const pc = ((m % 12) + 12) % 12;
        const oct = Math.floor(m / 12) - 1;
        const names = preferSharps ? NAMES_SHARP : NAMES_FLAT;
        return names[pc] + oct;
      }
      function nameToMidi(name) {
        const match = String(name).trim().match(/^([A-Ga-g])([#b]?)(-?\d)$/);
        if (!match) return null;
        const letter = match[1].toUpperCase();
        const acc = match[2];
        const oct = parseInt(match[3],10);
        const baseIndex = {C:0, D:2, E:4, F:5, G:7, A:9, B:11}[letter];
        let pc = baseIndex + (acc === "#" ? 1 : acc === "b" ? -1 : 0);
        pc = (pc + 12) % 12;
        return (oct + 1) * 12 + pc;
      }
      function midiRange(startMidi, endMidi) {
        const arr = [];
        for (let m = startMidi; m <= endMidi; m++) arr.push(m);
        return arr;
      }
      function isBlack(midi) { return BLACK_SET.has(((midi%12)+12)%12); }
      function idSafeNote(name) { return name.replace("#","s").replace("b","b"); }

      // Naming preferences
      function midiToDisplayName(midi) {
        const data = Store.getProfileData();
        const prefs = data.preferences;
        const preferSharps = prefs.enharmonic === 'sharps';
        if (prefs.naming === 'solfege') {
          const pc = ((midi % 12) + 12) % 12;
          const sNamesSharps = ["Do","Di","Re","Ri","Mi","Fa","Fi","Sol","Si","La","Li","Ti"];
          const sNamesFlats = ["Do","Ra","Re","Me","Mi","Fa","Se","Sol","Le","La","Te","Ti"];
          const names = preferSharps ? sNamesSharps : sNamesFlats;
          const oct = Math.floor(midi / 12) - 1;
          return names[pc] + " " + oct;
        }
        return midiToName(midi, preferSharps);
      }

      // Scales and Chords
      const SCALE_PATTERNS = {
        major: [0,2,4,5,7,9,11,12],
        naturalMinor: [0,2,3,5,7,8,10,12],
        harmonicMinor: [0,2,3,5,7,8,11,12],
        melodicMinor: [0,2,3,5,7,9,11,12],
        majorPent: [0,2,4,7,9,12],
        minorPent: [0,3,5,7,10,12],
        blues: [0,3,5,6,7,10,12],
        dorian: [0,2,3,5,7,9,10,12],
        mixolydian: [0,2,4,5,7,9,10,12],
        lydian: [0,2,4,6,7,9,11,12],
        phrygian: [0,1,3,5,7,8,10,12],
        locrian: [0,1,3,5,6,8,10,12],
      };
      const CHORD_PATTERNS = {
        maj: [0,4,7],
        min: [0,3,7],
        dim: [0,3,6],
        aug: [0,4,8],
        maj7: [0,4,7,11],
        min7: [0,3,7,10],
        dom7: [0,4,7,10],
        sus2: [0,2,7],
        sus4: [0,5,7],
      };

      // Dynamic piano range
      let PIANO_START = nameToMidi("C3");
      let PIANO_END = nameToMidi("B5");
      let ALL_MIDIS = midiRange(PIANO_START, PIANO_END);
      let WHITE_MIDIS = ALL_MIDIS.filter(m => !isBlack(m));

      // Piano rendering
      const pianoContainer = document.getElementById('pianoContainer');
      const keysMap = new Map(); // midi -> element

      function buildPiano() {
        pianoContainer.innerHTML = '';
        keysMap.clear();
        const totalWidth = pianoContainer.clientWidth;
        const totalHeight = pianoContainer.clientHeight;
        ALL_MIDIS = midiRange(PIANO_START, PIANO_END);
        WHITE_MIDIS = ALL_MIDIS.filter(m => !isBlack(m));
        const whiteCount = WHITE_MIDIS.length;
        const whiteW = totalWidth / whiteCount;
        const blackW = whiteW * 0.6;

        let whiteIndex = 0;
        let lastWhiteLeft = 0;

        ALL_MIDIS.forEach(midi => {
          const displayName = midiToDisplayName(midi);
          const name = midiToName(midi, Store.getProfileData().preferences.enharmonic === 'sharps');
          const isBlk = isBlack(midi);
          const key = document.createElement('div');
          key.className = `key ${isBlk ? 'black' : 'white'}`;
          key.dataset.midi = midi;
          key.dataset.name = name;
          key.id = `key-${idSafeNote(name)}`;

          let left = 0;
          let width = isBlk ? blackW : whiteW;

          if (!isBlk) {
            left = whiteIndex * whiteW;
            lastWhiteLeft = left;
            whiteIndex++;
          } else {
            left = lastWhiteLeft + whiteW * 0.66 - blackW / 2;
          }

          key.style.left = left + 'px';
          key.style.width = width + 'px';
          key.style.height = isBlk ? Math.floor(totalHeight * 0.62) + 'px' : '100%';

          const label = document.createElement('div');
          label.className = 'keyLabel';
          label.textContent = displayName;
          key.appendChild(label);

          // labels visibility
          if (!Store.getProfileData().preferences.noteLabels) {
            label.classList.add('hidden');
          }

          addKeyListeners(key);
          pianoContainer.appendChild(key);
          keysMap.set(midi, key);
        });
      }

      function addKeyListeners(el) {
        let midi = parseInt(el.dataset.midi, 10);
        let down = false;
        const start = (e) => {
          e.preventDefault();
          down = true;
          AudioEngine.playNote(midi);
          setKeyActive(midi, true);
          handlePianoClickAsAnswer(midi);
          guidedHandleKey(midi);
        };
        const move = (e) => {
          if (!down) return;
          const t = e.touches ? e.touches[0] : e;
          const elem = document.elementFromPoint(t.clientX, t.clientY);
          if (elem && elem.classList.contains('key')) {
            const m = parseInt(elem.dataset.midi,10);
            if (m !== midi) {
              AudioEngine.stopNote(midi, 60);
              setKeyActive(midi, false);
              midi = m;
              AudioEngine.playNote(midi);
              setKeyActive(midi, true);
              handlePianoClickAsAnswer(midi);
              guidedHandleKey(midi);
            }
          }
        };
        const end = () => {
          if (!down) return;
          down = false;
          AudioEngine.stopNote(midi, 120);
          setKeyActive(midi, false);
        };

        el.addEventListener('mousedown', start);
        el.addEventListener('touchstart', start, { passive: false });
        window.addEventListener('mousemove', move, { passive: false });
        window.addEventListener('touchmove', move, { passive: false });
        window.addEventListener('mouseup', end);
        window.addEventListener('touchend', end);
        window.addEventListener('touchcancel', end);
      }

      function setKeyActive(midi, on=true) {
        const el = keysMap.get(midi);
        if (!el) return;
        el.classList.toggle('active', on);
      }
      function highlightKeys(midis, className, on=true) {
        midis.forEach(m => {
          const el = keysMap.get(m);
          if (el) el.classList.toggle(className, on);
        });
      }
      function clearAllHighlights() {
        for (const el of keysMap.values()) {
          el.classList.remove('highlight-scale','highlight-chord','guided-next');
          el.style.outlineColor = '';
        }
      }

      new ResizeObserver(buildPiano).observe(pianoContainer);

      // Computer keyboard map
      const KEY_TO_OFFSET = {
        'z': 0, 'x': 2, 'c': 4, 'v': 5, 'b': 7, 'n': 9, 'm': 11,
        's': 1, 'd': 3, 'g': 6, 'h': 8, 'j': 10,
        'q': 12, 'w': 14, 'e': 16, 'r': 17, 't': 19, 'y': 21, 'u': 23,
        '2': 13, '3': 15, '5': 18, '6': 20, '7': 22
      };
      let BASE_KEYBOARD_MIDI = nameToMidi("C4");
      const downKeys = new Set();

      window.addEventListener('keydown', (e) => {
        if (e.repeat) return;
        const key = e.key.toLowerCase();
        if (KEY_TO_OFFSET[key] != null) {
          const midi = BASE_KEYBOARD_MIDI + KEY_TO_OFFSET[key];
          if (midi < PIANO_START || midi > PIANO_END) return;
          AudioEngine.playNote(midi);
          setKeyActive(midi, true);
          downKeys.add(midi);
          handlePianoClickAsAnswer(midi);
          guidedHandleKey(midi);
        }
      });
      window.addEventListener('keyup', (e) => {
        const key = e.key.toLowerCase();
        if (KEY_TO_OFFSET[key] != null) {
          const midi = BASE_KEYBOARD_MIDI + KEY_TO_OFFSET[key];
          AudioEngine.stopNote(midi, 120);
          setKeyActive(midi, false);
          downKeys.delete(midi);
        }
      });

      // Populate selects
      const scaleRootSelect = document.getElementById('scaleRootSelect');
      const scaleTypeSelect = document.getElementById('scaleTypeSelect');
      const chordRootSelect = document.getElementById('chordRootSelect');
      const chordTypeSelect = document.getElementById('chordTypeSelect');
      const chordInversionSelect = document.getElementById('chordInversionSelect');
      const customScaleRoot = document.getElementById('customScaleRoot');
      const rangeStartSelect = document.getElementById('rangeStartSelect');
      const progKeySelect = document.getElementById('progKeySelect');

      function populateRootSelects() {
        const roots = [];
        const start = nameToMidi("C2");
        const end = nameToMidi("B5");
        for (let m = start; m <= end; m++) roots.push(midiToName(m, true));
        scaleRootSelect.innerHTML = roots.map(n => `<option value="${n}">${n}</option>`).join('');
        chordRootSelect.innerHTML = roots.map(n => `<option value="${n}">${n}</option>`).join('');
        customScaleRoot.innerHTML = roots.map(n => `<option value="${n}">${n}</option>`).join('');
        rangeStartSelect.innerHTML = roots.map(n => `<option value="${n}">${n}</option>`).join('');
        progKeySelect.innerHTML = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"].map(n => `<option value="${n}4">${n}4</option>`).join('');

        // Defaults will be overwritten by preferences load
        scaleRootSelect.value = "C4";
        chordRootSelect.value = "C4";
        customScaleRoot.value = "C4";
        rangeStartSelect.value = "C3";
        progKeySelect.value = "G4";
      }

      populateRootSelects();

      const playScaleBtn = document.getElementById('playScaleBtn');
      const clearScaleHighlightsBtn = document.getElementById('clearScaleHighlightsBtn');
      const playChordBtn = document.getElementById('playChordBtn');
      const clearChordHighlightsBtn = document.getElementById('clearChordHighlightsBtn');

      function getScaleMidis(rootName, patternName) {
        const rootMidi = nameToMidi(rootName);
        const pattern = SCALE_PATTERNS[patternName] || SCALE_PATTERNS.major;
        return pattern.map(semi => rootMidi + semi).filter(m => m >= PIANO_START && m <= PIANO_END);
      }
      function getChordMidis(rootName, chordType, inversion=0) {
        const rootMidi = nameToMidi(rootName);
        let ints = CHORD_PATTERNS[chordType] || CHORD_PATTERNS.maj;
        let notes = ints.map(i => rootMidi + i);
        for (let i=0; i<inversion; i++) { const n = notes.shift(); notes.push(n + 12); }
        return notes.filter(m => m >= PIANO_START && m <= PIANO_END);
      }

      playScaleBtn.addEventListener('click', () => {
        const midis = getScaleMidis(scaleRootSelect.value, scaleTypeSelect.value);
        clearAllHighlights();
        highlightKeys(midis, 'highlight-scale', true);
        const asc = [...midis];
        const desc = [...midis].reverse().slice(1);
        AudioEngine.playSequence(asc.concat(desc), 250);
        setText('#previewStatus', 'played-scale');
      });
      clearScaleHighlightsBtn.addEventListener('click', () => {
        for (const el of keysMap.values()) el.classList.remove('highlight-scale');
      });
      playChordBtn.addEventListener('click', () => {
        const inv = parseInt(chordInversionSelect.value,10) || 0;
        const midis = getChordMidis(chordRootSelect.value, chordTypeSelect.value, inv);
        for (const el of keysMap.values()) el.classList.remove('highlight-chord');
        highlightKeys(midis, 'highlight-chord', true);
        AudioEngine.playChord(midis, { block: true });
        setText('#previewStatus', 'played-chord');
      });
      clearChordHighlightsBtn.addEventListener('click', () => {
        for (const el of keysMap.values()) el.classList.remove('highlight-chord');
      });

      // Guided Scale Practice
      const guidedModeToggle = document.getElementById('guidedModeToggle');
      const startGuidedBtn = document.getElementById('startGuidedBtn');
      const submitGuidedBtn = document.getElementById('submitGuidedBtn');
      const guidedStatus = document.getElementById('guidedStatus');
      let guided = { enabled: false, seq: [], index: 0, mistakes: 0, active: false };

      guidedModeToggle.addEventListener('change', () => {
        guided.enabled = guidedModeToggle.checked;
        updateGuidedStatus('Guided ' + (guided.enabled ? 'enabled' : 'disabled') + '.');
      });
      startGuidedBtn.addEventListener('click', () => {
        if (!guided.enabled) { updateGuidedStatus('Enable Guided Mode first.'); return; }
        const midis = getScaleMidis(scaleRootSelect.value, scaleTypeSelect.value);
        if (!midis.length) { updateGuidedStatus('No scale available in range.'); return; }
        guided.seq = [...midis];
        guided.index = 0;
        guided.mistakes = 0;
        guided.active = true;
        clearAllHighlights();
        highlightKeys(midis, 'highlight-scale', true);
        setGuidedNext();
        updateGuidedStatus('Follow the red outline to play the next note.');
        setText('#solveStatus', 'in-progress');
      });
      submitGuidedBtn.addEventListener('click', () => {
        if (!guided.active) { updateGuidedStatus('Nothing to submit.'); return; }
        guided.active = false;
        for (const m of guided.seq) {
          const el = keysMap.get(m);
          if (el) el.classList.remove('guided-next');
        }
        updateGuidedStatus(`Finished. Mistakes: ${guided.mistakes}.`);
        setText('#solveStatus', 'done');
        // log session
        logSession({
          mode: 'scales',
          subtype: scaleTypeSelect.value,
          count: guided.seq.length,
          mistakes: guided.mistakes,
          correct: guided.seq.length - guided.mistakes,
          details: { root: scaleRootSelect.value, type: scaleTypeSelect.value }
        });
        refreshStats();
        renderHistory();
      });

      function setGuidedNext() {
        for (const m of guided.seq