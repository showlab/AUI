<!DOCTYPE html>
<html lang="en">
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Warm & Fun Holiday Card Workshop - Destylized Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="description" content="A simple, accessible holiday card workshop. Drag and drop cute items, toggle snow and night, with clear controls and feedback." />
  <style>
    /* ============================================================
       Destylized baseline: High-contrast, simple, operator-friendly.
       ============================================================ */

    :root {
      /* Colors: strict and minimal palette for high contrast */
      --bg: #ffffff;
      --ink: #000000;
      --muted: #444444;
      --accent: #005fcc;   /* blue for focus/primary */
      --accent-2: #cc0000; /* red for warnings */
      --accent-3: #008000; /* green for confirmations */
      --border: #000000;   /* solid borders, not light gray to keep contrast */
      --focus: #ffcc00;    /* focus outline */

      /* Sizes and spacing */
      --gap-s: 8px;
      --gap: 12px;
      --gap-l: 16px;
      --pad: 12px;
      --pad-l: 16px;
      --control-min: 44px;

      /* Functional feature colors (stars/snow keep minimal appearance) */
      --star: #000000;
      --snow: #000000;
      --canvas-bg-day: #ffffff; /* destylized: plain white */
      --canvas-bg-night: #e6f0ff; /* subtle light blue to indicate night; still solid */
    }

    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--ink);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      line-height: 1.35;
    }

    /* Focus visibility */
    :focus {
      outline: 3px solid var(--focus);
      outline-offset: 2px;
    }

    a { color: var(--accent); text-decoration: underline; }
    a:focus, button:focus { outline: 3px solid var(--focus); }

    /* Heading and header layout */
    header {
      border-bottom: 1px solid var(--border);
      padding: var(--pad-l);
    }
    header h1 {
      margin: 0 0 4px 0;
      font-size: 20px;
      font-weight: 800;
    }
    header p {
      margin: 0;
      font-size: 14px;
      color: var(--muted);
    }

    /* Main layout: two columns; left shelf, right canvas */
    main {
      display: grid;
      grid-template-columns: 320px 1fr;
      grid-template-rows: auto 1fr auto auto;
      gap: var(--gap-l);
      padding: var(--pad-l);
      max-width: 1280px;
      margin: 0 auto;
      min-height: calc(100vh - 80px);
    }

    /* Toy Shelf (left column), scrollable independent */
    aside#item-palette {
      grid-column: 1 / 2;
      grid-row: 1 / 5;
      min-height: 0;
      border: 1px solid var(--border);
      padding: var(--pad);
      background: #fff;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: var(--gap);
    }
    #palette-header-row {
      display: flex;
      align-items: center;
      gap: var(--gap);
      justify-content: space-between;
    }
    #palette-title {
      margin: 0;
      font-weight: 800;
      font-size: 16px;
    }
    #item-counter {
      font-size: 12px;
      color: var(--muted);
    }
    #palette-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: var(--gap);
      overflow: auto;
      padding-right: var(--gap);
      flex: 1 1 auto;
      min-height: 0;
    }
    .palette-item {
      border: 1px solid var(--border);
      background: #fff;
      padding: var(--pad);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--gap);
      cursor: grab;
      user-select: none;
      text-align: center;
      min-height: 120px;
    }
    .palette-item:active { cursor: grabbing; }
    .palette-item .thumb {
      width: 80px; height: 80px;
      display: grid; place-items: center;
    }
    .palette-item .label {
      font-size: 13px;
      font-weight: 700;
    }

    /* Canvas (right column area) */
    section#card-wrapper {
      grid-column: 2 / 3;
      grid-row: 1 / 2;
      display: flex;
      flex-direction: column;
      gap: var(--gap);
    }
    #card-canvas {
      position: relative;
      width: 100%;
      height: 58vh;
      min-height: 380px;
      border: 1px solid var(--border);
      background: var(--canvas-bg-day);
      overflow: hidden;
      isolation: isolate;
    }
    #card-canvas.night {
      background: var(--canvas-bg-night);
      color: #000;
    }

    /* Greeting text */
    #greeting {
      position: absolute;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      font-size: clamp(18px, 2.4vw, 26px);
      font-weight: 900;
      color: #000;
      background: #fff;
      padding: 2px 6px;
      border: 1px solid var(--border);
      z-index: 5;
      pointer-events: none;
    }

    /* Sun & Moon (destylized: solid circles) */
    #sun, #moon {
      position: absolute;
      top: 16px; right: 16px;
      width: 24px; height: 24px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: #fff;
      z-index: 2;
    }
    #moon { display: none; }
    #card-canvas.night #sun { display: none; }
    #card-canvas.night #moon { display: block; }

    /* Stars at night (destylized small squares) */
    #stars {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 1;
      display: none;
    }
    #card-canvas.night #stars { display: block; }
    .star {
      position: absolute;
      width: 2px; height: 2px;
      background: var(--star);
    }

    /* Ground (destylized: simple rectangle at bottom) */
    #ground {
      position: absolute;
      left: 0; right: 0;
      bottom: 0;
      height: 120px;
      background: #fff;
      border-top: 1px solid var(--border);
      z-index: 3;
      pointer-events: none;
    }

    /* Snowflakes (destylized minimal animation retained for functionality) */
    #snow {
      position: absolute;
      inset: 0;
      z-index: 10;
      pointer-events: none;
      overflow: hidden;
    }
    .flake {
      position: absolute;
      top: -10px;
      width: 6px; height: 6px;
      background: var(--snow);
      border: 1px solid var(--border);
      animation-name: fall, sway;
      animation-timing-function: linear, ease-in-out;
      animation-iteration-count: infinite, infinite;
    }
    @keyframes fall {
      0% { transform: translateY(-5%); }
      100% { transform: translateY(110%); }
    }
    @keyframes sway {
      0% { margin-left: -8px; }
      50% { margin-left: 8px; }
      100% { margin-left: -8px; }
    }
    #snow.storm .flake {
      animation-duration: var(--fall, 8s), var(--sway, 3s);
    }

    /* Items container */
    #items-layer {
      position: absolute;
      inset: 0;
      z-index: 6;
    }
    .scene-item {
      position: absolute;
      width: 100px; height: 100px; /* slightly bigger hit target */
      cursor: grab;
      touch-action: none;
      user-select: none;
      border: 1px solid transparent; /* base */
      background: transparent; /* no box visuals around SVGs */
      transform-origin: center center;
    }
    .scene-item:active { cursor: grabbing; }
    .scene-item.selected {
      outline: 2px solid var(--accent);
      border-color: var(--accent);
    }
    .scene-item.edge {
      outline: 2px solid var(--accent-2);
    }
    .scene-item .handles {
      position: absolute;
      inset: 0;
      pointer-events: none; /* enabled per-handle */
    }
    .transform-handle {
      position: absolute;
      width: 14px; height: 14px;
      background: #fff;
      border: 1px solid var(--border);
      pointer-events: auto;
    }
    /* corners for resize */
    .handle-nw { left: -7px; top: -7px; cursor: nwse-resize; }
    .handle-ne { right: -7px; top: -7px; cursor: nesw-resize; }
    .handle-sw { left: -7px; bottom: -7px; cursor: nesw-resize; }
    .handle-se { right: -7px; bottom: -7px; cursor: nwse-resize; }
    /* rotate handle (top center) */
    .handle-rotate { left: 50%; transform: translateX(-50%); top: -28px; cursor: alias; }
    /* edge handles (optional larger touch targets) */
    .handle-n { top: -7px; left: 50%; transform: translateX(-50%); cursor: ns-resize; }
    .handle-s { bottom: -7px; left: 50%; transform: translateX(-50%); cursor: ns-resize; }
    .handle-w { left: -7px; top: 50%; transform: translateY(-50%); cursor: ew-resize; }
    .handle-e { right: -7px; top: 50%; transform: translateY(-50%); cursor: ew-resize; }

    /* Item toolbar (below canvas) */
    #item-toolbar {
      display: none;
      flex-wrap: wrap;
      gap: var(--gap);
      border: 1px solid var(--border);
      padding: var(--pad);
      background: #fff;
    }
    #item-toolbar[data-visible="true"] { display: flex; }
    .tool-btn {
      min-width: var(--control-min);
      min-height: var(--control-min);
      border: 1px solid var(--border);
      background: #fff;
      font-weight: 700;
      cursor: pointer;
    }

    /* Controls panel below the canvas */
    nav#top-controls {
      grid-column: 2 / 3;
      grid-row: 2 / 3;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: var(--gap);
      border: 1px solid var(--border);
      padding: var(--pad);
      background: #fff;
    }
    .btn {
      min-width: var(--control-min);
      min-height: var(--control-min);
      border: 1px solid var(--border);
      background: #fff;
      color: var(--ink);
      font-weight: 700;
      cursor: pointer;
      padding: 8px 12px;
    }
    .btn[data-active="true"] {
      background: #eef6ff;
      border-color: var(--accent);
    }

    /* Control grouping & spacing to separate sound from others */
    .divider {
      width: 1px; height: 28px;
      background: var(--border);
      display: inline-block;
      margin: 0 4px;
    }

    /* Status and hint rows */
    #status-bar {
      grid-column: 2 / 3;
      grid-row: 3 / 4;
      border: 1px solid var(--border);
      padding: var(--pad);
      background: #fff;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--gap);
      font-size: 13px;
    }
    #status-bar div {
      border-right: 1px solid var(--border);
      padding-right: var(--gap);
    }
    #status-bar div:last-child {
      border-right: none;
    }

    #hint-row {
      grid-column: 2 / 3;
      grid-row: 4 / 5;
      border: 1px solid var(--border);
      padding: var(--pad);
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--gap);
      font-size: 13px;
      color: var(--muted);
    }

    #selection-hint {
      position: absolute;
      display: none;
      padding: 2px 6px;
      font-size: 12px;
      background: #fff;
      border: 1px solid var(--border);
      color: var(--ink);
      z-index: 9;
    }
    #selection-hint[data-visible="true"] {
      display: block;
    }

    /* Drop highlight ring */
    .drop-highlight {
      outline: 3px solid var(--accent-3) !important;
    }

    /* Confirmation banner */
    #confirmationBanner {
      position: fixed;
      left: 50%;
      bottom: 20px;
      transform: translateX(-50%);
      background: #fff;
      border: 1px solid var(--border);
      padding: 8px 12px;
      display: none;
      z-index: 1000;
      color: var(--ink);
    }
    #confirmationBanner[data-visible="true"] {
      display: block;
    }

    /* Footer */
    footer {
      text-align: center;
      padding: var(--pad-l);
      border-top: 1px solid var(--border);
      font-size: 13px;
    }

    /* Responsive */
    @media (max-width: 980px) {
      main {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto auto auto;
      }
      aside#item-palette {
        order: 3;
        grid-row: auto;
        height: 240px;
      }
      #palette-grid {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
      section#card-wrapper {
        order: 1;
      }
      nav#top-controls {
        order: 2;
      }
      #status-bar {
        order: 4;
      }
      #hint-row {
        order: 5;
      }
      #card-canvas {
        height: 50vh;
        min-height: 320px;
      }
    }

    /* Maintain compatibility with preserved selectors/classes from original (unused visuals removed) */
    .wiggle { } /* no animated wiggle in destylized; kept for compatibility */
    .badge {
      font-weight: 800;
      font-size: 11px;
      background: #fff;
      color: var(--ink);
      border: 1px solid var(--border);
      padding: 2px 4px;
    }
  </style>
</head>
<body id="app-root">
  <header>
    <h1>Holiday Card Workshop</h1>
    <p>Drag items from the Toy Shelf into the Card. Controls are below the canvas. All buttons are at least 44px for easy tapping.</p>
  </header>

  <main>
    <!-- Left column: Toy Shelf -->
    <aside id="item-palette" aria-label="Toy shelf">
      <div id="palette-header-row">
        <h2 id="palette-title">Toy Shelf</h2>
        <div id="item-counter" aria-live="polite">Items: <span id="itemCountValue">0</span></div>
      </div>
      <div id="palette-grid"></div>
      <div>
        <p style="margin:0; font-size:12px;">Tip: Click a shelf item to place it quickly. Or drag it onto the card.</p>
      </div>
    </aside>

    <!-- Right column: Card Canvas -->
    <section id="card-wrapper" aria-label="Your Holiday Card">
      <div id="card-canvas" aria-live="polite">
        <div id="greeting" aria-hidden="true">Happy Holidays! ❄️</div>
        <div id="sun" aria-hidden="true"></div>
        <div id="moon" aria-hidden="true"></div>
        <div id="stars" aria-hidden="true"></div>
        <div id="items-layer" aria-label="Items on card" data-count="0"></div>
        <div id="snow" aria-hidden="true"></div>
        <div id="ground" aria-hidden="true"></div>
        <div id="selection-hint" role="note" aria-live="polite" data-visible="false">Drag to move · Use handles to resize/rotate · Toolbar below</div>
      </div>
    </section>

    <!-- Controls below canvas to remain visible in 1280×720 -->
    <nav id="top-controls" aria-label="Card controls">
      <button id="btn-undo" class="btn" type="button" role="button" title="Undo last change">
        Undo
      </button>
      <button id="btn-clear" class="btn" type="button" role="button" title="Reset Scene (clears all items)">
        Reset Scene
      </button>

      <span class="divider" aria-hidden="true"></span>

      <button id="btn-night" class="btn" type="button" role="button" aria-pressed="false" data-active="false" title="Toggle Day/Night">
        Toggle Night
      </button>
      <button id="btn-snowburst" class="btn" type="button" role="button" title="Let it snow more!">
        Snowburst
      </button>
      <button id="btn-carol" class="btn" type="button" role="button" title="Play a mini carol">
        Play Carol
      </button>

      <span class="divider" aria-hidden="true"></span>

      <button id="btn-sound" class="btn" type="button" role="button" aria-pressed="true" data-active="true" title="Toggle sound (Mute/Unmute)">
        Mute
      </button>
      <span style="font-size:12px; color:#444;">Keyboard hint: Tab to focus, Enter to activate</span>
    </nav>

    <!-- Item toolbar (kept, placed below controls for persistent visibility) -->
    <div id="item-toolbar" role="group" aria-label="Selected item tools" data-visible="false">
      <button id="tool-rotate" class="tool-btn" type="button" role="button" title="Rotate">Rotate</button>
      <button id="tool-bigger" class="tool-btn" type="button" role="button" title="Bigger">Bigger</button>
      <button id="tool-smaller" class="tool-btn" type="button" role="button" title="Smaller">Smaller</button>
      <button id="tool-duplicate" class="tool-btn" type="button" role="button" title="Duplicate">Duplicate</button>
      <button id="tool-delete" class="tool-btn" type="button" role="button" title="Delete">Delete</button>
    </div>

    <!-- Status bar with explicit, stable proxies -->
    <div id="status-bar" aria-live="polite">
      <div>
        <strong>Sound:</strong>
        <span id="soundStatus">unmuted</span>
      </div>
      <div>
        <strong>Undo:</strong>
        <span id="undoStatus">idle</span>
      </div>
      <div>
        <strong>Reset:</strong>
        <span id="resetStatus">idle</span>
      </div>
      <div>
        <strong>Drop:</strong>
        <span id="dropStatus">idle</span>
      </div>
    </div>

    <div id="hint-row">
      <div>Hint: Press Enter on a focused control to activate. Drag items within the canvas; at least 25% stays visible. Items count updates in real time.</div>
      <div id="activeSection" aria-live="polite">Canvas</div>
    </div>
  </main>

  <footer>
    Tip: Drag from the shelf to the card. Select an item to use resize/rotate handles and toolbar. Double-click the card to toss a snowball. This simple interface is tuned for clarity and keyboard use.
  </footer>

  <div id="confirmationBanner" role="status" aria-live="assertive">Scene reset.</div>

  <script>
    // ============================================================
    // Core Data and State
    // ============================================================

    // Data: Palette items
    const ITEM_TYPES = [
      { type: 'tree', label: 'Tree', sound: 'ting' },
      { type: 'gift', label: 'Gift', sound: 'pop' },
      { type: 'snowman', label: 'Snowman', sound: 'boing' },
      { type: 'star', label: 'Star', sound: 'ting' },
      { type: 'candy', label: 'Candy Cane', sound: 'pop' },
      { type: 'penguin', label: 'Penguin', sound: 'boing' },
      { type: 'bell', label: 'Bell', sound: 'bell' },
      { type: 'reindeer', label: 'Reindeer', sound: 'whoosh' },
      { type: 'stocking', label: 'Stocking', sound: 'pop' },
      { type: 'ginger', label: 'Gingerbread', sound: 'ting' },
      { type: 'mitten', label: 'Mitten', sound: 'pop' },
      { type: 'sled', label: 'Sled', sound: 'whoosh' },
    ];

    const state = {
      items: [], // {id, type, x, y, rot, scale, z}
      idCounter: 1,
      zCounter: 10,
      selectedId: null,
      history: [],
      soundEnabled: true,
      audio: { ctx: null, unlocked: false, masterGain: null, active: [] }
    };

    // ============================================================
    // Elements
    // ============================================================
    const paletteGrid = document.getElementById('palette-grid');
    const canvas = document.getElementById('card-canvas');
    const itemsLayer = document.getElementById('items-layer');
    const snow = document.getElementById('snow');
    const stars = document.getElementById('stars');
    const toolbar = document.getElementById('item-toolbar');
    const selectionHint = document.getElementById('selection-hint');
    const confirmationBanner = document.getElementById('confirmationBanner');

    const btnUndo = document.getElementById('btn-undo');
    const btnClear = document.getElementById('btn-clear');
    const btnNight = document.getElementById('btn-night');
    const btnSnowburst = document.getElementById('btn-snowburst');
    const btnCarol = document.getElementById('btn-carol');
    const btnSound = document.getElementById('btn-sound');

    const toolRotate = document.getElementById('tool-rotate');
    const toolBigger = document.getElementById('tool-bigger');
    const toolSmaller = document.getElementById('tool-smaller');
    const toolDelete = document.getElementById('tool-delete');
    const toolDuplicate = document.getElementById('tool-duplicate');

    // Proxies / counters
    const itemCountValue = document.getElementById('itemCountValue');
    const soundStatus = document.getElementById('soundStatus');
    const undoStatus = document.getElementById('undoStatus');
    const resetStatus = document.getElementById('resetStatus');
    const dropStatus = document.getElementById('dropStatus');
    const activeSection = document.getElementById('activeSection');

    // ============================================================
    // History
    // ============================================================
    function saveHistory() {
      const snapshot = JSON.stringify(state.items);
      state.history.push(snapshot);
      if (state.history.length > 60) state.history.shift();
    }

    function undo() {
      if (state.history.length < 2) return;
      state.history.pop(); // discard current
      const prev = state.history[state.history.length - 1];
      try {
        state.items = JSON.parse(prev);
        state.selectedId = null;
        renderAll();
        undoStatus.textContent = 'undone';
      } catch(e){
        undoStatus.textContent = 'error';
      }
    }

    // ============================================================
    // Audio
    // ============================================================
    function initAudioCtx() {
      if (state.audio.unlocked) return;
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const master = ctx.createGain();
      master.gain.value = state.soundEnabled ? 1 : 0;
      master.connect(ctx.destination);
      state.audio.ctx = ctx;
      state.audio.masterGain = master;
      // create silent buffer to unlock on iOS
      const buffer = ctx.createBuffer(1, 1, 22050);
      const source = ctx.createBufferSource();
      source.buffer = buffer;
      source.connect(master);
      source.start(0);
      state.audio.unlocked = true;
    }

    // Helper: track active nodes so muting can stop them immediately
    function trackNode(node, stopAt) {
      try {
        state.audio.active.push(node);
        if (stopAt) setTimeout(() => {
          try { node.stop && node.stop(); } catch(e){}
        }, Math.max(0, (stopAt - (state.audio.ctx?.currentTime || 0)) * 1000));
      } catch(e){}
    }

    // Global stop for active sounds (mute behavior)
    function stopAllActiveSounds() {
      const active = state.audio.active.splice(0);
      active.forEach(n => {
        try { n.stop && n.stop(); } catch(e){}
        try { n.disconnect && n.disconnect(); } catch(e){}
      });
    }

    function playSound(type) {
      if (!state.soundEnabled) return;
      if (!state.audio.ctx) initAudioCtx();
      const ctx = state.audio.ctx;
      if (!ctx) return;
      if (ctx.state === 'suspended') ctx.resume();

      const now = ctx.currentTime;
      const gain = ctx.createGain();
      gain.connect(state.audio.masterGain);

      function env(g, a=0.005, d=0.15, s=0, r=0.2, peak=0.8) {
        const t = ctx.currentTime;
        g.gain.cancelScheduledValues(t);
        g.gain.setValueAtTime(0, t);
        g.gain.linearRampToValueAtTime(peak, t + a);
        g.gain.exponentialRampToValueAtTime(Math.max(0.0001, s), t + a + d);
        g.gain.exponentialRampToValueAtTime(0.0001, t + a + d + r);
      }

      if (type === 'pop') {
        const bufferSize = 256;
        const b = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
        const data = b.getChannelData(0);
        for (let i=0;i<bufferSize;i++) data[i] = (Math.random()*2-1) * (1 - i/bufferSize);
        const src = ctx.createBufferSource();
        src.buffer = b;
        const biquad = ctx.createBiquadFilter();
        biquad.type = 'bandpass';
        biquad.frequency.setValueAtTime(900, now);
        src.connect(biquad).connect(gain);
        env(gain, 0.001, 0.05, 0, 0.07, 0.8);
        src.start(now);
        src.stop(now + 0.1);
        trackNode(src, now + 0.11);
      } else if (type === 'bell') {
        const o1 = ctx.createOscillator();
        const o2 = ctx.createOscillator();
        const o3 = ctx.createOscillator();
        o1.type='sine'; o2.type='sine'; o3.type='triangle';
        o1.frequency.setValueAtTime(880, now);
        o2.frequency.setValueAtTime(1320, now);
        o3.frequency.setValueAtTime(1760, now);
        const g1 = ctx.createGain(), g2 = ctx.createGain(), g3 = ctx.createGain();
        g1.gain.value = 0.6; g2.gain.value = 0.3; g3.gain.value = 0.2;
        o1.connect(g1).connect(gain);
        o2.connect(g2).connect(gain);
        o3.connect(g3).connect(gain);
        env(gain, 0.002, 0.25, 0, 0.6, 0.9);
        o1.start(now); o2.start(now); o3.start(now);
        const stopAt = now + 0.8;
        o1.stop(stopAt); o2.stop(stopAt); o3.stop(stopAt);
        trackNode(o1, stopAt); trackNode(o2, stopAt); trackNode(o3, stopAt);
      } else if (type === 'ting') {
        const o = ctx.createOscillator();
        o.type = 'triangle';
        o.frequency.setValueAtTime(1400, now);
        const g2 = ctx.createGain();
        o.connect(g2).connect(gain);
        g2.gain.value = 0.7;
        env(gain, 0.001, 0.08, 0, 0.2, 0.7);
        o.start(now);
        const stopAt = now + 0.22;
        o.stop(stopAt);
        trackNode(o, stopAt);
      } else if (type === 'boing') {
        const o = ctx.createOscillator();
        o.type = 'sine';
        const f = o.frequency;
        f.setValueAtTime(220, now);
        f.exponentialRampToValueAtTime(140, now + 0.12);
        f.exponentialRampToValueAtTime(440, now + 0.28);
        o.connect(gain);
        env(gain, 0.002, 0.18, 0, 0.2, 0.75);
        o.start(now);
        const stopAt = now + 0.3;
        o.stop(stopAt);
        trackNode(o, stopAt);
      } else if (type === 'whoosh') {
        const src = ctx.createBufferSource();
        const length = 0.26 * ctx.sampleRate;
        const b = ctx.createBuffer(1, length, ctx.sampleRate);
        const d = b.getChannelData(0);
        for (let i=0;i<length;i++) d[i] = (Math.random()*2-1)*(1-i/length);
        const filt = ctx.createBiquadFilter();
        filt.type = 'highpass';
        filt.frequency.setValueAtTime(400, now);
        src.buffer = b;
        src.connect(filt).connect(gain);
        env(gain, 0.001, 0.12, 0, 0.2, 0.7);
        src.start(now);
        const stopAt = now + 0.3;
        src.stop(stopAt);
        trackNode(src, stopAt);
      } else if (type === 'jingle') {
        // Little melody
        const notes = [659, 659, 659, 659, 659, 659, 659, 784, 523, 587, 659];
        notes.forEach((freq, i) => {
          const start = now + i * 0.18;
          const o = ctx.createOscillator();
          const g3 = ctx.createGain();
          o.type='square';
          o.frequency.setValueAtTime(freq, start);
          o.connect(g3).connect(state.audio.masterGain);
          g3.gain.setValueAtTime(0, start);
          g3.gain.linearRampToValueAtTime(0.25, start + 0.02);
          g3.gain.exponentialRampToValueAtTime(0.0001, start + 0.16);
          o.start(start);
          const stopAt = start + 0.2;
          o.stop(stopAt);
          trackNode(o, stopAt);
        });
      }
    }

    // ============================================================
    // SVG Factory (kept, simplified fills for destylized look)
    // ============================================================
    function svgFor(type) {
      const base = (content, view='0 0 100 100') => `
        <svg viewBox="${view}" width="100" height="100" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          ${content}
        </svg>`;
      switch(type) {
        case 'tree': return base(`
          <polygon points="50,10 20,50 80,50" fill="#0a0" stroke="#000"/>
          <polygon points="50,25 15,65 85,65" fill="#0a0" stroke="#000"/>
          <polygon points="50,40 10,80 90,80" fill="#0a0" stroke="#000"/>
          <rect x="44" y="80" width="12" height="16" fill="#654321" stroke="#000"/>
          <circle cx="35" cy="50" r="4" fill="#cc0000" stroke="#000"/>
          <circle cx="62" cy="60" r="4" fill="#ffcc00" stroke="#000"/>
          <circle cx="45" cy="70" r="4" fill="#00aaff" stroke="#000"/>
          <polygon points="50,4 46,12 54,12" fill="#ffcc00" stroke="#000"/>
        `);
        case 'gift': return base(`
          <rect x="15" y="35" width="70" height="50" fill="#cc0000" stroke="#000"/>
          <rect x="15" y="35" width="70" height="15" fill="#ff6666" stroke="#000"/>
          <rect x="46" y="35" width="8" height="50" fill="#ffcc00" stroke="#000"/>
          <rect x="15" y="58" width="70" height="6" fill="#ffcc00" stroke="#000"/>
          <path d="M50 35c-10 0-16-8-12-12s12 4 12 12z" fill="#ffcc00" stroke="#000"/>
          <path d="M50 35c10 0 16-8 12-12s-12 4-12 12z" fill="#ffcc00" stroke="#000"/>
        `);
        case 'snowman': return base(`
          <circle cx="50" cy="40" r="18" fill="#fff" stroke="#000"/>
          <circle cx="50" cy="75" r="22" fill="#fff" stroke="#000"/>
          <circle cx="44" cy="38" r="3" fill="#000"/>
          <circle cx="56" cy="38" r="3" fill="#000"/>
          <polygon points="50,42 70,47 50,50" fill="#ff8800" stroke="#000"/>
          <rect x="38" y="23" width="24" height="6" fill="#000"/>
          <rect x="42" y="18" width="16" height="6" fill="#000"/>
          <circle cx="50" cy="65" r="2" fill="#000"/>
          <circle cx="50" cy="75" r="2" fill="#000"/>
          <circle cx="50" cy="85" r="2" fill="#000"/>
          <path d="M30,55 Q38,50 46,55" stroke="#654321" stroke-width="3" fill="none"/>
          <path d="M54,55 Q62,50 70,55" stroke="#654321" stroke-width="3" fill="none"/>
          <path d="M38,48 Q50,54 62,48" stroke="#000" stroke-width="2" fill="none"/>
          <path d="M40,60 Q50,66 60,60" stroke="#cc0000" stroke-width="4" fill="none"/>
        `);
        case 'star': return base(`
          <polygon points="50,10 58,38 88,38 62,54 70,82 50,64 30,82 38,54 12,38 42,38"
            fill="#ffcc00" stroke="#000" stroke-width="2"/>
        `);
        case 'candy': return base(`
          <path d="M55 20c15-15 35 10 20 25l-30 30c-15 15-35-10-20-25L55 20z"
            stroke="#000" stroke-width="2" fill="#fff"/>
          <rect x="23" y="68" width="16" height="8" fill="#fff" stroke="#000"/>
          <rect x="14" y="55" width="8" height="16" fill="#fff" stroke="#000"/>
          <path d="M53 23 L77 47" stroke="#cc0000" stroke-width="4"/>
          <path d="M48 28 L72 52" stroke="#cc0000" stroke-width="4"/>
        `);
        case 'penguin': return base(`
          <ellipse cx="50" cy="60" rx="24" ry="30" fill="#000" stroke="#000"/>
          <ellipse cx="50" cy="62" rx="16" ry="22" fill="#fff" stroke="#000"/>
          <circle cx="42" cy="46" r="4" fill="#fff" stroke="#000"/>
          <circle cx="58" cy="46" r="4" fill="#fff" stroke="#000"/>
          <circle cx="42" cy="46" r="2" fill="#000"/>
          <circle cx="58" cy="46" r="2" fill="#000"/>
          <polygon points="50,52 46,58 54,58" fill="#ffcc66" stroke="#000"/>
          <ellipse cx="42" cy="86" rx="6" ry="3" fill="#ffcc66" stroke="#000"/>
          <ellipse cx="58" cy="86" rx="6" ry="3" fill="#ffcc66" stroke="#000"/>
          <rect x="34" y="24" width="32" height="10" fill="#cc0000" stroke="#000"/>
          <rect x="34" y="30" width="32" height="5" fill="#ffcc00" stroke="#000"/>
        `);
        case 'bell': return base(`
          <path d="M50 20c-12 0-20 12-20 24v8c0 6-6 8-6 10h52c0-2-6-4-6-10v-8c0-12-8-24-20-24z"
            fill="#ffcc00" stroke="#000" stroke-width="2"/>
          <circle cx="50" cy="66" r="5" fill="#ccaa33" stroke="#000"/>
          <rect x="44" y="16" width="12" height="6" fill="#ccaa33" stroke="#000"/>
        `);
        case 'reindeer': return base(`
          <ellipse cx="50" cy="56" rx="22" ry="20" fill="#a56a43" stroke="#000"/>
          <circle cx="40" cy="50" r="4" fill="#000"/>
          <circle cx="60" cy="50" r="4" fill="#000"/>
          <circle cx="50" cy="64" r="5" fill="#cc0000" stroke="#000"/>
          <path d="M34,36 C24,30 20,22 20,20" stroke="#654321" stroke-width="4" fill="none"/>
          <path d="M66,36 C76,30 80,22 80,20" stroke="#654321" stroke-width="4" fill="none"/>
          <ellipse cx="36" cy="60" rx="6" ry="8" fill="#8e5a3a" stroke="#000"/>
          <ellipse cx="64" cy="60" rx="6" ry="8" fill="#8e5a3a" stroke="#000"/>
        `);
        case 'stocking': return base(`
          <path d="M40 18h20v30c0 8-14 14-20 16-6 2-14-2-16-8s4-10 10-10c4 0 6-2 6-6V18z"
            fill="#cc0000" stroke="#000" stroke-width="2"/>
          <rect x="38" y="12" width="24" height="10" fill="#fff" stroke="#000"/>
          <circle cx="44" cy="42" r="3" fill="#fff" stroke="#000"/>
          <circle cx="52" cy="48" r="3" fill="#fff" stroke="#000"/>
        `);
        case 'ginger': return base(`
          <g fill="#b5753a" stroke="#000" stroke-width="2">
            <circle cx="50" cy="32" r="12"/>
            <rect x="38" y="42" width="24" height="26"/>
            <rect x="26" y="46" width="12" height="18"/>
            <rect x="62" y="46" width="12" height="18"/>
            <rect x="42" y="68" width="8" height="12"/>
            <rect x="50" y="68" width="8" height="12"/>
          </g>
          <circle cx="46" cy="30" r="2" fill="#fff"/>
          <circle cx="54" cy="30" r="2" fill="#fff"/>
          <path d="M44,36 Q50,40 56,36" stroke="#fff" stroke-width="2" fill="none"/>
          <circle cx="50" cy="50" r="3" fill="#00aaff" stroke="#000"/>
          <circle cx="50" cy="58" r="3" fill="#ffcc00" stroke="#000"/>
          <circle cx="50" cy="66" r="3" fill="#cc0000" stroke="#000"/>
        `);
        case 'mitten': return base(`
          <path d="M30 40c0-10 8-18 18-18s18 8 18 18v8H30v-8z" fill="#cc0000" stroke="#000"/>
          <rect x="30" y="46" width="36" height="14" fill="#fff" stroke="#000"/>
          <rect x="18" y="44" width="12" height="12" fill="#cc0000" stroke="#000"/>
        `);
        case 'sled': return base(`
          <rect x="22" y="60" width="56" height="8" fill="#8a5a3a" stroke="#000"/>
          <rect x="28" y="50" width="8" height="10" fill="#8a5a3a" stroke="#000"/>
          <rect x="44" y="50" width="8" height="10" fill="#8a5a3a" stroke="#000"/>
          <rect x="60" y="50" width="8" height="10" fill="#8a5a3a" stroke="#000"/>
          <path d="M20,68 Q30,78 80,68" stroke="#6b3d1f" stroke-width="4" fill="none"/>
        `);
      }
      return base(`<rect x="10" y="10" width="80" height="80" fill="#ccc" stroke="#000"/>`);
    }

    // ============================================================
    // Palette Construction
    // ============================================================
    function buildPalette() {
      ITEM_TYPES.forEach((it) => {
        const el = document.createElement('button');
        el.className = 'palette-item';
        el.id = `palette-item-${it.type}`;
        el.type = 'button';
        el.role = 'button';
        el.setAttribute('aria-label', `Add ${it.label}`);
        el.innerHTML = `
          <div class="thumb">${svgFor(it.type)}</div>
          <div class="label">${it.label}</div>
        `;
        el.addEventListener('pointerdown', e => {
          initAudioCtx();
          startDragFromPalette(e, it.type);
        }, {passive:false});
        el.addEventListener('click', e => {
          const rect = canvas.getBoundingClientRect();
          const x = Math.random() * (rect.width - 120) + 60;
          const y = Math.random() * (rect.height - 250) + 120;
          const id = addItem(it.type, x, y, {play: true, select: true, zTop: true});
          saveHistory();
          highlightDrop(id);
          dropStatus.textContent = 'placed';
        });
        paletteGrid.appendChild(el);
      });
    }

    // ============================================================
    // Items: Create, Position, Render
    // ============================================================
    function createItemEl(item) {
      const el = document.createElement('div');
      el.className = 'scene-item';
      el.id = `scene-item-${item.id}`;
      el.setAttribute('role', 'img');
      el.setAttribute('aria-label', item.type);
      el.dataset.id = item.id;
      el.dataset.type = item.type;
      el.innerHTML = svgFor(item.type);
      positionItemEl(el, item);

      // handles container (added when selected)
      const handles = document.createElement('div');
      handles.className = 'handles';
      handles.style.display = 'none';
      el.appendChild(handles);

      // Events
      el.addEventListener('pointerdown', (e)=> {
        startDragSceneItem(e, item.id);
      });
      el.addEventListener('click', (e)=> {
        selectItem(item.id);
        nudgeRotate(item.id, 0); // no auto-rotate, but keep call for compatibility
        actionSound(item.type);
      });
      el.addEventListener('dblclick', (e)=> {
        // snowball toss at center of item
        const rect = canvas.getBoundingClientRect();
        const cx = item.x;
        const cy = item.y;
        spawnSnowball(cx, cy);
        actionSound(item.type);
      });
      return el;
    }

    function positionItemEl(el, item) {
      el.style.left = `${item.x - 50}px`;
      el.style.top = `${item.y - 50}px`;
      el.style.zIndex = item.z || 10;
      el.style.transform = `rotate(${item.rot}deg) scale(${item.scale})`;
    }

    function addItem(type, x, y, opts={}) {
      const rect = canvas.getBoundingClientRect();
      const bounds = computeBounds(rect);
      const safeX = clamp(x, bounds.minX, bounds.maxX);
      const safeY = clamp(y, bounds.minY, bounds.maxY);
      const id = state.idCounter++;
      const item = { id, type, x: safeX, y: safeY, rot: 0, scale: 1, z: opts.zTop ? ++state.zCounter : 10 };
      state.items.push(item);
      const el = createItemEl(item);
      itemsLayer.appendChild(el);
      if (opts.play) playSound('pop');
      if (opts.select) selectItem(id);
      updateCounter();
      return id;
    }

    function renderAll() {
      // Clear and rebuild items
      itemsLayer.innerHTML = '';
      state.items.forEach(it => {
        const el = createItemEl(it);
        itemsLayer.appendChild(el);
      });
      if (state.selectedId) {
        const el = document.getElementById(`scene-item-${state.selectedId}`);
        if (el) {
          el.classList.add('selected');
          showHandlesFor(state.selectedId, true);
          toolbar.dataset.visible = 'true';
        }
      } else {
        hideAllHandles();
        toolbar.dataset.visible = 'false';
      }
      updateCounter();
    }

    function selectItem(id) {
      state.selectedId = id;
      document.querySelectorAll('.scene-item').forEach(el => {
        el.classList.remove('selected');
        const h = el.querySelector('.handles');
        if (h) h.style.display = 'none';
      });
      const el = document.getElementById(`scene-item-${id}`);
      if (el) {
        el.classList.add('selected');
        toolbar.dataset.visible = 'true';
        showHandlesFor(id, true);
        showSelectionHint(el);
      }
    }

    function clearSelection() {
      state.selectedId = null;
      document.querySelectorAll('.scene-item').forEach(el => {
        el.classList.remove('selected');
        const h = el.querySelector('.handles');
        if (h) h.style.display = 'none';
      });
      toolbar.dataset.visible = 'false';
      selectionHint.dataset.visible = 'false';
    }

    function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

    function computeBounds(rect) {
      // Keep at least 25% visible for 100x100 items: 25% of 100 = 25; center must be >=25 and <= width-25
      const margin = 25;
      const minX = margin;
      const maxX = rect.width - margin;
      const minY = margin;
      const maxY = rect.height - margin;
      return {minX, maxX, minY, maxY};
    }

    // ============================================================
    // Dragging From Palette
    // ============================================================
    function startDragFromPalette(e, type) {
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const id = addItem(type, e.clientX - rect.left, e.clientY - rect.top, {play:false, select:true, zTop:true});
      saveHistory();

      const move = (ev)=> {
        const item = getItem(id);
        if (!item) return;
        const nx = ev.clientX - rect.left;
        const ny = ev.clientY - rect.top;
        updateItemPos(id, nx, ny, true);
      };
      const up = (ev)=> {
        window.removeEventListener('pointermove', move);
        window.removeEventListener('pointerup', up);
        playSound('pop');
        saveHistory();
        highlightDrop(id);
        dropStatus.textContent = 'dropped';
      };
      window.addEventListener('pointermove', move);
      window.addEventListener('pointerup', up);
    }

    // ============================================================
    // Dragging Existing Scene Item
    // ============================================================
    function startDragSceneItem(e, id) {
      e.preventDefault();
      initAudioCtx();
      selectItem(id);
      const item = getItem(id);
      const rect = canvas.getBoundingClientRect();
      const el = document.getElementById(`scene-item-${id}`);
      if (!el) return;
      const offsetX = e.clientX - (rect.left + item.x);
      const offsetY = e.clientY - (rect.top + item.y);
      el.setPointerCapture(e.pointerId);

      const move = (ev)=> {
        const nx = ev.clientX - rect.left - offsetX;
        const ny = ev.clientY - rect.top - offsetY;
        updateItemPos(id, nx, ny, false);
      };
      const up = (ev)=> {
        try { el.releasePointerCapture(e.pointerId); } catch(_){}
        window.removeEventListener('pointermove', move);
        window.removeEventListener('pointerup', up);
        saveHistory();
        highlightDrop(id);
        dropStatus.textContent = 'moved';
      };
      window.addEventListener('pointermove', move);
      window.addEventListener('pointerup', up);
    }

    function updateItemPos(id, x, y, raw=false) {
      const item = getItem(id);
      if (!item) return;
      const rect = canvas.getBoundingClientRect();
      const bounds = computeBounds(rect);
      // x,y are center coordinates if raw, else x+50,y+50 adjust
      const nx = clamp(raw ? x : x + 50, bounds.minX, bounds.maxX);
      const ny = clamp(raw ? y : y + 50, bounds.minY, bounds.maxY);
      item.x = nx;
      item.y = ny;
      const el = document.getElementById(`scene-item-${id}`);
      if (el) {
        positionItemEl(el, item);
        // edge feedback: near edge within 5px
        const nearX = (nx - bounds.minX) < 6 || (bounds.maxX - nx) < 6;
        const nearY = (ny - bounds.minY) < 6 || (bounds.maxY - ny) < 6;
        if (nearX || nearY) {
          el.classList.add('edge');
        } else {
          el.classList.remove('edge');
        }
      }
    }

    function getItem(id) {
      return state.items.find(it => it.id === id);
    }

    // ============================================================
    // Toolbar Actions
    // ============================================================
    function nudgeRotate(id, deg=15) {
      const it = getItem(id);
      if (!it) return;
      it.rot = (it.rot + deg) % 360;
      const el = document.getElementById(`scene-item-${id}`);
      positionItemEl(el, it);
    }
    function scaleItem(id, factor) {
      const it = getItem(id);
      if (!it) return;
      it.scale = clamp(it.scale * factor, 0.6, 2.2);
      const el = document.getElementById(`scene-item-${id}`);
      positionItemEl(el, it);
    }
    function deleteItem(id) {
      state.items = state.items.filter(x => x.id !== id);
      const el = document.getElementById(`scene-item-${id}`);
      if (el) el.remove();
      clearSelection();
      updateCounter();
    }
    function duplicateItem(id) {
      const it = getItem(id);
      if (!it) return;
      const nid = addItem(it.type, it.x + 20, it.y + 20, {play:true, select:true, zTop:true});
      const newIt = getItem(nid);
      newIt.rot = it.rot;
      newIt.scale = it.scale;
      renderAll();
      saveHistory();
    }

    // Button bindings
    toolRotate.addEventListener('click', ()=> {
      if (!state.selectedId) return;
      nudgeRotate(state.selectedId, 20);
      saveHistory();
      playSound('ting');
    });
    toolBigger.addEventListener('click', ()=> {
      if (!state.selectedId) return;
      scaleItem(state.selectedId, 1.12);
      saveHistory();
    });
    toolSmaller.addEventListener('click', ()=> {
      if (!state.selectedId) return;
      scaleItem(state.selectedId, 0.9);
      saveHistory();
    });
    toolDelete.addEventListener('click', ()=> {
      if (!state.selectedId) return;
      deleteItem(state.selectedId);
      saveHistory();
      playSound('whoosh');
    });
    toolDuplicate.addEventListener('click', ()=> {
      if (!state.selectedId) return;
      duplicateItem(state.selectedId);
    });

    // ============================================================
    // Top Controls
    // ============================================================
    btnUndo.addEventListener('click', ()=> { undo(); playSound('ting'); });
    btnClear.addEventListener('click', ()=> {
      if (!state.items.length) return;
      state.items = [];
      renderAll();
      saveHistory();
      playSound('whoosh');
      showConfirmation('Scene reset.');
      resetStatus.textContent = 'done';
    });
    btnNight.addEventListener('click', ()=> {
      const ni = canvas.classList.toggle('night');
      btnNight.dataset.active = ni ? 'true' : 'false';
      btnNight.setAttribute('aria-pressed', ni ? 'true' : 'false');
      if (ni && !stars.childElementCount) spawnStars(80);
      playSound('ting');
    });
    btnSnowburst.addEventListener('click', ()=> {
      snow.classList.add('storm');
      playSound('whoosh');
      setTimeout(()=> snow.classList.remove('storm'), 2200);
    });
    btnCarol.addEventListener('click', ()=> {
      playSound('jingle');
    });
    btnSound.addEventListener('click', ()=> {
      state.soundEnabled = !state.soundEnabled;
      // Update master gain instantly; stop active sounds if muting
      if (state.audio.masterGain) {
        state.audio.masterGain.gain.value = state.soundEnabled ? 1 : 0;
      }
      if (!state.soundEnabled) stopAllActiveSounds();
      btnSound.dataset.active = state.soundEnabled ? 'true' : 'false';
      btnSound.setAttribute('aria-pressed', state.soundEnabled ? 'true