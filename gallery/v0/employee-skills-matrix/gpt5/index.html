<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Employee Skills Matrix</title>
  <style>
    :root{
      --primary: #1b6ca8;
      --primary-600: #175a8c;
      --accent: #50b83c;
      --bg: #f6f8fb;
      --card: #ffffff;
      --text: #1b1f24;
      --muted: #6b7280;
      --border: #e5e7eb;
      --warning: #f59e0b;
      --danger: #ef4444;
      --ok: #16a34a;

      --lv0: #e5e7eb;
      --lv1: #fde2cf;
      --lv2: #fff2b3;
      --lv3: #daf5d9;
      --lv4: #c7ecff;

      --gap: #ffe3e3;
      --shadow: 0 1px 2px rgba(0,0,0,0.06), 0 4px 12px rgba(0,0,0,0.06);
      --radius: 12px;
      --radius-sm: 8px;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background: linear-gradient(180deg, #f8fafc, #eef2f7);
    }

    header {
      position: sticky;
      top: 0;
      z-index: 50;
      background: linear-gradient(180deg, #0f172a 0%, #1f2937 100%);
      color: #fff;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .header-inner {
      max-width: 1400px;
      margin: 0 auto;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }
    .title-wrap {
      display: flex;
      align-items: center;
      gap: 14px;
      min-width: 260px;
    }
    .app-logo {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      background: linear-gradient(180deg, var(--primary), #268bd2);
      display: grid;
      place-items: center;
      box-shadow: var(--shadow);
    }
    .app-logo svg { opacity: .95; }
    h1 {
      margin: 0;
      font-size: 1.35rem;
      letter-spacing: 0.3px;
    }
    .subtitle {
      font-size: 0.9rem;
      color: #cbd5e1;
      margin-top: 2px;
    }
    .header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(255,255,255,0.08);
      color: #fff;
      cursor: pointer;
      transition: 0.18s ease;
      font-weight: 600;
      letter-spacing: .2px;
      backdrop-filter: blur(4px);
    }
    .btn:hover { background: rgba(255,255,255,0.16); }
    .btn.primary {
      background: var(--accent);
      border-color: transparent;
      color: #0b1a0b;
    }
    .btn.primary:hover { background: #4bac37; }
    .btn.danger {
      background: rgba(239,68,68,0.12);
      border-color: rgba(239,68,68,0.3);
      color: #fecaca;
    }
    .btn.sm { padding: 8px 12px; border-radius: 9px; font-size: 0.92rem; }
    .btn svg { width: 18px; height: 18px; }

    main {
      max-width: 1400px;
      margin: 18px auto;
      padding: 0 24px 24px;
      display: grid;
      grid-template-columns: 340px 1fr;
      gap: 18px;
    }
    @media (max-width: 1100px) {
      main { grid-template-columns: 1fr; }
    }

    aside {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
      position: sticky;
      top: 90px;
      max-height: calc(100vh - 120px);
      overflow: auto;
    }
    .panel-section + .panel-section { margin-top: 18px; padding-top: 18px; border-top: 1px dashed var(--border); }
    .section-title {
      font-size: 0.95rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .8px;
      margin-bottom: 10px;
    }

    .field {
      display: grid;
      gap: 6px;
      margin-bottom: 12px;
    }
    label { font-size: 0.95rem; color: var(--muted); }
    input[type="text"], select, input[type="search"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fff;
      transition: 0.15s ease;
      font-size: 0.98rem;
    }
    input[type="text"]:focus, select:focus, input[type="search"]:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(27,108,168,0.12);
    }
    .row {
      display: flex;
      gap: 8px;
      align-items: end;
    }
    .row > .field { flex: 1; }
    .hint { font-size: 0.86rem; color: var(--muted); }

    .matrix-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      min-height: 460px;
      overflow: hidden;
    }
    .matrix-toolbar {
      padding: 12px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, #ffffff, #fcfdff);
    }
    .toolbar-left, .toolbar-right {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    .pill {
      padding: 7px 10px;
      border: 1px solid var(--border);
      border-radius: 20px;
      background: #fff;
      color: var(--muted);
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .pill b { color: var(--text); }
    .checkbox {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      user-select: none;
      cursor: pointer;
      color: var(--muted);
    }

    .matrix-scroll {
      overflow: auto;
      position: relative;
    }

    table {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      min-width: 720px;
      font-size: 0.96rem;
    }
    thead th {
      position: sticky;
      top: 0;
      background: #f9fafb;
      border-bottom: 1px solid var(--border);
      z-index: 5;
    }
    th, td {
      border-right: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
      padding: 8px;
      vertical-align: middle;
      background: #fff;
    }
    th:first-child, td:first-child {
      position: sticky;
      left: 0;
      z-index: 3;
      background: #f9fafb;
      border-right: 1px solid var(--border);
    }
    thead th:first-child {
      z-index: 6;
      background: #eef2f7;
    }
    thead th, td { min-width: 130px; }
    thead th:first-child, td:first-child { min-width: 260px; }

    .emp-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .emp-name {
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .head-actions {
      display: inline-flex;
      gap: 6px;
    }
    .icon-btn {
      border: none;
      background: transparent;
      color: var(--muted);
      padding: 6px;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.15s ease;
    }
    .icon-btn:hover { background: rgba(0,0,0,0.05); color: var(--text); }
    .icon-btn.danger:hover { background: rgba(239,68,68,0.1); color: var(--danger); }
    .icon-btn svg { width: 16px; height: 16px; display: block; }

    .skill-cell {
      display: grid;
      grid-template-columns: 1fr auto auto;
      align-items: center;
      gap: 8px;
    }
    .skill-name {
      font-weight: 700;
    }
    .req-badge {
      font-size: 0.82rem;
      background: #eef6ff;
      color: #17406d;
      border: 1px solid #cde4ff;
      padding: 5px 8px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .req-badge select {
      border: none;
      background: transparent;
      padding: 0;
      outline: none;
      font-weight: 700;
      color: #17406d;
      cursor: pointer;
    }

    .prof-select {
      width: 100%;
      padding: 8px 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #fff;
      appearance: none;
      background-image: linear-gradient(45deg, transparent 50%, #9aa2ad 50%), linear-gradient(135deg, #9aa2ad 50%, transparent 50%);
      background-position: calc(100% - 18px) calc(1em + 2px), calc(100% - 13px) calc(1em + 2px);
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
      transition: 0.15s ease;
      font-weight: 600;
    }
    .prof-select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(27,108,168,0.12);
      outline: none;
    }

    .prof-0 { background-color: var(--lv0); }
    .prof-1 { background-color: var(--lv1); }
    .prof-2 { background-color: var(--lv2); }
    .prof-3 { background-color: var(--lv3); }
    .prof-4 { background-color: var(--lv4); }

    .cell-gap { box-shadow: inset 0 0 0 2px rgba(239,68,68,0.45); }

    .legend {
      display: grid;
      grid-template-columns: repeat(5, minmax(100px, 1fr));
      gap: 8px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #fff;
      border: 1px solid var(--border);
      padding: 8px 10px;
      border-radius: 10px;
    }
    .swatch {
      width: 18px; height: 18px; border-radius: 4px; border: 1px solid rgba(0,0,0,0.07);
    }

    .summary {
      display: grid;
      gap: 10px;
    }
    .summary-card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
    }
    .progress {
      height: 10px;
      background: #f1f5f9;
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid var(--border);
    }
    .progress > span {
      display: block;
      height: 100%;
      background: linear-gradient(90deg, var(--accent), #a1e89e);
      width: 0%;
      transition: width .3s ease;
    }
    .subtle {
      color: var(--muted);
      font-size: 0.92rem;
    }

    .col-hidden { display: none !important; }
    .row-hidden { display: none !important; }

    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #0f172a;
      color: #fff;
      padding: 10px 14px;
      border-radius: 999px;
      box-shadow: var(--shadow);
      opacity: 0;
      pointer-events: none;
      transition: opacity .25s ease, transform .25s ease;
      z-index: 100;
      font-size: 0.95rem;
    }
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(-6px);
      pointer-events: auto;
    }

    footer {
      max-width: 1400px;
      margin: 6px auto 24px;
      padding: 0 24px;
      color: var(--muted);
      font-size: 0.92rem;
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="title-wrap">
        <div class="app-logo" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="#f8fafc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="24" height="24">
            <rect x="3" y="3" width="7" height="7" rx="2"></rect>
            <rect x="14" y="3" width="7" height="7" rx="2"></rect>
            <rect x="14" y="14" width="7" height="7" rx="2"></rect>
            <rect x="3" y="14" width="7" height="7" rx="2"></rect>
          </svg>
        </div>
        <div>
          <h1>Employee Skills Matrix</h1>
          <div class="subtitle">Track team skills coverage and gaps</div>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn sm" id="btnExport" title="Export data" aria-label="Export matrix data">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 3v12m0 0l-4-4m4 4l4-4"/><path d="M5 21h14"/></svg>
          Export
        </button>
        <input type="file" id="fileImport" accept="application/json" style="display:none" />
        <button class="btn sm" id="btnImport" title="Import data" aria-label="Import matrix data">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 21V9m0 0l4 4m-4-4l-4 4"/><path d="M5 3h14"/></svg>
          Import
        </button>
        <button class="btn sm danger" id="btnReset" title="Reset to sample data" aria-label="Reset matrix">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 12a9 9 0 1 0 9-9"/><path d="M3 3v6h6"/></svg>
          Reset
        </button>
      </div>
    </div>
  </header>

  <main>
    <aside>
      <div class="panel-section">
        <div class="section-title">Add team members</div>
        <div class="row">
          <div class="field">
            <label for="inputEmployeeName">Employee name</label>
            <input type="text" id="inputEmployeeName" placeholder="e.g., Alice Chen" />
          </div>
          <button class="btn primary" id="btnAddEmployee" aria-label="Add employee">
            <svg viewBox="0 0 24 24" fill="none" stroke="#0b1a0b"><path d="M12 5v14M5 12h14"/></svg>
            Add
          </button>
        </div>
        <div class="hint">Tip: Add columns for each person in your team.</div>
      </div>

      <div class="panel-section">
        <div class="section-title">Add skills</div>
        <div class="field">
          <label for="inputSkillName">Skill name</label>
          <input type="text" id="inputSkillName" placeholder="e.g., JavaScript" />
        </div>
        <div class="row">
          <div class="field">
            <label for="selectSkillRequired">Required proficiency</label>
            <select id="selectSkillRequired">
              <option value="0">No requirement</option>
              <option value="1">Novice</option>
              <option value="2" selected>Intermediate</option>
              <option value="3">Advanced</option>
              <option value="4">Expert</option>
            </select>
          </div>
          <button class="btn primary" id="btnAddSkill" aria-label="Add skill">
            <svg viewBox="0 0 24 24" fill="none" stroke="#0b1a0b"><path d="M12 5v14M5 12h14"/></svg>
            Add
          </button>
        </div>
        <div class="hint">Set a target proficiency for coverage analysis.</div>
      </div>

      <div class="panel-section">
        <div class="section-title">Filters</div>
        <div class="field">
          <label for="searchSkills">Search skills</label>
          <input type="search" id="searchSkills" placeholder="Filter skills..." />
        </div>
        <div class="field">
          <label for="searchEmployees">Search employees</label>
          <input type="search" id="searchEmployees" placeholder="Filter employees..." />
        </div>
        <label class="checkbox">
          <input type="checkbox" id="toggleShowGaps" />
          <span>Show skills with gaps only</span>
        </label>
      </div>

      <div class="panel-section">
        <div class="section-title">Legend</div>
        <div class="legend" id="legendLevels"></div>
        <div class="hint" style="margin-top:8px;">Cells outlined in red are below the required level.</div>
      </div>

      <div class="panel-section">
        <div class="section-title">Coverage summary</div>
        <div class="summary">
          <div class="summary-card">
            <div class="subtle">Overall coverage</div>
            <div class="progress" aria-label="Overall coverage">
              <span id="overallCoverageBar" style="width:0%"></span>
            </div>
            <div class="pill" style="margin-top:8px;">
              Covered: <b id="overallCoverageText">0%</b>
            </div>
          </div>
          <div class="summary-card">
            <div class="subtle">Gaps</div>
            <div class="pill">
              Skills with gaps: <b id="skillsWithGapsCount">0</b>
            </div>
            <div class="pill">
              Below-required cells: <b id="belowRequiredCells">0</b>
            </div>
          </div>
        </div>
      </div>
    </aside>

    <section class="matrix-card" aria-live="polite">
      <div class="matrix-toolbar">
        <div class="toolbar-left">
          <div class="pill">
            Employees: <b id="employeeCount">0</b>
          </div>
          <div class="pill">
            Skills: <b id="skillCount">0</b>
          </div>
        </div>
        <div class="toolbar-right">
          <span class="subtle">Proficiency scale: None, Novice, Intermediate, Advanced, Expert</span>
        </div>
      </div>
      <div class="matrix-scroll" id="matrixScroll">
        <table id="matrixTable" aria-describedby="legendLevels">
          <thead id="matrixHead"></thead>
          <tbody id="matrixBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer>
    <div>Built for HR teams to visualize and close skill gaps.</div>
    <div>Tip: Export your data regularly for backup.</div>
  </footer>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
    // Level definitions
    const LEVELS = [
      { value: 0, label: 'None', css: 'prof-0', color: getComputedStyle(document.documentElement).getPropertyValue('--lv0').trim() },
      { value: 1, label: 'Novice', css: 'prof-1', color: getComputedStyle(document.documentElement).getPropertyValue('--lv1').trim() },
      { value: 2, label: 'Intermediate', css: 'prof-2', color: getComputedStyle(document.documentElement).getPropertyValue('--lv2').trim() },
      { value: 3, label: 'Advanced', css: 'prof-3', color: getComputedStyle(document.documentElement).getPropertyValue('--lv3').trim() },
      { value: 4, label: 'Expert', css: 'prof-4', color: getComputedStyle(document.documentElement).getPropertyValue('--lv4').trim() },
    ];

    // State management
    const STORAGE_KEY = 'esm-state-v1';
    let idCounter = 0;

    function uid(prefix) {
      idCounter += 1;
      return `${prefix}-${Date.now().toString(36)}-${idCounter}`;
    }

    let state = {
      version: 1,
      employees: [],
      skills: [],
      proficiencies: {} // { [skillId]: { [empId]: levelNumber } }
    };

    function sampleData() {
      const e1 = uid('emp'), e2 = uid('emp'), e3 = uid('emp'), e4 = uid('emp');
      const s1 = uid('sk'), s2 = uid('sk'), s3 = uid('sk'), s4 = uid('sk'), s5 = uid('sk');

      const employees = [
        { id: e1, name: 'Alice Chen' },
        { id: e2, name: 'Bob Martinez' },
        { id: e3, name: 'Carlos Nguyen' },
        { id: e4, name: 'Diana Patel' },
      ];
      const skills = [
        { id: s1, name: 'JavaScript', requiredLevel: 3 },
        { id: s2, name: 'HTML/CSS', requiredLevel: 3 },
        { id: s3, name: 'Project Management', requiredLevel: 2 },
        { id: s4, name: 'QA Testing', requiredLevel: 2 },
        { id: s5, name: 'HR Compliance', requiredLevel: 2 },
      ];
      const proficiencies = {};
      for (const sk of skills) {
        proficiencies[sk.id] = {};
        for (const emp of employees) {
          // randomize for demo
          proficiencies[sk.id][emp.id] = Math.floor(Math.random() * 5);
        }
      }
      return { version: 1, employees, skills, proficiencies };
    }

    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.warn('Could not save state', e);
      }
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return false;
        const data = JSON.parse(raw);
        if (!data || !data.employees || !data.skills || !data.proficiencies) return false;
        state = data;
        return true;
      } catch (e) {
        console.warn('Could not load state', e);
        return false;
      }
    }

    function resetState() {
      state = sampleData();
      saveState();
      renderAll();
      toast('Reset to sample data');
    }

    // Rendering
    const matrixHead = document.getElementById('matrixHead');
    const matrixBody = document.getElementById('matrixBody');
    const matrixTable = document.getElementById('matrixTable');

    function renderLegend() {
      const container = document.getElementById('legendLevels');
      container.innerHTML = '';
      LEVELS.forEach(lv => {
        const div = document.createElement('div');
        div.className = 'legend-item';
        div.innerHTML = `<span class="swatch" style="background:${lv.color}"></span><span>${lv.value} - ${lv.label}</span>`;
        container.appendChild(div);
      });
    }

    function renderMatrix() {
      // Header
      const headRow = document.createElement('tr');
      const firstTh = document.createElement('th');
      firstTh.innerHTML = `<div class="emp-header"><span class="emp-name">Skills (Required)</span></div>`;
      headRow.appendChild(firstTh);

      state.employees.forEach((emp, idx) => {
        const th = document.createElement('th');
        th.setAttribute('data-emp-id', emp.id);
        th.setAttribute('data-col-index', idx);
        th.id = `employee-${emp.id}`;
        th.innerHTML = `
          <div class="emp-header">
            <span class="emp-name" title="${escapeHtml(emp.name)}">${escapeHtml(emp.name)}</span>
            <span class="head-actions">
              <button class="icon-btn" id="btnRenameEmployee-${emp.id}" title="Rename ${escapeHtml(emp.name)}" aria-label="Rename employee">
                ${iconPencil()}
              </button>
              <button class="icon-btn danger" id="btnRemoveEmployee-${emp.id}" title="Remove ${escapeHtml(emp.name)}" aria-label="Remove employee">
                ${iconTrash()}
              </button>
            </span>
          </div>
        `;
        headRow.appendChild(th);
      });
      matrixHead.innerHTML = '';
      matrixHead.appendChild(headRow);

      // Body
      matrixBody.innerHTML = '';
      state.skills.forEach((sk) => {
        const tr = document.createElement('tr');
        tr.setAttribute('data-skill-id', sk.id);
        tr.id = `skill-${sk.id}`;

        const tdSkill = document.createElement('td');
        tdSkill.innerHTML = `
          <div class="skill-cell">
            <span class="skill-name" title="${escapeHtml(sk.name)}">${escapeHtml(sk.name)}</span>
            <span class="req-badge">Req:
              <select id="reqLevel-${sk.id}" aria-label="Required level for ${escapeHtml(sk.name)}">
                ${LEVELS.map(l => `<option value="${l.value}" ${l.value === sk.requiredLevel ? 'selected':''}>${l.value}</option>`).join('')}
              </select>
            </span>
            <span class="head-actions">
              <button class="icon-btn" id="btnRenameSkill-${sk.id}" title="Rename ${escapeHtml(sk.name)}" aria-label="Rename skill">${iconPencil()}</button>
              <button class="icon-btn danger" id="btnRemoveSkill-${sk.id}" title="Remove ${escapeHtml(sk.name)}" aria-label="Remove skill">${iconTrash()}</button>
            </span>
          </div>
        `;
        tr.appendChild(tdSkill);

        state.employees.forEach((emp, cidx) => {
          const td = document.createElement('td');
          td.setAttribute('data-emp-id', emp.id);
          td.setAttribute('data-col-index', cidx);

          const level = (state.proficiencies[sk.id] && state.proficiencies[sk.id][emp.id]) || 0;

          const selId = `prof-${sk.id}-${emp.id}`;
          td.innerHTML = `
            <select class="prof-select ${levelClass(level)}" id="${selId}" data-skill="${sk.id}" data-emp="${emp.id}" aria-label="${escapeHtml(emp.name)} proficiency in ${escapeHtml(sk.name)}">
              ${LEVELS.map(l => `<option value="${l.value}" ${l.value === level ? 'selected':''}>${l.value} - ${l.label}</option>`).join('')}
            </select>
          `;
          // gap highlight below required
          if (isBelowRequired(level, sk.requiredLevel)) td.classList.add('cell-gap');

          tr.appendChild(td);
        });

        matrixBody.appendChild(tr);
      });

      // Counters
      document.getElementById('employeeCount').textContent = state.employees.length;
      document.getElementById('skillCount').textContent = state.skills.length;

      applyFilters(); // Keep filters applied after render
      updateSummary();
    }

    function levelClass(value) {
      const lv = LEVELS.find(l => l.value === Number(value));
      return lv ? lv.css : '';
    }

    function isBelowRequired(level, required) {
      if (!required || required === 0) return false; // no requirement
      return Number(level) < Number(required);
    }

    function updateGapHighlightsForSkill(skillId) {
      const skill = state.skills.find(s => s.id === skillId);
      if (!skill) return;
      const row = document.getElementById(`skill-${skillId}`);
      if (!row) return;
      const cells = row.querySelectorAll('td[data-emp-id]');
      cells.forEach(td => {
        const empId = td.getAttribute('data-emp-id');
        const v = (state.proficiencies[skillId] && state.proficiencies[skillId][empId]) || 0;
        if (isBelowRequired(v, skill.requiredLevel)) td.classList.add('cell-gap');
        else td.classList.remove('cell-gap');
      });
    }

    function updateSummary() {
      // Overall coverage = average of (coverageCount/employees) across skills with requiredLevel>0
      let skillsWithReq = 0;
      let sumPercent = 0;
      let skillsWithGaps = 0;
      let belowRequiredCells = 0;

      const empCount = state.employees.length || 1;
      state.skills.forEach(sk => {
        if (sk.requiredLevel > 0) {
          skillsWithReq += 1;
          let covered = 0;
          for (const emp of state.employees) {
            const v = (state.proficiencies[sk.id] && state.proficiencies[sk.id][emp.id]) || 0;
            if (v >= sk.requiredLevel) covered += 1;
            else belowRequiredCells += 1;
          }
          const pct = covered / empCount;
          sumPercent += pct;
          if (covered < empCount) skillsWithGaps += 1;
        } else {
          // no requirement, treat as fully covered (no gaps)
        }
      });

      const overall = skillsWithReq ? Math.round((sumPercent / skillsWithReq) * 100) : 100;
      document.getElementById('overallCoverageBar').style.width = `${overall}%`;
      document.getElementById('overallCoverageText').textContent = `${overall}%`;
      document.getElementById('skillsWithGapsCount').textContent = String(skillsWithGaps);
      document.getElementById('belowRequiredCells').textContent = String(belowRequiredCells);
    }

    // Filters
    function applyFilters() {
      const skillQuery = document.getElementById('searchSkills').value.trim().toLowerCase();
      const empQuery = document.getElementById('searchEmployees').value.trim().toLowerCase();
      const showGapsOnly = document.getElementById('toggleShowGaps').checked;

      // Filter skills (rows)
      state.skills.forEach(sk => {
        const row = document.getElementById(`skill-${sk.id}`);
        if (!row) return;

        let matchesSearch = !skillQuery || sk.name.toLowerCase().includes(skillQuery);
        let hasGap = false;
        if (showGapsOnly) {
          if (sk.requiredLevel > 0) {
            for (const emp of state.employees) {
              const v = (state.proficiencies[sk.id] && state.proficiencies[sk.id][emp.id]) || 0;
              if (v < sk.requiredLevel) { hasGap = true; break; }
            }
          }
        } else {
          hasGap = true; // doesn't matter
        }

        if (matchesSearch && hasGap) {
          row.classList.remove('row-hidden');
        } else {
          row.classList.add('row-hidden');
        }
      });

      // Filter employees (columns)
      state.employees.forEach(emp => {
        const show = !empQuery || emp.name.toLowerCase().includes(empQuery);
        const cells = matrixTable.querySelectorAll(`[data-emp-id="${emp.id}"]`);
        cells.forEach(el => {
          if (show) el.classList.remove('col-hidden');
          else el.classList.add('col-hidden');
        });
      });
    }

    // Utility
    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function iconTrash() {
      return `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 6h18"/><path d="M8 6V4h8v2"/><path d="M6 6l1 14h10l1-14"/></svg>`;
    }
    function iconPencil() {
      return `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 20h9"/><path d="M16.5 3.5a2.1 2.1 0 013 3L7 19l-4 1 1-4 12.5-12.5z"/></svg>`;
    }

    function toast(msg) {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.classList.add('show');
      clearTimeout(toast._t);
      toast._t = setTimeout(() => el.classList.remove('show'), 2000);
    }

    // Actions
    function addEmployee(name) {
      const trimmed = name.trim();
      if (!trimmed) { toast('Please enter an employee name'); return; }
      const exists = state.employees.some(e => e.name.toLowerCase() === trimmed.toLowerCase());
      if (exists) { toast('Employee already exists'); return; }
      const emp = { id: uid('emp'), name: trimmed };
      state.employees.push(emp);
      // initialize proficiencies for existing skills
      for (const sk of state.skills) {
        state.proficiencies[sk.id] = state.proficiencies[sk.id] || {};
        state.proficiencies[sk.id][emp.id] = 0;
      }
      saveState();
      renderMatrix();
      toast(`Added ${emp.name}`);
    }

    function addSkill(name, requiredLevel) {
      const trimmed = name.trim();
      if (!trimmed) { toast('Please enter a skill name'); return; }
      const exists = state.skills.some(s => s.name.toLowerCase() === trimmed.toLowerCase());
      if (exists) { toast('Skill already exists'); return; }
      const skill = { id: uid('sk'), name: trimmed, requiredLevel: Number(requiredLevel) || 0 };
      state.skills.push(skill);
      state.proficiencies[skill.id] = {};
      for (const emp of state.employees) {
        state.proficiencies[skill.id][emp.id] = 0;
      }
      saveState();
      renderMatrix();
      toast(`Added skill: ${skill.name}`);
    }

    function removeEmployee(empId) {
      const emp = state.employees.find(e => e.id === empId);
      if (!emp) return;
      if (!confirm(`Remove employee "${emp.name}"? This will delete their proficiencies.`)) return;
      state.employees = state.employees.filter(e => e.id !== empId);
      // remove from proficiencies
      for (const skId in state.proficiencies) {
        delete state.proficiencies[skId][empId];
      }
      saveState();
      renderMatrix();
      toast(`Removed ${emp.name}`);
    }

    function removeSkill(skillId) {
      const sk = state.skills.find(s => s.id === skillId);
      if (!sk) return;
      if (!confirm(`Remove skill "${sk.name}" from the matrix?`)) return;
      state.skills = state.skills.filter(s => s.id !== skillId);
      delete state.proficiencies[skillId];
      saveState();
      renderMatrix();
      toast(`Removed skill: ${sk.name}`);
    }

    function renameEmployee(empId) {
      const emp = state.employees.find(e => e.id === empId);
      if (!emp) return;
      const newName = prompt('Rename employee', emp.name);
      if (newName === null) return;
      const trimmed = newName.trim();
      if (!trimmed) { toast('Name cannot be empty'); return; }
      emp.name = trimmed;
      saveState();
      renderMatrix();
      toast('Employee renamed');
    }

    function renameSkill(skillId) {
      const sk = state.skills.find(s => s.id === skillId);
      if (!sk) return;
      const newName = prompt('Rename skill', sk.name);
      if (newName === null) return;
      const trimmed = newName.trim();
      if (!trimmed) { toast('Name cannot be empty'); return; }
      sk.name = trimmed;
      saveState();
      renderMatrix();
      toast('Skill renamed');
    }

    // Event bindings
    document.getElementById('btnAddEmployee').addEventListener('click', () => {
      addEmployee(document.getElementById('inputEmployeeName').value);
      document.getElementById('inputEmployeeName').value = '';
      document.getElementById('inputEmployeeName').focus();
    });
    document.getElementById('inputEmployeeName').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        addEmployee(e.target.value);
        e.target.value = '';
      }
    });

    document.getElementById('btnAddSkill').addEventListener('click', () => {
      addSkill(
        document.getElementById('inputSkillName').value,
        document.getElementById('selectSkillRequired').value
      );
      document.getElementById('inputSkillName').value = '';
      document.getElementById('inputSkillName').focus();
    });
    document.getElementById('inputSkillName').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        addSkill(
          document.getElementById('inputSkillName').value,
          document.getElementById('selectSkillRequired').value
        );
        document.getElementById('inputSkillName').value = '';
      }
    });

    document.getElementById('searchSkills').addEventListener('input', applyFilters);
    document.getElementById('searchEmployees').addEventListener('input', applyFilters);
    document.getElementById('toggleShowGaps').addEventListener('change', applyFilters);

    // Matrix interactions via event delegation
    matrixTable.addEventListener('change', (e) => {
      const t = e.target;
      if (t.matches('.prof-select')) {
        const sk = t.getAttribute('data-skill');
        const emp = t.getAttribute('data-emp');
        const val = Number(t.value);
        state.proficiencies[sk] = state.proficiencies[sk] || {};
        state.proficiencies[sk][emp] = val;

        // Update class for color
        LEVELS.forEach(l => t.classList.remove(l.css));
        t.classList.add(levelClass(val));

        // Gap highlight on cell
        const tr = t.closest('tr');
        const td = t.closest('td');
        const skill = state.skills.find(s => s.id === sk);
        if (isBelowRequired(val, skill ? skill.requiredLevel : 0)) td.classList.add('cell-gap');
        else td.classList.remove('cell-gap');

        saveState();
        updateSummary();
      } else if (t.id.startsWith('reqLevel-')) {
        const skillId = t.id.replace('reqLevel-', '');
        const skill = state.skills.find(s => s.id === skillId);
        if (!skill) return;
        skill.requiredLevel = Number(t.value);
        saveState();
        updateGapHighlightsForSkill(skillId);
        updateSummary();
        applyFilters();
      }
    });

    matrixTable.addEventListener('click', (e) => {
      const t = e.target.closest('button');
      if (!t) return;
      const id = t.id || '';
      if (id.startsWith('btnRemoveEmployee-')) {
        const empId = id.replace('btnRemoveEmployee-', '');
        removeEmployee(empId);
      } else if (id.startsWith('btnRenameEmployee-')) {
        const empId = id.replace('btnRenameEmployee-', '');
        renameEmployee(empId);
      } else if (id.startsWith('btnRemoveSkill-')) {
        const skillId = id.replace('btnRemoveSkill-', '');
        removeSkill(skillId);
      } else if (id.startsWith('btnRenameSkill-')) {
        const skillId = id.replace('btnRenameSkill-', '');
        renameSkill(skillId);
      }
    });

    // Export / Import / Reset
    document.getElementById('btnExport').addEventListener('click', async () => {
      const data = JSON.stringify(state, null, 2);
      // Download file
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'employee-skills-matrix.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      // Copy to clipboard if possible
      try {
        await navigator.clipboard.writeText(data);
        toast('Exported + copied to clipboard');
      } catch {
        toast('Exported to file');
      }
    });

    document.getElementById('btnImport').addEventListener('click', () => {
      document.getElementById('fileImport').click();
    });
    document.getElementById('fileImport').addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          if (!data || !Array.isArray(data.employees) || !Array.isArray(data.skills) || typeof data.proficiencies !== 'object') {
            alert('Invalid file format.');
            return;
          }
          state = data;
          saveState();
          renderAll();
          toast('Data imported');
        } catch (err) {
          alert('Failed to parse JSON file.');
        } finally {
          e.target.value = '';
        }
      };
      reader.readAsText(file);
    });

    document.getElementById('btnReset').addEventListener('click', () => {
      if (confirm('Reset to sample data? This will overwrite current matrix.')) {
        resetState();
      }
    });

    function renderAll() {
      renderLegend();
      renderMatrix();
    }

    // Init
    (function init() {
      const loaded = loadState();
      if (!loaded) {
        resetState();
      } else {
        renderAll();
      }
      // Ensure scroll area fits 1280x720 comfortably
      // No-op: layout is responsive and scrollable.
    })();
  </script>
</body>
</html>