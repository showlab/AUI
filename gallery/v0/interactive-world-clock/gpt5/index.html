<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <title>Interactive World Clock</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg: #0b0f14;
      --panel: #121821;
      --panel-2: #192231;
      --text: #e8eff7;
      --muted: #a9b1bc;
      --accent: #4da3ff;
      --accent-2: #7bd389;
      --danger: #ff6b6b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);

      /* Daypart defaults (overridden per card) */
      --card-bg1: #1b2735;
      --card-bg2: #090a0f;
      --card-text: #f5f7fa;
      --chip-bg: rgba(255,255,255,.12);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol", "Noto Color Emoji", sans-serif;
      background: radial-gradient(1200px 600px at 80% -10%, #1a2540 0%, #0b0f14 55%, #080a0c 100%);
      color: var(--text);
      line-height:1.4;
    }

    header{
      position:sticky;
      top:0;
      z-index:5;
      background: linear-gradient(180deg, rgba(11,15,20,.9) 0%, rgba(11,15,20,.75) 60%, rgba(11,15,20,0) 100%);
      backdrop-filter: blur(6px);
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .container{
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px 24px;
    }
    .topbar{
      display:flex;
      align-items:center;
      gap:16px;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 240px;
    }
    .brand .logo{
      width:36px;height:36px; border-radius:10px;
      display:grid; place-items:center;
      background: conic-gradient(from 180deg at 50% 50%, #4da3ff, #7bd389, #ffd166, #ff6b6b, #4da3ff);
      color:#0b0f14;
      font-weight:800;
      text-shadow: none;
      box-shadow: var(--shadow);
    }
    .brand h1{
      font-size: clamp(18px, 2vw, 22px);
      margin:0;
      letter-spacing:.2px;
    }
    .controls{
      display:flex;
      align-items:center;
      gap:16px;
      flex-wrap:wrap;
    }

    /* Toggle */
    .toggle{
      display:flex; align-items:center; gap:10px;
      padding:8px 10px; border-radius:10px;
      background: var(--panel); border:1px solid rgba(255,255,255,.06);
    }
    .switch{
      --w: 50px; --h:28px;
      inline-size: var(--w); block-size: var(--h);
      position:relative; display:inline-block;
    }
    .switch input{display:none}
    .slider{
      position:absolute; inset:0; cursor:pointer;
      background: #2a3344;
      border-radius: 999px;
      transition: .25s ease;
      border:1px solid rgba(255,255,255,.08);
    }
    .slider:before{
      content:""; position:absolute; height:22px; width:22px;
      left:3px; top:50%; transform:translateY(-50%);
      background:white; border-radius:50%;
      transition:.25s ease; box-shadow: 0 3px 10px rgba(0,0,0,.35);
    }
    .switch input:checked + .slider{ background:#2e7ad3 }
    .switch input:checked + .slider:before{ transform: translate(22px,-50%) }

    .toggle .label{
      color: var(--muted);
      font-size: 14px;
    }

    /* Add city */
    .adder{
      display:flex; gap:8px; align-items:center;
      background: var(--panel);
      padding:8px; border-radius:12px;
      border:1px solid rgba(255,255,255,.06);
    }
    .adder input{
      width: 320px;
      max-width: 50vw;
      background: var(--panel-2);
      border:1px solid rgba(255,255,255,.08);
      color: var(--text);
      padding:10px 12px; border-radius:10px;
      outline:none;
    }
    .btn{
      appearance:none; border:none; cursor:pointer;
      padding:10px 14px; border-radius:10px;
      background: linear-gradient(180deg, #2e7ad3, #2367b3);
      color:white; font-weight:600; letter-spacing:.2px;
      box-shadow: 0 6px 16px rgba(46,122,211,.35);
      transition: transform .06s ease, filter .2s ease, opacity .2s ease;
    }
    .btn:active{ transform: translateY(1px) }
    .btn.secondary{
      background: linear-gradient(180deg, #313a4b, #262e3d);
      color:#d5deea; box-shadow: 0 6px 16px rgba(0,0,0,.25);
    }
    .btn.danger{
      background: linear-gradient(180deg, #e05252, #c03939);
      box-shadow: 0 6px 16px rgba(224,82,82,.35);
    }

    .help{
      color: var(--muted);
      padding: 6px 4px 0;
      font-size: 13px;
    }

    main{
      padding: 10px 24px 40px;
    }

    /* Grid */
    #cityGrid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      align-items: stretch;
    }

    /* Card */
    .card{
      position:relative;
      background: linear-gradient(135deg, var(--card-bg1), var(--card-bg2));
      color: var(--card-text);
      border-radius: 16px;
      padding: 14px 14px 16px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.06);
      box-shadow: var(--shadow);
      transition: transform .2s ease, box-shadow .2s ease, background .4s ease;
      min-height: 160px;
      display:flex; flex-direction:column; justify-content:space-between;
      isolation:isolate;
    }
    .card:hover{
      transform: translateY(-2px);
      box-shadow: 0 18px 40px rgba(0,0,0,.45);
    }
    .card .row-top{
      display:flex; align-items:center; justify-content:space-between;
      z-index:2;
    }
    .city-title{
      display:flex; align-items:center; gap:8px;
    }
    .city{
      font-weight:700; letter-spacing:.2px;
      font-size: 16px; margin:0;
    }
    .chip{
      font-size: 12px; padding:4px 8px; border-radius:999px;
      background: var(--chip-bg);
      color: #fff; border: 1px solid rgba(255,255,255,.18);
    }
    .remove{
      appearance:none; border:none; background: rgba(0,0,0,.2);
      color: #fff; border:1px solid rgba(255,255,255,.18);
      padding:8px; border-radius:10px; cursor:pointer;
      transition: background .2s ease, transform .06s ease, opacity .2s ease;
    }
    .remove:hover{ background: rgba(0,0,0,.32) }
    .remove:active{ transform: translateY(1px) }

    .time-row{
      display:flex; align-items:flex-end; justify-content:space-between;
      margin-top: 6px;
      z-index:2;
    }
    .time{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: clamp(28px, 5vw, 44px);
      font-weight: 800;
      letter-spacing: .5px;
      margin: 10px 0 0;
      text-shadow: 0 1px 0 rgba(0,0,0,.2);
      white-space: nowrap;
    }
    .ampm{ font-size: .45em; font-weight:700; opacity:.9; margin-left:8px }

    .sub{
      color: rgba(255,255,255,.9);
      font-size: 13px;
      margin-top: 2px;
    }
    .note{
      color: rgba(255,255,255,.8);
      font-size: 12px;
      margin-top: 2px;
    }

    .daypart{
      display:flex; align-items:center; gap:8px;
      background: var(--chip-bg);
      padding:8px 10px; border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      box-shadow: inset 0 0 40px rgba(255,255,255,.05);
    }
    .emoji{ font-size: 20px; line-height: 1 }
    .dp-label{ font-size: 13px; font-weight:700; letter-spacing:.2px }

    /* Decorative glows per card */
    .glow{
      position:absolute; inset: -30% -30% auto auto;
      width: 60%; aspect-ratio:1;
      filter: blur(40px);
      opacity:.35; z-index:1; pointer-events:none;
      transform: translate(20%, -10%);
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255,255,255,.28), transparent 60%);
      mix-blend-mode: screen;
    }

    /* Daypart themes */
    .card.morning{
      --card-bg1: #fff7bd;
      --card-bg2: #ffd98e;
      --card-text: #2b2b2b;
      --chip-bg: rgba(0,0,0,.06);
    }
    .card.afternoon{
      --card-bg1: #c2e9fb;
      --card-bg2: #a1c4fd;
      --card-text: #142033;
      --chip-bg: rgba(0,0,0,.06);
    }
    .card.evening{
      --card-bg1: #fbc2eb;
      --card-bg2: #a18cd1;
      --card-text: #201a2a;
      --chip-bg: rgba(0,0,0,.08);
    }
    .card.night{
      --card-bg1: #0f2027;
      --card-bg2: #203a43;
      --card-text: #e8eff7;
      --chip-bg: rgba(255,255,255,.12);
    }

    footer{
      color: var(--muted);
      font-size: 12px; text-align:center;
      padding: 16px 24px 28px;
    }

    /* Responsive tweaks */
    @media (max-width:720px){
      .adder input{ width: 220px }
      .time{ font-size: 32px }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="topbar" role="region" aria-label="App header and controls">
        <div class="brand">
          <div class="logo" aria-hidden="true">‚è∞</div>
          <h1 id="appTitle">Interactive World Clock</h1>
        </div>
        <div class="controls">
          <div class="toggle" aria-live="polite">
            <span class="label">Time format</span>
            <label class="switch" aria-label="Toggle 24-hour time format">
              <input id="formatToggle" type="checkbox" />
              <span class="slider"></span>
            </label>
            <span id="formatLabel" class="label" aria-hidden="true">12h</span>
          </div>
          <div class="adder" role="group" aria-label="Add city">
            <input id="cityInput" list="cityOptions" placeholder="Search city or enter IANA timezone (e.g., Europe/Paris)" autocomplete="off" aria-label="City to add" />
            <datalist id="cityOptions">
              <!-- Populated by JS -->
            </datalist>
            <button id="addCityBtn" class="btn" type="button">Add City</button>
            <button id="clearAllBtn" class="btn secondary" type="button" title="Remove all cities">Clear All</button>
          </div>
        </div>
      </div>
      <div class="help">Tip: Type a city name (e.g., Tokyo) or a timezone like America/Los_Angeles, then press Add.</div>
    </div>
  </header>

  <main class="container" role="main">
    <section id="cityGrid" role="list" aria-label="World clocks">
      <!-- Cards inserted here -->
    </section>
  </main>

  <footer>
    Built with HTML5, CSS3, and vanilla JavaScript. Times update every second. Colors and icons reflect morning, afternoon, evening, and night in each city.
  </footer>

  <script>
    "use strict";

    // ====== Data: Common cities and IANA time zones ======
    const CITY_DATA = [
      { name: "UTC (Coordinated Universal Time)", tz: "UTC" },
      { name: "Reykjavik, Iceland", tz: "Atlantic/Reykjavik" },
      { name: "Casablanca, Morocco", tz: "Africa/Casablanca" },
      { name: "London, United Kingdom", tz: "Europe/London" },
      { name: "Dublin, Ireland", tz: "Europe/Dublin" },
      { name: "Lisbon, Portugal", tz: "Europe/Lisbon" },
      { name: "Madrid, Spain", tz: "Europe/Madrid" },
      { name: "Paris, France", tz: "Europe/Paris" },
      { name: "Brussels, Belgium", tz: "Europe/Brussels" },
      { name: "Amsterdam, Netherlands", tz: "Europe/Amsterdam" },
      { name: "Berlin, Germany", tz: "Europe/Berlin" },
      { name: "Rome, Italy", tz: "Europe/Rome" },
      { name: "Zurich, Switzerland", tz: "Europe/Zurich" },
      { name: "Vienna, Austria", tz: "Europe/Vienna" },
      { name: "Stockholm, Sweden", tz: "Europe/Stockholm" },
      { name: "Oslo, Norway", tz: "Europe/Oslo" },
      { name: "Copenhagen, Denmark", tz: "Europe/Copenhagen" },
      { name: "Warsaw, Poland", tz: "Europe/Warsaw" },
      { name: "Athens, Greece", tz: "Europe/Athens" },
      { name: "Helsinki, Finland", tz: "Europe/Helsinki" },
      { name: "Istanbul, T√ºrkiye", tz: "Europe/Istanbul" },
      { name: "Moscow, Russia", tz: "Europe/Moscow" },
      { name: "Jerusalem, Israel", tz: "Asia/Jerusalem" },
      { name: "Cairo, Egypt", tz: "Africa/Cairo" },
      { name: "Nairobi, Kenya", tz: "Africa/Nairobi" },
      { name: "Johannesburg, South Africa", tz: "Africa/Johannesburg" },
      { name: "Dubai, UAE", tz: "Asia/Dubai" },
      { name: "Riyadh, Saudi Arabia", tz: "Asia/Riyadh" },
      { name: "Tehran, Iran", tz: "Asia/Tehran" },
      { name: "Kabul, Afghanistan", tz: "Asia/Kabul" },
      { name: "Karachi, Pakistan", tz: "Asia/Karachi" },
      { name: "Delhi, India", tz: "Asia/Kolkata" },
      { name: "Kathmandu, Nepal", tz: "Asia/Kathmandu" },
      { name: "Dhaka, Bangladesh", tz: "Asia/Dhaka" },
      { name: "Bangkok, Thailand", tz: "Asia/Bangkok" },
      { name: "Jakarta, Indonesia", tz: "Asia/Jakarta" },
      { name: "Singapore, Singapore", tz: "Asia/Singapore" },
      { name: "Kuala Lumpur, Malaysia", tz: "Asia/Kuala_Lumpur" },
      { name: "Hong Kong, China", tz: "Asia/Hong_Kong" },
      { name: "Taipei, Taiwan", tz: "Asia/Taipei" },
      { name: "Manila, Philippines", tz: "Asia/Manila" },
      { name: "Seoul, South Korea", tz: "Asia/Seoul" },
      { name: "Tokyo, Japan", tz: "Asia/Tokyo" },
      { name: "Sydney, Australia", tz: "Australia/Sydney" },
      { name: "Melbourne, Australia", tz: "Australia/Melbourne" },
      { name: "Adelaide, Australia", tz: "Australia/Adelaide" },
      { name: "Perth, Australia", tz: "Australia/Perth" },
      { name: "Auckland, New Zealand", tz: "Pacific/Auckland" },
      { name: "Honolulu, USA", tz: "Pacific/Honolulu" },
      { name: "Anchorage, USA", tz: "America/Anchorage" },
      { name: "Los Angeles, USA", tz: "America/Los_Angeles" },
      { name: "Phoenix, USA", tz: "America/Phoenix" },
      { name: "Denver, USA", tz: "America/Denver" },
      { name: "Chicago, USA", tz: "America/Chicago" },
      { name: "New York, USA", tz: "America/New_York" },
      { name: "Toronto, Canada", tz: "America/Toronto" },
      { name: "Vancouver, Canada", tz: "America/Vancouver" },
      { name: "Mexico City, Mexico", tz: "America/Mexico_City" },
      { name: "Bogot√°, Colombia", tz: "America/Bogota" },
      { name: "Lima, Peru", tz: "America/Lima" },
      { name: "Santiago, Chile", tz: "America/Santiago" },
      { name: "Buenos Aires, Argentina", tz: "America/Argentina/Buenos_Aires" },
      { name: "S√£o Paulo, Brazil", tz: "America/Sao_Paulo" }
    ];

    // ====== State ======
    const LS_KEYS = {
      cities: "iwc-cities",
      format24h: "iwc-24h"
    };

    const defaultCities = [
      { name: "New York, USA", tz: "America/New_York" },
      { name: "London, United Kingdom", tz: "Europe/London" },
      { name: "Tokyo, Japan", tz: "Asia/Tokyo" },
      { name: "Sydney, Australia", tz: "Australia/Sydney" }
    ];

    let cities = []; // {id,name,tz}
    const domIndex = new Map(); // id -> { card, timeEl, ampmEl, subEl, noteEl, iconEl }

    // ====== Elements ======
    const grid = document.getElementById("cityGrid");
    const formatToggle = document.getElementById("formatToggle");
    const formatLabel = document.getElementById("formatLabel");
    const cityInput = document.getElementById("cityInput");
    const addCityBtn = document.getElementById("addCityBtn");
    const clearAllBtn = document.getElementById("clearAllBtn");
    const datalist = document.getElementById("cityOptions");

    // ====== Helpers ======
    function safeIdFromTZ(tz){
      return tz.replace(/[^a-zA-Z0-9]/g, "_");
    }

    function setLocalStorage(key, value){
      try { localStorage.setItem(key, JSON.stringify(value)); } catch(e){}
    }
    function getLocalStorage(key, fallback){
      try {
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : fallback;
      } catch(e){ return fallback; }
    }

    function isValidTimeZone(tz){
      try { new Intl.DateTimeFormat('en-US', { timeZone: tz }).format(); return true; }
      catch(e){ return false; }
    }

    function getHourInTZ(date, tz){
      const s = new Intl.DateTimeFormat('en-US', { hour: 'numeric', hour12: false, timeZone: tz }).format(date);
      return parseInt(s, 10);
    }

    function getDayPart(hour){
      if (hour >= 5 && hour < 12) return "morning";
      if (hour >= 12 && hour < 17) return "afternoon";
      if (hour >= 17 && hour < 21) return "evening";
      return "night";
    }

    function dayPartIcon(dp){
      switch(dp){
        case "morning": return "üåÖ";
        case "afternoon": return "‚òÄÔ∏è";
        case "evening": return "üåá";
        case "night": return "üåô";
        default: return "üïí";
      }
    }

    function formatTime(date, tz, is24h){
      if (is24h){
        // Use en-GB for 24h formatting
        const str = new Intl.DateTimeFormat('en-GB', {
          timeZone: tz, hour12: false,
          hour: '2-digit', minute: '2-digit', second:'2-digit'
        }).format(date);
        return { time: str, ampm: "" };
      } else {
        // Use en-US for consistent AM/PM
        const str = new Intl.DateTimeFormat('en-US', {
          timeZone: tz, hour12: true,
          hour: '2-digit', minute: '2-digit', second:'2-digit'
        }).format(date); // e.g., "11:05:34 PM"
        // Split AM/PM
        const parts = str.split(" ");
        const ampm = parts.pop();
        const t = parts.join(" ");
        return { time: t, ampm };
      }
    }

    function formatDateLine(date, tz){
      const df = new Intl.DateTimeFormat(undefined, {
        timeZone: tz,
        weekday: 'short', month: 'short', day: '2-digit'
      });
      return df.format(date); // e.g., "Tue, Sep 03"
    }

    function ymd(date, tz){
      return new Intl.DateTimeFormat('en-CA', {
        timeZone: tz,
        year:'numeric', month:'2-digit', day:'2-digit'
      }).format(date); // YYYY-MM-DD
    }

    function relativeDayNote(date, tz){
      const local = ymd(date, Intl.DateTimeFormat().resolvedOptions().timeZone);
      const remote = ymd(date, tz);
      if (local === remote) return "Today";
      // Compare as dates
      const toDate = s => new Date(s + "T00:00:00Z").getTime();
      const diff = (toDate(remote) - toDate(local)) / (1000*60*60*24);
      if (diff === 1) return "Tomorrow";
      if (diff === -1) return "Yesterday";
      return "";
    }

    function createCard(city){
      const id = city.id;
      const card = document.createElement("article");
      card.className = "card night"; // default, will update
      card.setAttribute("role", "listitem");
      card.id = "city-card-" + id;
      card.dataset.tz = city.tz;

      const top = document.createElement("div");
      top.className = "row-top";

      const titleWrap = document.createElement("div");
      titleWrap.className = "city-title";
      const h = document.createElement("h2");
      h.className = "city";
      h.textContent = city.name;
      const chip = document.createElement("span");
      chip.className = "chip";
      chip.textContent = city.tz;
      titleWrap.append(h, chip);

      const remove = document.createElement("button");
      remove.className = "remove";
      remove.id = "removeBtn-" + id;
      remove.type = "button";
      remove.setAttribute("aria-label", `Remove ${city.name}`);
      remove.innerText = "Remove";
      remove.addEventListener("click", () => removeCity(city.id));

      top.append(titleWrap, remove);

      const timeRow = document.createElement("div");
      timeRow.className = "time-row";

      const timeEl = document.createElement("div");
      timeEl.className = "time";
      timeEl.id = "time-" + id;

      const ampmEl = document.createElement("span");
      ampmEl.className = "ampm";
      ampmEl.id = "ampm-" + id;

      timeEl.appendChild(ampmEl); // AM/PM lives as child (we'll set text on update, but keep structure)
      // We'll insert text into timeEl firstChild via update

      const dp = document.createElement("div");
      dp.className = "daypart";
      const ico = document.createElement("span");
      ico.className = "emoji";
      ico.id = "icon-" + id;
      ico.setAttribute("aria-hidden", "true");
      const label = document.createElement("span");
      label.className = "dp-label";
      label.id = "dp-" + id;
      dp.append(ico, label);

      timeRow.append(timeEl, dp);

      const sub = document.createElement("div");
      sub.className = "sub";
      sub.id = "sub-" + id;

      const note = document.createElement("div");
      note.className = "note";
      note.id = "note-" + id;

      const glow = document.createElement("div");
      glow.className = "glow";

      card.append(top, timeRow, sub, note, glow);

      grid.appendChild(card);

      domIndex.set(id, {
        card, timeEl, ampmEl, subEl: sub, noteEl: note, iconEl: ico, daypartLabelEl: label
      });
    }

    function updateCard(city, now, is24h){
      const ref = domIndex.get(city.id);
      if (!ref) return;
      const { card, timeEl, ampmEl, subEl, noteEl, iconEl, daypartLabelEl } = ref;

      // Time
      const fmt = formatTime(now, city.tz, is24h);
      // Put the time text (without AM/PM) into the time element, then append AM/PM span
      // We manage by setting innerHTML carefully to keep ampm span at end
      timeEl.textContent = fmt.time;
      if (fmt.ampm){
        const am = document.createElement("span");
        am.className = "ampm";
        am.textContent = fmt.ampm;
        timeEl.appendChild(am);
      }

      // Sub line (date)
      subEl.textContent = formatDateLine(now, city.tz);

      // Relative day note
      const rel = relativeDayNote(now, city.tz);
      noteEl.textContent = rel;

      // Day part visuals
      const hour = getHourInTZ(now, city.tz);
      const dp = getDayPart(hour);
      card.classList.remove("morning","afternoon","evening","night");
      card.classList.add(dp);
      iconEl.textContent = dayPartIcon(dp);
      daypartLabelEl.textContent = dp.charAt(0).toUpperCase() + dp.slice(1);
    }

    function renderAll(){
      // Clear
      grid.innerHTML = "";
      domIndex.clear();

      for (const c of cities){
        createCard(c);
      }
      // Immediately update display
      tick();
    }

    function tick(){
      const now = new Date();
      const is24h = !!formatToggle.checked;
      for (const c of cities){
        updateCard(c, now, is24h);
      }
      formatLabel.textContent = is24h ? "24h" : "12h";
    }

    let timer = null;
    function startTimer(){
      if (timer) clearInterval(timer);
      timer = setInterval(tick, 1000);
      tick();
    }

    function addCityByTZ(tz, displayName){
      if (!isValidTimeZone(tz)){
        alert("Invalid timezone. Please enter a valid IANA timezone such as Europe/Paris.");
        return;
      }
      const id = safeIdFromTZ(tz);
      if (cities.find(c => c.id === id)){
        // Already exists, focus it briefly
        pulseCard(id);
        return;
      }
      const name = displayName || (CITY_DATA.find(c => c.tz === tz)?.name) || tz;
      const city = { id, name, tz };
      cities.push(city);
      setLocalStorage(LS_KEYS.cities, cities);
      createCard(city);
      tick();
      pulseCard(id);
    }

    function pulseCard(id){
      const ref = domIndex.get(id);
      if (!ref) return;
      const { card } = ref;
      card.style.outline = "2px solid rgba(255,255,255,.7)";
      card.style.outlineOffset = "2px";
      setTimeout(()=>{ card.style.outline = "none"; card.style.outlineOffset = "0"; }, 600);
    }

    function removeCity(id){
      cities = cities.filter(c => c.id !== id);
      setLocalStorage(LS_KEYS.cities, cities);
      const ref = domIndex.get(id);
      if (ref){
        ref.card.style.opacity = "0";
        ref.card.style.transform = "scale(.98)";
        setTimeout(()=> {
          ref.card.remove();
          domIndex.delete(id);
        }, 180);
      }
    }

    function clearAll(){
      if (!cities.length) return;
      if (!confirm("Remove all cities?")) return;
      cities = [];
      setLocalStorage(LS_KEYS.cities, cities);
      renderAll();
    }

    function parseInput(value){
      if (!value) return null;
      const v = value.trim();
      // If value contains a timezone in parentheses, extract it
      const m = v.match(/\(([^)]+)\)$/);
      if (m && m[1]) {
        return { tz: m[1], name: v.replace(/\s*\([^)]+\)\s*$/, "") };
      }
      // If matches known city by name (case-insensitive prefix or full)
      const match = CITY_DATA.find(c => c.name.toLowerCase() === v.toLowerCase());
      if (match) return { tz: match.tz, name: match.name };
      // If value looks like an IANA TZ
      if (/^[A-Za-z_]+\/[A-Za-z0-9_\-+]+(?:\/[A-Za-z0-9_\-+]+)?$/.test(v)) {
        return { tz: v, name: CITY_DATA.find(c => c.tz === v)?.name || v };
      }
      // Try partial match on city list
      const partial = CITY_DATA.find(c => c.name.toLowerCase().includes(v.toLowerCase()));
      if (partial) return { tz: partial.tz, name: partial.name };

      return null;
    }

    function populateDatalist(){
      datalist.innerHTML = "";
      for (const c of CITY_DATA){
        const opt = document.createElement("option");
        opt.value = `${c.name} (${c.tz})`;
        datalist.appendChild(opt);
      }
    }

    function init(){
      // Populate datalist
      populateDatalist();

      // Load format
      const savedFmt = getLocalStorage(LS_KEYS.format24h, false);
      formatToggle.checked = !!savedFmt;
      formatToggle.addEventListener("change", () => {
        setLocalStorage(LS_KEYS.format24h, !!formatToggle.checked);
        tick();
      });

      // Load cities
      const saved = getLocalStorage(LS_KEYS.cities, null);
      if (saved && Array.isArray(saved) && saved.length){
        cities = saved;
      } else {
        cities = defaultCities.map(c => ({ id: safeIdFromTZ(c.tz), ...c }));
        setLocalStorage(LS_KEYS.cities, cities);
      }

      renderAll();
      startTimer();

      // Add city handlers
      const addFromInput = () => {
        const parsed = parseInput(cityInput.value);
        if (!parsed){
          alert("City or timezone not recognized. Try selecting from suggestions or enter a valid timezone like Europe/Paris.");
          cityInput.focus();
          return;
        }
        addCityByTZ(parsed.tz, parsed.name);
        cityInput.value = "";
        cityInput.focus();
      };

      addCityBtn.addEventListener("click", addFromInput);
      cityInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          addFromInput();
        }
      });

      clearAllBtn.addEventListener("click", clearAll);

      // Accessibility: announce live updates for time format label
      formatLabel.textContent = formatToggle.checked ? "24h" : "12h";
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>