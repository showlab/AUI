<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Virtual Drum Kit</title>
  <style>
    :root{
      --bg-1:#0e0f13;
      --bg-2:#181a22;
      --accent:#22d1ee;
      --accent-2:#ff7a59;
      --panel:#1f2330;
      --panel-2:#2a3042;
      --text:#e6e8ef;
      --muted:#9aa0ad;
      --good:#30d158;
      --warn:#ff453a;
      --focus:#8bd3dd;
      --rim:#0b0d12;
      --shadow: rgba(0,0,0,0.35);
    }
    *{box-sizing:border-box}
    html, body {
      margin:0;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(34,209,238,0.08), transparent 60%),
        radial-gradient(900px 520px at 80% -20%, rgba(255,122,89,0.08), transparent 60%),
        linear-gradient(180deg, var(--bg-2), var(--bg-1));
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      min-height:100%;
      overflow-x:hidden;
    }
    header{
      padding:16px 20px;
      position:sticky; top:0; z-index:10;
      background: linear-gradient(180deg, rgba(15,16,22,0.9), rgba(15,16,22,0.4));
      backdrop-filter: blur(6px);
      border-bottom:1px solid rgba(255,255,255,0.06);
    }
    .container{max-width:1200px; margin:0 auto; padding:0 12px}
    .header-bar{display:flex; align-items:center; gap:16px; justify-content:space-between}
    .brand{display:flex; align-items:center; gap:12px}
    .brand .logo{
      width:36px; height:36px; border-radius:50%;
      background:
        radial-gradient(60% 60% at 35% 30%, rgba(255,255,255,0.35), transparent),
        radial-gradient(120% 120% at 70% 80%, rgba(34,209,238,0.4), rgba(255,122,89,0.2)),
        conic-gradient(from 200deg at 50% 50%, #1e90ff, #8a2be2, #ff7a59, #ffd166, #1e90ff);
      box-shadow: 0 6px 20px rgba(34,209,238,0.25), inset 0 0 0 2px rgba(255,255,255,0.07);
    }
    .brand h1{font-size:20px; letter-spacing:0.4px; margin:0}
    .tagline{font-size:12px; color:var(--muted)}
    .help-actions{display:flex; gap:8px; align-items:center}
    button, input, select {
      color:inherit;
      font:inherit;
    }
    button {
      border:0; background:var(--panel);
      color:var(--text);
      border-radius:10px;
      padding:10px 14px;
      cursor:pointer;
      box-shadow: 0 1px 0 rgba(255,255,255,0.05) inset, 0 8px 24px rgba(0,0,0,0.25);
      transition: transform .04s ease, background .2s ease, box-shadow .2s ease, color .2s ease;
      user-select:none; touch-action: manipulation;
    }
    button:hover { background:var(--panel-2) }
    button:active { transform:translateY(1px) scale(0.99) }
    button:focus-visible { outline: 2px solid var(--focus); outline-offset:2px }
    .btn-icon {
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn-red { background: linear-gradient(180deg, #2a1e22, #211317); color:#ffdede; }
    .btn-red.active, .btn-red[aria-pressed="true"] { background: linear-gradient(180deg, #3a1518, #2a0f12); box-shadow: 0 0 0 1px rgba(255,69,58,0.35) inset, 0 0 18px rgba(255,69,58,0.22) }
    .btn-green { background: linear-gradient(180deg, #1e2a22, #122014); color:#dcffe4; }
    .btn-green.active { box-shadow: 0 0 0 1px rgba(48,209,88,0.35) inset, 0 0 18px rgba(48,209,88,0.22) }
    .controls-wrap{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;
    }

    main{padding:24px 0 40px}
    .studio{
      margin:0 auto;
      max-width:1200px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.06);
      border-radius:18px;
      box-shadow: 0 40px 100px rgba(0,0,0,0.45), inset 0 1px 0 rgba(255,255,255,0.04);
      overflow:hidden;
    }
    .top-panel{
      display:flex; gap:16px; align-items:center; justify-content:space-between;
      padding:14px 16px;
      background: linear-gradient(180deg, #1b1f2a, #171b25);
      border-bottom:1px solid rgba(255,255,255,0.06);
    }
    .transport{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .transport .led{
      width:10px; height:10px; border-radius:50%;
      background:#30343f; box-shadow: 0 0 0 1px rgba(0,0,0,0.4) inset;
      margin-right:6px;
    }
    .transport .led.on { background: var(--warn); box-shadow: 0 0 0 1px rgba(255,69,58,0.6) inset, 0 0 12px rgba(255,69,58,0.6) }
    .status{
      display:flex; align-items:center; gap:10px;
      color:var(--muted); font-size:13px;
      white-space:nowrap;
    }
    .meters{
      display:flex; align-items:center; gap:18px; flex-wrap:wrap;
    }
    .meter-group{display:flex; align-items:center; gap:10px}
    .meter-group label{font-size:12px; color:var(--muted)}
    .range{
      appearance:none; width:180px; height:8px; border-radius:999px; background:#2a3042; outline:none;
      box-shadow: inset 0 2px 6px rgba(0,0,0,0.4), 0 1px 0 rgba(255,255,255,0.06);
    }
    .range::-webkit-slider-thumb{
      -webkit-appearance:none; appearance:none;
      width:18px; height:18px; border-radius:50%;
      background: radial-gradient(50% 50% at 30% 30%, rgba(255,255,255,0.5), rgba(255,255,255,0.1)), linear-gradient(180deg, #3b9bd6, #1f6fb3);
      border:1px solid rgba(255,255,255,0.5);
      box-shadow: 0 6px 14px rgba(31,111,179,0.45);
      cursor:pointer;
    }
    .range::-moz-range-thumb{
      width:18px; height:18px; border-radius:50%;
      background: radial-gradient(50% 50% at 30% 30%, rgba(255,255,255,0.5), rgba(255,255,255,0.1)), linear-gradient(180deg, #3b9bd6, #1f6fb3);
      border:1px solid rgba(255,255,255,0.5);
      box-shadow: 0 6px 14px rgba(31,111,179,0.45);
      cursor:pointer;
    }

    .stage{
      display:grid;
      grid-template-columns: 1fr;
      gap:24px;
      padding:20px;
      background:
        radial-gradient(900px 240px at 50% -10%, rgba(34,209,238,0.10), rgba(0,0,0,0) 70%),
        linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.015));
    }
    .pad-grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(110px, 1fr));
      gap:18px;
      max-width:980px;
      margin:0 auto;
    }

    .pad {
      position:relative;
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px;
      border-radius:50%;
      aspect-ratio: 1 / 1;
      min-width:110px;
      padding:12px;
      background:
        radial-gradient(50% 50% at 50% 40%, rgba(255,255,255,0.18), rgba(255,255,255,0.06) 60%, rgba(255,255,255,0.02)),
        linear-gradient(180deg, #2b3145, #202536);
      box-shadow:
        inset 0 1px 3px rgba(255,255,255,0.12),
        inset 0 -4px 15px rgba(0,0,0,0.6),
        0 20px 30px var(--shadow);
      border: 2px solid rgba(255,255,255,0.06);
      user-select:none;
      touch-action: manipulation;
      cursor:pointer;
      transition: transform .06s ease, box-shadow .12s ease, filter .1s ease;
      outline: none;
    }
    .pad:focus-visible { box-shadow: inset 0 1px 3px rgba(255,255,255,0.12), inset 0 -4px 15px rgba(0,0,0,0.6), 0 0 0 3px var(--focus), 0 20px 30px var(--shadow) }
    .pad .rim {
      content:"";
      position:absolute; inset: -6px;
      border-radius:50%;
      border:6px solid var(--rim);
      opacity:0.9;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.05), 0 8px 20px rgba(0,0,0,0.6);
      pointer-events:none;
    }
    .pad .head {
      position:absolute; inset: 10%; border-radius:50%;
      background:
        radial-gradient(60% 50% at 50% 40%, rgba(255,255,255,0.35), rgba(255,255,255,0.08) 50%, rgba(255,255,255,0.02)),
        linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06));
      box-shadow: inset 0 8px 30px rgba(0,0,0,0.55), inset 0 0 0 2px rgba(255,255,255,0.08);
      pointer-events:none;
    }
    .pad .label { position:relative; z-index:2; font-weight:600; letter-spacing:0.3px; text-align:center }
    .pad .small { font-size:12px; color:var(--muted) }
    .pad .keycap{
      font-size:11px; padding:3px 7px; border-radius:8px; background:rgba(0,0,0,0.35);
      border:1px solid rgba(255,255,255,0.08); box-shadow: inset 0 1px 0 rgba(255,255,255,0.05);
      color:#d7e7ff; letter-spacing:0.5px;
    }
    .pad.active{
      transform: translateY(2px) scale(0.985);
      filter: brightness(1.08);
      box-shadow: inset 0 1px 3px rgba(255,255,255,0.12), inset 0 -4px 15px rgba(0,0,0,0.6), 0 10px 18px rgba(0,0,0,0.45), 0 0 0 4px rgba(255,255,255,0.04);
    }
    .pad .pulse{
      position:absolute; width:40%; aspect-ratio:1/1; border-radius:50%; pointer-events:none; opacity:0; transform:scale(0.6);
      background: radial-gradient(50% 50% at 50% 50%, rgba(255,255,255,0.45), rgba(255,255,255,0.05));
    }
    .pad.active .pulse{ animation: pulse .25s ease-out }
    @keyframes pulse {
      from { opacity:0.75; transform:scale(0.65) }
      to { opacity:0; transform:scale(1.6) }
    }

    .legend{
      text-align:center; color:var(--muted); font-size:13px;
    }
    .bottom-panel{
      padding:12px 16px; display:flex; align-items:center; gap:16px; justify-content:space-between;
      background: linear-gradient(180deg, #171b25, #141823);
      border-top:1px solid rgba(255,255,255,0.06);
    }
    .rec-info{
      display:flex; gap:14px; align-items:center; color:var(--muted); font-size:13px;
      min-height:24px;
    }
    .rec-indicator{
      display:inline-flex; align-items:center; gap:8px;
      padding:4px 8px; border-radius:999px;
      background:#242833; border:1px solid rgba(255,255,255,0.06)
    }
    .rec-dot{
      width:10px; height:10px; border-radius:50%; background:#4b505e; box-shadow: 0 0 0 1px rgba(0,0,0,0.35) inset
    }
    .rec-dot.on{ background: var(--warn); box-shadow: 0 0 0 1px rgba(255,69,58,0.6) inset, 0 0 10px rgba(255,69,58,0.8) }
    .progress-wrap{
      flex:1; height:6px; border-radius:999px; background:#272c3d; overflow:hidden; box-shadow: inset 0 1px 2px rgba(0,0,0,0.35)
    }
    .progress-bar{
      height:100%; width:0%; background: linear-gradient(90deg, #4ba3ff, #22d1ee);
      box-shadow: 0 8px 16px rgba(34,209,238,0.35);
      transition:width .1s linear;
    }

    .pill{
      padding:6px 10px; border-radius:8px; background:#242833; border:1px solid rgba(255,255,255,0.06); color:#c9cfdb; font-size:12px
    }
    .kbd{
      display:inline-block; min-width:1.5em; padding:1px 6px; border-radius:6px; background:#161923; border:1px solid rgba(255,255,255,0.12);
      color:#d7e7ff; font-weight:600; font-size:12px; letter-spacing:0.4px;
    }

    footer{
      color:var(--muted);
      font-size:12px; text-align:center; padding:14px; opacity:0.9
    }

    .color-ring{
      position:absolute; inset:-2px; border-radius:50%; pointer-events:none; mix-blend-mode:screen; opacity:0.6;
      background: conic-gradient(from 180deg, transparent, transparent, rgba(255,255,255,0.25), transparent);
      filter: blur(6px);
    }

    /* Responsive */
    @media (min-width: 780px){
      .stage{padding:24px}
      .pad-grid{
        grid-template-columns: repeat(5, minmax(120px, 1fr));
        gap:22px;
      }
      /* visual layout: place pads to resemble a kit (CSS grid areas for order) */
      #pad-crash { grid-column: 1 / span 1 }
      #pad-tom-high { grid-column: 2 / span 1 }
      #pad-ride { grid-column: 5 / span 1 }
      #pad-hihat-closed { grid-column: 1 / span 1 }
      #pad-snare { grid-column: 2 / span 1 }
      #pad-tom-low { grid-column: 4 / span 1 }
      #pad-hihat-open { grid-column: 1 / span 1 }
      #pad-clap { grid-column: 3 / span 1 }
      #pad-kick { grid-column: 3 / span 1 }
    }

    /* Accessibility helper for visually hidden text if needed */
    .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}

    /* Help modal */
    .modal {
      position: fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:50;
      background: rgba(0,0,0,0.55); backdrop-filter: blur(2px);
    }
    .modal[open]{ display:flex }
    .modal-card{
      width:min(680px, 92vw); max-height:80vh; overflow:auto;
      background: linear-gradient(180deg, #1a1f2b, #151a25);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:12px;
      padding:16px;
      box-shadow: 0 30px 80px rgba(0,0,0,0.6);
    }
    .modal-card h3{ margin:0 0 8px }
    .modal-grid{ display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; margin-top:8px }
    .modal-grid div{ background:#1d2230; border:1px solid rgba(255,255,255,0.06); border-radius:10px; padding:10px; font-size:14px }
    .modal-grid b{ display:block; margin-bottom:4px }
    .modal-actions{ display:flex; justify-content:flex-end; margin-top:10px }
  </style>
</head>
<body>
  <header>
    <div class="container header-bar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Virtual Drum Kit</h1>
          <div class="tagline">Play with keyboard or tap the pads. Record and play back your beats.</div>
        </div>
      </div>
      <div class="help-actions">
        <button id="btn-help" class="btn-icon" type="button" aria-haspopup="dialog" aria-controls="help-modal">
          <span aria-hidden="true">‚ùì</span> Help
        </button>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="studio" aria-label="Drum Studio">
      <div class="top-panel">
        <div class="transport">
          <div class="led" id="power-led" aria-hidden="true"></div>
          <button id="btn-record" class="btn-icon btn-red" type="button" aria-pressed="false">
            <span aria-hidden="true">‚è∫</span> Record
          </button>
          <button id="btn-play" class="btn-icon btn-green" type="button" disabled>
            <span aria-hidden="true">‚ñ∂</span> Play
          </button>
          <button id="btn-stop" class="btn-icon" type="button" disabled>
            <span aria-hidden="true">‚èπ</span> Stop
          </button>
          <button id="btn-clear" class="btn-icon" type="button" disabled title="Clear recording">
            <span aria-hidden="true">üóë</span> Clear
          </button>
          <div class="status" id="display-status" aria-live="polite">
            Ready
          </div>
        </div>
        <div class="meters">
          <div class="meter-group">
            <label for="slider-volume">Master</label>
            <input id="slider-volume" class="range" type="range" min="0" max="100" value="80" />
          </div>
          <div class="meter-group">
            <label for="slider-tempo">Tempo</label>
            <input id="slider-tempo" class="range" type="range" min="60" max="180" value="120" />
            <span id="tempo-readout" class="pill">120 BPM</span>
          </div>
        </div>
      </div>

      <div class="stage">
        <div class="pad-grid" role="group" aria-label="Drum pads">
          <button id="pad-crash" class="pad" data-drum="crash" aria-label="Crash cymbal (Key U)">
            <div class="rim"></div>
            <div class="head"></div>
            <div class="color-ring"></div>
            <span class="label">Crash</span>
            <span class="small"><span class="keycap">U</span></span>
            <div class="pulse"></div>
          </button>

          <button id="pad-tom-high" class="pad" data-drum="tom-high" aria-label="High tom (Key Y)">
            <div class="rim"></div>
            <div class="head"></div>
            <div class="color-ring"></div>
            <span class="label">High Tom</span>
            <span class="small"><span class="keycap">Y</span></span>
            <div class="pulse"></div>
          </button>

          <button id="pad-ride" class="pad" data-drum="ride" aria-label="Ride cymbal (Key O)">
            <div class="rim"></div>
            <div class="head"></div>
            <div class="color-ring"></div>
            <span class="label">Ride</span>
            <span class="small"><span class="keycap">O</span></span>
            <div class="pulse"></div>
          </button>

          <button id="pad-hihat-closed" class="pad" data-drum="hihat-closed" aria-label="Closed hi-hat (Key F)">
            <div class="rim"></div>
            <div class="head"></div>
            <div class="color-ring"></div>
            <span class="label">Hi-Hat Closed</span>
            <span class="small"><span class="keycap">F</span></span>
            <div class="pulse"></div>
          </button>

          <button id="pad-snare" class="pad" data-drum="snare" aria-label="Snare (Key J)">
            <div class="rim"></div>
            <div class="head"></div>
            <div class="color-ring"></div>
            <span class="label">Snare</span>
            <span class="small"><span class="keycap">J</span></span>
            <div class="pulse"></div>
          </button>

          <button id="pad-tom-low" class="pad" data-drum="tom-low" aria-label="Low tom (Key H)">
            <div class="rim"></div>
            <div class="head"></div>
            <div class="color-ring"></div>
            <span class="label">Low Tom</span>
            <span class="small"><span class="keycap">H</span></span>
            <div class="pulse"></div>
          </button>

          <button id="pad-hihat-open" class="pad" data-drum="hihat-open" aria-label="Open hi-hat (Key G)">
            <div class="rim"></div>
            <div class="head"></div>
            <div class="color-ring"></div>
            <span class="label">Hi-Hat Open</span>
            <span class="small"><span class="keycap">G</span></span>
            <div class="pulse"></div>
          </button>

          <button id="pad-clap" class="pad" data-drum="clap" aria-label="Clap (Key N)">
            <div class="rim"></div>
            <div class="head"></div>
            <div class="color-ring"></div>
            <span class="label">Clap</span>
            <span class="small"><span class="keycap">N</span></span>
            <div class="pulse"></div>
          </button>

          <button id="pad-kick" class="pad" data-drum="kick" aria-label="Kick (Key V or Space)">
            <div class="rim"></div>
            <div class="head"></div>
            <div class="color-ring"></div>
            <span class="label">Kick</span>
            <span class="small"><span class="keycap">V</span> / <span class="keycap">Space</span></span>
            <div class="pulse"></div>
          </button>
        </div>
        <div class="legend">
          Tip: Use your keyboard to play. Example mapping ‚Äî F: Closed Hat, G: Open Hat, J: Snare, V/Space: Kick.
        </div>
      </div>

      <div class="bottom-panel">
        <div class="rec-info">
          <span class="rec-indicator">
            <span id="rec-dot" class="rec-dot" aria-hidden="true"></span>
            <span id="recording-state">Idle</span>
          </span>
          <span id="display-events-count" class="pill" title="Number of recorded notes">0 events</span>
          <span id="display-recording-length" class="pill" title="Recording length">00:00.000</span>
        </div>
        <div class="progress-wrap" aria-label="Playback progress">
          <div id="record-progress" class="progress-bar"></div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    Virtual Drum Kit ‚Ä¢ No external libraries. Built with HTML5, CSS3, and Web Audio API. Works best on modern browsers.
  </footer>

  <dialog id="help-modal" class="modal" aria-labelledby="help-title">
    <div class="modal-card">
      <h3 id="help-title">How to play</h3>
      - Click or tap any drum pad to play.<br/>
      - Use your keyboard: F (Closed Hat), G (Open Hat), J (Snare), V or Space (Kick), Y (High Tom), H (Low Tom), U (Crash), O (Ride), N (Clap).<br/>
      - Press Record to capture your performance, then Play to hear it back. Adjust the BPM slider to change playback speed. Use Clear to reset.
      <div class="modal-grid" style="margin-top:12px">
        <div><b>Record</b> Start capturing drum hits. A red light indicates recording is in progress.</div>
        <div><b>Play</b> Plays back your last take. Stop to halt playback/recording.</div>
        <div><b>Tempo</b> Adjusts playback speed (BPM). Default is 120.</div>
        <div><b>Master</b> Controls the output volume.</div>
      </div>
      <div class="modal-actions">
        <button id="btn-help-close" class="btn-icon" type="button">Close</button>
      </div>
    </div>
  </dialog>

  <script>
    // Audio Engine using Web Audio API (no external samples)
    const audio = {
      ctx: null,
      master: null,
      comp: null,
      noiseBuffer: null,
      openHatNodes: new Set(), // to allow choke by closed hat
      started: false
    };

    const state = {
      isRecording: false,
      isPlaying: false,
      recordStart: 0,
      events: [], // {time:ms, id, vel}
      timeouts: [],
      progressTimer: null,
      lastLength: 0,
      tempo: 120,
      refTempo: 120
    };

    const DRUMS = [
      { id:'crash', name:'Crash', keys:['u'], color:'#ef476f' },
      { id:'tom-high', name:'High Tom', keys:['y'], color:'#9b5de5' },
      { id:'ride', name:'Ride', keys:['o'], color:'#26547c' },
      { id:'hihat-closed', name:'Hi-Hat Closed', keys:['f'], color:'#06d6a0' },
      { id:'snare', name:'Snare', keys:['j'], color:'#ffd166' },
      { id:'tom-low', name:'Low Tom', keys:['h'], color:'#f15bb5' },
      { id:'hihat-open', name:'Hi-Hat Open', keys:['g'], color:'#118ab2' },
      { id:'clap', name:'Clap', keys:['n'], color:'#ffa600' },
      { id:'kick', name:'Kick', keys:['v',' '], color:'#ff6b6b' }
    ];
    const keyMap = {};
    DRUMS.forEach(d => d.keys.forEach(k => keyMap[k] = d.id));

    function initAudio() {
      if (audio.ctx) return;
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const master = ctx.createGain();
      const comp = ctx.createDynamicsCompressor();
      comp.threshold.value = -18;
      comp.knee.value = 24;
      comp.ratio.value = 4;
      comp.attack.value = 0.003;
      comp.release.value = 0.25;

      master.gain.value = 0.8; // default volume
      comp.connect(master);
      master.connect(ctx.destination);

      // Create a reusable noise buffer
      const bufferSize = Math.floor(ctx.sampleRate * 2); // 2 seconds
      const noiseBuffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
      const data = noiseBuffer.getChannelData(0);
      for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;

      audio.ctx = ctx;
      audio.master = master;
      audio.comp = comp;
      audio.noiseBuffer = noiseBuffer;
      setPowerLed(true);
    }

    function setPowerLed(on) {
      const led = document.getElementById('power-led');
      if (led) led.classList.toggle('on', !!on);
    }

    function resumeAudio() {
      initAudio();
      if (audio.ctx.state === 'suspended') audio.ctx.resume();
    }

    // Utility: create noise source
    function createNoise() {
      const src = audio.ctx.createBufferSource();
      src.buffer = audio.noiseBuffer;
      src.loop = true;
      return src;
    }

    // Utility: quick connect to master bus
    function toMaster(node) {
      node.connect(audio.comp);
    }

    // Sound design
    function playKick(vel=1) {
      const t = audio.ctx.currentTime;
      const osc = audio.ctx.createOscillator();
      const g = audio.ctx.createGain();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(150, t);
      osc.frequency.exponentialRampToValueAtTime(45, t + 0.48);
      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(1.0 * vel, t + 0.005);
      g.gain.exponentialRampToValueAtTime(0.0001, t + 0.5);

      osc.connect(g);
      toMaster(g);
      osc.start(t);
      osc.stop(t + 0.52);

      // Sub transient
      const click = audio.ctx.createOscillator();
      const cg = audio.ctx.createGain();
      click.type = 'triangle';
      click.frequency.setValueAtTime(100, t);
      cg.gain.setValueAtTime(0.0, t);
      cg.gain.linearRampToValueAtTime(0.25 * vel, t + 0.005);
      cg.gain.exponentialRampToValueAtTime(0.0001, t + 0.05);
      click.connect(cg);
      toMaster(cg);
      click.start(t);
      click.stop(t + 0.06);
    }

    function playSnare(vel=1) {
      const t = audio.ctx.currentTime;
      // Noise burst
      const noise = createNoise();
      const bp = audio.ctx.createBiquadFilter();
      bp.type = 'bandpass';
      bp.frequency.value = 1800;
      bp.Q.value = 0.8;

      const hp = audio.ctx.createBiquadFilter();
      hp.type = 'highpass';
      hp.frequency.value = 650;

      const ng = audio.ctx.createGain();
      ng.gain.setValueAtTime(0.0001, t);
      ng.gain.linearRampToValueAtTime(0.8 * vel, t + 0.002);
      ng.gain.exponentialRampToValueAtTime(0.0001, t + 0.24);

      noise.connect(bp).connect(hp).connect(ng);
      toMaster(ng);
      noise.start(t);
      noise.stop(t + 0.3);

      // Snare body (tone)
      const osc = audio.ctx.createOscillator();
      const og = audio.ctx.createGain();
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(180, t);
      osc.frequency.exponentialRampToValueAtTime(140, t + 0.1);
      og.gain.setValueAtTime(0.0001, t);
      og.gain.linearRampToValueAtTime(0.4 * vel, t + 0.002);
      og.gain.exponentialRampToValueAtTime(0.0001, t + 0.16);
      osc.connect(og);
      toMaster(og);
      osc.start(t);
      osc.stop(t + 0.18);
    }

    function playHat(closed=true, vel=1) {
      const t = audio.ctx.currentTime;
      const noise = createNoise();
      const hp = audio.ctx.createBiquadFilter();
      hp.type = 'highpass';
      hp.frequency.value = 7000;
      const bp = audio.ctx.createBiquadFilter();
      bp.type = 'bandpass';
      bp.frequency.value = 10000;
      bp.Q.value = 0.8;
      const g = audio.ctx.createGain();

      // open hat ring time vs closed
      const decay = closed ? 0.08 : 0.6;
      const peak = closed ? 0.6 : 0.45; // open hat slightly softer
      g.gain.setValueAtTime(0.0001, t);
      g.gain.linearRampToValueAtTime(peak * vel, t + 0.004);
      g.gain.exponentialRampToValueAtTime(0.0001, t + decay);

      noise.connect(hp).connect(bp).connect(g);
      toMaster(g);

      noise.start(t);
      noise.stop(t + decay + 0.05);

      if (!closed) {
        audio.openHatNodes.add(g);
        g.onended = () => audio.openHatNodes.delete(g);
      } else {
        // choke any ringing open hats
        audio.openHatNodes.forEach(node => {
          try { node.gain.cancelScheduledValues(t); node.gain.exponentialRampToValueAtTime(0.0001, t + 0.02); } catch(e){}
        });
      }
    }
    function playHatClosed(vel=1){ playHat(true, vel); }
    function playHatOpen(vel=1){ playHat(false, vel); }

    function playTom(freq=150, vel=1) {
      const t = audio.ctx.currentTime;
      const osc = audio.ctx.createOscillator();
      const g = audio.ctx.createGain();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(freq, t);
      osc.frequency.exponentialRampToValueAtTime(freq * 0.6, t + 0.24);
      g.gain.setValueAtTime(0.0001, t);
      g.gain.linearRampToValueAtTime(0.9 * vel, t + 0.004);
      g.gain.exponentialRampToValueAtTime(0.0001, t + 0.28);
      osc.connect(g);
      toMaster(g);
      osc.start(t);
      osc.stop(t + 0.32);
    }
    function playTomHigh(vel=1){ playTom(200, vel); }
    function playTomLow(vel=1){ playTom(130, vel); }

    function playCrash(vel=1) {
      const t = audio.ctx.currentTime;
      const noise = createNoise();

      const hp = audio.ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value = 5500;
      const bp = audio.ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value = 10000; bp.Q.value=0.6;

      const g = audio.ctx.createGain();
      g.gain.setValueAtTime(0.0001, t);
      g.gain.linearRampToValueAtTime(0.8 * vel, t + 0.003);
      g.gain.exponentialRampToValueAtTime(0.0001, t + 1.2);

      noise.connect(hp).connect(bp).connect(g);
      toMaster(g);
      noise.start(t);
      noise.stop(t + 1.25);

      // metallic partial ping
      const osc = audio.ctx.createOscillator();
      const og = audio.ctx.createGain();
      osc.type = 'square';
      osc.frequency.setValueAtTime(600, t);
      og.gain.setValueAtTime(0.15 * vel, t);
      og.gain.exponentialRampToValueAtTime(0.0001, t + 0.12);
      osc.connect(og);
      toMaster(og);
      osc.start(t);
      osc.stop(t + 0.14);
    }

    function playRide(vel=1) {
      const t = audio.ctx.currentTime;
      const noise = createNoise();
      const hp = audio.ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value = 5000;
      const g = audio.ctx.createGain();
      g.gain.setValueAtTime(0.0001, t);
      g.gain.linearRampToValueAtTime(0.55 * vel, t + 0.004);
      g.gain.exponentialRampToValueAtTime(0.0001, t + 0.9);
      noise.connect(hp).connect(g); toMaster(g);
      noise.start(t); noise.stop(t + 0.95);

      // gentle bell partial
      const bell = audio.ctx.createOscillator();
      const bg = audio.ctx.createGain();
      bell.type='triangle'; bell.frequency.setValueAtTime(880, t);
      bg.gain.setValueAtTime(0.12*vel, t);
      bg.gain.exponentialRampToValueAtTime(0.0001, t + 0.3);
      bell.connect(bg); toMaster(bg);
      bell.start(t); bell.stop(t + 0.32);
    }

    function playClap(vel=1) {
      const t = audio.ctx.currentTime;
      const noise = createNoise();
      const hp = audio.ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value = 1200;
      const g = audio.ctx.createGain();
      // classic 3-slap envelope
      g.gain.setValueAtTime(0.0001, t);
      const a = 0.25 * vel;
      g.gain.linearRampToValueAtTime(a, t + 0.005);
      g.gain.exponentialRampToValueAtTime(0.0001, t + 0.025);
      g.gain.setValueAtTime(0.18 * vel, t + 0.035);
      g.gain.exponentialRampToValueAtTime(0.0001, t + 0.06);
      g.gain.setValueAtTime(0.1 * vel, t + 0.075);
      g.gain.exponentialRampToValueAtTime(0.0001, t + 0.14);

      noise.connect(hp).connect(g); toMaster(g);
      noise.start(t);
      noise.stop(t + 0.16);
    }

    // Map drum id to play function
    const PLAY = {
      'kick': playKick,
      'snare': playSnare,
      'hihat-closed': playHatClosed,
      'hihat-open': playHatOpen,
      'tom-low': playTomLow,
      'tom-high': playTomHigh,
      'crash': playCrash,
      'ride': playRide,
      'clap': playClap
    };

    // UI helpers
    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);

    function formatTime(ms) {
      const m = Math.floor(ms / 60000);
      const s = Math.floor((ms % 60000) / 1000);
      const msr = Math.floor(ms % 1000);
      return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}.${String(msr).padStart(3,'0')}`;
    }

    function setStatus(msg) {
      $('#display-status').textContent = msg;
    }

    function setRecordUI(on) {
      state.isRecording = on;
      $('#btn-record').setAttribute('aria-pressed', on ? 'true' : 'false');
      $('#btn-record').classList.toggle('active', on);
      $('#rec-dot').classList.toggle('on', on);
      $('#recording-state').textContent = on ? 'Recording...' : 'Idle';
    }

    function updatePlaybackButtons() {
      $('#btn-play').disabled = state.events.length === 0 || state.isRecording || state.isPlaying;
      $('#btn-stop').disabled = !state.isRecording && !state.isPlaying;
      $('#btn-clear').disabled = state.events.length === 0 || state.isRecording || state.isPlaying;
    }

    function animatePad(drumId) {
      const pad = document.querySelector(`.pad[data-drum="${drumId}"]`);
      if (!pad) return;
      pad.classList.add('active');
      // flash color ring
      pad.querySelector('.color-ring').style.background = `radial-gradient(50% 50% at 50% 50%, rgba(255,255,255,0.2), rgba(255,255,255,0.05))`;
      setTimeout(() => {
        pad.classList.remove('active');
      }, 120);
    }

    function velocityFromEvent(e) {
      // normalize pointer pressure (0..1), fallback
      if (e && 'pressure' in e && e.pressure > 0) {
        return 0.5 + Math.min(0.5, e.pressure * 0.5);
      }
      return 1;
    }

    function trigger(drumId, source='user', vel=1) {
      resumeAudio();
      if (!PLAY[drumId]) return;
      // Play sound
      PLAY[drumId](vel * ($('#slider-volume').value / 100));
      // UI
      animatePad(drumId);
      // Record if needed
      if (state.isRecording && (source === 'user' || source === 'keyboard')) {
        const now = performance.now();
        state.events.push({ time: now - state.recordStart, id: drumId, vel: vel });
        $('#display-events-count').textContent = `${state.events.length} event${state.events.length===1?'':'s'}`;
        if (state.events.length > 0) {
          const len = state.events[state.events.length - 1].time;
          state.lastLength = len;
          $('#display-recording-length').textContent = formatTime(len);
          updatePlaybackButtons();
        }
      }
    }

    function startRecording() {
      if (state.isPlaying) stopPlayback();
      state.events = [];
      $('#display-events-count').textContent = '0 events';
      $('#display-recording-length').textContent = '00:00.000';
      state.recordStart = performance.now();
      setRecordUI(true);
      setStatus('Recording... Play the pads or use your keyboard.');
      updatePlaybackButtons();
    }

    function stopRecording() {
      if (!state.isRecording) return;
      setRecordUI(false);
      updatePlaybackButtons();
      const len = state.events.length ? state.events[state.events.length - 1].time : 0;
      state.lastLength = len;
      setStatus(state.events.length ? `Recorded ${state.events.length} events` : 'Nothing recorded');
      if (state.events.length) $('#record-progress').style.width = '0%';
    }

    function clearRecording() {
      if (state.isPlaying || state.isRecording) return;
      state.events = [];
      state.lastLength = 0;
      $('#display-events-count').textContent = '0 events';
      $('#display-recording-length').textContent = '00:00.000';
      $('#record-progress').style.width = '0%';
      setStatus('Cleared recording');
      updatePlaybackButtons();
    }

    function stopPlayback() {
      state.isPlaying = false;
      state.timeouts.forEach(id => clearTimeout(id));
      state.timeouts = [];
      if (state.progressTimer) { cancelAnimationFrame(state.progressTimer); state.progressTimer = null; }
      $('#btn-stop').disabled = true;
      $('#btn-play').disabled = state.events.length === 0 || state.isRecording;
      setStatus('Stopped');
    }

    function playRecording() {
      if (!state.events.length) return;
      if (state.isRecording) stopRecording();
      stopPlayback();

      const tempo = state.tempo;
      const scale = state.refTempo / tempo; // faster tempo -> shorter times
      const scaledLen = (state.lastLength || state.events[state.events.length - 1].time) * scale;

      state.isPlaying = true;
      $('#btn-stop').disabled = false;
      $('#btn-play').disabled = true;
      setStatus('Playing back...');
      const start = performance.now();

      // progress animation
      const progressBar = $('#record-progress');
      function tick() {
        if (!state.isPlaying) return;
        const elapsed = performance.now() - start;
        const pct = Math.min(100, (elapsed / scaledLen) * 100);
        progressBar.style.width = `${pct}%`;
        if (pct >= 100) return;
        state.progressTimer = requestAnimationFrame(tick);
      }
      state.progressTimer = requestAnimationFrame(tick);

      // schedule events
      for (const ev of state.events) {
        const when = ev.time * scale;
        const id = setTimeout(() => {
          trigger(ev.id, 'playback', ev.vel);
        }, Math.max(0, Math.floor(when)));
        state.timeouts.push(id);
      }
      // finalize
      const doneId = setTimeout(() => {
        if (!state.isPlaying) return;
        progressBar.style.width = '100%';
        state.isPlaying = false;
        updatePlaybackButtons();
        setStatus('Playback finished');
        setTimeout(() => { progressBar.style.width = '0%'; }, 250);
      }, Math.max(0, Math.floor(scaledLen + 10)));
      state.timeouts.push(doneId);
    }

    // Event wiring
    function onPadPointerDown(e) {
      const pad = e.currentTarget;
      const id = pad.getAttribute('data-drum');
      const vel = velocityFromEvent(e);
      trigger(id, 'user', vel);
    }

    function onKeyDown(e) {
      const k = e.key.toLowerCase();
      if (keyMap[k]) {
        e.preventDefault();
        trigger(keyMap[k], 'keyboard', 1);
      } else if (e.code === 'Space') {
        e.preventDefault();
        trigger('kick', 'keyboard', 1);
      }
    }

    function setupUI() {
      // Pads
      $$('.pad').forEach(p => {
        p.addEventListener('pointerdown', onPadPointerDown);
        p.addEventListener('keydown', ev => { if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); trigger(p.dataset.drum, 'keyboard', 1); }});
      });

      // Transport
      $('#btn-record').addEventListener('click', () => {
        if (!state.isRecording) startRecording(); else stopRecording();
        updatePlaybackButtons();
      });
      $('#btn-play').addEventListener('click', () => playRecording());
      $('#btn-stop').addEventListener('click', () => {
        if (state.isRecording) stopRecording();
        if (state.isPlaying) stopPlayback();
      });
      $('#btn-clear').addEventListener('click', () => clearRecording());

      // Sliders
      $('#slider-volume').addEventListener('input', () => {
        resumeAudio();
        const v = parseInt($('#slider-volume').value, 10) / 100;
        if (audio.master) audio.master.gain.value = v;
      });

      const tempoEl = $('#slider-tempo');
      const tempoReadout = $('#tempo-readout');
      tempoEl.addEventListener('input', () => {
        state.tempo = parseInt(tempoEl.value, 10);
        tempoReadout.textContent = `${state.tempo} BPM`;
      });

      // Help modal
      const modal = $('#help-modal');
      const btnHelp = $('#btn-help');
      const btnHelpClose = $('#btn-help-close');
      btnHelp.addEventListener('click', () => {
        modal.setAttribute('open', '');
        modal.showModal?.();
      });
      btnHelpClose.addEventListener('click', () => {
        modal.close?.();
        modal.removeAttribute('open');
      });
      modal.addEventListener('click', (e) => {
        const rect = modal.querySelector('.modal-card').getBoundingClientRect();
        if (e.clientX < rect.left || e.clientX > rect.right || e.clientY < rect.top || e.clientY > rect.bottom) {
          modal.close?.();
          modal.removeAttribute('open');
        }
      });

      // Keyboard
      window.addEventListener('keydown', onKeyDown, { passive:false });

      // Wake audio on first interaction
      const wake = () => { resumeAudio(); window.removeEventListener('pointerdown', wake); window.removeEventListener('keydown', wake); };
      window.addEventListener('pointerdown', wake, { once:true });
      window.addEventListener('keydown', wake, { once:true });

      // Accessibility: allow tab focus for pads
      $$('.pad').forEach(p => p.setAttribute('tabindex', '0'));
    }

    // Color accents per pad
    function colorizePads() {
      DRUMS.forEach(d => {
        const el = document.getElementById('pad-' + d.id);
        if (!el) return;
        const ring = el.querySelector('.color-ring');
        ring.style.background = `radial-gradient(50% 50% at 50% 50%, ${hexToRgba(d.color, 0.25)}, rgba(255,255,255,0.05))`;
        el.style.borderColor = hexToRgba(d.color, 0.35);
        el.querySelector('.head').style.boxShadow = `inset 0 8px 30px rgba(0,0,0,0.55), inset 0 0 0 2px rgba(255,255,255,0.08), inset 0 0 40px ${hexToRgba(d.color,0.12)}`;
      });
    }
    function hexToRgba(hex, a=1) {
      const h = hex.replace('#','');
      const bigint = parseInt(h, 16);
      const r = (bigint >> 16) & 255;
      const g = (bigint >> 8) & 255;
      const b = bigint & 255;
      return `rgba(${r},${g},${b},${a})`;
    }

    // Initial setup
    setupUI();
    colorizePads();
    updatePlaybackButtons();
    setStatus('Ready');

    // Ensure 1280x720 viewport compatibility: layout already responsive; no extra code needed
  </script>
</body>
</html>