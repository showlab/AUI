<!DOCTYPE html>
<html lang="en">
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Camping Gear Checklist</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Destylized theme: simple, high-contrast, no gradients/shadows/rounded corners */
    :root{
      --bg:#ffffff;
      --text:#000000;
      --muted:#444444;
      --border:#dddddd;
      --accent:#0a7a3b;
      --accent-2:#d68c00;
      --danger:#b00020;
      --warn:#c07c00;
      --ok:#157f3b;
      --chip:#e7f4ed;
      --focus:#1a73e8;
    }
    *{ box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin:0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      line-height: 1.35;
    }

    a { color: #0645ad; text-decoration: underline; }
    a:focus, button:focus, input:focus, select:focus, textarea:focus{
      outline: 2px solid var(--focus);
      outline-offset: 2px;
    }

    header{
      position: relative;
      padding: 12px 16px 8px 16px;
      border-bottom: 1px solid var(--border);
      background: #fff;
    }
    #appTitle{
      margin:0;
      font-size: clamp(18px, 2.5vw, 28px);
      display:flex; align-items:center; gap:8px;
      font-weight: 700;
    }
    #appTitle .emoji{ font-size:1.2em; }
    .header-toolbar{
      margin-top:8px;
      display:flex; gap:12px; flex-wrap:wrap; align-items:center;
    }
    .unit-select, .search, .category-filter {
      border:1px solid var(--border);
      padding:8px 12px;
      display:flex; align-items:center; gap:8px;
      height:44px;
    }
    .unit-select select, .search input, .category-filter select{
      border:none; outline:none; background:transparent; font-size:14px; color:var(--text);
      min-width: 140px; height:100%;
    }
    .chip{
      display:inline-flex; align-items:center;
      background:var(--chip); color:#1a412e;
      padding:8px 12px; border:1px solid var(--border);
      height: 44px; font-weight:600;
    }

    /* Status proxy bar */
    #statusBar{
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
      padding:8px 16px; border-top:1px solid var(--border);
      border-bottom:1px solid var(--border);
      background:#fafafa;
      font-size:14px;
    }
    #activeSection, #actionStatus{
      padding:4px 8px; border:1px solid var(--border);
      background:#fff;
    }

    main{
      width: min(1200px, 98vw);
      margin: 8px auto;
      display:grid; grid-template-columns: 420px 1fr; gap:16px;
      align-items: start;
    }
    @media (max-width: 980px){
      main{ grid-template-columns: 1fr; }
    }

    /* Cards simplified */
    .card{
      border:1px solid var(--border);
      background:#fff;
      padding:12px;
    }
    .card h2, .card h3{
      margin:0 0 8px 0;
      font-size:18px;
    }
    .divider{
      border-top:1px solid var(--border);
      margin:12px 0;
    }

    /* Form basics */
    .form-row{
      display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:12px;
    }
    .form-row.full{ grid-template-columns: 1fr; }
    label{ font-size:13px; color:var(--muted); display:block; margin-bottom:4px; }
    input[type=text], input[type=number], select, textarea{
      width:100%; min-height:44px;
      padding:8px 10px;
      border:1px solid var(--border);
      background:#fff; color:var(--text);
      font-size:14px;
    }
    textarea{ resize:vertical; min-height:66px; }
    .helper{ font-size:12px; color:#555; margin-top:4px; }

    .btn{
      appearance:none; border:1px solid var(--border); background:#fff;
      color:var(--text); min-height:44px; padding:8px 12px; cursor:pointer;
      font-weight:600; display:inline-flex; align-items:center; justify-content:center;
      user-select:none;
    }
    .btn.primary{ background:var(--accent); color:#fff; border-color:var(--accent); }
    .btn.secondary{ background:#efefef; }
    .btn.warn{ background:#ffe8c2; color:#5a3e00; border-color:#d6b27b; }
    .btn.danger{ background:#f8d7da; color:#721c24; border-color:#f5c6cb; }
    .btn.ghost{ background:#fff; }
    .btn.small{ min-height:36px; padding:6px 10px; font-size:13px; }
    .btn-group{ display:flex; gap:8px; flex-wrap:wrap; }

    /* Summary widgets */
    .summary{
      display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px;
    }
    .summary .stat{
      border:1px solid var(--border); padding:10px; text-align:center; min-height:60px;
    }
    .stat .label{ color:#555; font-size:12px; }
    .stat .value{ font-size:16px; font-weight:700; margin-top:4px; }

    .progress{
      margin-top:10px; background:#eee; height:10px; width:100%; border:1px solid var(--border);
    }
    .progress .bar{ height:100%; width:0%; background:var(--accent); transition:none; }

    /* Gear list panel */
    .list-toolbar{
      position: sticky; top: 0; z-index: 2;
      background:#fff; padding-bottom:8px;
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      border-bottom:1px solid var(--border);
      margin-bottom:8px;
    }
    .top-summary{
      position: sticky; top: 44px; z-index: 1;
      background:#fafafa; padding:6px; border-bottom:1px solid var(--border);
      display:flex; gap:12px; flex-wrap:wrap; align-items:center;
      font-size:14px;
    }
    .top-actions{
      position: sticky; top: 76px; z-index: 1;
      background:#fff; padding:6px 0; border-bottom:1px solid var(--border);
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    }

    /* List itself becomes scrollable to keep controls visible */
    #gearList{
      list-style:none; padding:0; margin:0;
      display:grid; gap:8px;
      max-height: calc(100vh - 320px);
      overflow:auto;
    }
    @media (max-width: 980px){
      #gearList{ max-height: none; }
    }

    .gear-item{
      display:grid;
      grid-template-columns: 32px 1fr auto auto auto;
      gap:8px; align-items:center;
      border:1px solid var(--border); padding:8px;
      min-height: 60px;
    }
    @media (max-width: 720px){
      .gear-item{ grid-template-columns: 32px 1fr; grid-auto-rows:auto; }
      .gear-item .qty, .gear-item .weight, .gear-item .actions{ grid-column: 2 / span 1; }
    }
    .gear-item.packed{
      background: #f3fff6; border-color: #b8e3c5;
    }
    .checkbox{
      width:28px; height:28px; display:inline-flex; align-items:center; justify-content:center;
    }
    .checkbox input{
      appearance:none; width:24px; height:24px; margin:0;
      border:2px solid #555; background:#fff; cursor:pointer; display:inline-block; position:relative;
    }
    .checkbox input:checked{
      background: var(--ok);
      border-color: var(--ok);
    }
    .checkbox input:checked::after{
      content:""; position:absolute; left:6px; top:2px; width:8px; height:16px;
      border-right:3px solid #fff; border-bottom:3px solid #fff; transform:rotate(45deg);
    }
    .item-main .name{
      font-weight:700; font-size:15px;
      word-break: break-word;
    }
    .item-main .meta{ display:flex; gap:8px; flex-wrap:wrap; margin-top:4px; }
    .badge{
      background:#f3f7f4; color:#2b2b2b; border:1px solid var(--border); padding:4px 6px; font-size:12px;
    }
    .note{
      color:#333; font-size:12px; margin-top:4px;
    }
    .packed .name{ text-decoration: line-through; color:#555; }

    .qty{
      display:flex; align-items:center; gap:6px;
      border:1px solid var(--border); padding:6px; min-height:44px;
    }
    .qty input{ width:64px; text-align:center; min-height:36px; }
    .qty .btn{ min-width:44px; }

    .weight{
      color:#111; font-weight:600; text-align:right; min-width:160px;
    }
    .weight small{ display:block; font-weight:400; color:#777; }

    .actions{ display:flex; gap:6px; }

    .gear-item.editing{ border-color:#3a8f5f; background:#eefaf1; }
    .edit-fields{
      display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:8px; grid-column: 2 / -1;
      margin-top:6px; border-top:1px solid var(--border); padding-top:8px; background:#f9f9f9;
    }
    .edit-fields .row-2{ grid-column:1 / -1; }

    /* Feedback and proxy areas */
    .tip{ font-size:12px; color:#333; }
    .feedback{
      font-size:13px; padding:8px; border:1px solid var(--border); background:#f9f9f9;
      margin-top:6px;
    }
    .feedback.success{ border-color:#a1d9b3; background:#f4fbf6; }
    .feedback.error{ border-color:#f5c6cb; background:#f8d7da; color:#721c24; }
    .feedback.warn{ border-color:#ffeeba; background:#fff3cd; }
    #saveLoadFeedback, #addItemFeedback{ min-height: 20px; }
    .space{ height:8px; }

    /* Footer simple */
    .footer{
      border-top:1px solid var(--border);
      padding:12px 16px; font-size:12px; color:#333;
    }

    /* Flashing summary highlight */
    .flash-summary{
      animation: flash 500ms linear 1;
    }
    @keyframes flash{
      0% { background:#fff9c4; }
      100% { background:transparent; }
    }

    /* Long content guide section */
    #helpSection{
      border:1px solid var(--border); padding:12px; background:#fff; margin:16px auto; width:min(1200px, 98vw);
    }
    #helpSection h3{ margin: 8px 0; }
    #helpSection details{ border-top:1px solid var(--border); padding-top:8px; margin-top:8px; }
    #helpSection summary{ cursor:pointer; font-weight:700; }
  </style>
</head>
<body>
  <header>
    <h1 id="appTitle"><span class="emoji">üèïÔ∏è</span> Camping Gear Checklist</h1>
    <div class="header-toolbar" role="toolbar" aria-label="Global controls">
      <div class="unit-select" title="Choose display unit">
        <label for="displayUnit" style="position:absolute; left:-9999px;">Display unit</label>
        <select id="displayUnit" aria-label="Display unit">
          <option value="g">grams (g)</option>
          <option value="kg">kilograms (kg)</option>
          <option value="oz">ounces (oz)</option>
          <option value="lb">pounds (lb)</option>
        </select>
      </div>
      <div class="search">
        <label for="searchInput" style="position:absolute; left:-9999px;">Search</label>
        <input id="searchInput" type="text" placeholder="Search your gear list" aria-label="Search gear" />
      </div>
      <div class="category-filter">
        <label for="filterCategory" style="position:absolute; left:-9999px;">Category</label>
        <select id="filterCategory" aria-label="Filter by category">
          <option value="">All</option>
        </select>
      </div>
      <span class="chip" id="packedCountDisplay">Packed 0/0 items</span>
    </div>
  </header>

  <div id="statusBar" aria-live="polite">
    <span id="activeSection" data-section="home">Home</span>
    <span id="actionStatus" data-status="idle">idle</span>
  </div>

  <main id="appRoot" role="main">
    <aside aria-label="Controls sidebar">
      <!-- Save / Load moved above Add Gear for visibility -->
      <section class="card" aria-labelledby="saveLoadHeading">
        <h2 id="saveLoadHeading">Save / Load Lists</h2>
        <div class="form-row full">
          <div>
            <label for="listNameInput">List name <span aria-hidden="true" title="required">*</span></label>
            <input id="listNameInput" type="text" placeholder="e.g., Yosemite Weekend" aria-label="List name input" />
            <div class="helper">Tip: Use descriptive titles. Long names are supported and will scroll horizontally. Hover to see full name.</div>
          </div>
        </div>
        <div class="btn-group" role="group" aria-label="Save and Update">
          <button id="btnNewList" type="button" class="btn ghost" aria-label="Start a new list">New List</button>
          <button id="btnSaveList" type="button" class="btn primary" aria-label="Save as a new list">Save as New</button>
          <button id="btnUpdateList" type="button" class="btn secondary" aria-label="Update current list">Update Current</button>
        </div>
        <div class="divider"></div>
        <div class="form-row full">
          <div>
            <label id="manageListsLabel" for="savedListsSelect">Manage Lists:</label>
            <select id="savedListsSelect" aria-label="Saved lists"></select>
          </div>
        </div>
        <div class="btn-group" role="group" aria-label="Load, Delete, Import/Export">
          <button id="btnLoadList" type="button" class="btn" aria-label="Load selected list">Load</button>
          <button id="btnDeleteList" type="button" class="btn danger" aria-label="Delete selected list">Delete</button>
          <button id="btnExportList" type="button" class="btn ghost" aria-label="Export current list">Export</button>
          <button id="btnImportList" type="button" class="btn ghost" aria-label="Import list from file">Import</button>
          <input id="fileImport" type="file" accept="application/json" class="hidden" />
        </div>
        <div class="space"></div>
        <div class="feedback" id="saveLoadFeedback" aria-live="polite">No list loaded.</div>
        <div class="space"></div>
        <div class="tip" id="currentListStatus" aria-live="polite"></div>
        <!-- Status proxies for automation -->
        <div class="space"></div>
        <div class="feedback" id="proxyArea">
          <div>Save status: <span id="saveStatus" data-status="idle">idle</span></div>
          <div>Load status: <span id="loadStatus" data-status="idle">idle</span></div>
          <div>Delete status: <span id="deleteStatus" data-status="idle">idle</span></div>
          <div>Download: <span id="downloadStatus">disabled</span> <a id="exportDownloadLink" href="#" download="" style="display:none;">download</a></div>
        </div>
      </section>

      <section class="card" aria-labelledby="addItemHeading">
        <h2 id="addItemHeading">Add New Gear Item</h2>
        <form id="addItemForm" aria-describedby="keyboardHintAdd">
          <div class="form-row full">
            <div>
              <label for="inputName">Item name <span aria-hidden="true" title="required">*</span></label>
              <input id="inputName" type="text" placeholder="Required: e.g., Tent, Headlamp" aria-label="Item name (required)" />
              <div class="helper">Required. The primary field for your gear. You can include emoji and accented characters.</div>
            </div>
          </div>
          <div class="form-row">
            <div>
              <label for="inputCategory">Category</label>
              <input id="inputCategory" list="categoryDatalist" type="text" placeholder="e.g., Shelter" aria-label="Category" />
              <datalist id="categoryDatalist"></datalist>
              <div class="helper">Helper: Category is used for filtering. You can enter any text.</div>
            </div>
            <div>
              <label for="inputQuantity">Quantity</label>
              <input id="inputQuantity" type="number" min="1" step="1" value="1" aria-label="Quantity" />
            </div>
          </div>
          <div class="form-row">
            <div>
              <label for="inputWeight">Weight per item</label>
              <input id="inputWeight" type="number" step="0.01" placeholder="e.g., 250" aria-label="Weight per item" />
            </div>
            <div>
              <label for="selectUnit">Unit</label>
              <select id="selectUnit" aria-label="Weight unit">
                <option value="g">g</option>
                <option value="kg">kg</option>
                <option value="oz">oz</option>
                <option value="lb">lb</option>
              </select>
            </div>
          </div>
          <div class="form-row full">
            <div>
              <label for="inputNote">Note (optional)</label>
              <textarea id="inputNote" placeholder="e.g., stakes included, spare batteries" aria-label="Item note"></textarea>
            </div>
          </div>
          <div class="btn-group" role="group" aria-label="Add item">
            <button id="btnAddItem" type="submit" class="btn primary" aria-label="Add item">Add Item</button>
            <button id="btnAddSampleData" type="button" class="btn secondary" aria-label="Add sample items">Add Sample Items</button>
          </div>
          <div id="keyboardHintAdd" class="tip">Keyboard: Press Enter to add the item.</div>
          <div id="addItemFeedback" class="feedback" aria-live="polite"></div>
          <div class="divider"></div>
          <div class="btn-group" role="group" aria-label="Bulk actions">
            <button id="btnCheckAll" type="button" class="btn ghost">Check All</button>
            <button id="btnUncheckAll" type="button" class="btn ghost">Uncheck All</button>
            <button id="btnClearPacked" type="button" class="btn warn">Remove Packed</button>
            <button id="btnClearAll" type="button" class="btn danger">Clear All</button>
          </div>
          <div class="space"></div>
          <div class="tip">Tip: Weight calculator updates as you add, edit, and check items. Duplicate names are allowed.</div>
        </form>
      </section>

      <section class="card" aria-labelledby="totalsHeading">
        <h2 id="totalsHeading">Weight Summary</h2>
        <div class="summary" id="summaryCards">
          <div class="stat">
            <div class="label">Packed</div>
            <div class="value" id="totalPacked">0 g</div>
          </div>
          <div class="stat">
            <div class="label">Unpacked</div>
            <div class="value" id="totalUnpacked">0 g</div>
          </div>
          <div class="stat">
            <div class="label">All Items</div>
            <div class="value" id="totalAll">0 g</div>
          </div>
        </div>
        <div class="space"></div>
        <div class="label">Packed progress</div>
        <div class="progress" aria-label="Packed progress">
          <div id="progressPackedBar" class="bar"></div>
        </div>
      </section>
    </aside>

    <section class="card" aria-labelledby="gearListHeading">
      <div class="list-toolbar">
        <h2 id="gearListHeading">Gear List</h2>
        <div class="btn-group" role="group" aria-label="List view controls">
          <button id="btnCollapseNotes" type="button" class="btn small">Toggle Notes</button>
        </div>
      </div>

      <div class="top-summary" aria-live="polite">
        <span>Packed: <strong id="totalPackedTop">0 g</strong></span>
        <span>Unpacked: <strong id="totalUnpackedTop">0 g</strong></span>
        <span>All: <strong id="totalAllTop">0 g</strong></span>
      </div>

      <div class="top-actions" role="group" aria-label="Sticky bulk actions">
        <button id="btnTopCheckAll" type="button" class="btn small">Check All</button>
        <button id="btnTopUncheckAll" type="button" class="btn small">Uncheck All</button>
        <button id="btnTopClearPacked" type="button" class="btn small warn">Remove Packed</button>
        <button id="btnTopAddSampleData" type="button" class="btn small secondary">Add Sample Items</button>
      </div>

      <ul id="gearList" aria-live="polite"></ul>
    </section>
  </main>

  <section id="helpSection" aria-labelledby="helpHeading">
    <h3 id="helpHeading">Help & Tips</h3>
    <p>
      This tool helps you plan and track your camping or backpacking gear. It‚Äôs intentionally simple, with a minimalist design for clarity and speed.
      Use the sidebar to manage lists and add gear. The main panel shows your gear list, total weight, and a packed progress indicator.
    </p>
    <details>
      <summary>Keyboard and Navigation</summary>
      <ul>
        <li>Press Enter while focused on the Add Item form to add the gear item.</li>
        <li>Use Tab and Shift+Tab to navigate through inputs and buttons.</li>
        <li>When you click "Edit" on a gear item, the item will be scrolled into view and the edit fields appear inline.</li>
      </ul>
    </details>
    <details>
      <summary>Saving and Loading</summary>
      <ul>
        <li>Save as New creates a named snapshot of your current items. Update Current replaces that snapshot with your latest changes.</li>
        <li>New List clears the workspace and starts fresh. If you have unsaved changes, you‚Äôll be asked to confirm.</li>
        <li>Load a saved list from the dropdown and click Load. The Weight Summary and Gear List will update immediately.</li>
        <li>Export downloads your current items to a JSON file. Import can load them back from a JSON file.</li>
      </ul>
    </details>
    <details>
      <summary>Units, Weights, and Totals</summary>
      <ul>
        <li>Select your preferred display unit (g, kg, oz, or lb) at the top. All totals are converted automatically.</li>
        <li>Each item‚Äôs per-unit weight is multiplied by its quantity to compute the total.</li>
        <li>Packed and Unpacked totals update as you check or uncheck items.</li>
      </ul>
    </details>
    <details>
      <summary>Troubleshooting</summary>
      <ul>
        <li>If you have very long item names, they will wrap automatically and the row height grows to fit.</li>
        <li>Unicode, emoji, and accented characters are supported throughout (e.g., ‚ÄúCaf√© kit ‚òï‚Äù).</li>
        <li>Your last session is saved locally and restored on refresh, including unit choice and whether notes are shown.</li>
      </ul>
    </details>
    <details>
      <summary>Privacy and Storage</summary>
      <ul>
        <li>Your data is only stored in your browser via localStorage. Nothing is uploaded.</li>
        <li>You can export your data to JSON for backup or sharing.</li>
      </ul>
    </details>
  </section>

  <footer class="footer">
    Made for the outdoors. Your lists are saved locally in your browser. No gradients, no distractions‚Äîjust gear.
  </footer>

  <script>
    // State and constants
    const SAVED_LISTS_KEY = 'campingGear_savedLists_v1';
    const LAST_SESSION_KEY = 'campingGear_lastSession_v1';

    const DEFAULT_CATEGORIES = [
      'Shelter','Sleep','Kitchen','Clothing','Health','Tools','Electronics','Food','Water','Navigation','Misc'
    ];

    const unitToGrams = {
      g: 1,
      kg: 1000,
      oz: 28.349523125,
      lb: 453.59237,
    };

    const state = {
      items: [],
      currentListName: null,
      dirty: false,
      showNotes: true,
      savedLists: {},
      lastExportUrl: null
    };

    // Helpers
    const $ = (sel, scope=document)=>scope.querySelector(sel);
    const $$ = (sel, scope=document)=>Array.from(scope.querySelectorAll(sel));

    function generateId(){
      return 'itm-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,7);
    }

    function gramsFrom(value, unit){
      const v = Number(value || 0);
      const factor = unitToGrams[unit] || 1;
      return v * factor;
    }

    function convertFromGrams(grams, unit){
      const factor = unitToGrams[unit] || 1;
      return grams / factor;
    }

    function formatWeight(grams, unit){
      const val = convertFromGrams(grams, unit);
      let decimals = unit === 'g' ? 0 : 2;
      const s = val.toFixed(decimals);
      return `${trimZeros(s)} ${unit}`;
    }

    function trimZeros(str){
      if (str.indexOf('.') >= 0){
        str = str.replace(/\.?0+$/,'');
      }
      return str;
    }

    function pluralize(word, n){
      return n === 1 ? word : word + 's';
    }

    function setDirty(flag=true){
      state.dirty = flag;
      updateCurrentStatus();
      saveLastSession();
    }

    function updateCurrentStatus(){
      const statusEl = $('#currentListStatus');
      const name = state.currentListName ? `‚Äú${state.currentListName}‚Äù` : 'Unsaved list';
      const modified = state.dirty ? '‚Ä¢ Unsaved changes' : '';
      statusEl.textContent = `${name} ${modified}`.trim();
    }

    // Simple status/proxy helpers
    function setStatusText(id, text, statusValue){
      const el = $(id);
      if (!el) return;
      el.textContent = text;
      if (statusValue !== undefined && el.dataset){
        el.dataset.status = statusValue;
      }
    }
    function setActionStatus(text){
      setStatusText('#actionStatus', text, text);
    }
    function setActiveSection(text){
      const el = $('#activeSection');
      el.textContent = text;
      el.dataset.section = text;
    }

    // Storage
    function loadSavedLists(){
      try{
        const raw = localStorage.getItem(SAVED_LISTS_KEY);
        state.savedLists = raw ? JSON.parse(raw) : {};
      }catch(e){
        state.savedLists = {};
      }
      populateSavedListsSelect();
    }

    function saveSavedLists(){
      localStorage.setItem(SAVED_LISTS_KEY, JSON.stringify(state.savedLists));
    }

    function saveLastSession(){
      const session = {
        items: state.items,
        currentListName: state.currentListName,
        displayUnit: $('#displayUnit').value,
        showNotes: state.showNotes
      };
      localStorage.setItem(LAST_SESSION_KEY, JSON.stringify(session));
    }

    function restoreLastSession(){
      try{
        const raw = localStorage.getItem(LAST_SESSION_KEY);
        if (!raw) return false;
        const session = JSON.parse(raw);
        if (Array.isArray(session.items)){
          state.items = session.items;
        }
        if (session.currentListName){
          state.currentListName = session.currentListName;
          // also reflect in listNameInput and title attribute
          $('#listNameInput').value = session.currentListName;
          $('#listNameInput').title = session.currentListName;
        }
        if (session.displayUnit && unitToGrams[session.displayUnit]){
          $('#displayUnit').value = session.displayUnit;
        }
        state.showNotes = session.showNotes !== false;
        setDirty(false);
        return true;
      }catch(e){
        return false;
      }
    }

    // Rendering
    function renderCategoriesDatalist(){
      const dl = $('#categoryDatalist');
      const cats = new Set([...DEFAULT_CATEGORIES, ...state.items.map(i=>i.category || '').filter(Boolean)]);
      dl.innerHTML = [...cats].map(c => `<option value="${escapeHtml(c)}">`).join('');
      // Filter dropdown
      const filterSel = $('#filterCategory');
      const prev = filterSel.value;
      const options = ['','Shelter','Sleep','Kitchen','Clothing','Health','Tools','Electronics','Food','Water','Navigation','Misc', ...state.items.map(i=>i.category).filter(Boolean)];
      const uniq = [...new Set(options)];
      filterSel.innerHTML = uniq.map(c => {
        if (c==='') return `<option value="">All</option>`;
        return `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`;
      }).join('');
      filterSel.value = prev || '';
    }

    function render(){
      renderCategoriesDatalist();
      renderList();
      renderTotals();
      updateCurrentStatus();
    }

    function getFilters(){
      const q = $('#searchInput').value.trim().toLowerCase();
      const cat = $('#filterCategory').value;
      return { q, cat };
    }

    function filteredItems(){
      const { q, cat } = getFilters();
      return state.items.filter(item=>{
        const matchesQ = !q || [item.name, item.category, item.note].filter(Boolean).some(t => t.toLowerCase().includes(q));
        const matchesC = !cat || (item.category || '') === cat;
        return matchesQ && matchesC;
      });
    }

    function renderList(){
      const list = $('#gearList');
      const items = filteredItems();
      if (!items.length){
        list.innerHTML = `<li class="gear-item" aria-live="polite" style="grid-template-columns: 1fr; text-align:center;">
          Your list is empty. Add items to get started!
        </li>`;
        $('#packedCountDisplay').textContent = `Packed 0/0 items`;
        syncTopSummary(0,0,0);
        return;
      }
      const displayUnit = $('#displayUnit').value;
      const html = items.map(item=>{
        const totalGrams = item.weightGrams * item.quantity;
        const packedCls = item.packed ? ' packed' : '';
        const notes = item.note && state.showNotes ? `<div class="note">üìù ${escapeHtml(item.note)}</div>` : '';
        return `
          <li class="gear-item${packedCls}" data-id="${item.id}">
            <label class="checkbox" title="Mark as packed">
              <input type="checkbox" id="chk-${item.id}" ${item.packed?'checked':''} aria-label="Packed checkbox for ${escapeHtmlAttr(item.name)}"/>
            </label>
            <div class="item-main">
              <div class="name">${escapeHtml(item.name)}</div>
              <div class="meta">
                ${item.category ? `<span class="badge">${escapeHtml(item.category)}</span>` : ''}
                <span class="badge" title="Per-item weight">${formatWeight(item.weightGrams, displayUnit)} ea</span>
                <span class="badge" title="Quantity">${item.quantity} ${pluralize('pc', item.quantity)}</span>
              </div>
              ${notes}
            </div>
            <div class="qty" aria-label="Quantity controls">
              <button class="btn ghost small qty-dec" title="Decrease quantity" aria-label="Decrease quantity">‚àí</button>
              <input class="qty-input" type="number" min="1" step="1" value="${item.quantity}" aria-label="Quantity input for ${escapeHtmlAttr(item.name)}"/>
              <button class="btn ghost small qty-inc" title="Increase quantity" aria-label="Increase quantity">+</button>
            </div>
            <div class="weight" aria-label="Item total weight">
              <div>${formatWeight(totalGrams, displayUnit)}</div>
              <small>${formatWeight(item.weightGrams, displayUnit)} √ó ${item.quantity}</small>
            </div>
            <div class="actions" role="group" aria-label="Row actions">
              <button class="btn ghost small btn-edit" title="Edit" aria-label="Edit ${escapeHtmlAttr(item.name)}">Edit</button>
              <button class="btn ghost small btn-dup" title="Duplicate" aria-label="Duplicate ${escapeHtmlAttr(item.name)}">Copy</button>
              <button class="btn danger small btn-del" title="Delete" aria-label="Delete ${escapeHtmlAttr(item.name)}">Delete</button>
            </div>
          </li>
        `;
      }).join('');
      list.innerHTML = html;

      // Update packed count display (all items, not just filtered)
      const packedCount = state.items.filter(i=>i.packed).length;
      $('#packedCountDisplay').textContent = `Packed ${packedCount}/${state.items.length} items`;
    }

    function computeTotals(){
      let all=0, packed=0, unpacked=0;
      for (const item of state.items){
        const weight = item.weightGrams * item.quantity;
        all += weight;
        if (item.packed) packed += weight; else unpacked += weight;
      }
      return { all, packed, unpacked };
    }

    function syncTopSummary(all, packed, unpacked){
      const unit = $('#displayUnit').value;
      $('#totalAllTop').textContent = formatWeight(all, unit);
      $('#totalPackedTop').textContent = formatWeight(packed, unit);
      $('#totalUnpackedTop').textContent = formatWeight(unpacked, unit);
    }

    function flashSummary(){
      const cards = $('#summaryCards');
      cards.classList.remove('flash-summary');
      void cards.offsetWidth; // reflow to restart animation
      cards.classList.add('flash-summary');
    }

    function renderTotals(){
      const displayUnit = $('#displayUnit').value;
      const { all, packed, unpacked } = computeTotals();
      $('#totalAll').textContent = formatWeight(all, displayUnit);
      $('#totalPacked').textContent = formatWeight(packed, displayUnit);
      $('#totalUnpacked').textContent = formatWeight(unpacked, displayUnit);
      const count = state.items.length || 1;
      const packedCount = state.items.filter(i=>i.packed).length;
      const percent = Math.round((packedCount / count) * 100);
      $('#progressPackedBar').style.width = percent + '%';
      syncTopSummary(all, packed, unpacked);
    }

    // Item operations
    function addItemFromForm(e){
      if (e) e.preventDefault();
      const name = $('#inputName').value.trim();
      let category = $('#inputCategory').value.trim();
      const qty = Math.max(1, parseInt($('#inputQuantity').value || '1', 10));
      // Accept empty weight field; treat non-numeric as NaN -> 0
      const rawWeight = $('#inputWeight').value;
      const weightVal = rawWeight === '' ? 0 : parseFloat(rawWeight);
      const unit = $('#selectUnit').value;
      const note = $('#inputNote').value.trim();
      const feedback = $('#addItemFeedback');

      if (!name){
        feedback.className = 'feedback error';
        feedback.textContent = 'Please enter an item name.';
        setStatusText('#addItemStatus', 'error', 'error');
        setActionStatus('add-error');
        return;
      }
      if (isNaN(weightVal) || weightVal < 0){
        feedback.className = 'feedback error';
        feedback.textContent = 'Please enter a valid weight (0 or more).';
        setStatusText('#addItemStatus', 'error', 'error');
        setActionStatus('add-error');
        return;
      }
      if (!category) category = 'Misc';

      const item = {
        id: generateId(),
        name,
        category,
        quantity: qty,
        weightGrams: gramsFrom(weightVal, unit),
        note,
        packed: false
      };
      state.items.push(item);
      feedback.className = 'feedback success';
      feedback.textContent = `Added: ‚Äú${name}‚Äù (${qty} √ó ${weightVal || 0} ${unit}${qty>1?' each':''})`;
      setStatusText('#addItemStatus', 'done', 'done');
      setActionStatus('added');
      clearAddForm();
      setDirty(true);
      render();
      flashSummary();
      setActiveSection('Added Item');
    }

    function clearAddForm(){
      $('#inputName').value = '';
      $('#inputCategory').value = '';
      $('#inputQuantity').value = 1;
      $('#inputWeight').value = '';
      $('#inputNote').value = '';
      $('#inputName').focus();
      // keep unit as-is
    }

    function updateItemQuantity(id, newQty){
      const item = state.items.find(i=>i.id===id);
      if (!item) return;
      const qty = Math.max(1, parseInt(newQty || '1', 10));
      item.quantity = qty;
      setDirty(true);
      renderTotals();
      renderList();
      flashSummary();
      setActionStatus('qty-updated');
    }

    function togglePacked(id, packed){
      const item = state.items.find(i=>i.id===id);
      if (!item) return;
      item.packed = packed;
      setDirty(true);
      renderList();
      renderTotals();
      flashSummary();
      setActionStatus(packed ? 'packed' : 'unpacked');
    }

    function deleteItem(id){
      const idx = state.items.findIndex(i=>i.id===id);
      if (idx >= 0){
        const name = state.items[idx].name || 'Item';
        state.items.splice(idx,1);
        setDirty(true);
        render();
        flashSummary();
        setActionStatus('deleted');
        const feedback = $('#saveLoadFeedback');
        if (feedback){
          feedback.className = 'feedback warn';
          feedback.textContent = `Deleted: ‚Äú${name}‚Äù`;
        }
      }
    }

    function duplicateItem(id){
      const item = state.items.find(i=>i.id===id);
      if (!item) return;
      const copy = JSON.parse(JSON.stringify(item));
      copy.id = generateId();
      copy.packed = false;
      copy.name = item.name + ' (copy)';
      state.items.push(copy);
      setDirty(true);
      render();
      flashSummary();
      setActionStatus('duplicated');
    }

    function openEditRow(li, item){
      // Close any existing editors in other rows
      $$('.gear-item.editing').forEach(el=>{
        if (el !== li) cancelEdit(el);
      });
      li.classList.add('editing');
      const displayUnit = $('#displayUnit').value;
      const editor = document.createElement('div');
      editor.className = 'edit-fields';
      editor.innerHTML = `
        <div>
          <label class="label">Name</label>
          <input type="text" class="edit-name" value="${escapeHtmlAttr(item.name)}"/>
        </div>
        <div>
          <label class="label">Category</label>
          <input type="text" class="edit-category" list="categoryDatalist" value="${escapeHtmlAttr(item.category || '')}"/>
        </div>
        <div>
          <label class="label">Quantity</label>
          <input type="number" class="edit-qty" min="1" step="1" value="${item.quantity}"/>
        </div>
        <div>
          <label class="label">Weight</label>
          <div style="display:flex; gap:6px;">
            <input type="number" class="edit-weight" step="0.01" value="${convertFromGrams(item.weightGrams, displayUnit).toFixed(displayUnit==='g'?0:2)}" style="flex:1;"/>
            <select class="edit-unit">
              ${Object.keys(unitToGrams).map(u => `<option value="${u}" ${u===displayUnit?'selected':''}>${u}</option>`).join('')}
            </select>
          </div>
        </div>
        <div class="row-2">
          <label class="label">Note</label>
          <input type="text" class="edit-note" value="${escapeHtmlAttr(item.note || '')}"/>
        </div>
        <div class="row-2" style="display:flex; gap:8px; justify-content:flex-end;">
          <button class="btn secondary small btn-cancel-edit">Cancel</button>
          <button class="btn small btn-save-edit">Save</button>
        </div>
      `;
      li.appendChild(editor);
      // Scroll item into view for better UX
      try{ li.scrollIntoView({block:'center', behavior:'instant'}); }catch(e){}
      setActiveSection('Edit Item');
      setActionStatus('editing');
    }

    function saveEdit(li, id){
      const item = state.items.find(i=>i.id===id);
      if (!item) return;
      const name = $('.edit-name', li).value.trim();
      const category = $('.edit-category', li).value.trim() || 'Misc';
      const qty = Math.max(1, parseInt($('.edit-qty', li).value || '1', 10));
      const wValRaw = $('.edit-weight', li).value;
      const wVal = wValRaw === '' ? 0 : parseFloat(wValRaw);
      const wUnit = $('.edit-unit', li).value;
      const note = $('.edit-note', li).value.trim();
      if (!name){
        alert('Please enter an item name.');
        return;
      }
      if (isNaN(wVal) || wVal < 0){
        alert('Please enter a valid weight (0 or more).');
        return;
      }
      item.name = name;
      item.category = category;
      item.quantity = qty;
      item.weightGrams = gramsFrom(wVal, wUnit);
      item.note = note;
      setDirty(true);
      render();
      flashSummary();
      setActiveSection('Edited Item');
      setActionStatus('edit-saved');
    }

    function cancelEdit(li){
      li.classList.remove('editing');
      const edit = $('.edit-fields', li);
      if (edit) edit.remove();
      setActionStatus('edit-cancelled');
    }

    // Save/Load
    function populateSavedListsSelect(){
      const sel = $('#savedListsSelect');
      const names = Object.keys(state.savedLists).sort((a,b)=> a.localeCompare(b));
      sel.innerHTML = names.length ? names.map(n => `<option value="${escapeHtml(n)}" title="${escapeHtml(n)}">${escapeHtml(n)}</option>`).join('') : `<option value="">No saved lists</option>`;
    }

    function newList(){
      if (state.items.length && state.dirty){
        const ok = confirm('Discard current changes and start a new list?');
        if (!ok) return;
      }
      state.items = [];
      state.currentListName = null;
      $('#listNameInput').value = '';
      $('#listNameInput').title = '';
      setDirty(false);
      render();
      setStatusText('#saveLoadFeedback', 'Started a new list.', 'done');
      setStatusText('#saveStatus', 'idle', 'idle');
      setStatusText('#loadStatus', 'idle', 'idle');
      setStatusText('#deleteStatus', 'idle', 'idle');
      setActiveSection('New List');
      setActionStatus('new-list');
    }

    function saveAsNew(){
      const name = $('#listNameInput').value.trim();
      $('#listNameInput').title = name;
      if (!name){
        setStatusText('#saveLoadFeedback', 'Enter a list name to save.', 'error');
        $('#saveLoadFeedback').className = 'feedback error';
        setStatusText('#saveStatus', 'error', 'error');
        setActiveSection('Save List');
        setActionStatus('save-error');
        return;
      }
      if (state.savedLists[name]){
        const overwrite = confirm('A list with this name exists. Overwrite?');
        if (!overwrite) { setStatusText('#saveStatus', 'cancelled', 'idle'); return; }
      }
      const now = new Date().toISOString();
      state.savedLists[name] = {
        name,
        items: state.items,
        createdAt: state.savedLists[name]?.createdAt || now,
        updatedAt: now
      };
      state.currentListName = name;
      setDirty(false);
      saveSavedLists();
      populateSavedListsSelect();
      setStatusText('#saveLoadFeedback', `List saved: ‚Äú${name}‚Äù.`, 'done');
      $('#saveLoadFeedback').className = 'feedback success';
      setStatusText('#saveStatus', 'done', 'done');
      setActiveSection('Save List');
      setActionStatus('saved');
    }

    function updateCurrent(){
      if (!state.currentListName){
        setStatusText('#saveLoadFeedback', 'No current list. Use "Save as New" first.', 'error');
        $('#saveLoadFeedback').className = 'feedback error';
        setStatusText('#saveStatus', 'error', 'error');
        setActiveSection('Update List');
        setActionStatus('update-error');
        return;
      }
      const name = state.currentListName;
      const now = new Date().toISOString();
      state.savedLists[name] = {
        name,
        items: state.items,
        createdAt: state.savedLists[name]?.createdAt || now,
        updatedAt: now
      };
      setDirty(false);
      saveSavedLists();
      setStatusText('#saveLoadFeedback', `List updated: ‚Äú${name}‚Äù.`, 'done');
      $('#saveLoadFeedback').className = 'feedback success';
      setStatusText('#saveStatus', 'done', 'done');
      setActiveSection('Update List');
      setActionStatus('updated');
    }

    function loadSelected(){
      const sel = $('#savedListsSelect');
      const name = sel.value;
      if (!name){
        setStatusText('#saveLoadFeedback', 'No saved list selected.', 'error');
        $('#saveLoadFeedback').className = 'feedback error';
        setStatusText('#loadStatus', 'error', 'error');
        setActiveSection('Load List');
        setActionStatus('load-error');
        return;
      }
      const list = state.savedLists[name];
      if (!list){
        setStatusText('#saveLoadFeedback', 'List not found.', 'error');
        $('#saveLoadFeedback').className = 'feedback error';
        setStatusText('#loadStatus', 'error', 'error');
        setActiveSection('Load List');
        setActionStatus('load-error');
        return;
      }
      if (state.dirty){
        const ok = confirm('Discard current unsaved changes and load the selected list?');
        if (!ok) { setStatusText('#loadStatus', 'cancelled', 'idle'); return; }
      }
      state.items = JSON.parse(JSON.stringify(list.items || []));
      state.currentListName = name;
      $('#listNameInput').value = name;
      $('#listNameInput').title = name;
      setDirty(false);
      render();
      setStatusText('#saveLoadFeedback', `Loaded list: ‚Äú${name}‚Äù.`, 'done');
      $('#saveLoadFeedback').className = 'feedback success';
      setStatusText('#loadStatus', 'done', 'done');
      setActiveSection('Load List');
      setActionStatus('loaded');
      flashSummary();
    }

    function deleteSelected(){
      const sel = $('#savedListsSelect');
      const name = sel.value;
      if (!name || !state.savedLists[name]){
        setStatusText('#saveLoadFeedback', 'No saved list selected.', 'error');
        $('#saveLoadFeedback').className = 'feedback error';
        setStatusText('#deleteStatus', 'error', 'error');
        setActiveSection('Delete List');
        setActionStatus('delete-error');
        return;
      }
      const ok = confirm(`Delete the saved list ‚Äú${name}‚Äù? This cannot be undone.`);
      if (!ok) { setStatusText('#deleteStatus', 'cancelled', 'idle'); return; }
      delete state.savedLists[name];
      saveSavedLists();
      populateSavedListsSelect();
      if (state.currentListName === name){
        state.currentListName = null;
        $('#listNameInput').value = '';
        $('#listNameInput').title = '';
        setDirty(true); // current items remain in view
      }
      setStatusText('#saveLoadFeedback', `Deleted list: ‚Äú${name}‚Äù.`, 'done');
      $('#saveLoadFeedback').className = 'feedback warn';
      setStatusText('#deleteStatus', 'done', 'done');
      setActiveSection('Delete List');
      setActionStatus('deleted-list');
    }

    function exportCurrent(){
      const data = {
        name: state.currentListName || $('#listNameInput').value.trim() || 'Unnamed List',
        items: state.items
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type:'application/json' });

      // Revoke previous URL if any
      if (state.lastExportUrl){
        try{ URL.revokeObjectURL(state.lastExportUrl); }catch(e){}
      }
      const url = URL.createObjectURL(blob);
      state.lastExportUrl = url;

      const a = $('#exportDownloadLink');
      a.href = url;
      a.download = `camping-gear-${sanitizeFilename(data.name)}.json`;
      a.style.display = 'inline';
      setStatusText('#downloadStatus', 'enabled', 'enabled');

      // Also auto-trigger download for convenience
      const auto = document.createElement('a');
      auto.href = url;
      auto.download = a.download;
      document.body.appendChild(auto);
      auto.click();
      setTimeout(()=>{ auto.remove(); }, 0);

      setStatusText('#saveLoadFeedback', 'Export ready. If your browser blocked it, click the download link shown.', 'done');
      $('#saveLoadFeedback').className = 'feedback success';
      setActiveSection('Export List');
      setActionStatus('export-ready');
    }

    function importFromFile(){
      $('#fileImport').click();
      setActiveSection('Import List');
    }

    function handleFileImport(e){
      const file = e.target.files[0];
      e.target.value = '';
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const obj = JSON.parse(reader.result);
          if (!obj || !Array.isArray(obj.items)){
            setStatusText('#saveLoadFeedback', 'Invalid file format.', 'error');
            $('#saveLoadFeedback').className = 'feedback error';
            setActiveSection('Import List');
            setActionStatus('import-error');
            return;
          }
          const ok = confirm('Importing will replace the current items. Continue?');
          if (!ok) return;
          state.items = obj.items.map(normalizeItem);
          state.currentListName = obj.name || null;
          $('#listNameInput').value = obj.name || '';
          $('#listNameInput').title = obj.name || '';
          setDirty(true);
          render();
          setStatusText('#saveLoadFeedback', `Imported list: ‚Äú${obj.name || 'Unnamed'}‚Äù.`, 'done');
          $('#saveLoadFeedback').className = 'feedback success';
          setActiveSection('Import List');
          setActionStatus('imported');
          flashSummary();
        }catch(err){
          setStatusText('#saveLoadFeedback', 'Failed to read the file.', 'error');
          $('#saveLoadFeedback').className = 'feedback error';
          setActiveSection('Import List');
          setActionStatus('import-error');
        }
      };
      reader.readAsText(file);
    }

    function normalizeItem(i){
      return {
        id: i.id || generateId(),
        name: i.name || 'Item',
        category: i.category || 'Misc',
        quantity: Math.max(1, parseInt(i.quantity || 1, 10)),
        weightGrams: typeof i.weightGrams === 'number' ? i.weightGrams : gramsFrom(parseFloat(i.weight || 0), 'g'),
        note: i.note || '',
        packed: !!i.packed
      };
    }

    // Bulk actions
    function checkAll(){
      state.items.forEach(i => i.packed = true);
      setDirty(true);
      render();
      flashSummary();
      setActiveSection('Bulk: Check All');
      setActionStatus('checked-all');
    }
    function uncheckAll(){
      state.items.forEach(i => i.packed = false);
      setDirty(true);
      render();
      flashSummary();
      setActiveSection('Bulk: Uncheck All');
      setActionStatus('unchecked-all');
    }
    function clearPacked(){
      const before = state.items.length;
      state.items = state.items.filter(i => !i.packed);
      setDirty(true);
      render();
      const removed = before - state.items.length;
      const msg = removed ? `Removed ${removed} packed ${pluralize('item', removed)}.` : 'No packed items to remove.';
      alert(msg);
      setActiveSection('Bulk: Clear Packed');
      setActionStatus('cleared-packed');
    }
    function clearAll(){
      if (!state.items.length) return;
      const ok = confirm('Clear all items?');
      if (!ok) return;
      state.items = [];
      setDirty(true);
      render();
      flashSummary();
      setActiveSection('Bulk: Clear All');
      setActionStatus('cleared-all');
    }

    function addSampleData(){
      const sample = [
        { name:'Tent (2P)', category:'Shelter', qty:1, w: 2100, u:'g', note:'stakes & fly included' },
        { name:'Sleeping Bag', category:'Sleep', qty:1, w: 900, u:'g', note:'20¬∞F down' },
        { name:'Sleeping Pad', category:'Sleep', qty:1, w: 450, u:'g', note:'' },
        { name:'Stove', category:'Kitchen', qty:1, w: 85, u:'g', note:'fuel can separate' },
        { name:'Fuel Canister', category:'Kitchen', qty:1, w: 230, u:'g', note:'partial' },
        { name:'Lighter', category:'Kitchen', qty:1, w: 20, u:'g', note:'' },
        { name:'Cook Pot 750ml', category:'Kitchen', qty:1, w: 120, u:'g', note:'titanium' },
        { name:'Spoon', category:'Kitchen', qty:1, w: 12, u:'g', note:'' },
        { name:'Water Filter', category:'Water', qty:1, w: 57, u:'g', note:'' },
        { name:'Water Bottle 1L', category:'Water', qty:2, w: 180, u:'g', note:'' },
        { name:'Headlamp', category:'Electronics', qty:1, w: 90, u:'g', note:'with batteries' },
        { name:'First Aid Kit', category:'Health', qty:1, w: 180, u:'g', note:'' },
        { name:'Rain Jacket', category:'Clothing', qty:1, w: 300, u:'g', note:'' },
        { name:'Knife', category:'Tools', qty:1, w: 120, u:'g', note:'' },
        { name:'Snacks', category:'Food', qty:5, w: 45, u:'g', note:'bars' }
      ];
      for (const s of sample){
        state.items.push({
          id: generateId(),
          name: s.name,
          category: s.category,
          quantity: s.qty,
          weightGrams: gramsFrom(s.w, s.u),
          note: s.note,
          packed: false
        });
      }
      setDirty(true);
      render();
      flashSummary();
      setActiveSection('Add Sample');
      setActionStatus('sample-added');
    }

    // UI events
    function bindEvents(){
      $('#addItemForm').addEventListener('submit', addItemFromForm);
      $('#btnAddItem').addEventListener('click', addItemFromForm);
      $('#btnAddSampleData').addEventListener('click', addSampleData);

      $('#displayUnit').addEventListener('change', ()=>{
        renderList(); renderTotals(); saveLastSession();
        setActionStatus('unit-changed');
      });
      $('#searchInput').addEventListener('input', ()=> { renderList(); setActionStatus('search'); });
      $('#filterCategory').addEventListener('change', ()=> { renderList(); setActionStatus('filter'); });
      $('#btnCollapseNotes').addEventListener('click', ()=>{
        state.showNotes = !state.showNotes; renderList(); saveLastSession();
        setActiveSection('Notes Toggle');
        setActionStatus('notes-toggled');
      });

      $('#btnCheckAll').addEventListener('click', checkAll);
      $('#btnUncheckAll').addEventListener('click', uncheckAll);
      $('#btnClearPacked').addEventListener('click', clearPacked);
      $('#btnClearAll').addEventListener('click', clearAll);

      // Sticky top action mirrors
      $('#btnTopCheckAll').addEventListener('click', checkAll);
      $('#btnTopUncheckAll').addEventListener('click', uncheckAll);
      $('#btnTopClearPacked').addEventListener('click', clearPacked);
      $('#btnTopAddSampleData').addEventListener('click', addSampleData);

      $('#btnNewList').addEventListener('click', newList);
      $('#btnSaveList').addEventListener('click', saveAsNew);
      $('#btnUpdateList').addEventListener('click', updateCurrent);
      $('#btnLoadList').addEventListener('click', loadSelected);
      $('#btnDeleteList').addEventListener('click', deleteSelected);
      $('#btnExportList').addEventListener('click', exportCurrent);
      $('#btnImportList').addEventListener('click', importFromFile);
      $('#fileImport').addEventListener('change', handleFileImport);

      // Keep listNameInput title in sync for long names (overflow tooltip)
      $('#listNameInput').addEventListener('input', (e)=>{
        e.target.title = e.target.value;
      });

      // List interactions (event delegation)
      $('#gearList').addEventListener('click', (e)=>{
        const li = e.target.closest('.gear-item');
        if (!li) return;
        const id = li.getAttribute('data-id');
        if (!id) return;

        if (e.target.matches('.qty-dec')){
          const input = $('.qty-input', li);
          input.value = Math.max(1, parseInt(input.value,10)-1);
          updateItemQuantity(id, input