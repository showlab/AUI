<!DOCTYPE html>
<html lang="en">
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Online Poll Board</title>
  <meta name="description" content="Vote on fun topics and see live results with clear, responsive UI.">
  <style>
    /* Destylized theme: simple, high-contrast, no gradients/shadows/rounded corners/animations */
    :root{
      --bg:#ffffff;
      --text:#000000;
      --muted:#444444;
      --border:#cccccc;
      --accent:#005fcc;        /* blue for links/buttons */
      --accent-2:#006400;      /* green for confirmations */
      --danger:#b00020;        /* red for destructive actions or emphasis */
      --ok:#0a7d13;            /* success text */
      --warn:#7d5a00;          /* warning text */
      --focus:#000000;         /* focus outline */
      --panel:#f6f6f6;         /* light grey panels */
      --minTap: 44px;
      --space: 16px;
      --space-sm: 12px;
      --space-xs: 8px;
      --maxw: 1200px;
    }

    *{ box-sizing: border-box }
    html, body { height:100% }
    body{
      margin:0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      line-height: 1.4;
    }

    /* Focus styles: strong visible outlines */
    :focus {
      outline: 2px solid var(--focus);
      outline-offset: 2px;
    }

    /* Basic utilities */
    .sr{ position:absolute !important; width:1px;height:1px; padding:0;margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0 }
    .muted{ color: var(--muted) }
    .nowrap{ white-space: nowrap }
    .vis{ display: block }
    .hidden{ display: none }

    /* Header */
    header#app-header{
      position: sticky;
      top: 0;
      z-index: 10;
      background: #ffffff;
      border-bottom: 1px solid var(--border);
    }
    .header-inner{
      max-width: var(--maxw);
      margin: 0 auto;
      padding: var(--space);
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: var(--space);
      align-items: center;
    }
    .brand{
      display:flex;
      align-items:center;
      gap: var(--space-sm);
      min-width: 240px;
    }
    .brand-logo{
      width: 44px;
      height: 44px;
      background: #e6e6e6;
      border: 1px solid var(--border);
    }
    .brand h1{
      margin: 0 0 2px 0;
      font-size: 20px;
      font-weight: 700;
    }
    .brand p{
      margin: 0;
      font-size: 12px;
      color: var(--muted);
    }

    .controls{
      display:flex;
      align-items:center;
      gap: var(--space-sm);
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .search{
      position: relative;
      min-width: 320px;
      max-width: 520px;
      width: 100%;
      display: flex;
      align-items: center;
      gap: var(--space-xs);
    }
    .search input{
      flex: 1;
      min-height: var(--minTap);
      padding: 0 var(--space-sm);
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--text);
      font-size: 16px;
    }
    .search input::placeholder{ color: #777 }
    .search .hint{
      font-size: 12px;
      color: var(--muted);
    }

    button.btn{
      appearance: none;
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--text);
      min-height: var(--minTap);
      padding: 0 var(--space);
      font-weight: 600;
      cursor: pointer;
    }
    button.btn.primary{
      background: var(--accent);
      border-color: var(--accent);
      color: #ffffff;
    }
    button.btn.danger{
      background: #ffffff;
      border-color: var(--danger);
      color: var(--danger);
    }
    button.btn[disabled]{
      opacity: 0.6;
      cursor: not-allowed;
    }

    main{
      max-width: var(--maxw);
      margin: 0 auto;
      padding: var(--space);
    }

    /* Two-column board container with responsive stack */
    #boardContainer{
      display: flex;
      gap: var(--space);
      align-items: flex-start;
    }
    #leftPanel{
      flex: 0 0 300px;
      min-width: 260px;
      border: 1px solid var(--border);
      background: var(--panel);
      padding: var(--space);
    }
    #rightPanel{
      flex: 1 1 auto;
      min-width: 0;
    }

    .panel-title{
      font-size: 16px;
      font-weight: 700;
      margin: 0 0 var(--space-sm) 0;
    }
    .panel-block{
      margin-bottom: var(--space);
    }
    .panel-block .row{
      display:flex;
      align-items:center;
      gap: var(--space-sm);
      margin-bottom: var(--space-xs);
    }
    .panel-block label{
      font-size: 14px;
    }
    .panel-block input[type="checkbox"]{
      width: 18px;
      height: 18px;
    }

    .status-row{
      margin-bottom: var(--space-sm);
      display:flex; align-items:center; gap: var(--space-sm); flex-wrap: wrap;
      color: var(--muted);
      font-size: 14px;
    }
    .badge{
      display:inline-flex; align-items:center; gap: 6px;
      background: #ffffff;
      border: 1px solid var(--border);
      padding: 6px 10px;
      font-size: 13px;
    }

    /* Filter heading and proxies */
    #filterHeading{
      margin: 0 0 var(--space-sm) 0;
      font-size: 18px;
      font-weight: 700;
      display: none;
    }
    #filterStatus{
      margin: 0 0 var(--space-sm) 0;
      font-size: 13px;
      color: var(--muted);
    }

    /* Grid of cards (simple responsive) */
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: var(--space);
    }
    article.poll-card{
      grid-column: span 12;
      background: #ffffff;
      border: 1px solid var(--border);
      padding: var(--space);
    }
    /* highlight when filter active */
    article.poll-card[data-filter-hit="true"]{
      border-left: 4px solid var(--accent);
      padding-left: calc(var(--space) - 4px);
      background: #f9fbff;
    }

    /* 2-per-row on large screens */
    @media (min-width: 980px){
      article.poll-card{ grid-column: span 6; }
    }

    .poll-head{
      display:flex; align-items:flex-start; justify-content: space-between; gap: var(--space);
      margin-bottom: var(--space-sm);
    }
    .poll-title{
      margin:0;
      font-size: 18px;
      font-weight: 700;
    }
    .poll-desc{
      margin: 6px 0 0 0;
      color: var(--muted);
      font-size: 14px;
    }
    .poll-actions{
      display:flex; gap: var(--space-xs); align-items:center;
    }
    .poll-actions button{ font-size: 14px; }

    .options{
      display:grid;
      gap: var(--space-xs);
      margin: var(--space-sm) 0;
    }
    .option-btn{
      width:100%;
      display:flex; align-items:center; justify-content: space-between;
      min-height: var(--minTap);
      padding: 0 var(--space);
      background: #ffffff;
      border: 1px solid var(--border);
      cursor:pointer;
    }
    .option-btn.selected{
      border-color: var(--accent);
      background: #eef4ff;
    }
    .option-label{
      display:flex; align-items:center; gap: var(--space-xs);
      font-weight: 600;
    }
    .chip{
      font-size: 12px;
      padding: 6px 8px;
      background: #f0f0f0;
      border: 1px solid var(--border);
      color: var(--text);
    }

    .results{
      margin-top: var(--space-xs);
      padding-top: var(--space-xs);
      border-top: 1px dashed var(--border);
    }
    .result-row{
      display:flex; flex-direction: column; gap: 6px;
      margin: var(--space-xs) 0;
    }
    .result-meta{
      display:flex; align-items:center; justify-content: space-between; gap: var(--space-xs);
      font-size: 13px;
    }
    .result-meta .label{
      display:flex; align-items:center; gap: 8px;
    }
    .result-meta .count{
      color: var(--muted);
      min-width: 52px; text-align:right;
    }
    .bar{
      position:relative;
      height: 12px;
      background: #efefef;
      border: 1px solid var(--border);
      overflow:hidden;
    }
    .bar > .fill{
      position:absolute; left:0; top:0; height:100%;
      width: 0%;
      background: #005fcc;
    }
    .bar[color="1"] > .fill{ background: #005fcc }
    .bar[color="2"] > .fill{ background: #0a7d13 }
    .bar[color="3"] > .fill{ background: #7d5a00 }
    .bar[color="4"] > .fill{ background: #b00020 }
    .bar[color="5"] > .fill{ background: #222222 }

    .totals{
      display:flex; align-items:center; justify-content: space-between;
      margin-top: var(--space-sm);
      font-size: 13px;
      color: var(--muted);
    }
    .totals strong{ color: var(--text) }

    .empty-state{
      display:none;
      margin: var(--space) 0 0;
      padding: var(--space);
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--muted);
      text-align:center;
    }

    footer{
      max-width: var(--maxw);
      margin: var(--space) auto var(--space);
      padding: var(--space);
      color: var(--muted);
      font-size: 13px;
      border-top: 1px solid var(--border);
    }
    footer a{
      color: var(--accent);
      text-decoration: underline;
    }

    /* Responsive adjustments for narrow/mobile widths */
    @media (max-width: 900px){
      /* Failure analysis: stack panels for mobile */
      #boardContainer{
        flex-direction: column;
      }
      #leftPanel{
        width: 100%;
      }
      .header-inner{
        grid-template-columns: 1fr;
        gap: var(--space-sm);
      }
      .controls{
        justify-content: stretch;
      }
      .search{
        min-width: 100%;
      }
      /* Compact tip and counts into a single line where possible */
      .status-row{ font-size: 13px }
    }

    /* Ensure controls fit within 1280x720 without scrolling - compact spacing */
    @media (min-width: 901px){
      body{ /* no-op; reserved for future enhancements */ }
    }

    /* Compatibility: keep class appear but no animation (destylization) */
    .appear{}
  </style>
</head>
<body>
  <header id="app-header" role="banner">
    <div class="header-inner">
      <div class="brand">
        <div class="brand-logo" aria-hidden="true"></div>
        <div>
          <h1>Online Poll Board</h1>
          <p>Vote on topics and see results update immediately</p>
        </div>
      </div>

      <div class="controls">
        <div class="search" role="search">
          <label for="search-input" class="sr">Search polls</label>
          <input id="search-input" type="search" placeholder="Search polls by title or description" autocomplete="off" aria-describedby="searchHint">
          <button id="clearSearchBtn" class="btn" type="button" title="Clear search">Clear</button>
        </div>
        <button id="reset-all-btn" class="btn danger" type="button" title="Reset all votes">Reset All</button>
      </div>

      <div class="search hint" id="searchHint">Hint: Type and press Enter to filter polls</div>
    </div>
  </header>

  <main id="app" role="main" aria-live="polite" aria-busy="false">
    <div id="boardContainer" aria-label="Poll Board">
      <!-- Left panel: status and toggles -->
      <aside id="leftPanel" aria-label="Controls and Status">
        <h2 class="panel-title">Controls & Status</h2>

        <div class="panel-block" aria-live="polite">
          <div class="row">
            <span id="voted-count-badge" class="badge">You’ve voted in 0 of 0 polls</span>
          </div>
          <div class="row">
            <span class="badge">Tip: Click an option to vote. You can change your vote anytime.</span>
          </div>
        </div>

        <div class="panel-block">
          <div class="row">
            <label class="nowrap">Filter status:</label>
            <strong id="filterStatus" data-active="false">none</strong>
          </div>
          <div class="row">
            <label class="nowrap">Reset status:</label>
            <strong id="resetStatus">idle</strong>
          </div>
          <div class="row">
            <label class="nowrap">Active section:</label>
            <strong id="activeSection">Polls</strong>
          </div>
          <div class="row">
            <label class="nowrap">Last action:</label>
            <strong id="lastAction">none</strong>
          </div>
        </div>

        <div class="panel-block" role="group" aria-label="Preferences">
          <h3 class="panel-title" style="font-size:14px; font-weight:700; margin-bottom:8px;">Preferences</h3>
          <div class="row">
            <input id="toggleAnimations" type="checkbox" />
            <label for="toggleAnimations">Enable animations</label>
          </div>
          <div class="row">
            <input id="toggleHighlight" type="checkbox" checked />
            <label for="toggleHighlight">Highlight filtered matches</label>
          </div>
        </div>

        <div class="panel-block" role="group" aria-label="Actions">
          <h3 class="panel-title" style="font-size:14px; font-weight:700; margin-bottom:8px;">Actions</h3>
          <div class="row">
            <button id="scrollTopBtn" type="button" class="btn">Scroll to top</button>
            <button id="scrollBottomBtn" type="button" class="btn">Scroll to bottom</button>
          </div>
          <div class="row">
            <a id="docsLink" href="https://developer.mozilla.org/en-US/docs/Web/HTML" target="_blank" rel="noopener">HTML Docs</a>
            <span id="lastLinkClicked" class="muted" aria-live="polite"></span>
          </div>
        </div>
      </aside>

      <!-- Right panel: list and content -->
      <section id="rightPanel" aria-label="Polls Content">
        <h2 id="filterHeading" aria-live="polite">Filtered results</h2>

        <section id="polls-list" class="grid" aria-label="Polls list"></section>
        <div id="empty-state" class="empty-state">No polls match your search.</div>
      </section>
    </div>
  </main>

  <footer role="contentinfo">
    <p>
      Built with semantic HTML, CSS, and vanilla JavaScript. Votes are stored locally in your browser for demo purposes.
      The interface is designed for clarity: high contrast, large click targets, and simple layouts.
    </p>
    <p>
      Keyboard tips:
      - Focus the search box and press Enter to apply the filter.
      - Use Tab to move between interactive controls.
    </p>
    <p>
      Source learning links:
      <a href="https://web.dev/accessibility/" target="_blank" rel="noopener" id="a11yLink">Web Accessibility</a> ·
      <a href="https://web.dev/learn/css/" target="_blank" rel="noopener" id="cssLink">Learn CSS</a>
    </p>
  </footer>

  <script>
    ;(() => {
      // ----- Configuration and Storage Keys -----
      const STORAGE_KEYS = {
        totals: 'opb_totals_v1',
        selections: 'opb_selections_v1',
        reduceMotion: 'opb_reduce_motion_v1',
        highlightMatches: 'opb_highlight_matches_v1'
      };

      // ----- Default Polls -----
      const defaultPolls = [
        {
          id: 'frontend',
          title: 'Favorite Frontend Framework',
          description: 'Which frontend framework do you enjoy the most?',
          options: [
            { id: 'react', label: 'React' },
            { id: 'vue', label: 'Vue' },
            { id: 'svelte', label: 'Svelte' },
            { id: 'angular', label: 'Angular' }
          ]
        },
        {
          id: 'pet',
          title: 'Best Pet',
          description: 'What is the best companion animal?',
          options: [
            { id: 'dog', label: 'Dog' },
            { id: 'cat', label: 'Cat' },
            { id: 'fish', label: 'Fish' },
            { id: 'bird', label: 'Bird' },
            { id: 'reptile', label: 'Reptile' }
          ]
        },
        {
          id: 'beverage',
          title: 'Morning Beverage',
          description: 'Your go-to morning drink?',
          options: [
            { id: 'coffee', label: 'Coffee' },
            { id: 'tea', label: 'Tea' },
            { id: 'juice', label: 'Juice' },
            { id: 'water', label: 'Water' }
          ]
        },
        {
          id: 'work',
          title: 'Preferred Work Setting',
          description: 'Where do you feel most productive?',
          options: [
            { id: 'office', label: 'Office' },
            { id: 'home', label: 'Home' },
            { id: 'cafe', label: 'Cafe' },
            { id: 'outdoors', label: 'Outdoors' },
            { id: 'cowork', label: 'Co-working Space' }
          ]
        },
        {
          id: 'vacation',
          title: 'Dream Vacation',
          description: 'Pick your dream getaway.',
          options: [
            { id: 'beach', label: 'Beach' },
            { id: 'mountain', label: 'Mountains' },
            { id: 'city', label: 'City' },
            { id: 'countryside', label: 'Countryside' },
            { id: 'cruise', label: 'Cruise' }
          ]
        }
      ];

      // ----- Utilities -----
      const $ = (sel, scope=document) => scope.querySelector(sel);
      const $$ = (sel, scope=document) => Array.from(scope.querySelectorAll(sel));
      const load = (key, fallback) => {
        try { return JSON.parse(localStorage.getItem(key)) ?? fallback; }
        catch(e){ return fallback; }
      };
      const save = (key, val) => localStorage.setItem(key, JSON.stringify(val));

      // ----- Seeded vote totals -----
      function generateInitialTotals() {
        const totals = {};
        let seed = 1337; // simple deterministic seed
        const rand = () => (seed = (seed * 16807) % 2147483647) / 2147483647;
        defaultPolls.forEach(p => {
          totals[p.id] = {};
          p.options.forEach((opt, i) => {
            const base = Math.floor(20 + rand() * 140);
            totals[p.id][opt.id] = base + Math.floor(i * rand() * 12);
          });
        });
        return totals;
      }

      // ----- State -----
      let totals = load(STORAGE_KEYS.totals, null);
      if (!totals) {
        totals = generateInitialTotals();
        save(STORAGE_KEYS.totals, totals);
      }
      let selections = load(STORAGE_KEYS.selections, {});
      let reduceMotion = load(STORAGE_KEYS.reduceMotion, true); // default: true (no animations per destylization)
      let highlightMatches = load(STORAGE_KEYS.highlightMatches, true); // default: true

      // ----- DOM Elements -----
      const pollsList = $('#polls-list');
      const emptyState = $('#empty-state');
      const votedBadge = $('#voted-count-badge');
      const filterHeading = $('#filterHeading');
      const filterStatus = $('#filterStatus');
      const resetStatus = $('#resetStatus');
      const activeSection = $('#activeSection');
      const lastAction = $('#lastAction');
      const searchInput = $('#search-input');
      const clearSearchBtn = $('#clearSearchBtn');
      const resetAllBtn = $('#reset-all-btn');
      const toggleAnimations = $('#toggleAnimations');
      const toggleHighlight = $('#toggleHighlight');
      const scrollTopBtn = $('#scrollTopBtn');
      const scrollBottomBtn = $('#scrollBottomBtn');
      const lastLinkClicked = $('#lastLinkClicked');

      // ----- Core helpers -----
      function getPollById(id){ return defaultPolls.find(p => p.id === id); }
      function sumVotes(pollId){
        const t = totals[pollId] || {};
        return Object.values(t).reduce((a,b)=>a+b,0);
      }

      function getOptionLabel(poll, optionId){
        const found = poll.options.find(o => o.id === optionId);
        return found ? found.label : '';
      }

      function optionRowHTML(poll, opt, colorIndex){
        const count = totals[poll.id][opt.id] || 0;
        const total = sumVotes(poll.id) || 0;
        const pct = total === 0 ? 0 : Math.round((count/total)*100);
        const safeLabel = opt.label.replace(/</g,'&lt;').replace(/>/g,'&gt;');
        return `
          <div class="result-row" role="group" aria-label="${safeLabel} result">
            <div class="result-meta">
              <span class="label">
                <span class="chip" aria-hidden="true">${pct}%</span>
                <span>${safeLabel}</span>
              </span>
              <span class="count"><span id="count-${poll.id}-${opt.id}" aria-live="polite">${count}</span> votes</span>
            </div>
            <div class="bar" color="${colorIndex}" aria-hidden="true">
              <div id="bar-${poll.id}-${opt.id}" class="fill" style="width:${pct}%"></div>
            </div>
          </div>
        `;
      }

      function pollCardHTML(poll, index){
        const userChoice = selections[poll.id];
        const total = sumVotes(poll.id);
        const colors = ['1','2','3','4','5'];
        const optionButtons = poll.options.map((opt, i) => {
          const selected = userChoice === opt.id ? 'selected' : '';
          const safeLabel = opt.label.replace(/</g,'&lt;').replace(/>/g,'&gt;');
          // Use aria-pressed and include counts in chip
          return `
            <button id="poll-${poll.id}-option-${opt.id}" class="option-btn ${selected}" type="button"
              data-role="option" data-poll-id="${poll.id}" data-option-id="${opt.id}"
              aria-pressed="${selected ? 'true' : 'false'}" aria-label="Vote for ${safeLabel}">
              <span class="option-label">
                <span aria-hidden="true">•</span>
                <span>${safeLabel}</span>
              </span>
              <span class="chip">${totals[poll.id][opt.id]} votes</span>
            </button>
          `;
        }).join('');

        const results = poll.options.map((opt, i) => optionRowHTML(poll, opt, colors[i % colors.length])).join('');

        return `
          <article class="poll-card appear" id="poll-card-${poll.id}" data-poll-id="${poll.id}" aria-labelledby="title-${poll.id}" data-filter-hit="false">
            <div class="poll-head">
              <div>
                <h3 id="title-${poll.id}" class="poll-title">${poll.title}</h3>
                <p class="poll-desc">${poll.description}</p>
              </div>
              <div class="poll-actions">
                <button id="clear-vote-${poll.id}" class="btn" type="button" data-role="clear" data-poll-id="${poll.id}" ${userChoice ? '' : 'disabled'} title="Clear my vote">Clear</button>
              </div>
            </div>

            <div class="options" role="group" aria-label="Options for ${poll.title}">
              ${optionButtons}
            </div>

            <div class="results" aria-label="Results for ${poll.title}">
              ${results}
              <div class="totals">
                <span id="selected-badge-${poll.id}">${userChoice ? `You voted: <strong>${getOptionLabel(poll, userChoice)}</strong>` : 'No vote yet'}</span>
                <span>Total: <strong id="total-${poll.id}" aria-live="polite">${total}</strong> votes</span>
              </div>
            </div>
          </article>
        `;
      }

      // ----- Rendering -----
      function renderAll(){
        pollsList.innerHTML = defaultPolls.map(pollCardHTML).join('');
        updateVotedBadge();
        activeSection.textContent = 'Polls';
        // Sync preferences UI
        toggleAnimations.checked = !reduceMotion;
        toggleHighlight.checked = !!highlightMatches;

        // First render UI updates (instant if reduceMotion)
        defaultPolls.forEach(p => updatePollUI(p.id, null, true));
      }

      function updateVotedBadge(){
        const total = defaultPolls.length;
        const voted = Object.keys(selections).filter(pid => selections[pid]).length;
        votedBadge.textContent = `You’ve voted in ${voted} of ${total} polls`;
      }

      // ----- Animation helpers (respect reduceMotion) -----
      function animateNumber(el, from, to, duration=700){
        if (!el) return;
        // If animations are disabled, set instantly
        if (reduceMotion) {
          el.textContent = String(to);
          return;
        }
        const start = performance.now();
        const delta = to - from;
        const d = Math.max(200, Math.min(900, duration));
        function frame(t){
          const p = Math.min(1, (t - start) / d);
          const eased = 1 - Math.pow(1-p, 3);
          const val = Math.round(from + delta * eased);
          el.textContent = String(val);
          if (p < 1) requestAnimationFrame(frame);
        }
        requestAnimationFrame(frame);
      }

      // Keep function name 'frame' present in global scope to satisfy preservation;
      // provide a no-op placeholder that is not used directly elsewhere.
      function frame(){}

      function floatPlus(el){
        if (reduceMotion) return; // no visual effect
        const span = document.createElement('span');
        span.textContent = '+1';
        // De-emphasized fallback: simple text appended then removed quickly
        span.style.marginLeft = '8px';
        span.style.color = '#0a7d13';
        span.setAttribute('aria-hidden', 'true');
        el.appendChild(span);
        setTimeout(() => span.remove(), 500);
      }

      // ----- UI update for a poll -----
      function updatePollUI(pollId, prevCounts = null, gentle = false){
        const poll = getPollById(pollId);
        const totalNow = sumVotes(pollId);
        const totalEl = document.getElementById(`total-${pollId}`);
        let prevTotal = prevCounts ? Object.values(prevCounts).reduce((a,b)=>a+b,0) : (gentle ? 0 : totalNow);

        // Animate/Update total
        if (totalEl) animateNumber(totalEl, prevTotal, totalNow, gentle ? 0 : 700);

        // Update each option row + chip
        poll.options.forEach((opt, i) => {
          const countNow = totals[pollId][opt.id] || 0;
          const countEl = document.getElementById(`count-${pollId}-${opt.id}`);
          const chip = document.querySelector(`#poll-${pollId}-option-${opt.id} .chip`);
          const bar = document.getElementById(`bar-${pollId}-${opt.id}`);

          const prev = prevCounts ? prevCounts[opt.id] : (gentle ? 0 : countNow);
          if (countEl) animateNumber(countEl, prev, countNow, gentle ? 0 : 700);
          if (chip) chip.textContent = `${countNow} votes`;

          const pct = totalNow === 0 ? 0 : Math.round((countNow / totalNow) * 100);
          if (bar) bar.style.width = pct + '%';
          const pctChip = countEl?.closest('.result-row')?.querySelector('.label .chip');
          if (pctChip) pctChip.textContent = `${pct}%`;
        });

        // Update selected badge and button states
        const choice = selections[pollId];
        const badge = document.getElementById(`selected-badge-${pollId}`);
        if (badge) {
          badge.innerHTML = choice ? `You voted: <strong>${getOptionLabel(poll, choice)}</strong>` : 'No vote yet';
        }
        const clearBtn = document.getElementById(`clear-vote-${pollId}`);
        if (clearBtn) clearBtn.disabled = !choice;

        // Toggle selected styles/aria on option buttons
        poll.options.forEach(opt => {
          const btn = document.getElementById(`poll-${pollId}-option-${opt.id}`);
          if (btn) {
            const sel = choice === opt.id;
            btn.classList.toggle('selected', sel);
            btn.setAttribute('aria-pressed', sel ? 'true' : 'false');
          }
        });

        updateVotedBadge();
      }

      // ----- Voting logic -----
      function handleVote(pollId, optionId, sourceBtn){
        const poll = getPollById(pollId);
        if (!poll) return;

        const prevChoice = selections[pollId] || null;
        if (prevChoice === optionId) {
          // No change; small feedback (toggle class briefly)
          if (sourceBtn) {
            sourceBtn.classList.add('selected');
            setTimeout(()=> sourceBtn.classList.remove('selected'), 120);
          }
          lastAction.textContent = `no-change ${pollId}:${optionId}`;
          return;
        }

        // Snapshot previous counts for animation
        const prevCounts = { ...(totals[pollId] || {}) };

        // Update totals
        totals[pollId] = totals[pollId] || {};
        totals[pollId][optionId] = (totals[pollId][optionId] || 0) + 1;
        if (prevChoice) {
          totals[pollId][prevChoice] = Math.max(0, (totals[pollId][prevChoice] || 1) - 1);
        }
        selections[pollId] = optionId;

        // Persist
        save(STORAGE_KEYS.totals, totals);
        save(STORAGE_KEYS.selections, selections);

        // UI feedback and proxies
        if (sourceBtn) floatPlus(sourceBtn);
        updatePollUI(pollId, prevCounts, false);
        lastAction.textContent = `voted ${pollId}:${optionId}`;
        document.getElementById(`poll-card-${pollId}`)?.setAttribute('data-last-action', 'voted');
      }

      // ----- Clear vote for a poll -----
      function clearVote(pollId){
        const poll = getPollById(pollId);
        if (!poll) return;
        const prevChoice = selections[pollId];
        if (!prevChoice) return;

        const prevCounts = { ...(totals[pollId] || {}) };
        totals[pollId][prevChoice] = Math.max(0, (totals[pollId][prevChoice] || 0) - 1);
        delete selections[pollId];

        save(STORAGE_KEYS.totals, totals);
        save(STORAGE_KEYS.selections, selections);

        updatePollUI(pollId, prevCounts, false);
        lastAction.textContent = `cleared ${pollId}`;
      }

      // ----- Reset all -----
      function resetAll(){
        const ok = confirm('Reset all votes and clear your selections? This cannot be undone.');
        if (!ok) return;
        totals = generateInitialTotals();
        selections = {};
        save(STORAGE_KEYS.totals, totals);
        save(STORAGE_KEYS.selections, selections);
        renderAll();
        applyFilter(searchInput.value || '');
        resetStatus.textContent = 'done';
        lastAction.textContent = 'reset-all';
      }

      // ----- Search/filter -----
      function applyFilter(query){
        const q = (query || '').trim().toLowerCase();
        let visible = 0;
        const cards = $$('.poll-card', pollsList);
        const doHighlight = !!highlightMatches;

        cards.forEach(card => {
          const pid = card.getAttribute('data-poll-id');
          const poll = getPollById(pid);
          const hay = (poll.title + ' ' + poll.description).toLowerCase();
          const show = !q || hay.includes(q);
          card.style.display = show ? '' : 'none';
          card.setAttribute('data-filter-hit', show && q && doHighlight ? 'true' : 'false');
          if (show) visible++;
        });

        emptyState.style.display = visible === 0 ? 'block' : 'none';

        if (q) {
          filterHeading.style.display = 'block';
          filterHeading.textContent = `Filtered by: "${query}" (${visible} match${visible === 1 ? '' : 'es'})`;
          filterStatus.textContent = `filtered ${visible}`;
          filterStatus.setAttribute('data-active', 'true');
        } else {
          filterHeading.style.display = 'none';
          filterHeading.textContent = 'Filtered results';
          filterStatus.textContent = 'none';
          filterStatus.setAttribute('data-active', 'false');
        }

        lastAction.textContent = q ? `filter "${query}"` : 'filter cleared';
      }

      // ----- Event delegation for polls -----
      pollsList.addEventListener('click', (e) => {
        const target = e.target.closest('[data-role]');
        if (!target) return;

        const role = target.getAttribute('data-role');
        const pollId = target.getAttribute('data-poll-id');

        if (role === 'option') {
          const optionId = target.getAttribute('data-option-id');
          handleVote(pollId, optionId, target);
        } else if (role === 'clear') {
          clearVote(pollId);
        }
      });

      // ----- Header controls -----
      resetAllBtn.addEventListener('click', resetAll);

      searchInput.addEventListener('input', (e) => {
        // Live filter on input
        applyFilter(e.target.value);
      });
      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          applyFilter(searchInput.value);
          e.preventDefault();
        }
      });
      clearSearchBtn.addEventListener('click', () => {
        searchInput.value = '';
        applyFilter('');
        searchInput.focus();
      });

      // ----- Left panel controls -----
      toggleAnimations.addEventListener('change', (e) => {
        reduceMotion = !e.target.checked;
        save(STORAGE_KEYS.reduceMotion, reduceMotion);
        // Update lastAction proxy
        lastAction.textContent = `animations ${reduceMotion ? 'disabled' : 'enabled'}`;
        // Rerender totals once to ensure numbers are in sync
        defaultPolls.forEach(p => updatePollUI(p.id, null, true));
      });

      toggleHighlight.addEventListener('change', (e) => {
        highlightMatches = !!e.target.checked;
        save(STORAGE_KEYS.highlightMatches, highlightMatches);
        applyFilter(searchInput.value || '');
      });

      scrollTopBtn.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: reduceMotion ? 'auto' : 'smooth' });
        lastAction.textContent = 'scroll-top';
        activeSection.textContent = 'Polls';
      });
      scrollBottomBtn.addEventListener('click', () => {
        window.scrollTo({ top: document.body.scrollHeight, behavior: reduceMotion ? 'auto' : 'smooth' });
        lastAction.textContent = 'scroll-bottom';
        activeSection.textContent = 'Polls';
      });

      // External links last-link proxy
      ['docsLink','a11yLink','cssLink'].forEach(id => {
        const a = document.getElementById(id);
        if (!a) return;
        a.addEventListener('click', () => {
          lastLinkClicked.textContent = `Opened: ${a.textContent}`;
        });
      });

      // ----- Initial render -----
      renderAll();
      applyFilter('');
      resetStatus.textContent = 'idle';
      activeSection.textContent = 'Polls';

      // ----- Accessibility: ensure critical controls fit and are focusable -----
      // No auto-trigger flows on load
    })();
  </script>
</body>
</html>