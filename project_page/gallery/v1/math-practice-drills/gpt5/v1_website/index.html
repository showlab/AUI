<!DOCTYPE html>
<html lang="en">
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Math Practice Drills</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* Destylized, high-contrast, operator-friendly UI
       - White background, black text
       - No shadows, gradients, rounded corners, or animations
       - Strong focus outlines and minimum touch size
       - Two-column layout on desktop to fit 1280x720 comfortably
    */

    :root{
      --bg: #ffffff;
      --text: #000000;
      --muted: #333333;
      --accent: #0a58ff;
      --ok: #007a0c;
      --bad: #b50000;
      --warn: #a86700;
      --border: #cfcfcf;
      --focus: #ff9900;
      --panel-bg: #f7f7f7;
      --gap: 16px;
      --control-min: 44px;
      --error: #b50000;
      --good: #007a0c;
      --info: #004f8a;
    }

    html, body{
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial, "Noto Sans";
      font-size: 16px;
      line-height: 1.35;
    }

    *:focus { outline: 3px solid var(--focus); outline-offset: 1px; }

    .container{
      width: min(1200px, 98vw);
      margin: 0 auto;
      padding: 12px;
      display: grid;
      grid-template-columns: 1.05fr 1fr;
      grid-template-rows: auto auto auto 1fr auto;
      grid-template-areas:
        "header header"
        "controls quiz"
        "stats stats"
        "summary history"
        "footer footer";
      gap: 16px;
    }

    header{
      grid-area: header;
      border: 1px solid var(--border);
      background: var(--panel-bg);
      padding: 12px;
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 16px;
    }
    #appTitle{
      margin: 0;
      font-weight: 800;
      font-size: clamp(24px, 3vw, 32px);
    }
    #tagline{
      color: var(--muted);
      margin: 4px 0 0 0;
      font-size: 14px;
    }

    .controls{
      grid-area: controls;
      border: 1px solid var(--border);
      background: var(--panel-bg);
      padding: 12px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .control-row{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .control-group{
      display: grid;
      gap: 6px;
    }

    .control-group label{
      font-weight: 700;
      font-size: 14px;
    }

    select, button, input[type="text"]{
      min-height: var(--control-min);
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      padding: 8px 10px;
      font-size: 16px;
    }

    button{
      cursor: pointer;
    }
    button[disabled], .btn-disabled{
      cursor: not-allowed;
      opacity: 0.7;
    }

    .ops{
      display: grid;
      grid-template-columns: repeat(4, minmax(44px, 1fr));
      gap: 6px;
    }
    .ops label{
      display: grid;
      grid-template-columns: 24px 1fr;
      gap: 6px;
      align-items: center;
      border: 1px solid var(--border);
      background: #fff;
      padding: 6px;
      min-height: var(--control-min);
      user-select: none;
    }

    .actions{
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
    }
    .action-col{
      display: grid;
      gap: 8px;
      align-content: start;
    }

    .primary{ background: var(--accent); color: #fff; border-color: var(--text); }
    .secondary{ background: #fff; color: var(--text); border-color: var(--text); }
    .warn{ background: #f8e6c4; color: var(--warn); border-color: var(--warn); }
    .ok{ background: #e1f3e3; color: var(--ok); border-color: var(--ok); }
    .bad{ background: #f4d4d4; color: var(--bad); border-color: var(--bad); }

    .hint{
      font-size: 12px;
      color: var(--muted);
    }

    .inline-msg{
      font-size: 13px;
      padding: 6px 8px;
      border: 1px solid var(--border);
      background: #fff;
    }

    .quiz{
      grid-area: quiz;
      border: 1px solid var(--border);
      background: var(--panel-bg);
      padding: 12px;
      display: grid;
      gap: 12px;
    }

    .row{
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      align-items: center;
    }

    .timer{
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 12px;
      align-items: center;
    }

    #timerDisplay{
      font-size: 28px;
      font-weight: 800;
      font-variant-numeric: tabular-nums;
    }

    .progress{
      height: 14px;
      border: 1px solid var(--border);
      background: #fff;
      position: relative;
    }
    .progress > .bar{
      position: absolute; left:0; top:0; bottom:0;
      width: 0%;
      background: #cfe0ff;
    }

    .stat-inline{
      border: 1px solid var(--border);
      background: #fff;
      padding: 6px 8px;
      display: grid;
      gap: 2px;
      min-width: 160px;
    }
    .stat-inline .label{ font-size: 12px; color: var(--muted); }
    .stat-inline .value{ font-weight: 800; }

    .question-wrap{
      border: 1px solid var(--border);
      background: #fff;
      padding: 12px;
    }
    #questionText{
      margin: 0;
      text-align: center;
      font-weight: 800;
      font-size: clamp(24px, 8vw, 48px);
    }
    .flash-correct{ outline: 3px solid var(--good); }
    .flash-incorrect{ outline: 3px solid var(--bad); }

    .answer-row{
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 12px;
      align-items: center;
    }
    #answerInput{
      text-align: center;
      font-weight: 700;
      letter-spacing: .3px;
    }
    #answerInput.error{
      border-color: var(--error);
      background: #ffe9e9;
    }
    #accuracyHighlight{
      transition: none; /* prohibited animations */
    }
    .highlight{
      background: #fff3c4;
      border: 1px solid #e6c200;
    }

    .stats{
      grid-area: stats;
      border: 1px solid var(--border);
      background: var(--panel-bg);
      padding: 12px;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }
    .stat{
      border: 1px solid var(--border);
      background: #fff;
      padding: 10px;
      display: grid;
      gap: 6px;
      align-content: start;
    }
    .stat .label{ font-size: 12px; color: var(--muted); }
    .stat .value{ font-weight: 800; font-size: 22px; }

    #bestContainer{ position: relative; }
    #bestStatus{
      font-size: 12px;
      color: var(--good);
    }
    #bestTooltip{
      font-size: 12px;
      color: var(--muted);
    }

    .summary{
      grid-area: summary;
      border: 1px solid var(--border);
      background: var(--panel-bg);
      padding: 12px;
      display: grid;
      gap: 8px;
      color: var(--muted);
    }
    .summary strong{ color: var(--text); }

    .history{
      grid-area: history;
      border: 1px solid var(--border);
      background: var(--panel-bg);
      padding: 12px;
      display: grid;
      grid-template-rows: auto auto 1fr;
      gap: 8px;
    }

    #historyList{
      border: 1px solid var(--border);
      background: #fff;
      min-height: 120px;
      max-height: 300px;
      overflow: auto;
      padding: 8px;
      font-size: 14px;
    }

    footer{
      grid-area: footer;
      border: 1px solid var(--border);
      background: var(--panel-bg);
      padding: 8px;
      text-align: center;
      color: var(--muted);
      font-size: 13px;
    }

    .visually-hidden{
      position:absolute !important;
      left:-9999px !important;
      top:auto !important;
      width:1px !important;
      height:1px !important;
      overflow:hidden !important;
    }

    /* Dialog */
    #confirmDialog{
      position: fixed;
      z-index: 9999;
      left: 0; right: 0; top: 0; bottom: 0;
      display: none;
      align-items: center; justify-content: center;
      background: rgba(0,0,0,0.3);
    }
    #confirmPanel{
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      padding: 16px;
      width: min(520px, 92vw);
      display: grid;
      gap: 12px;
    }
    #confirmText{ font-size: 16px; }
    #confirmActions{
      display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
    }

    /* Proxies and labels */
    .proxy{
      font-size: 12px;
      color: var(--muted);
      border: 1px solid var(--border);
      background: #fff;
      padding: 4px 6px;
    }

    /* Responsive tweaks */
    @media (max-width: 900px){
      .container{
        grid-template-columns: 1fr;
        grid-template-areas:
          "header"
          "controls"
          "quiz"
          "stats"
          "summary"
          "history"
          "footer";
      }
      .stats{ grid-template-columns: repeat(2, 1fr); }
      .answer-row{ grid-template-columns: 1fr auto; }
      #btnSkip{ grid-column: 1 / -1; }
    }
  </style>
</head>
<body>
  <div class="container" role="application" aria-label="Math Practice Drills">
    <header>
      <div>
        <h1 id="appTitle">Math Practice Drills</h1>
        <p id="tagline">Improve speed and accuracy with timed math quizzes.</p>
      </div>
      <div style="display:grid; gap:6px; align-content:start;">
        <div id="quizStatus" class="proxy" aria-live="polite" aria-atomic="true">status: idle</div>
        <div id="activeSection" class="proxy" aria-live="polite" aria-atomic="true">section: Controls</div>
      </div>
    </header>

    <section class="controls panel" aria-labelledby="settingsHeading">
      <h2 id="settingsHeading">Settings</h2>

      <div class="control-row">
        <div class="control-group">
          <label for="difficultySelect">Difficulty</label>
          <select id="difficultySelect" aria-label="Select difficulty">
            <option value="easy">Easy</option>
            <option value="medium">Medium</option>
            <option value="hard">Hard</option>
          </select>
          <div id="difficultyChangedNote" class="inline-msg" style="display:none;">Difficulty updated.</div>
        </div>

        <div class="control-group">
          <label for="durationSelect">Duration</label>
          <select id="durationSelect" aria-label="Select quiz duration">
            <option value="30">30 seconds</option>
            <option value="60" selected>60 seconds</option>
            <option value="120">120 seconds</option>
          </select>
          <div id="durationChangedNote" class="inline-msg" style="display:none;">Duration updated.</div>
        </div>
      </div>

      <div class="control-group">
        <label>Operations</label>
        <div class="ops" role="group" aria-label="Choose operations">
          <label for="opsAdd"><input id="opsAdd" type="checkbox" checked> <span>+</span></label>
          <label for="opsSub"><input id="opsSub" type="checkbox"> <span>−</span></label>
          <label for="opsMul"><input id="opsMul" type="checkbox"> <span>×</span></label>
          <label for="opsDiv"><input id="opsDiv" type="checkbox"> <span>÷</span></label>
        </div>
        <div id="opsChangedNote" class="inline-msg" style="display:none;">Operations updated.</div>
      </div>

      <div class="actions">
        <div class="action-col">
          <button id="btnStart" class="primary" aria-label="Start quiz">Start</button>
          <div id="startLockedMsg" class="inline-msg" style="display:none;">Quiz in progress. Pause or Reset to start again.</div>
          <div id="startLockStatus" class="proxy" aria-live="polite">start-locked: false</div>
          <div class="hint" id="keyboardHint">Hint: Press Enter to submit an answer.</div>
          <div id="runSettingsLabel" class="inline-msg" aria-live="polite">Run settings: Difficulty Easy • Duration 60s • Ops +</div>
        </div>
        <div class="action-col">
          <button id="btnPause" class="secondary" aria-label="Pause quiz" disabled>Pause</button>
          <button id="btnReset" class="warn" aria-label="Reset quiz" disabled>Reset</button>
          <div id="applyStatus" class="proxy">apply: idle</div>
        </div>
        <div class="action-col">
          <div class="stat-inline" title="Lifetime personal best. Does not reset.">
            <div class="label">Best (lifetime)</div>
            <div id="lifetimeBest" class="value">0</div>
            <div id="bestStatus">personal best</div>
            <div id="bestTooltip">This is your all-time best correct answers.</div>
          </div>
          <button id="btnCopySummary" class="secondary" aria-label="Copy summary">Copy Summary</button>
          <div id="copyStatus" class="proxy" aria-live="polite">copy: idle</div>
        </div>
      </div>
    </section>

    <main class="quiz panel" aria-labelledby="quizHeading">
      <h2 id="quizHeading">Quiz</h2>

      <div class="row">
        <div class="timer" aria-live="polite" aria-atomic="true">
          <div id="timerDisplay">01:00</div>
          <div class="progress" aria-hidden="true"><div id="progressBar" class="bar"></div></div>
        </div>
        <div class="timer" style="justify-content:flex-end;">
          <div class="stat-inline" style="min-width: 160px;">
            <div class="label">Streak</div>
            <div id="scoreStreak" class="value">0</div>
          </div>
        </div>
      </div>

      <div id="questionWrap" class="question-wrap" aria-live="polite" aria-atomic="true">
        <p id="questionText" aria-label="Current question">Press Start to begin</p>
      </div>

      <form id="answerForm" class="answer-row" autocomplete="off" novalidate>
        <label for="answerInput" class="visually-hidden">Your answer</label>
        <input id="answerInput" type="text" inputmode="numeric" placeholder="Type answer…" aria-label="Answer input" disabled maxlength="18">
        <button id="btnSubmit" type="submit" aria-label="Submit answer" class="ok" disabled>Submit</button>
        <button id="btnSkip" type="button" class="secondary" aria-label="Skip question" disabled>Skip</button>
      </form>

      <div id="inputError" role="alert" aria-live="polite" class="inline-msg" style="display:none;"></div>
      <div id="trimStatus" class="inline-msg" style="display:none;">Trimmed whitespace from your answer.</div>
      <div id="inputAssistLive" aria-live="polite" aria-atomic="true" class="visually-hidden"></div>
    </main>

    <section class="stats panel" aria-labelledby="statsHeading">
      <h2 id="statsHeading" class="visually-hidden">Score Tracker</h2>

      <div class="stat">
        <div class="label">Correct</div>
        <div id="scoreCorrect" class="value">0</div>
      </div>
      <div class="stat">
        <div class="label">Attempted</div>
        <div id="scoreAttempted" class="value">0</div>
      </div>
      <div class="stat" id="accuracyHighlight">
        <div class="label">Accuracy</div>
        <div id="scoreAccuracy" class="value">0%</div>
      </div>
      <div class="stat" id="bestContainer">
        <div class="label">Best (lifetime)</div>
        <div class="value" aria-describedby="bestTooltip"><span id="bestValueMirror"></span></div>
      </div>
    </section>

    <section class="summary" id="sessionSummaryArea" aria-live="polite" aria-atomic="true">
      Tip: Use Enter to submit your answer. You can adjust difficulty, duration, and operations before starting. Results update in the scoreboard and your best score is saved locally.
    </section>

    <aside class="history panel" aria-labelledby="historyHeading">
      <h2 id="historyHeading">History</h2>
      <div class="hint">Recent sessions are listed below. Use Clear to remove the list (does not affect lifetime best).</div>
      <div id="historyList" aria-live="polite" aria-atomic="false"></div>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px;">
        <button id="btnClearHistory" class="secondary" aria-label="Clear session history">Clear History</button>
        <button id="btnClearLifetime" class="secondary" aria-label="Clear lifetime aggregates">Clear Lifetime Totals</button>
      </div>
    </aside>

    <footer>
      © <span id="year"></span> Math Practice Drills
    </footer>

    <div id="announce" aria-live="assertive" aria-atomic="true" class="visually-hidden">Invalid number</div>
  </div>

  <!-- Confirmation dialog -->
  <div id="confirmDialog" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <div id="confirmPanel">
      <div id="confirmTitle" style="font-weight:800; font-size:18px;">Apply Changes?</div>
      <div id="confirmText">Changing settings during a quiz will end your current run and restart with the new settings. You will lose current progress.</div>
      <div id="confirmActions">
        <button id="btnConfirmApply" class="primary" aria-label="Confirm apply changes">Confirm</button>
        <button id="btnCancelApply" class="secondary" aria-label="Cancel and keep current quiz">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // Elements
    const el = {
      difficulty: document.getElementById('difficultySelect'),
      duration: document.getElementById('durationSelect'),
      opsAdd: document.getElementById('opsAdd'),
      opsSub: document.getElementById('opsSub'),
      opsMul: document.getElementById('opsMul'),
      opsDiv: document.getElementById('opsDiv'),
      btnStart: document.getElementById('btnStart'),
      btnPause: document.getElementById('btnPause'),
      btnReset: document.getElementById('btnReset'),
      questionWrap: document.getElementById('questionWrap'),
      questionText: document.getElementById('questionText'),
      answerForm: document.getElementById('answerForm'),
      answerInput: document.getElementById('answerInput'),
      btnSubmit: document.getElementById('btnSubmit'),
      btnSkip: document.getElementById('btnSkip'),
      timerDisplay: document.getElementById('timerDisplay'),
      progressBar: document.getElementById('progressBar'),
      scoreCorrect: document.getElementById('scoreCorrect'),
      scoreAttempted: document.getElementById('scoreAttempted'),
      scoreAccuracy: document.getElementById('scoreAccuracy'),
      scoreStreak: document.getElementById('scoreStreak'),
      lifetimeBest: document.getElementById('lifetimeBest'),
      sessionSummary: document.getElementById('sessionSummaryArea'),
      announce: document.getElementById('announce'),
      year: document.getElementById('year'),
      difficultyNote: document.getElementById('difficultyChangedNote'),
      durationNote: document.getElementById('durationChangedNote'),
      opsNote: document.getElementById('opsChangedNote'),
      inputError: document.getElementById('inputError'),
      trimStatus: document.getElementById('trimStatus'),
      inputAssistLive: document.getElementById('inputAssistLive'),
      accuracyHighlight: document.getElementById('accuracyHighlight'),
      startLockedMsg: document.getElementById('startLockedMsg'),
      startLockStatus: document.getElementById('startLockStatus'),
      runSettingsLabel: document.getElementById('runSettingsLabel'),
      quizStatus: document.getElementById('quizStatus'),
      activeSection: document.getElementById('activeSection'),
      confirmDialog: document.getElementById('confirmDialog'),
      confirmText: document.getElementById('confirmText'),
      btnConfirmApply: document.getElementById('btnConfirmApply'),
      btnCancelApply: document.getElementById('btnCancelApply'),
      copySummary: document.getElementById('btnCopySummary'),
      copyStatus: document.getElementById('copyStatus'),
      historyList: document.getElementById('historyList'),
      btnClearHistory: document.getElementById('btnClearHistory'),
      btnClearLifetime: document.getElementById('btnClearLifetime'),
      bestStatus: document.getElementById('bestStatus'),
      bestValueMirror: document.getElementById('bestValueMirror'),
      keyboardHint: document.getElementById('keyboardHint'),
      applyStatus: document.getElementById('applyStatus'),
    };

    // Storage keys
    const STORAGE_LIFE = 'mathDrills_lifetime_v1';
    const STORAGE_SETTINGS = 'mathDrills_settings_v1';
    const STORAGE_HISTORY = 'mathDrills_history_v1';

    // State
    let state = {
      active: false,
      paused: false,
      pendingSettingsChange: null, // function to run after confirm
      timer: {
        totalMs: 60000,
        remainingMs: 60000,
        id: null,
        tickRate: 200
      },
      current: null, // {a,b,op,answer,text}
      stats: {
        correct: 0,
        attempted: 0,
        streak: 0,
        maxStreak: 0,
      },
      lifetime: {
        totalSessions: 0,
        totalCorrect: 0,
        totalAttempted: 0,
        bestCorrect: 0,
        bestAccuracy: 0, // percentage integer
      },
      settings: {
        difficulty: 'easy',
        duration: 60,
        ops: { add: true, sub: false, mul: false, div: false }
      },
      history: [], // array of session entries
    };

    // Utilities
    const clamp = (v, min, max) => Math.min(max, Math.max(min, v));
    const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
    const fmtTime = ms => {
      const s = Math.max(0, Math.ceil(ms / 1000));
      const mPart = String(Math.floor(s / 60)).padStart(2,'0');
      const sPart = String(s % 60).padStart(2,'0');
      return `${mPart}:${sPart}`;
    };
    const percent = (num, den) => den ? Math.round((num / den) * 100) : 0;

    function show(elm){ elm.style.display = ''; }
    function hide(elm){ elm.style.display = 'none'; }

    function saveLifetime(){
      localStorage.setItem(STORAGE_LIFE, JSON.stringify(state.lifetime));
    }
    function loadLifetime(){
      try{
        const raw = localStorage.getItem(STORAGE_LIFE);
        if(raw){
          const parsed = JSON.parse(raw);
          Object.assign(state.lifetime, parsed);
        }
      }catch{}
      el.lifetimeBest.textContent = state.lifetime.bestCorrect;
      el.bestValueMirror.textContent = state.lifetime.bestCorrect;
    }
    function saveHistory(){
      try{ localStorage.setItem(STORAGE_HISTORY, JSON.stringify(state.history)); }catch{}
    }
    function loadHistory(){
      try{
        const raw = localStorage.getItem(STORAGE_HISTORY);
        if(raw){ state.history = JSON.parse(raw) || []; }
      }catch{ state.history = []; }
      renderHistory();
    }
    function renderHistory(){
      if(state.history.length === 0){
        el.historyList.textContent = 'No sessions yet.';
        return;
      }
      const lines = state.history.slice(-50).map((h, idx)=>{
        const ops = []
        if(h.ops.add) ops.push('+');
        if(h.ops.sub) ops.push('−');
        if(h.ops.mul) ops.push('×');
        if(h.ops.div) ops.push('÷');
        return `[${h.ts}] • ${h.difficulty.toUpperCase()} • ${h.duration}s • Ops ${ops.join('')} • Correct ${h.correct}/${h.attempted} (${h.accuracy}%) • BestAfter ${h.bestAfter}`;
      });
      el.historyList.textContent = lines.join('\n');
    }

    function saveSettings(){
      const s = {
        difficulty: el.difficulty.value,
        duration: Number(el.duration.value),
        ops: {
          add: el.opsAdd.checked,
          sub: el.opsSub.checked,
          mul: el.opsMul.checked,
          div: el.opsDiv.checked,
        }
      };
      localStorage.setItem(STORAGE_SETTINGS, JSON.stringify(s));
      state.settings = s;
      updateRunSettingsLabel();
    }
    function loadSettings(){
      try{
        const raw = localStorage.getItem(STORAGE_SETTINGS);
        if(raw){
          const s = JSON.parse(raw);
          el.difficulty.value = s.difficulty ?? 'easy';
          el.duration.value = String(s.duration ?? 60);
          el.opsAdd.checked = !!s.ops?.add;
          el.opsSub.checked = !!s.ops?.sub;
          el.opsMul.checked = !!s.ops?.mul;
          el.opsDiv.checked = !!s.ops?.div;
          state.settings = {
            difficulty: el.difficulty.value,
            duration: Number(el.duration.value),
            ops: { add: el.opsAdd.checked, sub: el.opsSub.checked, mul: el.opsMul.checked, div: el.opsDiv.checked }
          };
        }
      }catch{}
      updateRunSettingsLabel();
    }

    // Question generation based on difficulty and selected operations
    function getRanges(difficulty){
      switch(difficulty){
        case 'easy':
          return { addsub: [0, 20], mul: [0, 12], divDivisor: [1,12], divQuotient: [0,12] };
        case 'medium':
          return { addsub: [0, 100], mul: [0, 20], divDivisor: [1,20], divQuotient: [0,20] };
        case 'hard':
          return { addsub: [0, 999], mul: [0, 50], divDivisor: [1,50], divQuotient: [0,50] };
        default:
          return { addsub: [0, 20], mul: [0, 12], divDivisor: [1,12], divQuotient: [0,12] };
      }
    }

    function generateQuestion(){
      const difficulty = el.difficulty.value;
      const ops = [];
      if(el.opsAdd.checked) ops.push('+');
      if(el.opsSub.checked) ops.push('-');
      if(el.opsMul.checked) ops.push('×');
      if(el.opsDiv.checked) ops.push('÷');
      if(ops.length === 0) return null;

      const op = pick(ops);
      const r = getRanges(difficulty);
      let a, b, ans, text;

      if(op === '+'){
        a = randInt(r.addsub[0], r.addsub[1]);
        b = randInt(r.addsub[0], r.addsub[1]);
        ans = a + b;
        text = `${a} + ${b} = ?`;
      }
      else if(op === '-'){
        // avoid negative results
        const x = randInt(r.addsub[0], r.addsub[1]);
        const y = randInt(r.addsub[0], r.addsub[1]);
        a = Math.max(x, y);
        b = Math.min(x, y);
        ans = a - b;
        text = `${a} − ${b} = ?`;
      }
      else if(op === '×'){
        a = randInt(r.mul[0], r.mul[1]);
        b = randInt(r.mul[0], r.mul[1]);
        ans = a * b;
        text = `${a} × ${b} = ?`;
      }
      else if(op === '÷'){
        // ensure integer division
        const divisor = randInt(r.divDivisor[0], r.divDivisor[1]);
        const quotient = randInt(r.divQuotient[0], r.divQuotient[1]);
        a = divisor * quotient;
        b = divisor === 0 ? 1 : divisor;
        ans = b === 0 ? 0 : (a / b);
        text = `${a} ÷ ${b} = ?`;
      }
      return { a, b, op, answer: ans, text };
    }

    // Session logic
    function resetStats(){
      state.stats.correct = 0;
      state.stats.attempted = 0;
      state.stats.streak = 0;
      state.stats.maxStreak = 0;
      updateStatsUI();
    }
    function updateStatsUI(){
      el.scoreCorrect.textContent = state.stats.correct;
      el.scoreAttempted.textContent = state.stats.attempted;
      const acc = percent(state.stats.correct, state.stats.attempted);
      el.scoreAccuracy.textContent = `${acc}%`;
      el.scoreStreak.textContent = state.stats.streak;
      bumpAccuracy();
    }
    function bumpAccuracy(){
      el.accuracyHighlight.classList.remove('highlight');
      void el.accuracyHighlight.offsetWidth; // force reflow without animations
      el.accuracyHighlight.classList.add('highlight');
      setTimeout(()=>{ el.accuracyHighlight.classList.remove('highlight'); }, 180);
    }
    function updateTimerUI(){
      el.timerDisplay.textContent = fmtTime(state.timer.remainingMs);
      const pct = clamp(100 - (state.timer.remainingMs / state.timer.totalMs) * 100, 0, 100);
      el.progressBar.style.width = `${pct}%`;
    }
    function setActiveUI(active){
      state.active = active;
      const running = active && !state.paused;

      el.btnStart.disabled = active || !hasAnyOperation();
      el.btnStart.setAttribute('aria-disabled', String(el.btnStart.disabled));
      if(el.btnStart.disabled && active){
        show(el.startLockedMsg);
        el.startLockStatus.textContent = 'start-locked: true';
      }else{
        hide(el.startLockedMsg);
        el.startLockStatus.textContent = 'start-locked: false';
      }

      // Allow difficulty/duration/ops to be changed mid-quiz but guard with confirm
      el.difficulty.disabled = false;
      el.duration.disabled = false;
      el.opsAdd.disabled = false;
      el.opsSub.disabled = false;
      el.opsMul.disabled = false;
      el.opsDiv.disabled = false;

      el.answerInput.disabled = !active || state.paused;
      el.btnSubmit.disabled = !active || state.paused;
      el.btnSkip.disabled = !active || state.paused;

      el.btnPause.disabled = !active;
      el.btnReset.disabled = !active;

      el.btnPause.textContent = state.paused ? 'Resume' : 'Pause';

      if(active && !state.paused){
        el.answerInput.focus();
        el.answerInput.select();
        el.activeSection.textContent = 'section: Quiz';
      }else{
        el.activeSection.textContent = 'section: Controls';
      }

      el.quizStatus.textContent = 'status: ' + (active ? (state.paused ? 'paused' : 'running') : 'idle');
    }

    function hasAnyOperation(){
      return el.opsAdd.checked || el.opsSub.checked || el.opsMul.checked || el.opsDiv.checked;
    }

    function nextQuestion(){
      const q = generateQuestion();
      if(!q){
        el.questionText.textContent = 'Select at least one operation';
        return;
      }
      state.current = q;
      el.questionText.textContent = q.text;
      if(state.active && !state.paused){
        el.answerInput.focus();
        el.answerInput.select();
      }
    }

    function startTimer(){
      clearInterval(state.timer.id);
      state.timer.id = setInterval(()=>{
        if(state.paused || !state.active) return;
        state.timer.remainingMs -= state.timer.tickRate;
        if(state.timer.remainingMs <= 0){
          state.timer.remainingMs = 0;
          updateTimerUI();
          // Disable input immediately at boundary
          el.answerInput.disabled = true;
          el.btnSubmit.disabled = true;
          el.btnSkip.disabled = true;
          endQuiz('time');
          return;
        }
        updateTimerUI();
      }, state.timer.tickRate);
    }

    function stopTimer(){
      clearInterval(state.timer.id);
      state.timer.id = null;
    }

    function clearInlineMessages(){
      hide(el.inputError);
      hide(el.trimStatus);
      hide(el.difficultyNote);
      hide(el.durationNote);
      hide(el.opsNote);
    }

    function startQuiz(){
      if(!hasAnyOperation()) return;
      // Save current settings
      saveSettings();

      resetStats();
      state.paused = false;
      const totalMs = Number(el.duration.value) * 1000;
      state.timer.totalMs = totalMs;
      state.timer.remainingMs = totalMs;
      updateTimerUI();
      clearInlineMessages();
      nextQuestion();
      setActiveUI(true);
      el.sessionSummary.textContent = 'Good luck! Keep an eye on the timer.';
      startTimer();
      announce('Quiz started');
    }

    function summarize(reason){
      const acc = percent(state.stats.correct, state.stats.attempted);
      const msg =
        `Session ${reason === 'time' ? 'complete (time up)' : 'ended'} — ` +
        `Correct: ${state.stats.correct} / ${state.stats.attempted} ` +
        `(${acc}%). Max streak: ${state.stats.maxStreak}.`;
      return {msg, acc};
    }

    function endQuiz(reason = 'stopped'){
      if(!state.active) {
        el.quizStatus.textContent = 'status: idle';
        return;
      }
      setActiveUI(false);
      stopTimer();

      // Lifetime updates
      state.lifetime.totalSessions += 1;
      state.lifetime.totalCorrect += state.stats.correct;
      state.lifetime.totalAttempted += state.stats.attempted;
      let newBest = false;
      if(state.stats.correct > state.lifetime.bestCorrect){
        state.lifetime.bestCorrect = state.stats.correct;
        newBest = true;
      }
      const acc = percent(state.stats.correct, state.stats.attempted);
      if(acc > state.lifetime.bestAccuracy){
        state.lifetime.bestAccuracy = acc;
      }
      saveLifetime();
      el.lifetimeBest.textContent = state.lifetime.bestCorrect;
      el.bestValueMirror.textContent = state.lifetime.bestCorrect;
      el.bestStatus.textContent = newBest ? 'new personal best!' : 'personal best';
      if(newBest){ el.bestStatus.style.color = 'var(--ok)'; }

      // History entry
      const ops = {
        add: el.opsAdd.checked,
        sub: el.opsSub.checked,
        mul: el.opsMul.checked,
        div: el.opsDiv.checked
      };
      const entry = {
        ts: new Date().toLocaleString(),
        difficulty: el.difficulty.value,
        duration: Number(el.duration.value),
        correct: state.stats.correct,
        attempted: state.stats.attempted,
        accuracy: acc,
        bestAfter: state.lifetime.bestCorrect,
        ops
      };
      state.history.push(entry);
      saveHistory();
      renderHistory();

      // Summary
      const s = summarize(reason);
      el.sessionSummary.innerHTML = `<strong>${s.msg}</strong>`;
      el.questionText.textContent = 'Press Start to try another round';
      updateTimerUI();
      announce('Quiz ended');
      el.btnStart.focus(); // accessibility: focus start
      el.quizStatus.textContent = 'status: ended';
    }

    // Answer submission guard (prevent double submit)
    let submitGuard = false;

    function handleAnswerSubmission(){
      if(submitGuard) return;
      if(!state.active || state.paused || !state.current) return;
      if(state.timer.remainingMs <= 0){ // hard boundary
        el.answerInput.disabled = true;
        el.btnSubmit.disabled = true;
        el.btnSkip.disabled = true;
        endQuiz('time');
        return;
      }

      const before = el.answerInput.value;
      const raw = before.trim();
      if(before !== raw){
        show(el.trimStatus);
        el.trimStatus.textContent = 'Trimmed whitespace from your answer.';
        el.inputAssistLive.textContent = 'Trimmed whitespace.';
      }else{
        hide(el.trimStatus);
      }
      if(raw === ''){
        showError('Please enter a number.');
        flash(el.questionWrap, 'incorrect');
        announce('Invalid number');
        return;
      }
      // Accept integer, including negative sign
      if(!/^-?\d+$/.test(raw)){
        showError('Only whole numbers are allowed.');
        el.answerInput.classList.add('error');
        flash(el.questionWrap, 'incorrect');
        announce('Invalid number');
        return;
      }
      // Overflow feedback (allow submission)
      const digits = raw.replace('-', '').length;
      if(digits > 10){
        showError('Input exceeds 10 digits; it will still be accepted.');
      }else{
        hide(el.inputError);
      }

      // Prevent double submit briefly
      submitGuard = true;
      el.answerInput.disabled = true;
      el.btnSubmit.disabled = true;
      setTimeout(()=>{
        el.answerInput.disabled = false;
        el.btnSubmit.disabled = false;
        if(state.active && !state.paused){
          el.answerInput.focus();
          el.answerInput.select();
        }
        submitGuard = false;
      }, 400);

      el.answerInput.classList.remove('error');

      const user = Number(raw);
      const correct = (user === state.current.answer);
      state.stats.attempted += 1;
      if(correct){
        state.stats.correct += 1;
        state.stats.streak += 1;
        if(state.stats.streak > state.stats.maxStreak){
          state.stats.maxStreak = state.stats.streak;
        }
        flash(el.questionWrap, 'correct');
        flashButton(el.btnSubmit, 'Accepted');
        announce('Correct');
      }else{
        state.stats.streak = 0;
        flash(el.questionWrap, 'incorrect');
        announce('Incorrect');
      }
      updateStatsUI();
      el.answerInput.value = '';
      nextQuestion();
    }

    function flashButton(btn, text){
      const old = btn.textContent;
      btn.textContent = text;
      setTimeout(()=>{ btn.textContent = old; }, 450);
    }

    function skipQuestion(){
      if(!state.active || state.paused) return;
      state.stats.attempted += 1;
      state.stats.streak = 0;
      updateStatsUI();
      flash(el.questionWrap, 'incorrect');
      nextQuestion();
      announce('Skipped');
      el.answerInput.value = '';
    }

    function flash(node, kind){
      node.classList.remove('flash-correct', 'flash-incorrect');
      void node.offsetWidth; // restart effect
      node.classList.add(kind === 'correct' ? 'flash-correct' : 'flash-incorrect');
      setTimeout(()=>node.classList.remove('flash-correct', 'flash-incorrect'), 180);
    }

    function togglePause(){
      if(!state.active) return;
      state.paused = !state.paused;
      if(state.paused){
        stopTimer();
        el.sessionSummary.textContent = 'Paused — Resume when ready.';
        announce('Paused');
      }else{
        el.sessionSummary.textContent = 'Go!';
        startTimer();
        announce('Resumed');
      }
      setActiveUI(true);
    }

    // Announce for screen readers
    function announce(text){
      el.announce.textContent = '';
      setTimeout(()=>{ el.announce.textContent = text; }, 0);
    }

    // Messages
    function showError(msg){
      el.inputError.textContent = msg;
      show(el.inputError);
    }

    // Run settings label
    function updateRunSettingsLabel(){
      const ops = []
      if(el.opsAdd.checked) ops.push('+');
      if(el.opsSub.checked) ops.push('−');
      if(el.opsMul.checked) ops.push('×');
      if(el.opsDiv.checked) ops.push('÷');
      el.runSettingsLabel.textContent =
        `Run settings: Difficulty ${capitalize(el.difficulty.value)} • Duration ${el.duration.value}s • Ops ${ops.join('') || '—'}`;
    }

    function capitalize(s){ return s ? s[0].toUpperCase() + s.slice(1) : s; }

    // Confirm dialog for mid-quiz changes
    function openConfirm(applyFn){
      state.pendingSettingsChange = applyFn;
      el.confirmText.textContent = 'Changing settings during a quiz will end your current run and restart with the new settings. You will lose current progress.';
      el.applyStatus.textContent = 'apply: pending';
      el.confirmDialog.style.display = 'flex';
      el.btnConfirmApply.focus();
    }
    function closeConfirm(){
      state.pendingSettingsChange = null;
      el.confirmDialog.style.display = 'none';
      el.applyStatus.textContent = 'apply: canceled';
    }
    function confirmApply(){
      const fn = state.pendingSettingsChange;
      el.confirmDialog.style.display = 'none';
      el.applyStatus.textContent = 'apply: confirmed';
      if(typeof fn === 'function'){ fn(); }
      state.pendingSettingsChange = null;
    }

    // Clipboard copy
    async function copySummary(){
      const text = el.sessionSummary.textContent || '';
      try{
        await navigator.clipboard.writeText(text);
        el.copyStatus.textContent = 'copy: done';
      }catch{
        el.copyStatus.textContent = 'copy: failed';
      }
    }

    // Event bindings
    el.btnStart.addEventListener('click', ()=>{
      if(state.active){
        show(el.startLockedMsg);
        el.startLockStatus.textContent = 'start-locked: true';
        return;
      }
      startQuiz();
    });
    el.btnPause.addEventListener('click', togglePause);
    el.btnReset.addEventListener('click', ()=> endQuiz('stopped'));
    el.copySummary.addEventListener('click', copySummary);

    el.answerForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      handleAnswerSubmission();
    });
    el.btnSkip.addEventListener('click', skipQuestion);

    el.answerInput.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape'){
        e.preventDefault();
        skipQuestion();
      }
    });
    el.answerInput.addEventListener('input', ()=>{
      hide(el.inputError);
      el.answerInput.classList.remove('error');
    });

    // Settings changes
    function handleSettingChange(noteEl){
      show(noteEl);
      saveSettings();
      el.btnStart.disabled = !hasAnyOperation() || state.active;
      el.btnStart.setAttribute('aria-disabled', String(el.btnStart.disabled));
      if(state.active){
        openConfirm(()=>{
          // restart quiz with new settings
          endQuiz('settings-changed');
          startQuiz();
        });
      }
    }

    el.difficulty.addEventListener('change', ()=> handleSettingChange(el.difficultyNote));
    el.duration.addEventListener('change', ()=> handleSettingChange(el.durationNote));
    [el.opsAdd, el.opsSub, el.opsMul, el.opsDiv].forEach(control=>{
      control.addEventListener('change', ()=> handleSettingChange(el.opsNote));
    });

    el.btnConfirmApply.addEventListener('click', confirmApply);
    el.btnCancelApply.addEventListener('click', closeConfirm);

    // Clear history and lifetime
    el.btnClearHistory.addEventListener('click', ()=>{
      state.history = [];
      saveHistory();
      renderHistory();
      el.sessionSummary.textContent = 'History cleared.';
    });
    el.btnClearLifetime.addEventListener('click', ()=>{
      state.lifetime.totalSessions = 0;
      state.lifetime.totalCorrect = 0;
      state.lifetime.totalAttempted = 0;
      state.lifetime.bestCorrect = state.lifetime.bestCorrect; // do not reset best by default
      // The request was to clear lifetime aggregates but keep best; we keep best intact.
      saveLifetime();
      el.sessionSummary.textContent = 'Lifetime totals cleared. Personal best preserved.';
    });

    // Init
    (function init(){
      el.year.textContent = new Date().getFullYear();
      loadSettings();
      loadLifetime();
      loadHistory();
      el.btnStart.disabled = !hasAnyOperation();
      el.btnStart.setAttribute('aria-disabled', String(el.btnStart.disabled));
      el.timerDisplay.textContent = fmtTime(Number(el.duration.value) * 1000);
      updateStatsUI();
      updateRunSettingsLabel();
      el.quizStatus.textContent = 'status: idle';
      el.activeSection.textContent = 'section: Controls';
    })();

    // Keep exported function names present for non-regression checks (no functional changes needed)
    // The functions already exist above: saveLifetime, loadLifetime, saveSettings, loadSettings,
    // getRanges, generateQuestion, resetStats, updateStatsUI, updateTimerUI, setActiveUI,
    // hasAnyOperation, nextQuestion, startTimer, stopTimer, startQuiz, endQuiz,
    // handleAnswerSubmission, skipQuestion, flash, togglePause, announce, init(IIFE)
  </script>
</body>
</html>