<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <title>Music Theory Trainer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Music Theory Trainer: Learn notes, scales, and chords with an interactive piano and ear training exercises." />
  <style>
    :root{
      --bg1: #0b1f3a;
      --bg2: #142b4f;
      --accent: #ffd452;
      --accent2: #7cf4ff;
      --good: #37d67a;
      --bad: #ff5c5c;
      --muted: #a9b6d3;
      --whiteKey: #fffdf8;
      --whiteKeyEdge: #e5e2d9;
      --blackKey: #1a1a1a;
      --active: #8ac6ff;
      --highlightScale: #8dffb3;
      --highlightChord: #ffda7b;
    }
    html, body {
      margin: 0;
      height: 100%;
      background: radial-gradient(1200px 700px at 25% 30%, #183b6b 0%, var(--bg2) 50%, var(--bg1) 100%);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
      color: #f2f5ff;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.0));
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    header h1 {
      margin: 0;
      font-size: 28px;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    header h1 .logo {
      display: inline-flex;
      width: 34px; height: 34px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #ffe38d, #ff8a00);
      box-shadow: 0 0 20px rgba(255,212,82,0.5), inset 0 0 10px rgba(0,0,0,0.2);
      position: relative;
    }
    header h1 .logo::after {
      content: "♪";
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      color: #1a1a1a;
      font-weight: 700;
      font-size: 18px;
      text-shadow: 0 1px 0 rgba(255,255,255,0.3);
    }
    #globalControls {
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .control {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: var(--muted);
    }
    select, button, input[type="range"] {
      background: rgba(255,255,255,0.08);
      color: #f7fbff;
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 14px;
    }
    button {
      cursor: pointer;
      transition: transform 0.04s ease, background 0.2s ease, box-shadow 0.2s ease;
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
      box-shadow: 0 3px 0 rgba(0,0,0,0.3);
      border-radius: 10px;
    }
    button:hover { transform: translateY(-1px); }
    button:active { transform: translateY(1px); }
    button.primary {
      background: linear-gradient(180deg, rgba(255,212,82,0.4), rgba(255,212,82,0.08));
      border-color: rgba(255,212,82,0.4);
      color: #1a1a1a;
      font-weight: 700;
    }
    button.good {
      background: linear-gradient(180deg, rgba(55,214,122,0.4), rgba(55,214,122,0.08));
      border-color: rgba(55,214,122,0.4);
      color: #0d1d13;
      font-weight: 700;
    }
    button.bad {
      background: linear-gradient(180deg, rgba(255,92,92,0.4), rgba(255,92,92,0.08));
      border-color: rgba(255,92,92,0.4);
      color: #1a0d0d;
      font-weight: 700;
    }

    main {
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 16px;
      padding: 16px 20px 24px;
      min-height: calc(100% - 74px);
    }

    aside {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    .tabs button {
      flex: 1 1 auto;
      padding: 10px;
    }
    .tabs button.active {
      outline: 2px solid var(--accent);
      outline-offset: 0px;
      box-shadow: 0 0 0 3px rgba(255,212,82,0.2);
    }
    .panel {
      display: none;
      gap: 14px;
      flex-direction: column;
    }
    .panel.active {
      display: flex;
    }
    .card {
      background: rgba(0,0,0,0.2);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 12px;
      padding: 12px;
    }
    .card h3 {
      margin: 0 0 8px;
      font-size: 18px;
    }
    .group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      align-items: center;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .hint {
      font-size: 12px;
      color: var(--muted);
    }
    .status {
      font-size: 14px;
      padding: 8px 10px;
      border-radius: 8px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
      min-height: 22px;
    }
    .score {
      font-weight: 700;
      color: var(--accent);
    }

    section#pianoArea {
      position: relative;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 12px;
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 12px;
      min-height: 520px;
    }
    #pianoHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    #pianoContainer {
      position: relative;
      width: 100%;
      height: 340px;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.08);
      overflow: hidden;
      user-select: none;
      touch-action: none;
    }
    .key {
      position: absolute;
      bottom: 0;
      border-radius: 0 0 8px 8px;
      box-sizing: border-box;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding-bottom: 6px;
      cursor: pointer;
      transition: background 0.12s ease, transform 0.02s, box-shadow 0.2s ease, filter 0.2s;
    }
    .key.white {
      background: linear-gradient(180deg, var(--whiteKey), #f7f5f0);
      border: 1px solid var(--whiteKeyEdge);
      height: 100%;
      z-index: 1;
    }
    .key.black {
      background: linear-gradient(180deg, #333, var(--blackKey));
      border: 1px solid #111;
      height: 62%;
      border-radius: 0 0 6px 6px;
      box-shadow: 0 6px 14px rgba(0,0,0,0.5);
      color: #ddd;
      z-index: 2;
    }
    .key.white.active, .key.white:active {
      background: linear-gradient(180deg, #e9f5ff, #d7edff);
      border-color: #c6dfff;
      box-shadow: inset 0 -8px 20px rgba(138,198,255,0.45);
    }
    .key.black.active, .key.black:active {
      background: linear-gradient(180deg, #556, #223);
      filter: brightness(1.15);
    }
    .key.highlight-scale {
      box-shadow: inset 0 -8px 20px rgba(141,255,179,0.65), 0 0 0 2px rgba(141,255,179,0.4);
    }
    .key.highlight-chord {
      box-shadow: inset 0 -10px 24px rgba(255,218,123,0.7), 0 0 0 2px rgba(255,218,123,0.4);
    }
    .keyLabel {
      font-size: 11px;
      color: #333;
      background: rgba(0,0,0,0.06);
      padding: 3px 6px;
      border-radius: 6px;
    }
    .key.black .keyLabel {
      color: #f7f7f7;
      background: rgba(255,255,255,0.08);
    }
    #pianoFooter {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
    }

    details.help summary {
      cursor: pointer;
      color: var(--accent2);
      margin-bottom: 6px;
    }

    /* Mobile-ish tweaks */
    @media (max-width: 1100px) {
      main { grid-template-columns: 1fr; }
      #pianoContainer { height: 300px; }
    }

    /* Tiny celebratory notes when correct */
    .burst {
      position: absolute;
      pointer-events: none;
      font-size: 16px;
      animation: floatUp 900ms ease-out forwards;
      opacity: 0.95;
      text-shadow: 0 2px 0 rgba(0,0,0,0.25);
    }
    @keyframes floatUp {
      0% { transform: translateY(0) scale(1); opacity: 1; }
      80% { opacity: 0.9; }
      100% { transform: translateY(-60px) scale(1.2); opacity: 0; }
    }
  </style>
</head>
<body>
  <header>
    <h1><span class="logo" aria-hidden="true"></span> Music Theory Trainer</h1>
    <div id="globalControls" aria-label="Global audio controls">
      <div class="control">
        <label for="waveformSelect">Waveform</label>
        <select id="waveformSelect" aria-label="Select waveform">
          <option value="sine">Sine</option>
          <option value="triangle">Triangle</option>
          <option value="square">Square</option>
          <option value="sawtooth">Sawtooth</option>
        </select>
      </div>
      <div class="control">
        <label for="volumeSlider">Volume</label>
        <input id="volumeSlider" type="range" min="0" max="1" step="0.01" value="0.6" />
      </div>
    </div>
  </header>

  <main>
    <aside aria-label="Learning and training controls">
      <nav class="tabs" aria-label="Panels">
        <button id="tabLearnBtn" class="active" aria-controls="panelLearn" aria-pressed="true">Learn</button>
        <button id="tabTrainBtn" aria-controls="panelTrain" aria-pressed="false">Train (Ear)</button>
      </nav>

      <section id="panelLearn" class="panel active" aria-live="polite">
        <div class="card">
          <h3>Scale Explorer</h3>
          <div class="group">
            <label for="scaleRootSelect">Root</label>
            <select id="scaleRootSelect"></select>
            <label for="scaleTypeSelect">Scale</label>
            <select id="scaleTypeSelect">
              <option value="major">Major (Ionian)</option>
              <option value="naturalMinor">Natural Minor (Aeolian)</option>
              <option value="harmonicMinor">Harmonic Minor</option>
              <option value="melodicMinor">Melodic Minor (Asc)</option>
              <option value="majorPent">Major Pentatonic</option>
              <option value="minorPent">Minor Pentatonic</option>
              <option value="blues">Blues</option>
              <option value="dorian">Dorian</option>
              <option value="mixolydian">Mixolydian</option>
              <option value="lydian">Lydian</option>
              <option value="phrygian">Phrygian</option>
              <option value="locrian">Locrian</option>
            </select>
          </div>
          <div class="row">
            <button id="playScaleBtn" class="primary">Play Scale</button>
            <button id="clearScaleHighlightsBtn">Clear Highlights</button>
            <span class="hint">Keys highlighted in green</span>
          </div>
        </div>

        <div class="card">
          <h3>Chord Explorer</h3>
          <div class="group">
            <label for="chordRootSelect">Root</label>
            <select id="chordRootSelect"></select>
            <label for="chordTypeSelect">Type</label>
            <select id="chordTypeSelect">
              <option value="maj">Major</option>
              <option value="min">Minor</option>
              <option value="dim">Diminished</option>
              <option value="aug">Augmented</option>
              <option value="maj7">Major 7</option>
              <option value="min7">Minor 7</option>
              <option value="dom7">Dominant 7</option>
              <option value="sus2">Suspended 2</option>
              <option value="sus4">Suspended 4</option>
            </select>
          </div>
          <div class="group">
            <label for="chordInversionSelect">Inversion</label>
            <select id="chordInversionSelect">
              <option value="0">Root position</option>
              <option value="1">1st inversion</option>
              <option value="2">2nd inversion</option>
              <option value="3">3rd inversion</option>
            </select>
            <span class="hint">Try inversions to reorder chord tones</span>
          </div>
          <div class="row">
            <button id="playChordBtn" class="primary">Play Chord</button>
            <button id="clearChordHighlightsBtn">Clear Highlights</button>
            <span class="hint">Keys highlighted in gold</span>
          </div>
        </div>

        <details class="help" id="learnHelp">
          <summary>Tips for Learn mode</summary>
          - Choose a scale or chord to highlight matching keys on the piano. 
          - Press "Play" to hear the pattern. 
          - Combine with different waveforms to explore timbre.
        </details>
      </section>

      <section id="panelTrain" class="panel" aria-live="polite">
        <div class="card">
          <h3>Note Trainer</h3>
          <div class="row">
            <button id="startNoteQuizBtn" class="primary">New Note</button>
            <button id="replayNoteBtn">Replay</button>
            <button id="revealNoteBtn">Reveal</button>
            <span id="noteScore" class="score">0/0</span>
          </div>
          <div id="noteQuizStatus" class="status">Click "New Note", then choose the right piano key.</div>
        </div>

        <div class="card">
          <h3>Interval Trainer</h3>
          <div class="row">
            <button id="startIntervalQuizBtn" class="primary">New Interval</button>
            <button id="replayIntervalBtn">Replay</button>
            <span id="intervalScore" class="score">0/0</span>
          </div>
          <div id="intervalOptions" class="row" role="group" aria-label="Interval options">
            <!-- interval buttons injected -->
          </div>
          <div id="intervalQuizStatus" class="status">Click "New Interval", then pick the interval you hear.</div>
        </div>

        <div class="card">
          <h3>Chord Trainer</h3>
          <div class="row">
            <button id="startChordQuizBtn" class="primary">New Chord</button>
            <button id="replayChordBtn">Replay</button>
            <span id="chordScore" class="score">0/0</span>
          </div>
          <div id="chordOptions" class="row" role="group" aria-label="Chord options">
            <!-- chord option buttons injected -->
          </div>
          <div id="chordQuizStatus" class="status">Click "New Chord", then choose its quality.</div>
        </div>

        <details class="help" id="trainHelp">
          <summary>Tips for Ear Training</summary>
          - Note Trainer: Identify a single pitch by clicking the correct key. 
          - Interval Trainer: Identify the distance between two notes (semitones shown by name). 
          - Chord Trainer: Identify the chord quality from a block chord.
        </details>
      </section>
    </aside>

    <section id="pianoArea" aria-label="Interactive piano">
      <div id="pianoHeader">
        <div>
          <strong>Interactive Piano</strong>
          <div class="hint">Click keys or use your keyboard: Z-S-X-D-C-V-G-B-H-N-J-M for white keys, with nearby letters for black keys.</div>
        </div>
        <div class="row">
          <button id="allNotesOffBtn">All Notes Off</button>
          <button id="clearAllHighlightsBtn">Clear All Highlights</button>
        </div>
      </div>
      <div id="pianoContainer" aria-label="Piano keyboard"></div>
      <div id="pianoFooter" class="hint">
        Tip: Use the Learn tools to highlight notes on the keyboard, then test yourself in Train mode.
      </div>
    </section>
  </main>

  <footer class="hint" style="padding: 8px 20px 16px;">
    © 2025 Music Theory Trainer – Built with HTML5, CSS3 and vanilla JavaScript. No external libraries.
  </footer>

  <script>
    // Music Theory Trainer - Vanilla JS, Web Audio, Responsive Piano
    (function(){
      'use strict';

      // ----------------------------
      // Audio Engine
      // ----------------------------
      const AudioEngine = {
        context: null,
        master: null,
        active: new Map(),
        waveform: 'sine',
        volume: 0.6,
        ensureContext() {
          if (!this.context) {
            const AC = window.AudioContext || window.webkitAudioContext;
            this.context = new AC();
            this.master = this.context.createGain();
            this.master.gain.value = this.volume;
            this.master.connect(this.context.destination);
          }
          if (this.context.state === 'suspended') {
            this.context.resume();
          }
        },
        setWaveform(type) {
          this.waveform = type;
        },
        setVolume(v) {
          this.volume = v;
          if (this.master) this.master.gain.value = v;
        },
        freqFromMidi(m) {
          return 440 * Math.pow(2, (m - 69) / 12);
        },
        playNote(midi, opts = {}) {
          this.ensureContext();
          const now = this.context.currentTime;
          const osc = this.context.createOscillator();
          const gain = this.context.createGain();

          // Simple ADSR
          const a = 0.01, d = 0.08, s = 0.75, r = 0.2;
          const vel = (opts.velocity != null ? opts.velocity : 1.0);
          gain.gain.cancelScheduledValues(now);
          gain.gain.setValueAtTime(0.0001, now);
          gain.gain.linearRampToValueAtTime(0.85 * vel, now + a);
          gain.gain.linearRampToValueAtTime(0.85 * vel * s, now + a + d);

          osc.type = this.waveform;
          osc.frequency.value = this.freqFromMidi(midi);

          // Slight detune for richness if chord block
          if (opts.detuneCents) osc.detune.value = opts.detuneCents;

          osc.connect(gain);
          gain.connect(this.master);
          osc.start(now);

          const stop = (releaseMs=200) => {
            const t = this.context.currentTime;
            gain.gain.cancelScheduledValues(t);
            gain.gain.setTargetAtTime(0.0001, t, Math.max(0.02, releaseMs/1000));
            try {
              osc.stop(t + Math.max(0.03, releaseMs/1000 + 0.02));
            } catch {}
          };

          this.active.set(midi, { osc, gain, stop });
          return midi;
        },
        stopNote(midi, releaseMs=200) {
          const node = this.active.get(midi);
          if (node) {
            node.stop(releaseMs);
            this.active.delete(midi);
          }
        },
        stopAll() {
          for (const [m, node] of this.active) { try { node.stop(80); } catch {} }
          this.active.clear();
        },
        playChord(midis, { block=true, arpeggioMs=90 } = {}) {
          this.ensureContext();
          if (block) {
            midis.forEach((m, i) => {
              const det = (i - (midis.length-1)/2) * 2; // slight spread
              this.playNote(m, { velocity: 0.9, detuneCents: det });
            });
          } else {
            let delay = 0;
            midis.forEach((m) => {
              setTimeout(() => this.playNote(m, { velocity: 0.9 }), delay);
              delay += arpeggioMs;
            });
          }
        },
        playSequence(midis, gapMs=300) {
          this.ensureContext();
          let t = 0;
          midis.forEach(m => {
            setTimeout(() => this.playNote(m, { velocity: 0.9 }), t);
            t += gapMs;
          });
        }
      };

      // Attach UI controls to engine
      const waveformSelect = document.getElementById('waveformSelect');
      const volumeSlider = document.getElementById('volumeSlider');
      waveformSelect.addEventListener('change', e => AudioEngine.setWaveform(e.target.value));
      volumeSlider.addEventListener('input', e => AudioEngine.setVolume(parseFloat(e.target.value)));
      // Create/resume on first interaction
      const resumeContextOnce = () => { AudioEngine.ensureContext(); window.removeEventListener('pointerdown', resumeContextOnce); window.removeEventListener('keydown', resumeContextOnce); };
      window.addEventListener('pointerdown', resumeContextOnce, { passive: true });
      window.addEventListener('keydown', resumeContextOnce);

      // ----------------------------
      // Music Theory Helpers
      // ----------------------------
      const NAMES_SHARP = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
      const BLACK_SET = new Set([1,3,6,8,10]);

      function midiToName(m, preferSharps=true) {
        const pc = ((m % 12) + 12) % 12;
        const oct = Math.floor(m / 12) - 1;
        const sharp = NAMES_SHARP[pc];
        if (!preferSharps) {
          const flats = { "C#":"Db","D#":"Eb","F#":"Gb","G#":"Ab","A#":"Bb" };
          return (flats[sharp] || sharp) + oct;
        }
        return sharp + oct;
      }
      function nameToMidi(name) {
        const match = String(name).trim().match(/^([A-Ga-g])([#b]?)(-?\d)$/);
        if (!match) return null;
        const letter = match[1].toUpperCase();
        const acc = match[2];
        const oct = parseInt(match[3],10);
        const baseIndex = {C:0, D:2, E:4, F:5, G:7, A:9, B:11}[letter];
        let pc = baseIndex + (acc === "#" ? 1 : acc === "b" ? -1 : 0);
        pc = (pc + 12) % 12;
        return (oct + 1) * 12 + pc;
      }
      function midiRange(startMidi, endMidi) {
        const arr = [];
        for (let m = startMidi; m <= endMidi; m++) arr.push(m);
        return arr;
      }
      function isBlack(midi) { return BLACK_SET.has(((midi%12)+12)%12); }

      // Scales
      const SCALE_PATTERNS = {
        major: [0,2,4,5,7,9,11,12],
        naturalMinor: [0,2,3,5,7,8,10,12],
        harmonicMinor: [0,2,3,5,7,8,11,12],
        melodicMinor: [0,2,3,5,7,9,11,12],
        majorPent: [0,2,4,7,9,12],
        minorPent: [0,3,5,7,10,12],
        blues: [0,3,5,6,7,10,12],
        dorian: [0,2,3,5,7,9,10,12],
        mixolydian: [0,2,4,5,7,9,10,12],
        lydian: [0,2,4,6,7,9,11,12],
        phrygian: [0,1,3,5,7,8,10,12],
        locrian: [0,1,3,5,6,8,10,12],
      };
      // Chords
      const CHORD_PATTERNS = {
        maj: [0,4,7],
        min: [0,3,7],
        dim: [0,3,6],
        aug: [0,4,8],
        maj7: [0,4,7,11],
        min7: [0,3,7,10],
        dom7: [0,4,7,10],
        sus2: [0,2,7],
        sus4: [0,5,7],
      };

      // ----------------------------
      // Piano Rendering and Interaction
      // ----------------------------
      const PIANO_START = nameToMidi("C3"); // 48
      const PIANO_END = nameToMidi("B5");   // 83
      const ALL_MIDIS = midiRange(PIANO_START, PIANO_END);
      const WHITE_MIDIS = ALL_MIDIS.filter(m => !isBlack(m));

      const pianoContainer = document.getElementById('pianoContainer');
      const keysMap = new Map(); // midi -> element

      function idSafeNote(name) {
        return name.replace("#","s").replace("b","b");
      }

      function buildPiano() {
        pianoContainer.innerHTML = "";
        keysMap.clear();
        const totalWidth = pianoContainer.clientWidth;
        const totalHeight = pianoContainer.clientHeight;
        const whiteCount = WHITE_MIDIS.length;
        const whiteW = totalWidth / whiteCount;
        const blackW = whiteW * 0.62;

        let whiteIndex = 0;
        let lastWhiteLeft = 0;

        ALL_MIDIS.forEach(midi => {
          const name = midiToName(midi, true);
          const isBlk = isBlack(midi);
          const key = document.createElement('div');
          key.className = `key ${isBlk ? 'black' : 'white'}`;
          key.dataset.midi = midi;
          key.dataset.name = name;
          key.id = `key-${idSafeNote(name)}`;

          let left = 0;
          let width = isBlk ? blackW : whiteW;

          if (!isBlk) {
            left = whiteIndex * whiteW;
            lastWhiteLeft = left;
            whiteIndex++;
          } else {
            left = lastWhiteLeft + whiteW * 0.68 - blackW / 2;
          }

          key.style.left = `${left}px`;
          key.style.width = `${width}px`;
          key.style.height = isBlk ? `${Math.floor(totalHeight * 0.62)}px` : `100%`;

          const label = document.createElement('div');
          label.className = 'keyLabel';
          if (!isBlk) {
            // Label white keys only (C, D, E, F, G, A, B)
            label.textContent = name;
            key.appendChild(label);
          } else {
            label.textContent = name.replace("#","♯");
            key.appendChild(label);
          }

          addKeyListeners(key);
          pianoContainer.appendChild(key);
          keysMap.set(midi, key);
        });
      }

      function addKeyListeners(el) {
        let midi = parseInt(el.dataset.midi, 10);
        let down = false;

        const start = (e) => {
          e.preventDefault();
          down = true;
          AudioEngine.playNote(midi);
          setKeyActive(midi, true);
          handlePianoClickAsAnswer(midi);
        };
        const move = (e) => {
          // Support dragging across keys on touch
          if (!down) return;
          const t = e.touches ? e.touches[0] : e;
          const elem = document.elementFromPoint(t.clientX, t.clientY);
          if (elem && elem.classList.contains('key')) {
            const m = parseInt(elem.dataset.midi,10);
            if (m !== midi) {
              AudioEngine.stopNote(midi, 60);
              setKeyActive(midi, false);
              midi = m;
              AudioEngine.playNote(midi);
              setKeyActive(midi, true);
            }
          }
        };
        const end = (e) => {
          if (!down) return;
          down = false;
          AudioEngine.stopNote(midi, 120);
          setKeyActive(midi, false);
        };

        el.addEventListener('mousedown', start);
        el.addEventListener('touchstart', start, { passive: false });
        window.addEventListener('mousemove', move, { passive: false });
        window.addEventListener('touchmove', move, { passive: false });
        window.addEventListener('mouseup', end);
        window.addEventListener('touchend', end);
        window.addEventListener('touchcancel', end);
      }

      function setKeyActive(midi, on=true) {
        const el = keysMap.get(midi);
        if (!el) return;
        el.classList.toggle('active', on);
      }
      function highlightKeys(midis, className, on=true) {
        midis.forEach(m => {
          const el = keysMap.get(m);
          if (el) el.classList.toggle(className, on);
        });
      }
      function clearAllHighlights() {
        for (const el of keysMap.values()) {
          el.classList.remove('highlight-scale','highlight-chord');
        }
      }

      // Initial render and responsive layout
      new ResizeObserver(buildPiano).observe(pianoContainer);
      buildPiano();

      // ----------------------------
      // Computer Keyboard Mapping
      // ----------------------------
      // Map for two octaves (approx C4..C6). We will map commonly used rows.
      const KEY_TO_OFFSET = {
        // Lower octave whites
        'z': 0, 'x': 2, 'c': 4, 'v': 5, 'b': 7, 'n': 9, 'm': 11,
        // Lower octave blacks
        's': 1, 'd': 3, 'g': 6, 'h': 8, 'j': 10,
        // Upper octave whites
        'q': 12, 'w': 14, 'e': 16, 'r': 17, 't': 19, 'y': 21, 'u': 23,
        // Upper octave blacks
        '2': 13, '3': 15, '5': 18, '6': 20, '7': 22
      };
      const BASE_KEYBOARD_MIDI = nameToMidi("C4");
      const downKeys = new Set();

      window.addEventListener('keydown', (e) => {
        if (e.repeat) return;
        const key = e.key.toLowerCase();
        if (KEY_TO_OFFSET[key] != null) {
          const midi = BASE_KEYBOARD_MIDI + KEY_TO_OFFSET[key];
          if (midi < PIANO_START || midi > PIANO_END) return;
          AudioEngine.playNote(midi);
          setKeyActive(midi, true);
          downKeys.add(midi);
          handlePianoClickAsAnswer(midi);
        }
      });
      window.addEventListener('keyup', (e) => {
        const key = e.key.toLowerCase();
        if (KEY_TO_OFFSET[key] != null) {
          const midi = BASE_KEYBOARD_MIDI + KEY_TO_OFFSET[key];
          AudioEngine.stopNote(midi, 120);
          setKeyActive(midi, false);
          downKeys.delete(midi);
        }
      });

      // ----------------------------
      // Learn Panels - Scale and Chord Explorer
      // ----------------------------
      const scaleRootSelect = document.getElementById('scaleRootSelect');
      const scaleTypeSelect = document.getElementById('scaleTypeSelect');
      const chordRootSelect = document.getElementById('chordRootSelect');
      const chordTypeSelect = document.getElementById('chordTypeSelect');
      const chordInversionSelect = document.getElementById('chordInversionSelect');

      function populateRootSelects() {
        const roots = [];
        // Offer C3..B4 as roots for clarity
        const start = nameToMidi("C3");
        const end = nameToMidi("B4");
        for (let m = start; m <= end; m++) {
          roots.push(midiToName(m, true));
        }
        scaleRootSelect.innerHTML = roots.map(n => `<option value="${n}">${n}</option>`).join('');
        chordRootSelect.innerHTML = roots.map(n => `<option value="${n}">${n}</option>`).join('');
        // Defaults
        scaleRootSelect.value = "C4";
        chordRootSelect.value = "C4";
      }
      populateRootSelects();

      const playScaleBtn = document.getElementById('playScaleBtn');
      const clearScaleHighlightsBtn = document.getElementById('clearScaleHighlightsBtn');
      const playChordBtn = document.getElementById('playChordBtn');
      const clearChordHighlightsBtn = document.getElementById('clearChordHighlightsBtn');

      function getScaleMidis(rootName, patternName) {
        const rootMidi = nameToMidi(rootName);
        const pattern = SCALE_PATTERNS[patternName] || SCALE_PATTERNS.major;
        return pattern
          .map(semi => rootMidi + semi)
          .filter(m => m >= PIANO_START && m <= PIANO_END);
      }
      function getChordMidis(rootName, chordType, inversion=0) {
        const rootMidi = nameToMidi(rootName);
        let ints = CHORD_PATTERNS[chordType] || CHORD_PATTERNS.maj;
        let notes = ints.map(i => rootMidi + i);
        // Apply inversions by raising the lowest note an octave
        for (let i=0; i<inversion; i++) {
          const n = notes.shift();
          notes.push(n + 12);
        }
        // Keep within range if possible
        return notes.filter(m => m >= PIANO_START && m <= PIANO_END);
      }

      playScaleBtn.addEventListener('click', () => {
        const midis = getScaleMidis(scaleRootSelect.value, scaleTypeSelect.value);
        clearAllHighlights();
        highlightKeys(midis, 'highlight-scale', true);
        // Play ascending then descending
        const asc = [...midis];
        const desc = [...midis].reverse().slice(1); // avoid repeating octave
        AudioEngine.playSequence(asc.concat(desc), 250);
        noteBurst("Scale!", 'var(--highlightScale)');
      });
      clearScaleHighlightsBtn.addEventListener('click', () => {
        for (const el of keysMap.values()) el.classList.remove('highlight-scale');
      });
      playChordBtn.addEventListener('click', () => {
        const inv = parseInt(chordInversionSelect.value,10) || 0;
        const midis = getChordMidis(chordRootSelect.value, chordTypeSelect.value, inv);
        for (const el of keysMap.values()) el.classList.remove('highlight-chord');
        highlightKeys(midis, 'highlight-chord', true);
        AudioEngine.playChord(midis, { block: true });
        noteBurst("Chord!", 'var(--highlightChord)');
      });
      clearChordHighlightsBtn.addEventListener('click', () => {
        for (const el of keysMap.values()) el.classList.remove('highlight-chord');
      });

      // ----------------------------
      // Train Panels - Ear Training
      // ----------------------------
      const startNoteQuizBtn = document.getElementById('startNoteQuizBtn');
      const replayNoteBtn = document.getElementById('replayNoteBtn');
      const revealNoteBtn = document.getElementById('revealNoteBtn');
      const noteQuizStatus = document.getElementById('noteQuizStatus');
      const noteScore = document.getElementById('noteScore');

      const startIntervalQuizBtn = document.getElementById('startIntervalQuizBtn');
      const replayIntervalBtn = document.getElementById('replayIntervalBtn');
      const intervalOptions = document.getElementById('intervalOptions');
      const intervalQuizStatus = document.getElementById('intervalQuizStatus');
      const intervalScore = document.getElementById('intervalScore');

      const startChordQuizBtn = document.getElementById('startChordQuizBtn');
      const replayChordBtn = document.getElementById('replayChordBtn');
      const chordOptions = document.getElementById('chordOptions');
      const chordQuizStatus = document.getElementById('chordQuizStatus');
      const chordScore = document.getElementById('chordScore');

      // Note Trainer
      let noteQuiz = { answerMidi: null, correct: 0, total: 0, active: false };
      function newNoteQuestion() {
        const candidates = ALL_MIDIS;
        noteQuiz.answerMidi = candidates[Math.floor(Math.random() * candidates.length)];
        noteQuiz.active = true;
        noteQuiz.total++;
        updateNoteScore();
        noteQuizStatus.textContent = "Listen and click the correct key.";
        AudioEngine.playNote(noteQuiz.answerMidi);
        setTimeout(() => AudioEngine.stopNote(noteQuiz.answerMidi, 120), 600);
      }
      function updateNoteScore() {
        noteScore.textContent = `${noteQuiz.correct}/${noteQuiz.total}`;
      }
      startNoteQuizBtn.addEventListener('click', newNoteQuestion);
      replayNoteBtn.addEventListener('click', () => {
        if (noteQuiz.answerMidi != null) {
          AudioEngine.playNote(noteQuiz.answerMidi);
          setTimeout(() => AudioEngine.stopNote(noteQuiz.answerMidi, 120), 600);
        }
      });
      revealNoteBtn.addEventListener('click', () => {
        if (noteQuiz.answerMidi == null) return;
        const name = midiToName(noteQuiz.answerMidi);
        noteQuizStatus.textContent = `Answer: ${name}`;
        flashKey(noteQuiz.answerMidi, 'highlight-scale');
      });

      // Interval Trainer
      const INTERVALS = [
        { name: 'm2', semi: 1 },
        { name: 'M2', semi: 2 },
        { name: 'm3', semi: 3 },
        { name: 'M3', semi: 4 },
        { name: 'P4', semi: 5 },
        { name: 'TT', semi: 6 },
        { name: 'P5', semi: 7 },
        { name: 'm6', semi: 8 },
        { name: 'M6', semi: 9 },
        { name: 'm7', semi: 10 },
        { name: 'M7', semi: 11 },
        { name: 'P8', semi: 12 },
      ];
      INTERVALS.forEach(int => {
        const btn = document.createElement('button');
        btn.textContent = int.name;
        btn.id = `intervalBtn-${int.name}`;
        btn.addEventListener('click', () => answerInterval(int.semi));
        intervalOptions.appendChild(btn);
      });
      let intervalQuiz = { root: null, semi: null, correct: 0, total: 0, active: false, ascending: true };
      function newIntervalQuestion() {
        // Choose root so that root+semi is within range
        const maxSemi = 12;
        let root = ALL_MIDIS[Math.floor(Math.random()*ALL_MIDIS.length)];
        let intObj = INTERVALS[Math.floor(Math.random()*INTERVALS.length)];
        // adjust if out of range
        if (root + intObj.semi > PIANO_END) root = root - intObj.semi;
        if (root < PIANO_START) root = PIANO_START;
        intervalQuiz.root = root;
        intervalQuiz.semi = intObj.semi;
        intervalQuiz.total++;
        intervalQuiz.active = true;
        updateIntervalScore();
        intervalQuizStatus.textContent = "Identify the interval.";
        // play
        playInterval(root, intObj.semi);
      }
      function playInterval(root, semi) {
        const second = root + semi;
        AudioEngine.playNote(root);
        setTimeout(() => {
          AudioEngine.stopNote(root, 80);
          AudioEngine.playNote(second);
          setTimeout(() => AudioEngine.stopNote(second, 120), 500);
        }, 600);
      }
      function answerInterval(semi) {
        if (!intervalQuiz.active) return;
        if (semi === intervalQuiz.semi) {
          intervalQuiz.correct++;
          intervalQuiz.active = false;
          intervalQuizStatus.textContent = "Correct!";
          intervalQuizStatus.style.borderColor = 'rgba(55,214,122,0.6)';
          burstAt(intervalQuizStatus, "♪", 'var(--good)');
          updateIntervalScore();
          // Highlight the two keys briefly
          flashKey(intervalQuiz.root, 'highlight-scale');
          flashKey(intervalQuiz.root + intervalQuiz.semi, 'highlight-scale');
        } else {
          intervalQuizStatus.textContent = "Not quite. Try again!";
          intervalQuizStatus.style.borderColor = 'rgba(255,92,92,0.6)';
          burstAt(intervalQuizStatus, "♭", 'var(--bad)');
        }
      }
      function updateIntervalScore() {
        intervalScore.textContent = `${intervalQuiz.correct}/${intervalQuiz.total}`;
      }
      startIntervalQuizBtn.addEventListener('click', newIntervalQuestion);
      replayIntervalBtn.addEventListener('click', () => {
        if (intervalQuiz.root != null && intervalQuiz.semi != null) playInterval(intervalQuiz.root, intervalQuiz.semi);
      });

      // Chord Trainer
      const QUIZ_CHORDS = [
        { key: 'maj', name: 'Major' },
        { key: 'min', name: 'Minor' },
        { key: 'dim', name: 'Diminished' },
        { key: 'aug', name: 'Augmented' },
        { key: 'maj7', name: 'Major 7' },
        { key: 'min7', name: 'Minor 7' },
        { key: 'dom7', name: 'Dominant 7' },
      ];
      QUIZ_CHORDS.forEach(ch => {
        const btn = document.createElement('button');
        btn.textContent = ch.name;
        btn.id = `chordBtn-${ch.key}`;
        btn.addEventListener('click', () => answerChord(ch.key));
        chordOptions.appendChild(btn);
      });

      let chordQuiz = { root: null, type: null, notes: [], correct: 0, total: 0, active: false };
      function newChordQuestion() {
        let root = ALL_MIDIS[Math.floor(Math.random()*ALL_MIDIS.length)];
        const choice = QUIZ_CHORDS[Math.floor(Math.random()*QUIZ_CHORDS.length)].key;
        // Build notes and fit within range; adjust root if needed
        let notes = CHORD_PATTERNS[choice].map(semi => root + semi);
        // If any out of range, move root down an octave if possible
        const max = Math.max(...notes), min = Math.min(...notes);
        if (max > PIANO_END) root -= 12;
        if (min < PIANO_START) root += 12;
        notes = CHORD_PATTERNS[choice].map(semi => root + semi).filter(m => m >= PIANO_START && m <= PIANO_END);
        chordQuiz.root = root;
        chordQuiz.type = choice;
        chordQuiz.notes = notes;
        chordQuiz.total++;
        chordQuiz.active = true;
        updateChordScore();
        chordQuizStatus.textContent = "What chord quality is this?";
        // Play block chord
        AudioEngine.playChord(notes, { block: true });
      }
      function answerChord(type) {
        if (!chordQuiz.active) return;
        if (type === chordQuiz.type) {
          chordQuiz.correct++;
          chordQuiz.active = false;
          chordQuizStatus.textContent = "Correct!";
          chordQuizStatus.style.borderColor = 'rgba(55,214,122,0.6)';
          burstAt(chordQuizStatus, "♩", 'var(--good)');
          updateChordScore();
          // Highlight briefly
          chordQuiz.notes.forEach(m => flashKey(m, 'highlight-chord'));
        } else {
          chordQuizStatus.textContent = "Try again!";
          chordQuizStatus.style.borderColor = 'rgba(255,92,92,0.6)';
          burstAt(chordQuizStatus, "♯", 'var(--bad)');
        }
      }
      function updateChordScore() {
        chordScore.textContent = `${chordQuiz.correct}/${chordQuiz.total}`;
      }
      startChordQuizBtn.addEventListener('click', newChordQuestion);
      replayChordBtn.addEventListener('click', () => {
        if (chordQuiz.notes && chordQuiz.notes.length) AudioEngine.playChord(chordQuiz.notes, { block: true });
      });

      // Handle piano clicks as answers in Note Trainer
      function handlePianoClickAsAnswer(midi) {
        if (!noteQuiz.active || noteQuiz.answerMidi == null) return;
        if (midi === noteQuiz.answerMidi) {
          noteQuiz.correct++;
          noteQuiz.active = false;
          noteQuizStatus.textContent = `Correct! It was ${midiToName(midi)}.`;
          noteQuizStatus.style.borderColor = 'rgba(55,214,122,0.6)';
          updateNoteScore();
          burstAt(noteQuizStatus, "♪", 'var(--good)');
          flashKey(midi, 'highlight-scale');
        } else {
          noteQuizStatus.textContent = "Not quite. Try again!";
          noteQuizStatus.style.borderColor = 'rgba(255,92,92,0.6)';
          burstAt(noteQuizStatus, "♭", 'var(--bad)');
        }
      }

      // ----------------------------
      // Tabs
      // ----------------------------
      const tabLearnBtn = document.getElementById('tabLearnBtn');
      const tabTrainBtn = document.getElementById('tabTrainBtn');
      const panelLearn = document.getElementById('panelLearn');
      const panelTrain = document.getElementById('panelTrain');

      function activateTab(which) {
        if (which === 'learn') {
          tabLearnBtn.classList.add('active');
          tabLearnBtn.setAttribute('aria-pressed','true');
          tabTrainBtn.classList.remove('active');
          tabTrainBtn.setAttribute('aria-pressed','false');
          panelLearn.classList.add('active');
          panelTrain.classList.remove('active');
        } else {
          tabTrainBtn.classList.add('active');
          tabTrainBtn.setAttribute('aria-pressed','true');
          tabLearnBtn.classList.remove('active');
          tabLearnBtn.setAttribute('aria-pressed','false');
          panelTrain.classList.add('active');
          panelLearn.classList.remove('active');
        }
      }
      tabLearnBtn.addEventListener('click', () => activateTab('learn'));
      tabTrainBtn.addEventListener('click', () => activateTab('train'));

      // ----------------------------
      // Misc Controls
      // ----------------------------
      const allNotesOffBtn = document.getElementById('allNotesOffBtn');
      const clearAllHighlightsBtn = document.getElementById('clearAllHighlightsBtn');

      allNotesOffBtn.addEventListener('click', () => {
        AudioEngine.stopAll();
        for (const m of downKeys) setKeyActive(m, false);
        downKeys.clear();
      });
      clearAllHighlightsBtn.addEventListener('click', () => {
        clearAllHighlights();
      });

      // ----------------------------
      // Visual helpers
      // ----------------------------
      function flashKey(midi, cls) {
        const el = keysMap.get(midi);
        if (!el) return;
        el.classList.add(cls);
        setTimeout(() => el.classList.remove(cls), 900);
      }
      function burstAt(el, char="♪", color='var(--accent)') {
        const rect = el.getBoundingClientRect();
        const b = document.createElement('div');
        b.className = 'burst';
        b.textContent = char;
        b.style.color = `var(${color.replace('var(','').replace(')','')})`;
        b.style.left = (rect.left + rect.width - 30) + 'px';
        b.style.top = (rect.top - 8 + window.scrollY) + 'px';
        b.style.position = 'absolute';
        document.body.appendChild(b);
        setTimeout(() => b.remove(), 1000);
      }
      function noteBurst(text, colorVar='var(--accent2)') {
        const b = document.createElement('div');
        b.className = 'burst';
        b.textContent = text;
        b.style.left = (pianoContainer.getBoundingClientRect().left + 20) + 'px';
        b.style.top = (pianoContainer.getBoundingClientRect().top + 10 + window.scrollY) + 'px';
        b.style.color = colorVar;
        document.body.appendChild(b);
        setTimeout(() => b.remove(), 1000);
      }

      // Accessibility: allow space/enter to toggle focused buttons nicely (native works)
      // No-op.

    })();
  </script>
</body>
</html>