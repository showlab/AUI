<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <title>Podcast Home Page</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="A clean, audio-centric podcast home page for browsing and playing episodes, searching, and subscribing." />
  <style>
    :root {
      --bg: #0f1420;
      --panel: #151b2c;
      --panel-2: #1b2235;
      --accent: #4aa8ff;
      --accent-2: #7cd1ff;
      --text: #edf2fb;
      --muted: #9fb0c9;
      --danger: #ff6b6b;
      --success: #2ecc71;
      --warning: #ffcc66;

      --radius: 14px;
      --radius-sm: 10px;
      --shadow: 0 10px 20px rgba(0,0,0,0.25);
    }

    html, body {
      background: var(--bg);
      color: var(--text);
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      line-height: 1.35;
    }

    a { color: var(--accent-2); text-decoration: none; }
    a:hover { text-decoration: underline; }

    header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: linear-gradient(180deg, rgba(15,20,32,0.95), rgba(15,20,32,0.85));
      backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 24px;
    }

    .header-bar {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 16px;
      align-items: center;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .logo {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: grid;
      place-items: center;
      background: radial-gradient(120px 80px at -10% 150%, #7cd1ff, #4aa8ff 60%, #2f75e1 100%);
      box-shadow: var(--shadow);
    }
    .logo-wave {
      width: 24px;
      height: 24px;
      fill: white;
      opacity: 0.95;
    }
    .title {
      font-size: 1.25rem;
      font-weight: 700;
      letter-spacing: 0.3px;
    }
    .subtitle {
      color: var(--muted);
      font-size: 0.9rem;
    }

    .search-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--panel);
      padding: 8px 10px 8px 12px;
      border-radius: 28px;
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.04);
      min-width: 420px;
    }
    .search-wrap input {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text);
      font-size: 0.95rem;
      padding: 6px;
    }
    .search-wrap button {
      background: var(--panel-2);
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.07);
      border-radius: 22px;
      padding: 8px 12px;
      font-weight: 600;
      cursor: pointer;
    }
    .search-wrap button:hover {
      background: #222a42;
    }
    .chip {
      font-size: 0.8rem;
      color: var(--muted);
      padding: 2px 8px;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 999px;
    }
    .actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .primary {
      background: linear-gradient(180deg, #4aa8ff, #2f75e1);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 999px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: var(--shadow);
    }
    .primary:hover {
      filter: brightness(1.06);
    }

    main {
      padding: 8px 0 60px;
    }

    .toolbar {
      display: flex;
      align-items: center;
      gap: 12px;
      justify-content: space-between;
      margin: 10px 0 14px;
    }
    .results {
      color: var(--muted);
      font-size: 0.9rem;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px;
    }

    @media (max-width: 960px) {
      .grid {
        grid-template-columns: 1fr;
      }
      .search-wrap { min-width: 0; }
      .header-bar {
        grid-template-columns: 1fr;
      }
      .actions { justify-content: flex-start; }
    }

    article.episode {
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,0.06);
      padding: 16px;
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 16px;
      box-shadow: var(--shadow);
    }

    .cover {
      width: 120px;
      height: 120px;
      background: radial-gradient(160px 120px at 0% 100%, #243156, #1b243c);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.06);
      display: grid;
      place-items: center;
      position: relative;
      overflow: hidden;
    }
    .cover svg {
      width: 84%;
      height: 84%;
      opacity: 0.88;
    }
    .badge {
      position: absolute;
      left: 8px;
      top: 8px;
      font-size: 0.7rem;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(74,168,255,0.15);
      color: #bfe3ff;
      border: 1px solid rgba(74,168,255,0.35);
      backdrop-filter: blur(2px);
    }

    .meta {
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-width: 0;
    }
    .meta h3 {
      margin: 0;
      font-size: 1.1rem;
    }
    .meta .subline {
      color: var(--muted);
      font-size: 0.85rem;
    }
    .description {
      color: #cdd7ea;
      font-size: 0.95rem;
      margin-top: 4px;
    }

    .player {
      background: rgba(0,0,0,0.26);
      border: 1px solid rgba(255,255,255,0.07);
      border-radius: 12px;
      padding: 10px;
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 10px;
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn {
      appearance: none;
      background: #243154;
      color: white;
      border: 1px solid rgba(255,255,255,0.08);
      padding: 10px;
      border-radius: 10px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-width: 40px;
      min-height: 40px;
    }
    .btn:hover { filter: brightness(1.08); }
    .btn.secondary { background: #1f2945; }
    .btn.ghost {
      background: transparent;
      border-color: rgba(255,255,255,0.1);
    }
    .btn .label { font-weight: 700; }

    .play {
      width: 46px; height: 46px;
      border-radius: 99px;
      background: linear-gradient(180deg, #4aa8ff, #2f75e1);
      border: none;
      box-shadow: 0 8px 18px rgba(47,117,225,0.45);
    }
    .play svg { transform: translateX(1px); }

    .timeline {
      display: grid;
      grid-template-rows: auto auto;
      gap: 6px;
      width: 100%;
      align-items: center;
    }

    .progress {
      position: relative;
      height: 10px;
      background: rgba(255,255,255,0.08);
      border-radius: 999px;
      overflow: hidden;
      cursor: pointer;
    }
    .bar {
      position: absolute;
      top: 0; left: 0; height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #4aa8ff, #7cd1ff);
      transition: width 0.1s linear;
    }
    .scrubber {
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 14px; height: 14px;
      background: white;
      border-radius: 99px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.35);
    }
    .time {
      display: flex;
      justify-content: space-between;
      color: var(--muted);
      font-size: 0.85rem;
    }

    .episode-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 6px;
    }
    .subscribe-toggle.subscribed {
      background: rgba(46, 204, 113, 0.15);
      border-color: rgba(46, 204, 113, 0.35);
      color: #c9f6da;
    }

    footer {
      border-top: 1px solid rgba(255,255,255,0.06);
      color: var(--muted);
      font-size: 0.9rem;
      padding: 18px 24px 36px;
    }

    dialog.modal {
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 0;
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      color: var(--text);
      width: min(560px, 92vw);
      box-shadow: var(--shadow);
    }
    .modal header {
      position: sticky; top: 0;
      background: transparent;
      border: none;
    }
    .modal .content {
      padding: 18px 18px 20px;
    }
    .modal h2 { margin: 0 0 6px; }
    .modal .providers {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin: 12px 0 8px;
    }
    .providers a {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px;
      background: #1f2945;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      text-decoration: none;
      color: var(--text);
      font-weight: 700;
    }
    .providers a:hover { filter: brightness(1.08); }

    .rss-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      margin-top: 10px;
    }
    .rss-row input {
      width: 100%;
      background: #0f1420;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      color: var(--text);
      padding: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    }
    .modal .actions {
      padding: 0 18px 18px;
      display: flex;
      justify-content: flex-end;
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 20px;
      transform: translateX(-50%) translateY(20px);
      background: #16203a;
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 999px;
      padding: 10px 16px;
      box-shadow: var(--shadow);
      opacity: 0;
      pointer-events: none;
      transition: transform 0.25s ease, opacity 0.25s ease;
      z-index: 100;
      font-weight: 600;
    }
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0px);
      pointer-events: auto;
    }

    /* Subtle focus styles for keyboard users */
    :focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
      border-radius: 8px;
    }

    /* Empty state */
    .empty {
      text-align: center;
      color: var(--muted);
      padding: 28px 10px;
      border: 1px dashed rgba(255,255,255,0.15);
      border-radius: 16px;
      background: rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <header>
    <div class="container header-bar">
      <div class="brand" aria-label="Podcast brand">
        <div class="logo" aria-hidden="true">
          <svg class="logo-wave" viewBox="0 0 24 24">
            <path d="M3 12c2 0 2-6 4-6s2 12 4 12 2-12 4-12 2 6 4 6" stroke="white" stroke-width="2" fill="none" stroke-linecap="round" />
          </svg>
        </div>
        <div>
          <div class="title">Podcast Home Page</div>
          <div class="subtitle">Browse, play, and subscribe</div>
        </div>
      </div>

      <form class="search-wrap" role="search" aria-label="Episode search" onsubmit="return false;">
        <svg aria-hidden="true" width="18" height="18" viewBox="0 0 24 24" fill="none">
          <path d="M21 21l-4.3-4.3m1.8-5.2a7 7 0 11-14 0 7 7 0 0114 0z" stroke="#9fb0c9" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <input id="searchInput" type="search" placeholder="Search episodes, topics, or guests…" aria-label="Search episodes" />
        <span class="chip" id="resultsCount" aria-live="polite">All episodes</span>
        <button id="searchButton" type="button" title="Search episodes">Search</button>
        <button id="clearSearchButton" type="button" class="btn ghost" title="Clear search">Clear</button>
      </form>

      <div class="actions">
        <button id="subscribeButton" class="primary" type="button" title="Open subscribe options">Subscribe</button>
      </div>
    </div>
  </header>

  <main class="container" id="mainContent">
    <section class="toolbar" aria-label="Episode toolbar">
      <div class="results" id="toolbarStatus">Tap play to start listening</div>
      <div class="results">Tip: Use ← → to skip 15s when a play button is focused</div>
    </section>

    <section aria-labelledby="latestHeading">
      <h2 id="latestHeading" style="margin: 0 0 12px;">Latest Episodes</h2>
      <div id="episodeList" class="grid" role="list"></div>
      <div id="emptyState" class="empty" hidden>No episodes match your search. Try a different term.</div>
    </section>
  </main>

  <footer class="container" role="contentinfo">
    © <span id="year"></span> Podcast Home Page. All episode audio in this demo is a generated tone for preview purposes.
  </footer>

  <dialog id="subscribeModal" class="modal" aria-labelledby="subscribeHeading">
    <header class="container" style="padding: 14px 18px;">
      <div style="display:flex; align-items:center; justify-content:space-between;">
        <h2 id="subscribeHeading" style="margin: 0;">Subscribe to the Podcast</h2>
        <button id="closeSubscribeModalButton" class="btn ghost" type="button" aria-label="Close subscribe dialog">Close</button>
      </div>
    </header>
    <div class="content">
      <p style="margin-top: 0; color: #cdd7ea;">Choose your favorite app or copy the RSS feed to add this podcast to your player.</p>
      <div class="providers">
        <a href="#" data-provider="Apple Podcasts" role="button" aria-label="Subscribe on Apple Podcasts">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="#ff6bd6" aria-hidden="true"><circle cx="12" cy="12" r="10"/></svg>
          Apple
        </a>
        <a href="#" data-provider="Spotify" role="button" aria-label="Subscribe on Spotify">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="#1DB954" aria-hidden="true"><circle cx="12" cy="12" r="10"/></svg>
          Spotify
        </a>
        <a href="#" data-provider="Pocket Casts" role="button" aria-label="Subscribe on Pocket Casts">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="#ee4056" aria-hidden="true"><circle cx="12" cy="12" r="10"/></svg>
          Pocket
        </a>
      </div>

      <div class="rss-row">
        <input id="rssInput" type="text" readonly value="https://example.com/podcast/feed.rss" aria-label="Podcast RSS feed URL" />
        <button id="copyRssButton" class="btn secondary" type="button" title="Copy RSS URL">Copy RSS</button>
      </div>
    </div>
    <div class="actions">
      <button id="closeSubscribeModalButton2" class="btn ghost" type="button" aria-label="Close subscribe dialog">Close</button>
    </div>
  </dialog>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // Data model for episodes
    const EPISODES = [
      {
        id: "e01",
        title: "The Origin Story: How It All Began",
        date: "2025-07-12",
        durationSec: 780,
        tags: ["intro", "host", "story"],
        description: "We kick off the show with our origin story, inspirations, and what you can expect from this podcast."
      },
      {
        id: "e02",
        title: "Deep Dive: The Art of Focus",
        date: "2025-07-19",
        durationSec: 1920,
        tags: ["productivity", "focus", "mindset"],
        description: "From context switching to flow state, we break down practical strategies for staying focused in a noisy world."
      },
      {
        id: "e03",
        title: "Designing for the Ear: Audio UX",
        date: "2025-07-26",
        durationSec: 1560,
        tags: ["design", "audio", "ux"],
        description: "Great audio is more than sound. We explore patterns that make audio-first products delightful and accessible."
      },
      {
        id: "e04",
        title: "Shipping Fast Without Breaking Things",
        date: "2025-08-02",
        durationSec: 2280,
        tags: ["engineering", "process", "delivery"],
        description: "How to ship quickly while maintaining quality: release trains, feature flags, and testing strategies."
      },
      {
        id: "e05",
        title: "Meet the Community: Listener Stories",
        date: "2025-08-09",
        durationSec: 1800,
        tags: ["community", "stories"],
        description: "We turn the mic to our listeners. From big wins to lessons learned—your stories, your voice."
      },
      {
        id: "e06",
        title: "The Sound of Productivity: Music vs. Silence",
        date: "2025-08-16",
        durationSec: 2100,
        tags: ["music", "focus"],
        description: "Do playlists help or hinder? We bring science and anecdotes to the eternal debate."
      },
      {
        id: "e07",
        title: "Behind the Scenes: Our Recording Setup",
        date: "2025-08-23",
        durationSec: 1620,
        tags: ["gear", "studio", "setup"],
        description: "Microphones, acoustics, and the software we rely on to make this show sound great."
      },
      {
        id: "e08",
        title: "Q&A: Your Questions Answered",
        date: "2025-08-30",
        durationSec: 1860,
        tags: ["Q&A", "community"],
        description: "We answer your questions on career, creativity, and everything in between."
      }
    ];

    // State
    const state = {
      filter: "",
      audioUrls: new Map(), // id -> ObjectURL
      audioRefs: new Map(), // id -> HTMLAudioElement
      playingId: null,
      subscribedEpisodes: new Set(JSON.parse(localStorage.getItem("subscribedEpisodes") || "[]")),
      subscribedShow: JSON.parse(localStorage.getItem("subscribedShow") || "false"),
    };

    // Utility: time formatting
    function fmtTime(sec) {
      sec = Math.max(0, Math.floor(sec || 0));
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      const s = sec % 60;
      if (h > 0) return `${h}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
      return `${m}:${String(s).padStart(2,"0")}`;
    }

    // Utility: toast
    let toastTimeout;
    function showToast(msg) {
      const el = document.getElementById("toast");
      el.textContent = msg;
      el.classList.add("show");
      clearTimeout(toastTimeout);
      toastTimeout = setTimeout(() => el.classList.remove("show"), 2200);
    }

    // Audio generation: create a short tone WAV via OfflineAudioContext then encode to WAV
    async function generateToneUrl({ duration = 6, frequency = 440, volume = 0.2 }) {
      const sampleRate = 44100;
      const length = Math.floor(duration * sampleRate);
      const ctx = new (window.OfflineAudioContext || window.webkitOfflineAudioContext)(1, length, sampleRate);

      const osc = ctx.createOscillator();
      osc.type = "sine";
      osc.frequency.value = frequency;

      const gain = ctx.createGain();
      gain.gain.value = 0;

      // Envelope to avoid clicks
      const attack = 0.03, release = 0.2;
      const sustainStart = attack;
      const sustainEnd = duration - release;
      const now = 0;

      gain.gain.setValueAtTime(0, now);
      gain.gain.linearRampToValueAtTime(volume, now + attack);
      gain.gain.setValueAtTime(volume, now + sustainStart);
      gain.gain.linearRampToValueAtTime(0.0001, now + sustainEnd); // exponential-like
      osc.connect(gain).connect(ctx.destination);

      osc.start(0);
      osc.stop(duration);

      const rendered = await ctx.startRendering();
      const wav = audioBufferToWav(rendered);
      const blob = new Blob([wav], { type: "audio/wav" });
      return URL.createObjectURL(blob);
    }

    // Encode AudioBuffer to WAV ArrayBuffer (16-bit PCM)
    function audioBufferToWav(buffer) {
      const numOfChan = buffer.numberOfChannels;
      const sampleRate = buffer.sampleRate;
      const format = 1; // PCM
      const bitDepth = 16;

      const samples = buffer.getChannelData(0);
      const length = samples.length * numOfChan * 2 + 44;
      const wav = new ArrayBuffer(length);
      const view = new DataView(wav);

      // helper
      function writeString(view, offset, string) {
        for (let i = 0; i < string.length; i++) {
          view.setUint8(offset + i, string.charCodeAt(i));
        }
      }

      let offset = 0;

      // RIFF
      writeString(view, offset, 'RIFF'); offset += 4;
      view.setUint32(offset, length - 8, true); offset += 4;
      writeString(view, offset, 'WAVE'); offset += 4;
      // fmt
      writeString(view, offset, 'fmt '); offset += 4;
      view.setUint32(offset, 16, true); offset += 4; // chunk size
      view.setUint16(offset, format, true); offset += 2;
      view.setUint16(offset, numOfChan, true); offset += 2;
      view.setUint32(offset, sampleRate, true); offset += 4;
      view.setUint32(offset, sampleRate * numOfChan * bitDepth / 8, true); offset += 4;
      view.setUint16(offset, numOfChan * bitDepth / 8, true); offset += 2;
      view.setUint16(offset, bitDepth, true); offset += 2;
      // data
      writeString(view, offset, 'data'); offset += 4;
      view.setUint32(offset, samples.length * numOfChan * bitDepth / 8, true); offset += 4;

      // interleave channels
      const channels = [];
      for (let i = 0; i < numOfChan; i++) channels.push(buffer.getChannelData(i));
      let pos = 0;
      for (let i = 0; i < samples.length; i++) {
        for (let ch = 0; ch < numOfChan; ch++) {
          let sample = channels[ch][i];
          // clamp
          sample = Math.max(-1, Math.min(1, sample));
          // scale to 16-bit signed int
          view.setInt16(offset + pos, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
          pos += 2;
        }
      }

      return wav;
    }

    // Render episodes
    function renderEpisodes(list) {
      const container = document.getElementById("episodeList");
      container.innerHTML = "";
      const empty = document.getElementById("emptyState");
      empty.hidden = list.length > 0;

      for (const ep of list) {
        const article = document.createElement("article");
        article.className = "episode";
        article.id = `episode-${ep.id}`;
        article.setAttribute("role", "listitem");

        // Cover
        const cover = document.createElement("div");
        cover.className = "cover";
        cover.innerHTML = `
          <span class="badge" aria-hidden="true">${fmtTime(ep.durationSec)}</span>
          <svg viewBox="0 0 200 200" aria-hidden="true">
            <defs>
              <linearGradient id="grad-${ep.id}" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="#4aa8ff"/>
                <stop offset="100%" stop-color="#7cd1ff"/>
              </linearGradient>
            </defs>
            <path d="${generateWavePath()}" stroke="url(#grad-${ep.id})" stroke-width="3" fill="none" stroke-linecap="round"/>
          </svg>
        `;

        // Meta and player
        const meta = document.createElement("div");
        meta.className = "meta";
        meta.innerHTML = `
          <h3>${ep.title}</h3>
          <div class="subline">${new Date(ep.date).toLocaleDateString()} • ${ep.tags.map(t => '#'+t).join(' ')}</div>
          <p class="description">${ep.description}</p>

          <div class="player" role="group" aria-label="Audio player for ${ep.title}">
            <div class="controls">
              <button class="btn secondary" id="rewindBtn-${ep.id}" type="button" title="Rewind 15 seconds" aria-label="Rewind 15 seconds">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M11 19a7 7 0 100-14v3L6 4l5-4v3a9 9 0 110 18" stroke="#cfe1ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span class="label">15s</span>
              </button>
              <button class="btn play" id="playBtn-${ep.id}" type="button" aria-label="Play ${ep.title}" title="Play/Pause">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="white" aria-hidden="true">
                  <path d="M8 5v14l11-7z" />
                </svg>
              </button>
              <button class="btn secondary" id="forwardBtn-${ep.id}" type="button" title="Forward 15 seconds" aria-label="Forward 15 seconds">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M13 5a7 7 0 100 14v-3l5 4-5 4v-3a9 9 0 110-18" stroke="#cfe1ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span class="label">15s</span>
              </button>
            </div>
            <div class="timeline">
              <div class="progress" id="progress-${ep.id}" role="slider" aria-label="Seek bar" aria-valuemin="0" aria-valuemax="${ep.durationSec}" aria-valuenow="0" tabindex="0">
                <div class="bar" id="progressBar-${ep.id}"></div>
                <div class="scrubber" id="scrubber-${ep.id}" style="left: 0%"></div>
              </div>
              <div class="time">
                <span id="timeCurrent-${ep.id}">0:00</span>
                <span id="timeTotal-${ep.id}">${fmtTime(ep.durationSec)}</span>
              </div>
            </div>
            <div class="episode-actions">
              <button class="btn ghost subscribe-toggle ${state.subscribedEpisodes.has(ep.id) ? 'subscribed' : ''}" id="episodeSubscribeBtn-${ep.id}" type="button" aria-pressed="${state.subscribedEpisodes.has(ep.id)}">
                ${state.subscribedEpisodes.has(ep.id) ? 'Subscribed' : 'Subscribe to this episode'}
              </button>
              <button class="btn ghost" type="button" onclick="openSubscribeModal()" aria-label="Open subscribe options">Subscribe to show</button>
            </div>
            <audio id="audio-${ep.id}" preload="none" crossorigin="anonymous"></audio>
          </div>
        `;

        article.appendChild(cover);
        article.appendChild(meta);
        container.appendChild(article);

        // wire up player controls
        setupPlayer(ep);
      }
      updateResultsCount();
    }

    // Generates a pleasing random-ish waveform path for the cover
    function generateWavePath() {
      const points = [];
      const W = 200, H = 200;
      const steps = 24;
      for (let i = 0; i <= steps; i++) {
        const t = i / steps;
        const x = 10 + t * (W - 20);
        const y = H/2 + Math.sin(t * Math.PI * 2) * 50 * Math.sin(t * Math.PI);
        points.push([x, y]);
      }
      // Smooth path
      let d = `M ${points[0][0]} ${points[0][1]}`;
      for (let i = 1; i < points.length - 1; i++) {
        const xc = (points[i][0] + points[i + 1][0]) / 2;
        const yc = (points[i][1] + points[i + 1][1]) / 2;
        d += ` Q ${points[i][0]} ${points[i][1]} ${xc} ${yc}`;
      }
      return d;
    }

    // Player logic
    async function setupPlayer(ep) {
      const audio = document.getElementById(`audio-${ep.id}`);
      state.audioRefs.set(ep.id, audio);

      // Generate tone URL if not present (different frequency per episode)
      if (!state.audioUrls.has(ep.id)) {
        const baseFreq = 220 + (parseInt(ep.id.replace(/\D/g,''), 10) || 1) * 35;
        const url = await generateToneUrl({
          duration: Math.min(ep.durationSec, 30), // generated preview up to 30s
          frequency: baseFreq
        });
        state.audioUrls.set(ep.id, url);
        audio.src = url;
      }

      const playBtn = document.getElementById(`playBtn-${ep.id}`);
      const rewindBtn = document.getElementById(`rewindBtn-${ep.id}`);
      const forwardBtn = document.getElementById(`forwardBtn-${ep.id}`);
      const progress = document.getElementById(`progress-${ep.id}`);
      const progressBar = document.getElementById(`progressBar-${ep.id}`);
      const scrubber = document.getElementById(`scrubber-${ep.id}`);
      const tCur = document.getElementById(`timeCurrent-${ep.id}`);
      const tTot = document.getElementById(`timeTotal-${ep.id}`);

      // Play/Pause interaction
      function setPlayIcon(isPlaying) {
        playBtn.innerHTML = isPlaying
          ? `<svg width="16" height="16" viewBox="0 0 24 24" fill="white" aria-hidden="true"><path d="M6 5h4v14H6zM14 5h4v14h-4z"/></svg>`
          : `<svg width="16" height="16" viewBox="0 0 24 24" fill="white" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>`;
        playBtn.setAttribute("aria-label", (isPlaying ? "Pause " : "Play ") + ep.title);
      }

      playBtn.addEventListener("click", async () => {
        // Pause any other playing
        if (state.playingId && state.playingId !== ep.id) {
          const other = state.audioRefs.get(state.playingId);
          if (other && !other.paused) other.pause();
          const otherBtn = document.getElementById(`playBtn-${state.playingId}`);
          if (otherBtn) setPlayIcon(false);
        }

        // Ensure source set
        if (!audio.src) {
          const baseFreq = 220 + (parseInt(ep.id.replace(/\D/g,''), 10) || 1) * 35;
          const url = await generateToneUrl({ duration: Math.min(ep.durationSec, 30), frequency: baseFreq });
          state.audioUrls.set(ep.id, url);
          audio.src = url;
        }

        if (audio.paused) {
          await audio.play();
          state.playingId = ep.id;
          setPlayIcon(true);
          document.getElementById("toolbarStatus").textContent = `Now playing: ${ep.title}`;
        } else {
          audio.pause();
          setPlayIcon(false);
        }
      });

      // Keyboard shortcuts on play button
      playBtn.addEventListener("keydown", (e) => {
        if (e.code === "Space") {
          e.preventDefault();
          playBtn.click();
        } else if (e.key === "ArrowLeft") {
          e.preventDefault();
          audio.currentTime = Math.max(0, audio.currentTime - 15);
        } else if (e.key === "ArrowRight") {
          e.preventDefault();
          audio.currentTime = Math.min(audio.duration || 0, audio.currentTime + 15);
        }
      });

      // Seek interactions
      function seekFromClientX(clientX) {
        const rect = progress.getBoundingClientRect();
        const ratio = Math.min(1, Math.max(0, (clientX - rect.left) / rect.width));
        const target = (audio.duration || Math.min(ep.durationSec, 30)) * ratio;
        audio.currentTime = target;
      }
      progress.addEventListener("click", (e) => seekFromClientX(e.clientX));
      progress.addEventListener("keydown", (e) => {
        const step = 5;
        if (e.key === "ArrowLeft") {
          audio.currentTime = Math.max(0, audio.currentTime - step);
          e.preventDefault();
        } else if (e.key === "ArrowRight") {
          audio.currentTime = Math.min(audio.duration || 0, audio.currentTime + step);
          e.preventDefault();
        }
      });

      // Rewind/Forward
      rewindBtn.addEventListener("click", () => {
        audio.currentTime = Math.max(0, audio.currentTime - 15);
      });
      forwardBtn.addEventListener("click", () => {
        audio.currentTime = Math.min(audio.duration || 0, audio.currentTime + 15);
      });

      // Time updates
      const onTimeUpdate = () => {
        const cur = audio.currentTime || 0;
        const dur = audio.duration || Math.min(ep.durationSec, 30);
        const pct = dur ? (cur / dur) * 100 : 0;
        progressBar.style.width = `${pct}%`;
        scrubber.style.left = `${pct}%`;
        tCur.textContent = fmtTime(cur);
        tTot.textContent = fmtTime(dur);
        progress.setAttribute("aria-valuenow", Math.floor(cur));
      };
      audio.addEventListener("timeupdate", onTimeUpdate);
      audio.addEventListener("loadedmetadata", onTimeUpdate);
      audio.addEventListener("ended", () => {
        setPlayIcon(false);
        state.playingId = null;
      });

      // Subscribe toggle per-episode
      const epSubBtn = document.getElementById(`episodeSubscribeBtn-${ep.id}`);
      epSubBtn.addEventListener("click", () => {
        const isNowSubbed = !state.subscribedEpisodes.has(ep.id);
        if (isNowSubbed) state.subscribedEpisodes.add(ep.id);
        else state.subscribedEpisodes.delete(ep.id);
        localStorage.setItem("subscribedEpisodes", JSON.stringify([...state.subscribedEpisodes]));
        epSubBtn.classList.toggle("subscribed", isNowSubbed);
        epSubBtn.textContent = isNowSubbed ? "Subscribed" : "Subscribe to this episode";
        epSubBtn.setAttribute("aria-pressed", String(isNowSubbed));
        showToast(isNowSubbed ? "Episode subscribed" : "Episode unsubscribed");
      });
    }

    // Search and filtering
    function getFilteredEpisodes() {
      if (!state.filter.trim()) return EPISODES;
      const q = state.filter.toLowerCase();
      return EPISODES.filter(e =>
        e.title.toLowerCase().includes(q) ||
        e.description.toLowerCase().includes(q) ||
        e.tags.some(t => t.toLowerCase().includes(q))
      );
    }

    function updateResultsCount() {
      const countEl = document.getElementById("resultsCount");
      const list = getFilteredEpisodes();
      if (!state.filter.trim()) {
        countEl.textContent = "All episodes";
      } else {
        countEl.textContent = `${list.length} result${list.length === 1 ? "" : "s"}`;
      }
    }

    function applySearch() {
      const list = getFilteredEpisodes();
      renderEpisodes(list);
    }

    // Subscribe modal
    function openSubscribeModal() {
      const modal = document.getElementById("subscribeModal");
      if (typeof modal.showModal === "function") {
        modal.showModal();
      } else {
        // Fallback if dialog unsupported
        modal.setAttribute("open", "");
      }
    }
    function closeSubscribeModal() {
      const modal = document.getElementById("subscribeModal");
      if (typeof modal.close === "function") modal.close();
      else modal.removeAttribute("open");
    }
    window.openSubscribeModal = openSubscribeModal; // for inline button

    // Initialization
    document.addEventListener("DOMContentLoaded", async () => {
      document.getElementById("year").textContent = new Date().getFullYear();

      // Initial render
      renderEpisodes(EPISODES);

      // Search wiring
      const searchInput = document.getElementById("searchInput");
      const searchButton = document.getElementById("searchButton");
      const clearSearchButton = document.getElementById("clearSearchButton");

      function doSearch() {
        state.filter = searchInput.value || "";
        applySearch();
      }
      searchInput.addEventListener("input", doSearch);
      searchInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          doSearch();
        }
      });
      searchButton.addEventListener("click", doSearch);
      clearSearchButton.addEventListener("click", () => {
        searchInput.value = "";
        state.filter = "";
        applySearch();
        searchInput.focus();
      });

      // Subscribe modal open/close
      const subscribeButton = document.getElementById("subscribeButton");
      subscribeButton.addEventListener("click", openSubscribeModal);
      document.getElementById("closeSubscribeModalButton").addEventListener("click", closeSubscribeModal);
      document.getElementById("closeSubscribeModalButton2").addEventListener("click", closeSubscribeModal);

      // Provider buttons
      document.querySelectorAll(".providers a").forEach(a => {
        a.addEventListener("click", (e) => {
          e.preventDefault();
          const provider = a.getAttribute("data-provider");
          state.subscribedShow = true;
          localStorage.setItem("subscribedShow", JSON.stringify(true));
          showToast(`Subscribed on ${provider}`);
          closeSubscribeModal();
        });
      });

      // Copy RSS
      document.getElementById("copyRssButton").addEventListener("click", async () => {
        const val = document.getElementById("rssInput").value;
        try {
          await navigator.clipboard.writeText(val);
          showToast("RSS feed copied");
        } catch {
          // Fallback selection
          const input = document.getElementById("rssInput");
          input.focus();
          input.select();
          showToast("Select + copy the RSS feed");
        }
      });

      // Close dialog by clicking backdrop
      const modal = document.getElementById("subscribeModal");
      modal.addEventListener("click", (e) => {
        const rect = modal.getBoundingClientRect();
        const isInDialog = (e.clientX >= rect.left && e.clientX <= rect.right &&
                            e.clientY >= rect.top && e.clientY <= rect.bottom);
        if (!isInDialog) closeSubscribeModal();
      });
      modal.addEventListener("cancel", (e) => { e.preventDefault(); closeSubscribeModal(); });

      // Pause audio when navigating away
      document.addEventListener("visibilitychange", () => {
        if (document.hidden && state.playingId) {
          const audio = state.audioRefs.get(state.playingId);
          if (audio && !audio.paused) {
            audio.pause();
            const btn = document.getElementById(`playBtn-${state.playingId}`);
            if (btn) {
              btn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="white" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>`;
            }
            state.playingId = null;
          }
        }
      });
    });
  </script>
</body>
</html>