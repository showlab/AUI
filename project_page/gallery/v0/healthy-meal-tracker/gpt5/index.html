<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Healthy Meal Tracker</title>
  <style>
    :root {
      --bg: #f6fbf7;
      --panel: #ffffff;
      --accent: #27ae60;
      --accent-weak: #e6f6ec;
      --muted: #6b7a77;
      --text: #202a27;
      --danger: #e74c3c;
      --warning: #f39c12;
      --shadow: 0 8px 20px rgba(31, 73, 54, 0.08);
      --radius: 14px;
      --radius-sm: 10px;
      --focus: 0 0 0 3px rgba(39, 174, 96, 0.25);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: linear-gradient(180deg, #f1faf4 0%, #f8fdf9 100%);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      line-height: 1.35;
    }

    header {
      background: var(--panel);
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      justify-content: space-between;
    }
    .brand {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .brand-emoji {
      font-size: 28px;
      filter: drop-shadow(0 2px 6px rgba(39,174,96,0.18));
    }
    h1 {
      font-size: 20px;
      margin: 0;
      font-weight: 700;
      letter-spacing: 0.2px;
    }

    .top-controls {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .control {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--accent-weak);
      padding: 8px 12px;
      border-radius: 999px;
    }
    label {
      font-size: 12px;
      color: var(--muted);
    }
    input[type="date"],
    input[type="time"],
    input[type="number"],
    input[type="text"],
    select {
      appearance: none;
      border: 1px solid #dfe9e3;
      background: #fff;
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 14px;
      outline: none;
      transition: box-shadow 0.15s ease, border-color 0.15s ease;
    }
    input:focus, select:focus, textarea:focus {
      box-shadow: var(--focus);
      border-color: var(--accent);
    }

    button {
      border: 0;
      background: var(--accent);
      color: #fff;
      padding: 10px 14px;
      font-size: 14px;
      border-radius: 10px;
      cursor: pointer;
      transition: transform 0.05s ease, box-shadow 0.15s ease, background 0.15s ease;
      box-shadow: 0 4px 12px rgba(39, 174, 96, 0.25);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    button:hover { transform: translateY(-1px); }
    button:active { transform: translateY(0); }
    button.secondary {
      background: #f1f6f3;
      color: #1d2b26;
      box-shadow: none;
      border: 1px solid #e3eee7;
    }
    button.danger {
      background: var(--danger);
      box-shadow: 0 4px 12px rgba(231, 76, 60, 0.25);
    }
    button.ghost {
      background: transparent;
      color: var(--text);
      box-shadow: none;
      border: 1px dashed #dce8e1;
    }

    main {
      max-width: 1200px;
      margin: 18px auto;
      padding: 0 20px 30px;
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 18px;
    }

    section, aside {
      background: var(--panel);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      gap: 10px;
    }
    .section-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      font-size: 16px;
    }
    .section-title .emoji {
      font-size: 20px;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .grid-3 {
      display: grid;
      grid-template-columns: 1.2fr 0.8fr 1fr;
      gap: 10px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .inline {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .help {
      color: var(--muted);
      font-size: 12px;
    }

    .divider {
      height: 1px;
      background: #eef4f0;
      margin: 12px 0;
      border-radius: 1px;
    }

    .ingredients-card {
      border: 1px solid #edf4ef;
      border-radius: var(--radius-sm);
      padding: 12px;
      background: #fcfefd;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      text-align: left;
      padding: 8px 6px;
      font-size: 14px;
    }
    thead th {
      font-weight: 600;
      color: #2f3a37;
      border-bottom: 1px solid #edf4ef;
    }
    tbody tr {
      border-bottom: 1px dashed #eef4f0;
    }
    tbody tr:last-child { border-bottom: 0; }

    .total-row {
      background: #f6fbf8;
      border-radius: 10px;
      padding: 8px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-weight: 700;
    }

    .notice {
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 13px;
      display: none;
      margin-top: 8px;
    }
    .notice.error {
      background: #fff0ee;
      color: #a1382c;
      border: 1px solid #ffd4ce;
    }
    .notice.success {
      background: #eefbf2;
      color: #1f6e3f;
      border: 1px solid #d8f2e3;
    }

    .summary-cards {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 10px;
    }
    .summary-card {
      border: 1px solid #edf4ef;
      border-radius: var(--radius-sm);
      padding: 12px;
      background: #fcfffd;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .summary-label {
      font-size: 12px;
      color: var(--muted);
    }
    .summary-value {
      font-size: 20px;
      font-weight: 800;
    }

    .progress {
      background: #eef6f1;
      border-radius: 999px;
      height: 12px;
      overflow: hidden;
      position: relative;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #27ae60, #2ecc71);
      width: 0%;
      transition: width 0.3s ease;
    }
    .progress-warning .progress-bar {
      background: linear-gradient(90deg, #f39c12, #f1c40f);
    }
    .progress-danger .progress-bar {
      background: linear-gradient(90deg, #e74c3c, #ff6b5a);
    }

    .meal-card {
      border: 1px solid #edf4ef;
      border-radius: var(--radius-sm);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: #ffffff;
    }
    .meal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .meal-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      font-size: 16px;
    }
    .meal-meta {
      color: var(--muted);
      font-size: 12px;
    }
    .pill {
      background: #eef6f2;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
      color: #1d5d3f;
    }
    .meal-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .ingredient-bullets {
      margin: 4px 0 0 0;
      padding-left: 18px;
      color: #30413b;
    }
    .ingredient-bullets li {
      margin: 2px 0;
    }
    .empty {
      color: var(--muted);
      text-align: center;
      padding: 16px 10px;
      border: 1px dashed #e7efe9;
      border-radius: 12px;
      background: #fbfefc;
    }

    footer {
      text-align: center;
      color: var(--muted);
      padding: 16px;
      font-size: 12px;
    }

    @media (max-width: 980px) {
      main {
        grid-template-columns: 1fr;
      }
      .summary-cards {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    @media (max-width: 560px) {
      .grid-2, .grid-3 {
        grid-template-columns: 1fr;
      }
      .top-controls {
        justify-content: stretch;
      }
      .control {
        width: 100%;
        justify-content: space-between;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="brand">
        <div class="brand-emoji" aria-hidden="true">ü•ó</div>
        <h1>Healthy Meal Tracker</h1>
      </div>
      <div class="top-controls">
        <div class="control" title="Select day to view or log meals">
          <label for="datePicker">Day</label>
          <input id="datePicker" type="date" />
        </div>
        <div class="control" title="Set a daily calorie goal">
          <label for="calorieGoalInput">Daily Goal</label>
          <input id="calorieGoalInput" type="number" min="0" step="10" placeholder="kcal" style="width: 110px;" />
          <button id="setGoalBtn" aria-label="Set calorie goal">üéØ Set</button>
        </div>
        <button id="clearDayBtn" class="ghost" title="Remove all meals for the selected day">üóëÔ∏è Clear Day</button>
      </div>
    </div>
  </header>

  <main>
    <section id="addMealSection" aria-labelledby="addMealTitle">
      <div class="section-header">
        <div class="section-title">
          <span class="emoji" aria-hidden="true">üçΩÔ∏è</span>
          <span id="addMealTitle">Add a Meal</span>
        </div>
        <span class="help">Log ingredients and we'll total the calories for you.</span>
      </div>

      <div class="grid-2">
        <div class="field">
          <label for="mealNameInput">Meal Name</label>
          <input id="mealNameInput" type="text" placeholder="e.g., Grilled Chicken Salad" autocomplete="off" />
        </div>
        <div class="grid-2">
          <div class="field">
            <label for="mealTypeSelect">Meal Type</label>
            <select id="mealTypeSelect">
              <option value="Breakfast">Breakfast üç≥</option>
              <option value="Lunch">Lunch ü•™</option>
              <option value="Dinner">Dinner üçù</option>
              <option value="Snack" selected>Snack üçé</option>
              <option value="Other">Other üçΩÔ∏è</option>
            </select>
          </div>
          <div class="field">
            <label for="mealTimeInput">Time</label>
            <input id="mealTimeInput" type="time" />
          </div>
        </div>
      </div>

      <div class="divider" role="separator"></div>

      <div class="ingredients-card">
        <div class="section-title" style="margin-bottom: 6px;">
          <span class="emoji" aria-hidden="true">ü•¶</span>
          <span>Ingredients</span>
        </div>

        <div class="grid-3" style="margin-bottom: 8px;">
          <div class="field">
            <label for="ingredientNameInput">Name</label>
            <input id="ingredientNameInput" type="text" placeholder="e.g., Chicken breast" autocomplete="off" />
          </div>
          <div class="inline">
            <div class="field" style="flex: 1;">
              <label for="ingredientQtyInput">Qty</label>
              <input id="ingredientQtyInput" type="number" min="0" step="0.1" placeholder="e.g., 1.5" />
            </div>
            <div class="field" style="flex: 1;">
              <label for="ingredientUnitInput">Unit</label>
              <input id="ingredientUnitInput" type="text" placeholder="g, piece, cup‚Ä¶" />
            </div>
          </div>
          <div class="field">
            <label for="ingredientCalPerUnitInput">Calories per Unit (kcal)</label>
            <input id="ingredientCalPerUnitInput" type="number" min="0" step="1" placeholder="e.g., 165" />
          </div>
        </div>

        <div class="inline" style="justify-content: space-between; margin-bottom: 8px;">
          <div class="help">Tip: Qty √ó Calories per Unit = Ingredient calories.</div>
          <div class="inline">
            <button id="addIngredientBtn">‚ûï Add Ingredient</button>
            <button id="clearIngredientsBtn" class="secondary">üßπ Clear Ingredients</button>
          </div>
        </div>

        <div style="overflow-x: auto;">
          <table aria-label="Ingredients table">
            <thead>
              <tr>
                <th>Ingredient</th>
                <th>Qty</th>
                <th>Unit</th>
                <th>kcal/unit</th>
                <th>kcal</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="ingredientTableBody">
              <!-- Dynamic rows -->
            </tbody>
          </table>
        </div>

        <div class="total-row" aria-live="polite" style="margin-top: 8px;">
          <span>Meal Calories</span>
          <span id="currentMealCalories">0 kcal</span>
        </div>
      </div>

      <div id="formNoticeError" class="notice error" role="alert"></div>
      <div id="formNoticeSuccess" class="notice success" role="status"></div>

      <div class="inline" style="justify-content: flex-end; margin-top: 12px;">
        <button id="resetMealBtn" class="secondary">Reset</button>
        <button id="saveMealBtn">üíæ Save Meal</button>
      </div>
    </section>

    <aside id="dailySummarySection" aria-labelledby="dailySummaryTitle">
      <div class="section-header">
        <div class="section-title">
          <span class="emoji" aria-hidden="true">üìä</span>
          <span id="dailySummaryTitle">Daily Summary</span>
        </div>
        <span id="summaryDateLabel" class="pill"></span>
      </div>

      <div class="summary-cards">
        <div class="summary-card">
          <div class="summary-label">Total Calories</div>
          <div id="dailyTotalCalories" class="summary-value">0 kcal</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Meals Logged</div>
          <div id="dailyMealCount" class="summary-value">0</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Avg per Meal</div>
          <div id="dailyAvgCalories" class="summary-value">0 kcal</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Highest Meal</div>
          <div id="dailyMaxCalories" class="summary-value">0 kcal</div>
        </div>
      </div>

      <div style="margin-bottom: 10px;">
        <div class="inline" style="justify-content: space-between; margin-bottom: 6px;">
          <div class="summary-label">Goal Progress</div>
          <div id="goalLabel" class="summary-label">Goal: ‚Äî</div>
        </div>
        <div id="calorieProgress" class="progress" aria-label="Calorie goal progress">
          <div id="calorieProgressBar" class="progress-bar"></div>
        </div>
      </div>

      <div class="section-title" style="margin: 14px 0 8px;">
        <span class="emoji" aria-hidden="true">üç±</span>
        <span>Meals</span>
      </div>

      <div id="mealsList">
        <div class="empty">No meals logged yet. Add your first meal on the left! üçΩÔ∏è</div>
      </div>
    </aside>
  </main>

  <footer>
    Healthy Meal Tracker ‚Ä¢ Your daily helper for mindful eating üçè
  </footer>

  <script>
    ;(() => {
      "use strict";

      // DOM elements
      const datePicker = document.getElementById('datePicker');
      const calorieGoalInput = document.getElementById('calorieGoalInput');
      const setGoalBtn = document.getElementById('setGoalBtn');
      const clearDayBtn = document.getElementById('clearDayBtn');

      const mealNameInput = document.getElementById('mealNameInput');
      const mealTypeSelect = document.getElementById('mealTypeSelect');
      const mealTimeInput = document.getElementById('mealTimeInput');

      const ingredientNameInput = document.getElementById('ingredientNameInput');
      const ingredientQtyInput = document.getElementById('ingredientQtyInput');
      const ingredientUnitInput = document.getElementById('ingredientUnitInput');
      const ingredientCalPerUnitInput = document.getElementById('ingredientCalPerUnitInput');
      const addIngredientBtn = document.getElementById('addIngredientBtn');
      const clearIngredientsBtn = document.getElementById('clearIngredientsBtn');

      const ingredientTableBody = document.getElementById('ingredientTableBody');
      const currentMealCaloriesEl = document.getElementById('currentMealCalories');

      const formNoticeError = document.getElementById('formNoticeError');
      const formNoticeSuccess = document.getElementById('formNoticeSuccess');

      const saveMealBtn = document.getElementById('saveMealBtn');
      const resetMealBtn = document.getElementById('resetMealBtn');

      const dailyTotalCalories = document.getElementById('dailyTotalCalories');
      const dailyMealCount = document.getElementById('dailyMealCount');
      const dailyAvgCalories = document.getElementById('dailyAvgCalories');
      const dailyMaxCalories = document.getElementById('dailyMaxCalories');
      const calorieProgress = document.getElementById('calorieProgress');
      const calorieProgressBar = document.getElementById('calorieProgressBar');
      const goalLabel = document.getElementById('goalLabel');
      const mealsList = document.getElementById('mealsList');
      const summaryDateLabel = document.getElementById('summaryDateLabel');

      // Data store
      const STORAGE_KEY = 'healthyMealTrackerData';
      let state = loadState();
      let currentIngredients = [];
      let editingMealId = null;

      // Helpers
      function todayISO() {
        const d = new Date();
        d.setHours(0,0,0,0);
        return d.toISOString().slice(0,10);
      }
      function pad2(n) { return n.toString().padStart(2,'0'); }
      function nowTime() {
        const d = new Date();
        return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
      }
      function fmtKcal(n) {
        return `${Math.round(n)} kcal`;
      }
      function pickIconForType(type) {
        switch (type) {
          case 'Breakfast': return 'üç≥';
          case 'Lunch': return 'ü•™';
          case 'Dinner': return 'üçù';
          case 'Snack': return 'üçé';
          default: return 'üçΩÔ∏è';
        }
      }
      function showError(msg) {
        formNoticeError.textContent = msg;
        formNoticeError.style.display = 'block';
        formNoticeSuccess.style.display = 'none';
      }
      function showSuccess(msg) {
        formNoticeSuccess.textContent = msg;
        formNoticeSuccess.style.display = 'block';
        formNoticeError.style.display = 'none';
      }
      function clearNotices() {
        formNoticeError.style.display = 'none';
        formNoticeSuccess.style.display = 'none';
      }
      function persist() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      }
      function loadState() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return { goals: {}, mealsByDate: {} };
          const parsed = JSON.parse(raw);
          if (!parsed.goals) parsed.goals = {};
          if (!parsed.mealsByDate) parsed.mealsByDate = {};
          return parsed;
        } catch {
          return { goals: {}, mealsByDate: {} };
        }
      }
      function getSelectedDate() {
        return datePicker.value || todayISO();
      }
      function setSummaryDateLabel(dateStr) {
        const d = new Date(dateStr + 'T00:00:00');
        const human = d.toLocaleDateString(undefined, { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
        summaryDateLabel.textContent = human;
      }
      function getMealsForDate(dateStr) {
        return state.mealsByDate[dateStr] || [];
      }
      function setMealsForDate(dateStr, meals) {
        state.mealsByDate[dateStr] = meals;
        persist();
      }
      function calcMealCalories(ingredients) {
        return ingredients.reduce((sum, ing) => sum + (Number(ing.totalCalories) || 0), 0);
      }
      function round2(n) {
        return Math.round(n * 100) / 100;
      }

      // Ingredient management
      function renderIngredientTable() {
        ingredientTableBody.innerHTML = '';
        if (!currentIngredients.length) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 6;
          td.className = 'help';
          td.textContent = 'No ingredients added yet.';
          tr.appendChild(td);
          ingredientTableBody.appendChild(tr);
        } else {
          currentIngredients.forEach((ing, idx) => {
            const tr = document.createElement('tr');

            const tdName = document.createElement('td');
            tdName.textContent = ing.name;
            const tdQty = document.createElement('td');
            tdQty.textContent = ing.qty;
            const tdUnit = document.createElement('td');
            tdUnit.textContent = ing.unit || '‚Äî';
            const tdCpu = document.createElement('td');
            tdCpu.textContent = Number(ing.calPerUnit) ? round2(ing.calPerUnit) : 0;
            const tdTotal = document.createElement('td');
            tdTotal.textContent = round2(ing.totalCalories);

            const tdActions = document.createElement('td');
            const delBtn = document.createElement('button');
            delBtn.textContent = 'üóëÔ∏è';
            delBtn.className = 'secondary';
            delBtn.title = 'Remove ingredient';
            delBtn.id = `removeIngredientBtn-${idx}`;
            delBtn.addEventListener('click', () => {
              currentIngredients.splice(idx, 1);
              updateCurrentMealTotals();
              renderIngredientTable();
            });
            tdActions.appendChild(delBtn);

            tr.appendChild(tdName);
            tr.appendChild(tdQty);
            tr.appendChild(tdUnit);
            tr.appendChild(tdCpu);
            tr.appendChild(tdTotal);
            tr.appendChild(tdActions);
            ingredientTableBody.appendChild(tr);
          });
        }
        updateCurrentMealTotals();
      }

      function updateCurrentMealTotals() {
        const total = calcMealCalories(currentIngredients);
        currentMealCaloriesEl.textContent = fmtKcal(total);
      }

      function clearIngredientInputs() {
        ingredientNameInput.value = '';
        ingredientQtyInput.value = '';
        ingredientUnitInput.value = '';
        ingredientCalPerUnitInput.value = '';
        ingredientNameInput.focus();
      }

      function addIngredientFromInputs() {
        const name = ingredientNameInput.value.trim();
        const qty = parseFloat(ingredientQtyInput.value);
        const unit = ingredientUnitInput.value.trim();
        const calPerUnit = parseFloat(ingredientCalPerUnitInput.value);

        if (!name) { showError('Please enter an ingredient name.'); return; }
        if (!(qty > 0)) { showError('Quantity must be greater than 0.'); return; }
        if (!(calPerUnit >= 0)) { showError('Calories per unit must be 0 or more.'); return; }

        const totalCalories = qty * calPerUnit;
        currentIngredients.push({ name, qty: round2(qty), unit, calPerUnit: round2(calPerUnit), totalCalories: round2(totalCalories) });
        clearNotices();
        renderIngredientTable();
        clearIngredientInputs();
      }

      // Meal management
      function resetMealForm(full = true) {
        if (full) {
          mealNameInput.value = '';
          mealTypeSelect.value = 'Snack';
          mealTimeInput.value = '';
        }
        editingMealId = null;
        currentIngredients = [];
        renderIngredientTable();
        clearNotices();
      }

      function saveMeal() {
        const dateStr = getSelectedDate();
        const name = mealNameInput.value.trim();
        const type = mealTypeSelect.value;
        let time = mealTimeInput.value;

        if (!name) { showError('Please enter a meal name.'); return; }
        if (!currentIngredients.length) { showError('Add at least one ingredient.'); return; }
        if (!time) time = nowTime();

        const totalCalories = calcMealCalories(currentIngredients);
        const meal = {
          id: editingMealId || (Date.now().toString() + '-' + Math.floor(Math.random() * 100000)),
          name,
          type,
          time,
          ingredients: JSON.parse(JSON.stringify(currentIngredients)),
          totalCalories: round2(totalCalories)
        };

        const meals = getMealsForDate(dateStr).slice();
        if (editingMealId) {
          const idx = meals.findIndex(m => m.id === editingMealId);
          if (idx >= 0) meals[idx] = meal;
        } else {
          meals.push(meal);
        }
        // sort meals by time
        meals.sort((a, b) => (a.time || '').localeCompare(b.time || ''));

        setMealsForDate(dateStr, meals);
        renderMealsList();
        renderDailySummary();

        resetMealForm();
        showSuccess('Meal saved successfully.');
      }

      function deleteMeal(dateStr, mealId) {
        const meals = getMealsForDate(dateStr).slice();
        const idx = meals.findIndex(m => m.id === mealId);
        if (idx >= 0) {
          meals.splice(idx, 1);
          setMealsForDate(dateStr, meals);
          renderMealsList();
          renderDailySummary();
        }
      }

      function editMeal(dateStr, mealId) {
        const meals = getMealsForDate(dateStr);
        const meal = meals.find(m => m.id === mealId);
        if (!meal) return;
        mealNameInput.value = meal.name;
        mealTypeSelect.value = meal.type;
        mealTimeInput.value = meal.time || '';
        currentIngredients = JSON.parse(JSON.stringify(meal.ingredients));
        editingMealId = meal.id;
        renderIngredientTable();
        clearNotices();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      function renderMealsList() {
        const dateStr = getSelectedDate();
        const meals = getMealsForDate(dateStr);

        mealsList.innerHTML = '';
        if (!meals.length) {
          const div = document.createElement('div');
          div.className = 'empty';
          div.textContent = 'No meals logged yet. Add your first meal on the left! üçΩÔ∏è';
          mealsList.appendChild(div);
          return;
        }

        meals.forEach(meal => {
          const card = document.createElement('div');
          card.className = 'meal-card';
          card.id = `mealCard-${meal.id}`;

          const header = document.createElement('div');
          header.className = 'meal-header';

          const title = document.createElement('div');
          title.className = 'meal-title';
          const icon = document.createElement('span');
          icon.textContent = pickIconForType(meal.type);
          const name = document.createElement('span');
          name.textContent = meal.name;
          title.appendChild(icon);
          title.appendChild(name);

          const meta = document.createElement('div');
          meta.className = 'meal-meta';
          meta.textContent = `${meal.type} ‚Ä¢ ${meal.time || '‚Äî'} ‚Ä¢ ${fmtKcal(meal.totalCalories)}`;

          header.appendChild(title);
          header.appendChild(meta);

          const ingList = document.createElement('ul');
          ingList.className = 'ingredient-bullets';
          meal.ingredients.forEach(ing => {
            const li = document.createElement('li');
            const unitText = ing.unit ? ` ${ing.unit}` : '';
            li.textContent = `${ing.name} ‚Äî ${ing.qty}${unitText} √ó ${round2(ing.calPerUnit)} kcal = ${round2(ing.totalCalories)} kcal`;
            ingList.appendChild(li);
          });

          const actions = document.createElement('div');
          actions.className = 'meal-actions';

          const editBtn = document.createElement('button');
          editBtn.textContent = '‚úèÔ∏è Edit';
          editBtn.className = 'secondary';
          editBtn.id = `editMealBtn-${meal.id}`;
          editBtn.addEventListener('click', () => editMeal(dateStr, meal.id));

          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = 'üóëÔ∏è Delete';
          deleteBtn.className = 'danger';
          deleteBtn.id = `deleteMealBtn-${meal.id}`;
          deleteBtn.addEventListener('click', () => {
            const confirmed = confirm('Delete this meal?');
            if (confirmed) deleteMeal(dateStr, meal.id);
          });

          actions.appendChild(editBtn);
          actions.appendChild(deleteBtn);

          card.appendChild(header);
          card.appendChild(ingList);
          card.appendChild(actions);
          mealsList.appendChild(card);
        });
      }

      // Summary
      function renderDailySummary() {
        const dateStr = getSelectedDate();
        const meals = getMealsForDate(dateStr);
        const total = meals.reduce((sum, m) => sum + (Number(m.totalCalories) || 0), 0);
        const count = meals.length;
        const avg = count ? total / count : 0;
        const max = meals.reduce((m, curr) => Math.max(m, curr.totalCalories || 0), 0);

        dailyTotalCalories.textContent = fmtKcal(total);
        dailyMealCount.textContent = String(count);
        dailyAvgCalories.textContent = fmtKcal(avg);
        dailyMaxCalories.textContent = fmtKcal(max);

        const goal = state.goals[dateStr];
        if (goal && goal > 0) {
          goalLabel.textContent = `Goal: ${fmtKcal(goal)}`;
          const pct = Math.max(0, Math.min(100, (total / goal) * 100));
          calorieProgressBar.style.width = pct + '%';
          calorieProgress.classList.remove('progress-warning', 'progress-danger');
          if (pct >= 100 && total < goal * 1.2) {
            calorieProgress.classList.add('progress-warning');
          } else if (pct >= 120) {
            calorieProgress.classList.add('progress-danger');
          }
        } else {
          goalLabel.textContent = 'Goal: ‚Äî';
          calorieProgressBar.style.width = '0%';
          calorieProgress.classList.remove('progress-warning', 'progress-danger');
        }

        setSummaryDateLabel(dateStr);
      }

      // Goal
      function setGoalForDate() {
        const dateStr = getSelectedDate();
        const val = parseFloat(calorieGoalInput.value);
        if (!(val > 0)) {
          alert('Enter a positive goal in kcal.');
          return;
        }
        state.goals[dateStr] = Math.round(val);
        persist();
        renderDailySummary();
      }

      function clearDay() {
        const dateStr = getSelectedDate();
        const confirmed = confirm('This will remove all meals for the selected day. Continue?');
        if (!confirmed) return;
        setMealsForDate(dateStr, []);
        renderMealsList();
        renderDailySummary();
      }

      // Initialization
      function initDatePicker() {
        datePicker.value = todayISO();
        datePicker.addEventListener('change', () => {
          // Reset editing form when changing date
          resetMealForm(false);
          clearIngredientInputs();
          renderMealsList();
          renderDailySummary();
          // Pre-fill goal input with current goal if exists
          const g = state.goals[getSelectedDate()];
          calorieGoalInput.value = g ? g : '';
        });
      }

      function initIngredientInputs() {
        addIngredientBtn.addEventListener('click', addIngredientFromInputs);
        clearIngredientsBtn.addEventListener('click', () => {
          currentIngredients = [];
          renderIngredientTable();
        });
        // Enter key adds ingredient when focused in any ingredient input
        [ingredientNameInput, ingredientQtyInput, ingredientUnitInput, ingredientCalPerUnitInput].forEach(el => {
          el.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              addIngredientFromInputs();
            }
          });
        });
      }

      function initMealForm() {
        saveMealBtn.addEventListener('click', saveMeal);
        resetMealBtn.addEventListener('click', () => resetMealForm());
      }

      function initGoalControls() {
        setGoalBtn.addEventListener('click', setGoalForDate);
        clearDayBtn.addEventListener('click', clearDay);
      }

      function prefillTime() {
        if (!mealTimeInput.value) {
          mealTimeInput.value = nowTime();
        }
      }

      // Kickoff
      function init() {
        initDatePicker();
        initIngredientInputs();
        initMealForm();
        initGoalControls();

        // Initial render
        renderIngredientTable();
        renderMealsList();
        renderDailySummary();

        // Prefill goal input if exists
        const g = state.goals[getSelectedDate()];
        calorieGoalInput.value = g ? g : '';

        // Prefill time on focus
        mealTimeInput.addEventListener('focus', prefillTime);
      }

      init();
    })();
  </script>
</body>
</html>